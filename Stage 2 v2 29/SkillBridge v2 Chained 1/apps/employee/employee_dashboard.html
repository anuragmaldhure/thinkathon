<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Custom Tailwind Config -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary-600': '#1B2A44',
                        'brand-primary-700': '#14233A',
                        'brand-primary-800': '#0E1A2B',
                        'accent-gold-50': '#FFF7E6',
                        'accent-gold-500': '#C59D42',
                        'accent-gold-600': '#A97D22',
                        'success-600': '#16A34A',
                        'warning-600': '#D97706',
                        'danger-600': '#DC2626',
                        'info-600': '#2563EB',
                        'heat-green': '#16A34A',
                        'heat-amber': '#F59E0B',
                        'heat-red': '#DC2626',
                        'neutral-50': '#F8FAFC',
                        'neutral-200': '#E2E8F0',
                        'neutral-500': '#64748B',
                        'neutral-700': '#334155',
                        'neutral-900': '#111827',
                        'neutral-950': '#0B1220',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-900 text-sm leading-5">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-brand-primary-800 border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8">
                <rect x="84" y="116" width="56" height="168" rx="8" fill="#1E40AF"/>
                <rect x="176" y="84" width="56" height="200" rx="8" fill="#059669"/>
                <rect x="268" y="156" width="48" height="128" rx="8" fill="#1E40AF"/>
                <rect x="114" y="180" width="172" height="20" rx="10" fill="#F59E0B"/>
            </svg>
            <span class="text-xl leading-7 font-semibold text-white">SkillBridge</span>
        </div>
        
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="md:hidden text-white hover:bg-brand-primary-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
            <i data-lucide="menu" class="w-5 h-5"></i>
        </button>

        <div class="hidden md:flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-2 text-white hover:bg-brand-primary-700 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
                    <div id="user-avatar" class="w-8 h-8 bg-accent-gold-500 rounded-full flex items-center justify-center text-brand-primary-800 font-semibold text-xs">
                        JD
                    </div>
                    <span id="user-name" class="text-sm">John Doe</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-neutral-200 rounded-md shadow-lg z-50">
                    <div class="px-4 py-3 border-b border-neutral-200">
                        <p class="text-sm font-medium text-neutral-900" id="dropdown-user-name">John Doe</p>
                        <p class="text-xs text-neutral-500" id="dropdown-user-email">johndoe@example.com</p>
                    </div>
                    <div class="py-1">
                        <button id="sign-out-btn" class="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:bg-neutral-50">
                            <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 z-20 w-64 bg-white border-r border-neutral-200 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out pt-16 md:pt-0 overflow-y-auto" style="height: calc(100vh - 4rem);">
            <nav class="p-4 space-y-1">
                <!-- Employee Dashboard -->
                <a href="employee_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="employee_dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                    <span class="font-medium">Employee Dashboard</span>
                </a>

                <!-- My Skills with Children -->
                <div class="space-y-1">
                    <a href="my_skills.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_skills">
                        <i data-lucide="list" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                        <span class="font-medium">My Skills</span>
                    </a>
                </div>

                <!-- My Training Sessions with Children -->
                <div class="space-y-1">
                    <a href="my_training_sessions.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_training_sessions">
                        <i data-lucide="calendar" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                        <span class="font-medium">My Training Sessions</span>
                    </a>
                </div>

                <!-- My Disputes with Children -->
                <div class="space-y-1">
                    <button class="nav-group-btn flex items-center justify-between w-full px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-group="disputes">
                        <div class="flex items-center gap-3">
                            <i data-lucide="flag" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                            <span class="font-medium">My Disputes</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-neutral-500 group-hover:text-brand-primary-700 transition-transform duration-200"></i>
                    </button>
                    <div class="nav-group-children ml-8 space-y-1 hidden" data-group-target="disputes">
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md text-xs" data-page="my_disputes">
                            <i data-lucide="flag" class="w-4 h-4"></i>
                            <span>View Disputes</span>
                        </a>
                        <a href="raise_dispute.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md text-xs" data-page="raise_dispute">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            <span>Raise Dispute</span>
                        </a>
                    </div>
                </div>

                <!-- My Profile -->
                <a href="my_profile.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_profile">
                    <i data-lucide="user" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                    <span class="font-medium">My Profile</span>
                </a>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-4 left-0 right-0 text-center text-xs text-neutral-500 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto min-h-screen">
            
<!-- Employee Dashboard Content -->
<div class="container mx-auto max-w-[1280px] space-y-6">
  <!-- Header Section -->
  <div class="bg-white rounded-md border border-neutral-200 p-6 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl leading-8 font-bold text-neutral-950 mb-2">Welcome back!</h1>
        <p class="text-sm text-neutral-700" id="dashboard-date">Today is January 15, 2024</p>
      </div>
      <button id="refresh-dashboard" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-neutral-500 hover:text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" aria-label="Refresh Dashboard">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Quick Stats Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Total Skills Assigned -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <div class="skeleton-loading" id="total-skills-skeleton">
            <div class="h-4 bg-neutral-200 rounded w-16 mb-2"></div>
            <div class="h-6 bg-neutral-200 rounded w-8"></div>
          </div>
          <div class="hidden" id="total-skills-content">
            <p class="text-xs font-medium text-neutral-700 mb-1">Total Skills</p>
            <p class="text-xl leading-7 font-semibold text-neutral-950" id="total-skills-count">0</p>
          </div>
        </div>
        <div class="p-2 bg-info-600/10 rounded-md">
          <i data-lucide="target" class="w-5 h-5 text-info-600"></i>
        </div>
      </div>
    </div>

    <!-- Skills Meeting Benchmark -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <div class="skeleton-loading" id="meeting-benchmark-skeleton">
            <div class="h-4 bg-neutral-200 rounded w-20 mb-2"></div>
            <div class="h-6 bg-neutral-200 rounded w-8"></div>
          </div>
          <div class="hidden" id="meeting-benchmark-content">
            <p class="text-xs font-medium text-neutral-700 mb-1">Meeting Benchmark</p>
            <p class="text-xl leading-7 font-semibold text-heat-green" id="meeting-benchmark-count">0</p>
          </div>
        </div>
        <div class="p-2 bg-success-600/10 rounded-md">
          <i data-lucide="check-circle" class="w-5 h-5 text-success-600"></i>
        </div>
      </div>
    </div>

    <!-- Skills Below Benchmark -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <div class="skeleton-loading" id="below-benchmark-skeleton">
            <div class="h-4 bg-neutral-200 rounded w-20 mb-2"></div>
            <div class="h-6 bg-neutral-200 rounded w-8"></div>
          </div>
          <div class="hidden" id="below-benchmark-content">
            <p class="text-xs font-medium text-neutral-700 mb-1">Below Benchmark</p>
            <p class="text-xl leading-7 font-semibold text-heat-red" id="below-benchmark-count">0</p>
          </div>
        </div>
        <div class="p-2 bg-danger-600/10 rounded-md">
          <i data-lucide="alert-triangle" class="w-5 h-5 text-danger-600"></i>
        </div>
      </div>
    </div>

    <!-- Active Disputes -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <div class="skeleton-loading" id="active-disputes-skeleton">
            <div class="h-4 bg-neutral-200 rounded w-16 mb-2"></div>
            <div class="h-6 bg-neutral-200 rounded w-8"></div>
          </div>
          <div class="hidden" id="active-disputes-content">
            <p class="text-xs font-medium text-neutral-700 mb-1">Active Disputes</p>
            <p class="text-xl leading-7 font-semibold text-warning-600" id="active-disputes-count">0</p>
          </div>
        </div>
        <div class="p-2 bg-warning-600/10 rounded-md">
          <i data-lucide="flag" class="w-5 h-5 text-warning-600"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Notifications -->
    <div class="lg:col-span-1">
      <!-- Notifications Panel -->
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base leading-6 font-semibold text-neutral-950">Notifications</h2>
          <button id="refresh-notifications" class="inline-flex items-center text-xs text-neutral-500 hover:text-neutral-700" aria-label="Refresh Notifications">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
          </button>
        </div>
        
        <div class="space-y-3">
          <!-- Skeleton Loading -->
          <div class="skeleton-loading" id="notifications-skeleton">
            <div class="space-y-3">
              <div class="flex items-start gap-3 p-3 border border-neutral-200 rounded-sm">
                <div class="w-2 h-2 bg-neutral-200 rounded-full mt-2 flex-shrink-0"></div>
                <div class="flex-1">
                  <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
                  <div class="h-3 bg-neutral-200 rounded w-full mb-1"></div>
                  <div class="h-3 bg-neutral-200 rounded w-1/2"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Notifications Content -->
          <div class="hidden" id="notifications-content">
            <div id="notifications-list" class="space-y-3">
              <!-- Notifications will be populated here -->
            </div>
            
            <!-- Empty State -->
            <div class="hidden text-center py-8 text-neutral-500" id="notifications-empty">
              <i data-lucide="bell-off" class="w-8 h-8 mx-auto mb-2 text-neutral-400"></i>
              <p class="text-sm">No notifications at this time</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Skills and Training -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Strengths and Improvement Areas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Strengths Card -->
        <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base leading-6 font-semibold text-neutral-950">Top Strengths</h3>
            <button class="view-all-btn text-xs text-brand-primary-600 hover:text-brand-primary-700 focus:outline-none focus:underline" data-page="my_skills">
              View All
            </button>
          </div>
          
          <div class="space-y-2">
            <!-- Skeleton Loading -->
            <div class="skeleton-loading" id="strengths-skeleton">
              <div class="space-y-2">
                <div class="flex items-center justify-between p-2 border border-neutral-200 rounded-sm">
                  <div class="flex-1">
                    <div class="h-3 bg-neutral-200 rounded w-3/4 mb-1"></div>
                    <div class="h-3 bg-neutral-200 rounded w-1/2"></div>
                  </div>
                  <div class="w-2 h-2 bg-neutral-200 rounded-full"></div>
                </div>
              </div>
            </div>
            
            <!-- Strengths Content -->
            <div class="hidden" id="strengths-content">
              <div id="strengths-list" class="space-y-2">
                <!-- Strengths will be populated here -->
              </div>
              
              <!-- Empty State -->
              <div class="hidden text-center py-4 text-neutral-500" id="strengths-empty">
                <p class="text-sm">No strengths data available</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Improvement Areas Card -->
        <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base leading-6 font-semibold text-neutral-950">Improvement Areas</h3>
            <button class="view-all-btn text-xs text-brand-primary-600 hover:text-brand-primary-700 focus:outline-none focus:underline" data-page="my_skills">
              View All
            </button>
          </div>
          
          <div class="space-y-2">
            <!-- Skeleton Loading -->
            <div class="skeleton-loading" id="improvements-skeleton">
              <div class="space-y-2">
                <div class="flex items-center justify-between p-2 border border-neutral-200 rounded-sm">
                  <div class="flex-1">
                    <div class="h-3 bg-neutral-200 rounded w-3/4 mb-1"></div>
                    <div class="h-3 bg-neutral-200 rounded w-1/2"></div>
                  </div>
                  <div class="w-2 h-2 bg-neutral-200 rounded-full"></div>
                </div>
              </div>
            </div>
            
            <!-- Improvements Content -->
            <div class="hidden" id="improvements-content">
              <div id="improvements-list" class="space-y-2">
                <!-- Improvements will be populated here -->
              </div>
              
              <!-- Empty State -->
              <div class="hidden text-center py-4 text-neutral-500" id="improvements-empty">
                <p class="text-sm">No improvement areas identified</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upcoming Training -->
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base leading-6 font-semibold text-neutral-950">Upcoming Training</h3>
          <button class="view-all-btn text-xs text-brand-primary-600 hover:text-brand-primary-700 focus:outline-none focus:underline" data-page="my_training_sessions">
            View All
          </button>
        </div>
        
        <div class="space-y-3">
          <!-- Skeleton Loading -->
          <div class="skeleton-loading" id="training-skeleton">
            <div class="space-y-3">
              <div class="flex items-start gap-3 p-3 border border-neutral-200 rounded-sm">
                <div class="w-10 h-10 bg-neutral-200 rounded-md flex-shrink-0"></div>
                <div class="flex-1">
                  <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
                  <div class="h-3 bg-neutral-200 rounded w-1/2 mb-1"></div>
                  <div class="h-3 bg-neutral-200 rounded w-2/3"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Training Content -->
          <div class="hidden" id="training-content">
            <div id="training-list" class="space-y-3">
              <!-- Training sessions will be populated here -->
            </div>
            
            <!-- Empty State -->
            <div class="hidden text-center py-6 text-neutral-500" id="training-empty">
              <i data-lucide="calendar-x" class="w-8 h-8 mx-auto mb-2 text-neutral-400"></i>
              <p class="text-sm">No upcoming training sessions</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Assessments -->
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base leading-6 font-semibold text-neutral-950">Recent Assessments</h3>
          <button id="refresh-assessments" class="inline-flex items-center text-xs text-neutral-500 hover:text-neutral-700" aria-label="Refresh Assessments">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
          </button>
        </div>
        
        <!-- Skeleton Loading -->
        <div class="skeleton-loading" id="assessments-skeleton">
          <div class="overflow-x-auto">
            <table class="w-full text-sm leading-5">
              <thead class="bg-neutral-50 text-neutral-700">
                <tr>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">
                    <div class="h-4 bg-neutral-200 rounded w-12"></div>
                  </th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">
                    <div class="h-4 bg-neutral-200 rounded w-16"></div>
                  </th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">
                    <div class="h-4 bg-neutral-200 rounded w-12"></div>
                  </th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">
                    <div class="h-4 bg-neutral-200 rounded w-10"></div>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-neutral-200">
                <tr>
                  <td class="px-3 py-3">
                    <div class="h-4 bg-neutral-200 rounded w-20"></div>
                  </td>
                  <td class="px-3 py-3">
                    <div class="h-4 bg-neutral-200 rounded w-16"></div>
                  </td>
                  <td class="px-3 py-3">
                    <div class="h-4 bg-neutral-200 rounded w-8"></div>
                  </td>
                  <td class="px-3 py-3">
                    <div class="h-2 w-2 bg-neutral-200 rounded-full"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Assessments Content -->
        <div class="hidden" id="assessments-content">
          <div class="overflow-x-auto">
            <table class="w-full text-sm leading-5">
              <thead class="bg-neutral-50 text-neutral-700">
                <tr>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Skill</th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Category</th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Score</th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Gap</th>
                  <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Date</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-neutral-200" id="assessments-table-body">
                <!-- Assessment rows will be populated here -->
              </tbody>
            </table>
          </div>
          
          <!-- Empty State -->
          <div class="hidden text-center py-8 text-neutral-500" id="assessments-empty">
            <i data-lucide="clipboard-x" class="w-8 h-8 mx-auto mb-2 text-neutral-400"></i>
            <p class="text-sm">No recent assessments</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        
        // Auth Guard - Check authentication before initializing page
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }
            // User is authenticated, proceed with page initialization
            initializePage();
        });

        // Wrap existing initialization code in this function
        function initializePage() {// Initialize Lucide icons
        lucide.createIcons();

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');

        function toggleMobileMenu() {
            sidebar.classList.toggle('-translate-x-full');
            mobileOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
        mobileOverlay?.addEventListener('click', toggleMobileMenu);

        // Navigation group toggle functionality
        document.querySelectorAll('.nav-group-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const groupName = btn.getAttribute('data-group');
                const children = document.querySelector(`[data-group-target="${groupName}"]`);
                const chevron = btn.querySelector('[data-lucide="chevron-down"]');
                
                children?.classList.toggle('hidden');
                chevron?.classList.toggle('rotate-180');
            });
        });

        // User profile dropdown
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');

        userProfileBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown?.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!userProfileBtn?.contains(e.target)) {
                userDropdown?.classList.add('hidden');
            }
        });

        // Active navigation highlighting
        function updateActiveNav() {
            const currentPage = window.location.pathname.split('/').pop()?.replace('.html', '') || 'employee_dashboard';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                const page = link.getAttribute('data-page');
                if (page === currentPage) {
                    link.classList.add('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-4', 'border-accent-gold-500');
                    link.classList.remove('text-neutral-700', 'text-neutral-600');
                } else {
                    link.classList.remove('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-4', 'border-accent-gold-500');
                }
            });
        }

        // Auth state management
        let currentUser = null;

        function updateUserProfile(user, userData = null) {
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const dropdownUserName = document.getElementById('dropdown-user-name');
            const dropdownUserEmail = document.getElementById('dropdown-user-email');

            if (userData) {
                const displayName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'User';
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                userAvatar.textContent = initials;
                userName.textContent = displayName;
                dropdownUserName.textContent = displayName;
                dropdownUserEmail.textContent = userData.email || user.email;
            } else {
                // Fallback to auth data
                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                userAvatar.textContent = initials;
                userName.textContent = displayName;
                dropdownUserName.textContent = displayName;
                dropdownUserEmail.textContent = user.email;
            }
        }

        async function loadUserData(user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    return userDoc.data();
                } else {
                    // Fallback data
                    return {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: user.email
                    };
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Sign out functionality
        document.getElementById('sign-out-btn')?.addEventListener('click', async () => {
            try {
                showLoader();
                await signOut(auth);
                showToast('Signed out successfully', 'success');
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Error signing out', 'error');
            } finally {
                hideLoader();
            }
        });

        // Initialize auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userData = await loadUserData(user);
                updateUserProfile(user, userData);
                updateActiveNav();
            } else {
                window.location.href = 'auth.html';
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateActiveNav();
        });
    
        } // End initializePage
</script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
  // Import required Firebase and utility functions
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    collection, getDocs, query, where, orderBy, limit, getCountFromServer, Timestamp,
    doc, getDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { auth, getDb } from "./scripts/firebase.js";
  import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";

  const db = getDb();
  let currentUser = null;
  let currentAbort = null;

  // Utility functions
  const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

  function createSemaphore(max = 2) {
    const queue = [];
    let active = 0;
    
    const next = () => {
      if (active >= max || queue.length === 0) return;
      active++;
      const { fn, res, rej } = queue.shift();
      
      Promise.resolve()
        .then(fn)
        .catch(e => rej(e))
        .then(v => res(v))
        .finally(() => {
          active--;
          next();
        });
    };

    return (fn) => new Promise((res, rej) => {
      queue.push({ fn, res, rej });
      next();
    });
  }

  const withLimit = createSemaphore(2);

  // Abortable fetch utility
  async function funAbortableFetch(buildQuery) {
    if (currentAbort) currentAbort.abort();
    currentAbort = new AbortController();
    const signal = currentAbort.signal;

    try {
      const q = buildQuery();
      const snapshot = await getDocs(q);
      
      if (signal.aborted) return { items: [], cursor: null };
      
      return {
        items: snapshot.docs.map(d => ({ id: d.id, ...d.data() })),
        cursor: snapshot.docs.at(-1) || null,
      };
    } catch (err) {
      if (signal.aborted) return { items: [], cursor: null };
      console.error('Fetch error:', err);
      showToast(err?.message || "Failed to load data");
      return { items: [], cursor: null };
    }
  }

  // Format date function
  function formatDate(dateString, format = 'default') {
    if (!dateString) return 'N/A';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'N/A';
      
      if (format === 'default') {
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
      
      return date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch (error) {
      console.error('Date formatting error:', error);
      return 'N/A';
    }
  }

  // Get gap color based on gap value
  function getGapColor(gap) {
    if (!gap && gap !== 0) return 'neutral-500';
    if (gap <= 0) return 'heat-green';
    if (gap >= 1 && gap <= 2) return 'heat-amber';
    return 'heat-red';
  }

  // Show skeleton loading
  function showSkeleton(skeletonId, contentId) {
    const skeleton = document.getElementById(skeletonId);
    const content = document.getElementById(contentId);
    
    if (skeleton) skeleton.classList.remove('hidden');
    if (content) content.classList.add('hidden');
  }

  // Hide skeleton loading
  function hideSkeleton(skeletonId, contentId) {
    const skeleton = document.getElementById(skeletonId);
    const content = document.getElementById(contentId);
    
    if (skeleton) skeleton.classList.add('hidden');
    if (content) content.classList.remove('hidden');
  }

  // Load quick stats
  async function funLoadQuickStats() {
    if (!currentUser) return;

    try {
      // Show skeletons
      showSkeleton('total-skills-skeleton', 'total-skills-content');
      showSkeleton('meeting-benchmark-skeleton', 'meeting-benchmark-content');
      showSkeleton('below-benchmark-skeleton', 'below-benchmark-content');
      showSkeleton('active-disputes-skeleton', 'active-disputes-content');

      // Get total skills assigned to the user
      const totalSkillsQuery = query(
        collection(db, 'skillMappings'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active')
      );

      // Get active disputes count
      const disputesQuery = query(
        collection(db, 'disputes'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'open')
      );

      // Get recent assessments to calculate benchmark stats
      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active'),
        orderBy('assessmentTimestamp', 'desc')
      );

      // Execute queries with concurrency limit
      const [totalSkillsSnapshot, disputesSnapshot, assessmentsSnapshot] = await Promise.all([
        withLimit(() => getCountFromServer(totalSkillsQuery)),
        withLimit(() => getCountFromServer(disputesQuery)),
        withLimit(() => getDocs(assessmentsQuery))
      ]);

      // Calculate benchmark stats from assessments
      const assessments = assessmentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const latestAssessmentPerSkill = {};

      // Get latest assessment per skill
      assessments.forEach(assessment => {
        const skillId = assessment.skillId;
        if (!latestAssessmentPerSkill[skillId] || 
            new Date(assessment.assessmentTimestamp) > new Date(latestAssessmentPerSkill[skillId].assessmentTimestamp)) {
          latestAssessmentPerSkill[skillId] = assessment;
        }
      });

      const latestAssessments = Object.values(latestAssessmentPerSkill);
      let meetingBenchmark = 0;
      let belowBenchmark = 0;

      latestAssessments.forEach(assessment => {
        const gap = (assessment.benchmarkAtTimeOfAssessment || 0) - (assessment.score || 0);
        if (gap <= 0) {
          meetingBenchmark++;
        } else {
          belowBenchmark++;
        }
      });

      // Update UI
      document.getElementById('total-skills-count').textContent = totalSkillsSnapshot.data()?.count || 0;
      document.getElementById('meeting-benchmark-count').textContent = meetingBenchmark;
      document.getElementById('below-benchmark-count').textContent = belowBenchmark;
      document.getElementById('active-disputes-count').textContent = disputesSnapshot.data()?.count || 0;

      // Hide skeletons
      hideSkeleton('total-skills-skeleton', 'total-skills-content');
      hideSkeleton('meeting-benchmark-skeleton', 'meeting-benchmark-content');
      hideSkeleton('below-benchmark-skeleton', 'below-benchmark-content');
      hideSkeleton('active-disputes-skeleton', 'active-disputes-content');

    } catch (error) {
      console.error('Error loading quick stats:', error);
      showToast('Failed to load dashboard statistics');
      
      // Hide skeletons on error
      hideSkeleton('total-skills-skeleton', 'total-skills-content');
      hideSkeleton('meeting-benchmark-skeleton', 'meeting-benchmark-content');
      hideSkeleton('below-benchmark-skeleton', 'below-benchmark-content');
      hideSkeleton('active-disputes-skeleton', 'active-disputes-content');
    }
  }

  // Load notifications (disputes requiring response and reassessment windows)
  async function funLoadNotifications() {
    if (!currentUser) return;

    try {
      showSkeleton('notifications-skeleton', 'notifications-content');

      // Get disputes that need employee response (resolved but not acknowledged)
      const disputesQuery = query(
        collection(db, 'disputes'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'resolved'),
        limit(5)
      );

      // Get training sessions for reassessment windows
      const trainingsQuery = query(
        collection(db, 'trainingSessions'),
        where('status', '==', 'completed'),
        orderBy('endDate', 'desc'),
        limit(10)
      );

      const [disputesSnapshot, trainingsSnapshot] = await Promise.all([
        withLimit(() => getDocs(disputesQuery)),
        withLimit(() => getDocs(trainingsQuery))
      ]);

      const disputes = disputesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const trainings = trainingsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      // Get active assessment cycle for reassessment delay
      const cycleQuery = query(
        collection(db, 'assessmentCycles'),
        where('isActiveCycle', '==', true),
        limit(1)
      );

      const cycleSnapshot = await getDocs(cycleQuery);
      const cycle = cycleSnapshot.docs[0]?.data();
      const reassessmentDelayDays = cycle?.reassessmentDelayDays || 14;

      const notifications = [];

      // Check disputes requiring response
      for (const dispute of disputes) {
        const auditTrail = dispute.auditTrail || [];
        const hasEmployeeResponse = auditTrail.some(entry => 
          entry.actorType === 'employee' && 
          ['agreed', 'disagreed'].includes(entry.action) &&
          new Date(entry.timestamp) > new Date(dispute.resolutionTimestamp || 0)
        );

        if (!hasEmployeeResponse) {
          notifications.push({
            type: 'dispute',
            title: 'Dispute Resolution Requires Response',
            message: 'A dispute has been resolved and requires your acknowledgment.',
            link: `dispute_detail.html?disputeId=${dispute.id}`,
            priority: 'high',
            date: dispute.resolutionTimestamp || dispute.submissionDate
          });
        }
      }

      // Check for reassessment windows
      const now = new Date();
      for (const training of trainings) {
        if (training.assignedEmployees?.some(emp => emp.employeeId === currentUser.uid)) {
          const endDate = new Date(training.endDate);
          const reassessmentDate = new Date(endDate.getTime() + (reassessmentDelayDays * 24 * 60 * 60 * 1000));
          
          // Check if we're within the reassessment window (now >= reassessmentDate)
          if (now >= reassessmentDate) {
            notifications.push({
              type: 'reassessment',
              title: 'Reassessment Window Open',
              message: `Your reassessment window is now open for training completed on ${formatDate(training.endDate)}.`,
              link: `skill_growth_detail.html?skillId=${training.skillId}`,
              priority: 'medium',
              date: training.endDate
            });
          }
        }
      }

      // Sort notifications by priority and date
      notifications.sort((a, b) => {
        const priorityOrder = { high: 3, medium: 2, low: 1 };
        const priorityDiff = (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
        if (priorityDiff !== 0) return priorityDiff;
        return new Date(b.date) - new Date(a.date);
      });

      // Render notifications
      const notificationsList = document.getElementById('notifications-list');
      const notificationsEmpty = document.getElementById('notifications-empty');

      if (notifications.length === 0) {
        notificationsList.innerHTML = '';
        notificationsEmpty.classList.remove('hidden');
      } else {
        notificationsEmpty.classList.add('hidden');
        notificationsList.innerHTML = notifications.slice(0, 5).map(notification => {
          const priorityColor = notification.priority === 'high' ? 'danger-600' : 
                               notification.priority === 'medium' ? 'warning-600' : 'info-600';
          
          return `
            <div class="flex items-start gap-3 p-3 border border-neutral-200 rounded-sm hover:bg-neutral-50 cursor-pointer notification-item" data-link="${notification.link}">
              <span class="h-2 w-2 rounded-full bg-${priorityColor} mt-2 flex-shrink-0"></span>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-neutral-950 mb-1">${notification.title}</p>
                <p class="text-xs text-neutral-700 mb-1">${notification.message}</p>
                <p class="text-xs text-neutral-500">${formatDate(notification.date)}</p>
              </div>
            </div>
          `;
        }).join('');

        // Add click handlers for notifications
        document.querySelectorAll('.notification-item').forEach(item => {
          item.addEventListener('click', function() {
            const link = this.getAttribute('data-link');
            if (link) {
              window.location.href = link;
            }
          });
        });
      }

      hideSkeleton('notifications-skeleton', 'notifications-content');

    } catch (error) {
      console.error('Error loading notifications:', error);
      showToast('Failed to load notifications');
      hideSkeleton('notifications-skeleton', 'notifications-content');
    }
  }

  // Load strengths and improvements
  async function funLoadSkillsOverview() {
    if (!currentUser) return;

    try {
      showSkeleton('strengths-skeleton', 'strengths-content');
      showSkeleton('improvements-skeleton', 'improvements-content');

      // Get user's skill mappings and assessments
      const skillMappingsQuery = query(
        collection(db, 'skillMappings'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active')
      );

      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active'),
        orderBy('assessmentTimestamp', 'desc')
      );

      const [mappingsSnapshot, assessmentsSnapshot] = await Promise.all([
        withLimit(() => getDocs(skillMappingsQuery)),
        withLimit(() => getDocs(assessmentsQuery))
      ]);

      const mappings = mappingsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const assessments = assessmentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      // Get latest assessment per skill
      const latestAssessmentPerSkill = {};
      assessments.forEach(assessment => {
        const skillId = assessment.skillId;
        if (!latestAssessmentPerSkill[skillId] || 
            new Date(assessment.assessmentTimestamp) > new Date(latestAssessmentPerSkill[skillId].assessmentTimestamp)) {
          latestAssessmentPerSkill[skillId] = assessment;
        }
      });

      // Get skill details
      const skillIds = [...new Set([...mappings.map(m => m.skillId), ...Object.keys(latestAssessmentPerSkill)])];
      const skills = {};
      const categories = {};

      // Fetch skill details in batches
      for (let i = 0; i < skillIds.length; i += 10) {
        const batch = skillIds.slice(i, i + 10);
        await Promise.all(batch.map(async (skillId) => {
          try {
            const skillDoc = await getDoc(doc(db, 'skills', skillId));
            if (skillDoc.exists()) {
              const skillData = skillDoc.data();
              skills[skillId] = skillData;
              
              // Get category if not already fetched
              if (skillData.categoryId && !categories[skillData.categoryId]) {
                const categoryDoc = await getDoc(doc(db, 'skillCategories', skillData.categoryId));
                if (categoryDoc.exists()) {
                  categories[skillData.categoryId] = categoryDoc.data();
                }
              }
            }
          } catch (error) {
            console.error(`Error fetching skill ${skillId}:`, error);
          }
        }));
        
        // Yield to avoid blocking UI
        await yieldToFrame();
      }

      // Calculate strengths and improvements
      const skillsWithGaps = [];

      mappings.forEach(mapping => {
        const skill = skills[mapping.skillId];
        const assessment = latestAssessmentPerSkill[mapping.skillId];
        
        if (skill && assessment) {
          const gap = (assessment.benchmarkAtTimeOfAssessment || 0) - (assessment.score || 0);
          const category = categories[skill.categoryId];
          
          skillsWithGaps.push({
            skillId: mapping.skillId,
            name: skill.name || 'N/A',
            categoryName: category?.categoryName || 'N/A',
            score: assessment.score || 0,
            benchmark: assessment.benchmarkAtTimeOfAssessment || 0,
            gap: gap,
            assessmentDate: assessment.assessmentTimestamp
          });
        }
      });

      // Sort for strengths (gap <= 0, highest scores first)
      const strengths = skillsWithGaps
        .filter(skill => skill.gap <= 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);

      // Sort for improvements (gap > 0, highest gaps first)
      const improvements = skillsWithGaps
        .filter(skill => skill.gap > 0)
        .sort((a, b) => b.gap - a.gap)
        .slice(0, 5);

      // Render strengths
      const strengthsList = document.getElementById('strengths-list');
      const strengthsEmpty = document.getElementById('strengths-empty');

      if (strengths.length === 0) {
        strengthsList.innerHTML = '';
        strengthsEmpty.classList.remove('hidden');
      } else {
        strengthsEmpty.classList.add('hidden');
        strengthsList.innerHTML = strengths.map(skill => `
          <div class="flex items-center justify-between p-2 border border-neutral-200 rounded-sm hover:bg-neutral-50 cursor-pointer skill-item" data-skill-id="${skill.skillId}">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-neutral-950 truncate">${skill.name}</p>
              <p class="text-xs text-neutral-700">${skill.categoryName} • Score: ${skill.score}</p>
            </div>
            <span class="h-2 w-2 rounded-full bg-${getGapColor(skill.gap)} flex-shrink-0"></span>
          </div>
        `).join('');
      }

      // Render improvements
      const improvementsList = document.getElementById('improvements-list');
      const improvementsEmpty = document.getElementById('improvements-empty');

      if (improvements.length === 0) {
        improvementsList.innerHTML = '';
        improvementsEmpty.classList.remove('hidden');
      } else {
        improvementsEmpty.classList.add('hidden');
        improvementsList.innerHTML = improvements.map(skill => `
          <div class="flex items-center justify-between p-2 border border-neutral-200 rounded-sm hover:bg-neutral-50 cursor-pointer skill-item" data-skill-id="${skill.skillId}">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-neutral-950 truncate">${skill.name}</p>
              <p class="text-xs text-neutral-700">${skill.categoryName} • Gap: ${skill.gap}</p>
            </div>
            <span class="h-2 w-2 rounded-full bg-${getGapColor(skill.gap)} flex-shrink-0"></span>
          </div>
        `).join('');
      }

      // Add click handlers for skill items
      document.querySelectorAll('.skill-item').forEach(item => {
        item.addEventListener('click', function() {
          const skillId = this.getAttribute('data-skill-id');
          if (skillId) {
            window.location.href = `skill_growth_detail.html?skillId=${skillId}`;
          }
        });
      });

      hideSkeleton('strengths-skeleton', 'strengths-content');
      hideSkeleton('improvements-skeleton', 'improvements-content');

    } catch (error) {
      console.error('Error loading skills overview:', error);
      showToast('Failed to load skills data');
      hideSkeleton('strengths-skeleton', 'strengths-content');
      hideSkeleton('improvements-skeleton', 'improvements-content');
    }
  }

  // Load upcoming training
  async function funLoadUpcomingTraining() {
    if (!currentUser) return;

    try {
      showSkeleton('training-skeleton', 'training-content');

      const now = new Date();
      const trainingsQuery = query(
        collection(db, 'trainingSessions'),
        where('status', '==', 'scheduled'),
        orderBy('scheduledDate', 'asc'),
        limit(10) // Get more to filter client-side
      );

      const trainingsSnapshot = await getDocs(trainingsQuery);
      const allTrainings = trainingsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      // Filter for user's trainings and future dates
      const userTrainings = allTrainings.filter(training => {
        const isAssigned = training.assignedEmployees?.some(emp => emp.employeeId === currentUser.uid);
        const isScheduledDate = training.scheduledDate && new Date(training.scheduledDate) > now;
        return isAssigned && isScheduledDate;
      }).slice(0, 3);

      // Get skill details for trainings
      const skillIds = [...new Set(userTrainings.map(t => t.skillId).filter(Boolean))];
      const skills = {};

      for (const skillId of skillIds) {
        try {
          const skillDoc = await getDoc(doc(db, 'skills', skillId));
          if (skillDoc.exists()) {
            skills[skillId] = skillDoc.data();
          }
        } catch (error) {
          console.error(`Error fetching skill ${skillId}:`, error);
        }
      }

      // Render training sessions
      const trainingList = document.getElementById('training-list');
      const trainingEmpty = document.getElementById('training-empty');

      if (userTrainings.length === 0) {
        trainingList.innerHTML = '';
        trainingEmpty.classList.remove('hidden');
      } else {
        trainingEmpty.classList.add('hidden');
        trainingList.innerHTML = userTrainings.map(training => {
          const skill = skills[training.skillId];
          const startDate = formatDate(training.scheduledDate);
          const endDate = formatDate(training.endDate);
          
          return `
            <div class="flex items-start gap-3 p-3 border border-neutral-200 rounded-sm hover:bg-neutral-50 cursor-pointer training-item" data-session-id="${training.id}">
              <div class="w-10 h-10 bg-brand-primary-600 rounded-md flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                ${skill?.name?.charAt(0) || 'T'}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-neutral-950 mb-1">${skill?.name || 'Training Session'}</p>
                <p class="text-xs text-neutral-700 mb-1">${startDate} - ${endDate}</p>
                <p class="text-xs text-neutral-500 capitalize">${training.mode || 'N/A'} Mode</p>
              </div>
            </div>
          `;
        }).join('');

        // Add click handlers for training items
        document.querySelectorAll('.training-item').forEach(item => {
          item.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            if (sessionId) {
              window.location.href = `training_session_detail.html?sessionId=${sessionId}`;
            }
          });
        });
      }

      hideSkeleton('training-skeleton', 'training-content');

    } catch (error) {
      console.error('Error loading upcoming training:', error);
      showToast('Failed to load training data');
      hideSkeleton('training-skeleton', 'training-content');
    }
  }

  // Load recent assessments
  async function funLoadRecentAssessments() {
    if (!currentUser) return;

    try {
      showSkeleton('assessments-skeleton', 'assessments-content');

      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active'),
        orderBy('assessmentTimestamp', 'desc'),
        limit(5)
      );

      const assessmentsSnapshot = await getDocs(assessmentsQuery);
      const assessments = assessmentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      // Get skill and category details
      const skillIds = [...new Set(assessments.map(a => a.skillId).filter(Boolean))];
      const skills = {};
      const categories = {};

      for (const skillId of skillIds) {
        try {
          const skillDoc = await getDoc(doc(db, 'skills', skillId));
          if (skillDoc.exists()) {
            const skillData = skillDoc.data();
            skills[skillId] = skillData;
            
            // Get category
            if (skillData.categoryId && !categories[skillData.categoryId]) {
              const categoryDoc = await getDoc(doc(db, 'skillCategories', skillData.categoryId));
              if (categoryDoc.exists()) {
                categories[skillData.categoryId] = categoryDoc.data();
              }
            }
          }
        } catch (error) {
          console.error(`Error fetching skill ${skillId}:`, error);
        }
      }

      // Render assessments table
      const tableBody = document.getElementById('assessments-table-body');
      const assessmentsEmpty = document.getElementById('assessments-empty');

      if (assessments.length === 0) {
        tableBody.innerHTML = '';
        assessmentsEmpty.classList.remove('hidden');
      } else {
        assessmentsEmpty.classList.add('hidden');
        tableBody.innerHTML = assessments.map(assessment => {
          const skill = skills[assessment.skillId];
          const category = categories[skill?.categoryId];
          const gap = (assessment.benchmarkAtTimeOfAssessment || 0) - (assessment.score || 0);
          const gapColor = getGapColor(gap);
          
          return `
            <tr class="hover:bg-neutral-50 focus-within:bg-neutral-50 cursor-pointer assessment-row" data-skill-id="${assessment.skillId}">
              <td class="px-3 py-3">
                <span class="text-neutral-950 font-medium">${skill?.name || 'N/A'}</span>
              </td>
              <td class="px-3 py-3">
                <span class="text-neutral-700">${category?.categoryName || 'N/A'}</span>
              </td>
              <td class="px-3 py-3">
                <span class="text-neutral-950 font-medium">${assessment.score || 0}</span>
              </td>
              <td class="px-3 py-3">
                <span class="h-2 w-2 rounded-full bg-${gapColor} inline-block"></span>
              </td>
              <td class="px-3 py-3">
                <span class="text-neutral-700">${formatDate(assessment.assessmentTimestamp)}</span>
              </td>
            </tr>
          `;
        }).join('');

        // Add click handlers for assessment rows
        document.querySelectorAll('.assessment-row').forEach(row => {
          row.addEventListener('click', function() {
            const skillId = this.getAttribute('data-skill-id');
            if (skillId) {
              window.location.href = `skill_growth_detail.html?skillId=${skillId}`;
            }
          });
        });
      }

      hideSkeleton('assessments-skeleton', 'assessments-content');

    } catch (error) {
      console.error('Error loading recent assessments:', error);
      showToast('Failed to load assessments');
      hideSkeleton('assessments-skeleton', 'assessments-content');
    }
  }

  // Main initialization function
  async function funInitialLoad(forceRefresh = false) {
    if (!currentUser) return;

    // Set current date
    document.getElementById('dashboard-date').textContent = 
      `Today is ${formatDate(new Date().toISOString(), 'long')}`;

    // Load all dashboard data
    await Promise.all([
      funLoadQuickStats(),
      funLoadNotifications(),
      funLoadSkillsOverview(),
      funLoadUpcomingTraining(),
      funLoadRecentAssessments()
    ]);

    // Initialize Lucide icons
    if (window.lucide) {
      lucide.createIcons();
    }
  }

  // Event handlers
  document.addEventListener('DOMContentLoaded', () => {
    // Refresh dashboard
    document.getElementById('refresh-dashboard')?.addEventListener('click', () => {
      funInitialLoad(true);
    });

    // Refresh notifications
    document.getElementById('refresh-notifications')?.addEventListener('click', () => {
      funLoadNotifications();
    });

    // Refresh assessments
    document.getElementById('refresh-assessments')?.addEventListener('click', () => {
      funLoadRecentAssessments();
    });

    // View All buttons
    document.querySelectorAll('.view-all-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        if (page) {
          window.location.href = `${page}.html`;
        }
      });
    });
  });

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
      return;
    }
    
    currentUser = user;
    funInitialLoad();
  });
</script>

</body>
</html>