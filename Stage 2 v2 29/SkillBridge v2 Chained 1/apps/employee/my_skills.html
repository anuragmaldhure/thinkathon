<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Custom Tailwind Config -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary-600': '#1B2A44',
                        'brand-primary-700': '#14233A',
                        'brand-primary-800': '#0E1A2B',
                        'accent-gold-50': '#FFF7E6',
                        'accent-gold-500': '#C59D42',
                        'accent-gold-600': '#A97D22',
                        'success-600': '#16A34A',
                        'warning-600': '#D97706',
                        'danger-600': '#DC2626',
                        'info-600': '#2563EB',
                        'heat-green': '#16A34A',
                        'heat-amber': '#F59E0B',
                        'heat-red': '#DC2626',
                        'neutral-50': '#F8FAFC',
                        'neutral-200': '#E2E8F0',
                        'neutral-500': '#64748B',
                        'neutral-700': '#334155',
                        'neutral-900': '#111827',
                        'neutral-950': '#0B1220',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-900 text-sm leading-5">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-brand-primary-800 border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8">
                <rect x="84" y="116" width="56" height="168" rx="8" fill="#1E40AF"/>
                <rect x="176" y="84" width="56" height="200" rx="8" fill="#059669"/>
                <rect x="268" y="156" width="48" height="128" rx="8" fill="#1E40AF"/>
                <rect x="114" y="180" width="172" height="20" rx="10" fill="#F59E0B"/>
            </svg>
            <span class="text-xl leading-7 font-semibold text-white">SkillBridge</span>
        </div>
        
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="md:hidden text-white hover:bg-brand-primary-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
            <i data-lucide="menu" class="w-5 h-5"></i>
        </button>

        <div class="hidden md:flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-2 text-white hover:bg-brand-primary-700 px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
                    <div id="user-avatar" class="w-8 h-8 bg-accent-gold-500 rounded-full flex items-center justify-center text-brand-primary-800 font-semibold text-xs">
                        JD
                    </div>
                    <span id="user-name" class="text-sm">John Doe</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-neutral-200 rounded-md shadow-lg z-50">
                    <div class="px-4 py-3 border-b border-neutral-200">
                        <p class="text-sm font-medium text-neutral-900" id="dropdown-user-name">John Doe</p>
                        <p class="text-xs text-neutral-500" id="dropdown-user-email">johndoe@example.com</p>
                    </div>
                    <div class="py-1">
                        <button id="sign-out-btn" class="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:bg-neutral-50">
                            <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 z-20 w-64 bg-white border-r border-neutral-200 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out pt-16 md:pt-0 overflow-y-auto" style="height: calc(100vh - 4rem);">
            <nav class="p-4 space-y-1">
                <!-- Employee Dashboard -->
                <a href="employee_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="employee_dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                    <span class="font-medium">Employee Dashboard</span>
                </a>

                <!-- My Skills with Children -->
                <div class="space-y-1">
                    <a href="my_skills.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_skills">
                        <i data-lucide="list" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                        <span class="font-medium">My Skills</span>
                    </a>
                </div>

                <!-- My Training Sessions with Children -->
                <div class="space-y-1">
                    <a href="my_training_sessions.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_training_sessions">
                        <i data-lucide="calendar" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                        <span class="font-medium">My Training Sessions</span>
                    </a>
                </div>

                <!-- My Disputes with Children -->
                <div class="space-y-1">
                    <button class="nav-group-btn flex items-center justify-between w-full px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-group="disputes">
                        <div class="flex items-center gap-3">
                            <i data-lucide="flag" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                            <span class="font-medium">My Disputes</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-neutral-500 group-hover:text-brand-primary-700 transition-transform duration-200"></i>
                    </button>
                    <div class="nav-group-children ml-8 space-y-1 hidden" data-group-target="disputes">
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md text-xs" data-page="my_disputes">
                            <i data-lucide="flag" class="w-4 h-4"></i>
                            <span>View Disputes</span>
                        </a>
                        <a href="raise_dispute.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md text-xs" data-page="raise_dispute">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            <span>Raise Dispute</span>
                        </a>
                    </div>
                </div>

                <!-- My Profile -->
                <a href="my_profile.html" class="nav-link flex items-center gap-3 px-3 py-2 text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md group" data-page="my_profile">
                    <i data-lucide="user" class="w-5 h-5 text-neutral-500 group-hover:text-brand-primary-700"></i>
                    <span class="font-medium">My Profile</span>
                </a>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-4 left-0 right-0 text-center text-xs text-neutral-500 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto min-h-screen">
            
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
  <div>
    <h1 class="text-2xl leading-8 font-bold text-neutral-950 mb-2">My Skills</h1>
    <p class="text-sm leading-5 text-neutral-700">Track your skill proficiency and identify development opportunities. View detailed progress and raise disputes when needed.</p>
  </div>
  
  <!-- Summary Stats -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 min-w-fit">
    <div class="bg-white border border-neutral-200 rounded-md p-3 text-center shadow-sm">
      <div class="text-xl leading-7 font-bold text-neutral-950" id="stats-total">-</div>
      <div class="text-xs text-neutral-500">Total Skills</div>
    </div>
    <div class="bg-white border border-neutral-200 rounded-md p-3 text-center shadow-sm">
      <div class="text-xl leading-7 font-bold text-success-600" id="stats-meeting">-</div>
      <div class="text-xs text-neutral-500">Meeting Benchmark</div>
    </div>
    <div class="bg-white border border-neutral-200 rounded-md p-3 text-center shadow-sm">
      <div class="text-xl leading-7 font-bold text-warning-600" id="stats-close">-</div>
      <div class="text-xs text-neutral-500">Close to Benchmark</div>
    </div>
    <div class="bg-white border border-neutral-200 rounded-md p-3 text-center shadow-sm">
      <div class="text-xl leading-7 font-bold text-danger-600" id="stats-gap">-</div>
      <div class="text-xs text-neutral-500">Significant Gap</div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm mb-6">
  <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
    <!-- Filter Chips -->
    <div class="flex flex-wrap gap-2">
      <button id="filter-all" class="filter-chip px-3 py-2 rounded-full text-xs font-medium border border-neutral-200 bg-white text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2 active" data-filter="all">
        All Skills
      </button>
      <button id="filter-strengths" class="filter-chip px-3 py-2 rounded-full text-xs font-medium border border-neutral-200 bg-white text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" data-filter="strengths">
        Strengths
      </button>
      <button id="filter-needs" class="filter-chip px-3 py-2 rounded-full text-xs font-medium border border-neutral-200 bg-white text-neutral-700 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" data-filter="needs_improvement">
        Needs Improvement
      </button>
    </div>
    
    <!-- Search Input -->
    <div class="relative w-full sm:w-64">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i data-lucide="search" class="w-4 h-4 text-neutral-500"></i>
      </div>
      <input 
        type="text" 
        id="search-input" 
        placeholder="Search skills..." 
        class="w-full pl-10 pr-4 py-2 border border-neutral-200 rounded-sm text-sm leading-5 bg-white focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2"
      >
    </div>

    <!-- Refresh Button -->
    <button id="btn-refresh" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-neutral-500 hover:text-neutral-700 hover:bg-neutral-50 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" aria-label="Refresh Skills">
      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
      Refresh
    </button>
  </div>
</div>

<!-- Skills Table -->
<div class="bg-white border border-neutral-200 rounded-md shadow-sm">
  <!-- Loading Skeleton -->
  <div id="table-skeleton" class="hidden">
    <div class="px-4 py-3 border-b border-neutral-200">
      <div class="h-4 bg-neutral-200 rounded animate-pulse"></div>
    </div>
    <div class="divide-y divide-neutral-200">
      <div class="px-4 py-4 flex items-center gap-4" v-for="i in 5">
        <div class="h-4 bg-neutral-200 rounded animate-pulse flex-1"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-20"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-16"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-12"></div>
        <div class="h-6 bg-neutral-200 rounded animate-pulse w-16"></div>
        <div class="h-8 bg-neutral-200 rounded animate-pulse w-24"></div>
      </div>
    </div>
  </div>

  <!-- Table Content -->
  <div id="table-content" class="hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm leading-5">
        <thead class="bg-neutral-50 text-neutral-700">
          <tr>
            <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" id="sort-name" data-sort="name">
              <div class="flex items-center gap-2">
                <span>Skill Name</span>
                <i data-lucide="arrow-up-down" class="w-4 h-4 text-neutral-400"></i>
              </div>
            </th>
            <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" id="sort-category" data-sort="category">
              <div class="flex items-center gap-2">
                <span>Category</span>
                <i data-lucide="arrow-up-down" class="w-4 h-4 text-neutral-400"></i>
              </div>
            </th>
            <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" id="sort-criticality" data-sort="criticality">
              <div class="flex items-center gap-2">
                <span>Criticality</span>
                <i data-lucide="arrow-up-down" class="w-4 h-4 text-neutral-400"></i>
              </div>
            </th>
            <th class="text-center font-semibold px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" id="sort-current" data-sort="currentScore">
              <div class="flex items-center justify-center gap-2">
                <span>Current Score</span>
                <i data-lucide="arrow-up-down" class="w-4 h-4 text-neutral-400"></i>
              </div>
            </th>
            <th class="text-center font-semibold px-4 py-3 border-b border-neutral-200">Benchmark</th>
            <th class="text-center font-semibold px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" id="sort-gap" data-sort="gap">
              <div class="flex items-center justify-center gap-2">
                <span>Gap</span>
                <i data-lucide="arrow-up-down" class="w-4 h-4 text-neutral-400"></i>
              </div>
            </th>
            <th class="text-center font-semibold px-4 py-3 border-b border-neutral-200">Status</th>
            <th class="text-center font-semibold px-4 py-3 border-b border-neutral-200">Actions</th>
          </tr>
        </thead>
        <tbody id="skills-table-body" class="divide-y divide-neutral-200">
          <!-- Table rows will be populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- No Data State -->
    <div id="no-data" class="hidden px-4 py-8 text-center">
      <div class="flex flex-col items-center gap-3">
        <div class="w-12 h-12 bg-neutral-100 rounded-full flex items-center justify-center">
          <i data-lucide="book-open" class="w-6 h-6 text-neutral-400"></i>
        </div>
        <div>
          <h3 class="text-base leading-6 font-semibold text-neutral-900 mb-1">No skills found</h3>
          <p class="text-sm text-neutral-500" id="no-data-message">No skills match your current filters. Try adjusting your search or filter criteria.</p>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between px-4 py-3 border-t border-neutral-200 bg-neutral-50">
      <div class="flex items-center gap-2 text-sm text-neutral-700">
        <span>Showing</span>
        <span id="pagination-start">1</span>
        <span>-</span>
        <span id="pagination-end">10</span>
        <span>of</span>
        <span id="pagination-total">0</span>
        <span>skills</span>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="prev-page" class="inline-flex items-center px-3 py-2 text-sm font-medium text-neutral-500 bg-white border border-neutral-200 rounded-md hover:bg-neutral-50 hover:text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>
          Previous
        </button>
        <button id="next-page" class="inline-flex items-center px-3 py-2 text-sm font-medium text-neutral-500 bg-white border border-neutral-200 rounded-md hover:bg-neutral-50 hover:text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Next
          <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
        </button>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');

        function toggleMobileMenu() {
            sidebar.classList.toggle('-translate-x-full');
            mobileOverlay.classList.toggle('hidden');
        }

        mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
        mobileOverlay?.addEventListener('click', toggleMobileMenu);

        // Navigation group toggle functionality
        document.querySelectorAll('.nav-group-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const groupName = btn.getAttribute('data-group');
                const children = document.querySelector(`[data-group-target="${groupName}"]`);
                const chevron = btn.querySelector('[data-lucide="chevron-down"]');
                
                children?.classList.toggle('hidden');
                chevron?.classList.toggle('rotate-180');
            });
        });

        // User profile dropdown
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');

        userProfileBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown?.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!userProfileBtn?.contains(e.target)) {
                userDropdown?.classList.add('hidden');
            }
        });

        // Active navigation highlighting
        function updateActiveNav() {
            const currentPage = window.location.pathname.split('/').pop()?.replace('.html', '') || 'employee_dashboard';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                const page = link.getAttribute('data-page');
                if (page === currentPage) {
                    link.classList.add('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-4', 'border-accent-gold-500');
                    link.classList.remove('text-neutral-700', 'text-neutral-600');
                } else {
                    link.classList.remove('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-4', 'border-accent-gold-500');
                }
            });
        }

        // Auth state management
        let currentUser = null;

        function updateUserProfile(user, userData = null) {
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const dropdownUserName = document.getElementById('dropdown-user-name');
            const dropdownUserEmail = document.getElementById('dropdown-user-email');

            if (userData) {
                const displayName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'User';
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                userAvatar.textContent = initials;
                userName.textContent = displayName;
                dropdownUserName.textContent = displayName;
                dropdownUserEmail.textContent = userData.email || user.email;
            } else {
                // Fallback to auth data
                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                userAvatar.textContent = initials;
                userName.textContent = displayName;
                dropdownUserName.textContent = displayName;
                dropdownUserEmail.textContent = user.email;
            }
        }

        async function loadUserData(user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    return userDoc.data();
                } else {
                    // Fallback data
                    return {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: user.email
                    };
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Sign out functionality
        document.getElementById('sign-out-btn')?.addEventListener('click', async () => {
            try {
                showLoader();
                await signOut(auth);
                showToast('Signed out successfully', 'success');
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Error signing out', 'error');
            } finally {
                hideLoader();
            }
        });

        // Initialize auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userData = await loadUserData(user);
                updateUserProfile(user, userData);
                updateActiveNav();
            } else {
                window.location.href = 'auth.html';
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateActiveNav();
        });
    </script>

    
<script id="my-skills-script" type="module" data-tiramai="web-gen">
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { 
    collection, getDocs, query, where, orderBy, limit, startAfter, 
    getCountFromServer, doc, getDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { auth, getDb } from './scripts/firebase.js';
  import { showToast, showLoader, hideLoader, env } from './scripts/main.js';

  const db = getDb();
  let currentUser = null;
  let allSkills = [];
  let filteredSkills = [];
  let currentPage = 1;
  let skillsPerPage = 10;
  let currentFilter = 'all';
  let currentSort = { field: 'name', direction: 'asc' };
  let searchQuery = '';
  let activeCycle = null;

  // Pagination state
  let paginationState = {
    total: 0,
    currentItems: [],
    hasMore: false
  };

  // Create semaphore for concurrency control
  function createSemaphore(max = 2) {
    const queue = [];
    let active = 0;
    const next = () => {
      if (active >= max || queue.length === 0) return;
      active++;
      const { fn, res, rej } = queue.shift();
      Promise.resolve()
        .then(fn)
        .then(v => res(v))
        .catch(e => rej(e))
        .finally(() => { active--; next(); });
    };
    return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
  }
  const withLimit = createSemaphore(2);

  // Micro-yield utility
  const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

  // Web Worker for data processing
  const worker = new Worker(new URL('./workers/data-shaper.js', import.meta.url), { type: 'module' });
  const shapeData = (raw) => new Promise((resolve) => {
    const id = crypto.randomUUID();
    const handler = (e) => { 
      if (e.data?.id === id) { 
        worker.removeEventListener('message', handler); 
        resolve(e.data.out); 
      } 
    };
    worker.addEventListener('message', handler);
    worker.postMessage({ id, raw }, { transfer: [] });
  });

  // AbortController for search/filter operations
  let currentAbort;
  
  async function funInitializeApp() {
    try {
      showSkeleton(true);
      await funLoadInitialData();
      setupEventListeners();
      await yieldToFrame();
      lucide.createIcons();
    } catch (error) {
      console.error('Error initializing app:', error);
      showToast('Failed to load skills data', 'error');
    }
  }

  async function funLoadInitialData(force = false) {
    if (currentAbort) currentAbort.abort();
    currentAbort = new AbortController();
    const signal = currentAbort.signal;

    try {
      // Load active cycle first
      await withLimit(() => funLoadActiveCycle(signal));
      
      if (signal.aborted) return;
      
      // Load skills data
      await withLimit(() => funLoadSkillsData(signal, force));
      
      if (signal.aborted) return;
      
      // Process and render data
      await funProcessAndRenderData();
      
    } catch (error) {
      if (signal.aborted) return;
      console.error('Error loading initial data:', error);
      showToast(error?.message || 'Failed to load data', 'error');
    } finally {
      showSkeleton(false);
    }
  }

  async function funLoadActiveCycle(signal) {
    try {
      const q = query(
        collection(db, 'assessmentCycles'),
        where('isActiveCycle', '==', true),
        limit(1)
      );
      
      const snapshot = await getDocs(q);
      if (signal.aborted) return;
      
      if (!snapshot.empty) {
        activeCycle = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
      }
    } catch (error) {
      console.error('Error loading active cycle:', error);
      // Continue without active cycle - some features will be disabled
    }
  }

  async function funLoadSkillsData(signal, force = false) {
    if (!currentUser) return;

    try {
      // Get skill mappings for current user
      const skillMappingsQuery = query(
        collection(db, 'skillMappings'),
        where('employeeId', '==', currentUser.uid),
        where('status', '==', 'active')
      );
      
      const mappingsSnapshot = await getDocs(skillMappingsQuery);
      if (signal.aborted) return;
      
      const mappings = mappingsSnapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data() 
      }));

      if (mappings.length === 0) {
        allSkills = [];
        return;
      }

      const skillIds = mappings.map(m => m.skillId);
      
      // Load all related data in parallel with limits
      const [skills, categories, criticalities, assessments, disputes] = await Promise.all([
        withLimit(() => funLoadSkills(skillIds, signal)),
        withLimit(() => funLoadCategories(signal)),
        withLimit(() => funLoadCriticalities(signal)),
        withLimit(() => funLoadAssessments(skillIds, signal)),
        withLimit(() => funLoadDisputes(signal))
      ]);

      if (signal.aborted) return;

      // Process data using Web Worker
      const processedData = await shapeData({
        mappings,
        skills,
        categories,
        criticalities,
        assessments,
        disputes,
        activeCycle,
        currentUserId: currentUser.uid
      });

      allSkills = processedData || [];

    } catch (error) {
      if (signal.aborted) return;
      throw error;
    }
  }

  async function funLoadSkills(skillIds, signal) {
    if (skillIds.length === 0) return [];
    
    // Batch skill IDs into groups of 10 (Firestore 'in' query limit)
    const batches = [];
    for (let i = 0; i < skillIds.length; i += 10) {
      batches.push(skillIds.slice(i, i + 10));
    }

    const allResults = [];
    for (const batch of batches) {
      if (signal.aborted) return [];
      
      const q = query(
        collection(db, 'skills'),
        where('id', 'in', batch),
        where('status', '==', 'active')
      );
      
      const snapshot = await getDocs(q);
      allResults.push(...snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      
      await yieldToFrame(); // Prevent blocking
    }
    
    return allResults;
  }

  async function funLoadCategories(signal) {
    const q = query(
      collection(db, 'skillCategories'),
      where('status', '==', 'active')
    );
    
    const snapshot = await getDocs(q);
    if (signal.aborted) return [];
    
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function funLoadCriticalities(signal) {
    const q = query(
      collection(db, 'skillCriticalities'),
      where('status', '==', 'active')
    );
    
    const snapshot = await getDocs(q);
    if (signal.aborted) return [];
    
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function funLoadAssessments(skillIds, signal) {
    if (skillIds.length === 0 || !currentUser) return [];
    
    // Get all assessments for user and skills
    const q = query(
      collection(db, 'assessments'),
      where('employeeId', '==', currentUser.uid),
      where('status', '==', 'active'),
      orderBy('assessmentTimestamp', 'desc')
    );
    
    const snapshot = await getDocs(q);
    if (signal.aborted) return [];
    
    const assessments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Filter for relevant skills only
    return assessments.filter(a => skillIds.includes(a.skillId));
  }

  async function funLoadDisputes(signal) {
    if (!currentUser || !activeCycle) return [];
    
    const q = query(
      collection(db, 'disputes'),
      where('employeeId', '==', currentUser.uid),
      where('assessmentCycleId', '==', activeCycle.id),
      where('status', '==', 'open')
    );
    
    const snapshot = await getDocs(q);
    if (signal.aborted) return [];
    
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function funProcessAndRenderData() {
    // Apply search and filter
    filteredSkills = funApplyFilters(allSkills);
    
    // Apply sorting
    filteredSkills = funApplySort(filteredSkills);
    
    // Update summary stats
    funUpdateSummaryStats();
    
    // Render current page
    funRenderCurrentPage();
    
    // Update pagination
    funUpdatePagination();

    await yieldToFrame();
  }

  function funApplyFilters(skills) {
    let filtered = [...skills];

    // Apply search filter
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase().trim();
      filtered = filtered.filter(skill => {
        return skill.name?.toLowerCase().includes(query) ||
               skill.categoryName?.toLowerCase().includes(query) ||
               skill.criticalityName?.toLowerCase().includes(query);
      });
    }

    // Apply status filter
    if (currentFilter === 'strengths') {
      filtered = filtered.filter(skill => {
        return skill.gap !== null && skill.gap !== undefined && skill.gap <= 0;
      });
    } else if (currentFilter === 'needs_improvement') {
      filtered = filtered.filter(skill => {
        return skill.gap !== null && skill.gap !== undefined && skill.gap > 0;
      });
    }

    return filtered;
  }

  function funApplySort(skills) {
    const sorted = [...skills];
    const { field, direction } = currentSort;
    
    sorted.sort((a, b) => {
      let aVal = a[field];
      let bVal = b[field];

      // Handle null/undefined values
      if (aVal === null || aVal === undefined) aVal = field === 'name' ? '' : -1;
      if (bVal === null || bVal === undefined) bVal = field === 'name' ? '' : -1;

      // Handle string comparisons
      if (typeof aVal === 'string' && typeof bVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }

      let comparison = 0;
      if (aVal < bVal) comparison = -1;
      else if (aVal > bVal) comparison = 1;

      return direction === 'desc' ? -comparison : comparison;
    });

    return sorted;
  }

  function funUpdateSummaryStats() {
    const total = allSkills.length;
    const meetingBenchmark = allSkills.filter(s => s.gap !== null && s.gap <= 0).length;
    const closeToBenchmark = allSkills.filter(s => s.gap !== null && s.gap >= 1 && s.gap <= 2).length;
    const significantGap = allSkills.filter(s => s.gap !== null && s.gap > 2).length;

    document.getElementById('stats-total').textContent = total.toString();
    document.getElementById('stats-meeting').textContent = meetingBenchmark.toString();
    document.getElementById('stats-close').textContent = closeToBenchmark.toString();
    document.getElementById('stats-gap').textContent = significantGap.toString();
  }

  function funRenderCurrentPage() {
    const tbody = document.getElementById('skills-table-body');
    const noData = document.getElementById('no-data');
    const tableContent = document.getElementById('table-content');

    if (filteredSkills.length === 0) {
      tableContent.classList.add('hidden');
      noData.classList.remove('hidden');
      
      const message = searchQuery.trim() || currentFilter !== 'all' 
        ? 'No skills match your current filters. Try adjusting your search or filter criteria.'
        : 'You have no skills mapped yet. Contact your team lead to get skills assigned.';
      
      document.getElementById('no-data-message').textContent = message;
      return;
    }

    noData.classList.add('hidden');
    tableContent.classList.remove('hidden');

    // Calculate pagination
    const startIndex = (currentPage - 1) * skillsPerPage;
    const endIndex = Math.min(startIndex + skillsPerPage, filteredSkills.length);
    const pageSkills = filteredSkills.slice(startIndex, endIndex);

    // Render table rows
    tbody.innerHTML = '';
    pageSkills.forEach(skill => {
      const row = funCreateSkillRow(skill);
      tbody.appendChild(row);
    });

    // Re-initialize icons
    lucide.createIcons();
  }

  function funCreateSkillRow(skill) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-neutral-50 focus-within:bg-neutral-50';
    
    row.innerHTML = `
      <td class="px-4 py-3">
        <button class="text-left text-brand-primary-600 hover:text-brand-primary-700 font-medium focus:outline-none focus:underline" data-skill-id="${skill.id}" data-action="view-details">
          ${funEscapeHtml(skill.name || 'N/A')}
        </button>
      </td>
      <td class="px-4 py-3">
        <span class="text-neutral-900">${funEscapeHtml(skill.categoryName || 'N/A')}</span>
      </td>
      <td class="px-4 py-3">
        <span class="text-neutral-900">${funEscapeHtml(skill.criticalityName || 'N/A')}</span>
      </td>
      <td class="px-4 py-3 text-center">
        ${skill.currentScore !== null && skill.currentScore !== undefined 
          ? `<span class="font-medium text-neutral-900">${skill.currentScore}</span>`
          : `<span class="text-neutral-500">Not Assessed</span>`
        }
      </td>
      <td class="px-4 py-3 text-center">
        ${skill.benchmark !== null && skill.benchmark !== undefined 
          ? `<span class="text-neutral-900">${skill.benchmark}</span>`
          : `<span class="text-neutral-500">N/A</span>`
        }
      </td>
      <td class="px-4 py-3 text-center">
        ${funRenderGap(skill.gap)}
      </td>
      <td class="px-4 py-3 text-center">
        ${funRenderStatusBadge(skill.statusBadge)}
      </td>
      <td class="px-4 py-3">
        <div class="flex items-center gap-2 justify-center">
          <button class="inline-flex items-center px-2 py-1 text-xs font-medium text-brand-primary-600 bg-brand-primary-50 border border-brand-primary-200 rounded hover:bg-brand-primary-100 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-1" data-skill-id="${skill.id}" data-action="view-details">
            <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
            View Details
          </button>
          ${skill.isDisputeEligible 
            ? `<button class="inline-flex items-center px-2 py-1 text-xs font-medium text-warning-600 bg-warning-50 border border-warning-200 rounded hover:bg-warning-100 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-1" data-skill-id="${skill.id}" data-action="raise-dispute">
                 <i data-lucide="flag" class="w-3 h-3 mr-1"></i>
                 Raise Dispute
               </button>`
            : `<button class="inline-flex items-center px-2 py-1 text-xs font-medium text-neutral-400 bg-neutral-100 border border-neutral-200 rounded cursor-not-allowed" disabled title="Not eligible for dispute">
                 <i data-lucide="flag" class="w-3 h-3 mr-1"></i>
                 Dispute
               </button>`
          }
        </div>
      </td>
    `;

    return row;
  }

  function funRenderGap(gap) {
    if (gap === null || gap === undefined) {
      return '<span class="text-neutral-500">N/A</span>';
    }
    
    if (gap === 0) {
      return '<span class="text-success-600 font-medium">0</span>';
    } else if (gap > 0) {
      return `<span class="text-danger-600 font-medium">+${gap}</span>`;
    } else {
      return `<span class="text-success-600 font-medium">${gap}</span>`;
    }
  }

  function funRenderStatusBadge(status) {
    const statusConfig = {
      'Green': { bg: 'bg-success-600', text: 'text-white', dot: 'bg-success-500', label: 'Meeting Benchmark' },
      'Amber': { bg: 'bg-warning-600', text: 'text-white', dot: 'bg-warning-500', label: 'Close to Benchmark' },
      'Red': { bg: 'bg-danger-600', text: 'text-white', dot: 'bg-danger-500', label: 'Significant Gap' },
      'Not Assessed': { bg: 'bg-neutral-100', text: 'text-neutral-700', dot: 'bg-neutral-400', label: 'Not Assessed' }
    };

    const config = statusConfig[status] || statusConfig['Not Assessed'];
    
    return `
      <span class="inline-flex items-center px-2 py-1 text-xs rounded-full ${config.bg} ${config.text}">
        <span class="h-2 w-2 rounded-full ${config.dot} mr-1"></span>
        ${config.label}
      </span>
    `;
  }

  function funUpdatePagination() {
    const totalItems = filteredSkills.length;
    const totalPages = Math.ceil(totalItems / skillsPerPage);
    const startItem = totalItems === 0 ? 0 : (currentPage - 1) * skillsPerPage + 1;
    const endItem = Math.min(currentPage * skillsPerPage, totalItems);

    document.getElementById('pagination-start').textContent = startItem.toString();
    document.getElementById('pagination-end').textContent = endItem.toString();
    document.getElementById('pagination-total').textContent = totalItems.toString();

    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;

    if (totalItems === 0) {
      document.getElementById('pagination').classList.add('hidden');
    } else {
      document.getElementById('pagination').classList.remove('hidden');
    }
  }

  function funEscapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showSkeleton(show) {
    const skeleton = document.getElementById('table-skeleton');
    const content = document.getElementById('table-content');
    
    if (show) {
      skeleton.classList.remove('hidden');
      content.classList.add('hidden');
    } else {
      skeleton.classList.add('hidden');
      content.classList.remove('hidden');
    }
  }

  function setupEventListeners() {
    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', (e) => {
        const filter = e.target.dataset.filter;
        funSetActiveFilter(filter);
      });
    });

    // Search input with debounce
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = e.target.value;
        currentPage = 1;
        funProcessAndRenderData();
      }, 300);
    });

    // Refresh button
    document.getElementById('btn-refresh').addEventListener('click', () => {
      funLoadInitialData(true);
    });

    // Sort headers
    document.querySelectorAll('[data-sort]').forEach(header => {
      header.addEventListener('click', (e) => {
        const field = e.currentTarget.dataset.sort;
        funToggleSort(field);
      });
    });

    // Pagination
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        funRenderCurrentPage();
        funUpdatePagination();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredSkills.length / skillsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        funRenderCurrentPage();
        funUpdatePagination();
      }
    });

    // Table actions (using event delegation)
    document.getElementById('skills-table-body').addEventListener('click', (e) => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;

      const action = button.dataset.action;
      const skillId = button.dataset.skillId;

      if (action === 'view-details') {
        window.location.href = `/skill_growth_detail.html?skillId=${encodeURIComponent(skillId)}`;
      } else if (action === 'raise-dispute') {
        window.location.href = `/raise_dispute.html?preselected_skill_ids=${encodeURIComponent(JSON.stringify([skillId]))}`;
      }
    });
  }

  function funSetActiveFilter(filter) {
    currentFilter = filter;
    currentPage = 1;

    // Update UI
    document.querySelectorAll('.filter-chip').forEach(chip => {
      if (chip.dataset.filter === filter) {
        chip.classList.add('active', 'bg-accent-gold-50', 'text-brand-primary-700', 'border-accent-gold-500');
        chip.classList.remove('bg-white', 'text-neutral-700');
      } else {
        chip.classList.remove('active', 'bg-accent-gold-50', 'text-brand-primary-700', 'border-accent-gold-500');
        chip.classList.add('bg-white', 'text-neutral-700');
      }
    });

    funProcessAndRenderData();
  }

  function funToggleSort(field) {
    if (currentSort.field === field) {
      currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.field = field;
      currentSort.direction = 'asc';
    }

    // Update sort icons
    document.querySelectorAll('[data-sort]').forEach(header => {
      const icon = header.querySelector('i[data-lucide]');
      if (header.dataset.sort === field) {
        icon.setAttribute('data-lucide', currentSort.direction === 'asc' ? 'arrow-up' : 'arrow-down');
      } else {
        icon.setAttribute('data-lucide', 'arrow-up-down');
      }
    });

    lucide.createIcons();
    funProcessAndRenderData();
  }

  // Initialize app when auth state changes
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      const currentPath = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = `auth.html?redirect=${currentPath}`;
    } else {
      currentUser = user;
      funInitializeApp();
    }
  });

</script>

</body>
</html>