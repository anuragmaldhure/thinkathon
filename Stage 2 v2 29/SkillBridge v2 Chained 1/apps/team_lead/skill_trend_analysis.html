<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Config -->
    <script data-tiramai="web-gen">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                'primary-600': '#1B2A44',
                'primary-700': '#14233A',
                'primary-800': '#0E1A2B',
              },
              accent: {
                'gold-50': '#FFF7E6',
                'gold-500': '#C59D42',
                'gold-600': '#A97D22',
              },
              success: { '600': '#16A34A' },
              warning: { '600': '#D97706' },
              danger: { '600': '#DC2626' },
              info: { '600': '#2563EB' },
              heat: {
                green: '#16A34A',
                amber: '#F59E0B',
                red: '#DC2626'
              },
              neutral: {
                '50': '#F8FAFC',
                '200': '#E2E8F0',
                '500': '#64748B',
                '700': '#334155',
                '900': '#111827',
                '950': '#0B1220',
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-900">
    <!-- Top-Nav -->
    <header class="fixed top-0 left-0 right-0 bg-brand-primary-800 border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-toggle" class="md:hidden text-white hover:text-accent-gold-500 transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex-shrink-0">
                    <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="84" y="116" width="56" height="168" rx="8" fill="#1E40AF"/>
                        <rect x="176" y="84" width="56" height="200" rx="8" fill="#059669"/>
                        <rect x="268" y="156" width="48" height="128" rx="8" fill="#1E40AF"/>
                        <rect x="114" y="180" width="172" height="20" rx="10" fill="#F59E0B"/>
                    </svg>
                </div>
                <span class="text-xl font-semibold text-white">SkillBridge</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-2 text-white hover:text-accent-gold-500 transition-colors">
                    <div id="user-avatar" class="w-8 h-8 bg-accent-gold-500 rounded-full flex items-center justify-center text-neutral-900 text-sm font-medium">
                        U
                    </div>
                    <span id="user-name" class="hidden sm:block text-sm">Loading...</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                
                <!-- User Profile Dropdown -->
                <div id="user-profile-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 hidden z-40">
                    <div class="px-4 py-3 border-b border-neutral-200">
                        <p id="dropdown-user-name" class="text-sm font-medium text-neutral-900">Loading...</p>
                        <p id="dropdown-user-email" class="text-xs text-neutral-500">loading@example.com</p>
                    </div>
                    <button id="sign-out-btn" class="w-full px-4 py-2 text-left text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Sign out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side-Nav -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-screen sticky top-16 overflow-y-auto transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out z-20">
            <nav class="p-4 space-y-2">
                <!-- Team Dashboard -->
                <a href="team_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="team_dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Team Dashboard</span>
                </a>

                <!-- My Team with collapsible children -->
                <div class="nav-group">
                    <button class="nav-group-toggle w-full flex items-center justify-between px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>My Team</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 transform transition-transform nav-group-chevron"></i>
                    </button>
                    <div class="nav-group-content ml-8 mt-1 space-y-1 hidden">
                        <a href="my_team.html" class="nav-link block px-3 py-2 text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="my_team">
                            Team Overview
                        </a>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span>Employee Profile</span>
                            </div>
                        </div>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="clipboard" class="w-4 h-4"></i>
                                <span>Skill Mappings</span>
                            </div>
                        </div>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="circle-plus" class="w-4 h-4"></i>
                                <span>Add Skills</span>
                            </div>
                        </div>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="check-square" class="w-4 h-4"></i>
                                <span>Assess Skills</span>
                            </div>
                        </div>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                <span>Assessment History</span>
                            </div>
                        </div>
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                <span>Growth Tracking</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Skill Gap Analysis with children -->
                <div class="nav-group">
                    <button class="nav-group-toggle w-full flex items-center justify-between px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="grid" class="w-5 h-5"></i>
                            <span>Skill Gap Analysis</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 transform transition-transform nav-group-chevron"></i>
                    </button>
                    <div class="nav-group-content ml-8 mt-1 space-y-1 hidden">
                        <div class="px-3 py-2 text-xs text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                            <div class="flex items-center gap-2">
                                <i data-lucide="grid" class="w-4 h-4"></i>
                                <span>Team Gaps Overview</span>
                            </div>
                        </div>
                        <a href="skill_trend_analysis.html" class="nav-link block px-3 py-2 text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="skill_trend_analysis">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                <span>Skill Trends</span>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Training Impact Analysis -->
                <div class="px-3 py-2 text-sm text-neutral-500 cursor-not-allowed hover:text-neutral-400" title="Coming Soon">
                    <div class="flex items-center gap-3">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>Training Impact</span>
                    </div>
                </div>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-20 w-full text-center text-sm text-neutral-500 bg-white rounded px-4 py-2">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto">
            
<!-- Skill Trend Analysis Page -->
<div class="max-w-7xl mx-auto space-y-6">
  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl leading-8 font-bold text-neutral-950">Skill Trend Analysis</h1>
      <p class="text-sm leading-5 text-neutral-700 mt-1">Deep-dive into skill performance across your team with distribution, trends, and rankings</p>
    </div>
    <button id="btn-refresh" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-neutral-500 hover:text-neutral-700 border border-neutral-200 rounded-md hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" aria-label="Refresh Data">
      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
      Refresh
    </button>
  </div>

  <!-- Skill Selector -->
  <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
    <label for="skill-selector" class="block text-sm font-medium text-neutral-900 mb-2">Select Skill</label>
    <div class="flex items-center gap-4">
      <select id="skill-selector" class="flex-1 border border-neutral-200 rounded-sm px-3 py-2 bg-white text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
        <option value="">Choose a skill to analyze...</option>
      </select>
      <div id="selector-loading" class="hidden">
        <div class="animate-pulse h-5 w-5 bg-neutral-200 rounded"></div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="bg-white border border-neutral-200 rounded-md p-8 shadow-sm text-center">
    <div class="w-16 h-16 mx-auto bg-neutral-100 rounded-full flex items-center justify-center mb-4">
      <i data-lucide="trending-up" class="w-8 h-8 text-neutral-400"></i>
    </div>
    <h3 class="text-base leading-6 font-semibold text-neutral-900 mb-2">Select a Skill to Analyze</h3>
    <p class="text-sm leading-5 text-neutral-700">Choose a skill from the dropdown above to view detailed performance analysis, trends, and team rankings.</p>
  </div>

  <!-- No Data State -->
  <div id="no-data-state" class="hidden bg-white border border-neutral-200 rounded-md p-8 shadow-sm text-center">
    <div class="w-16 h-16 mx-auto bg-warning-600 rounded-full flex items-center justify-center mb-4">
      <i data-lucide="alert-circle" class="w-8 h-8 text-white"></i>
    </div>
    <h3 class="text-base leading-6 font-semibold text-neutral-900 mb-2">No Assessment Data Available</h3>
    <p class="text-sm leading-5 text-neutral-700">No assessments found for this skill. Assessments are needed to generate trend analysis.</p>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden space-y-6">
    <!-- Skill Info Card -->
    <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
      <div id="skill-info-skeleton" class="space-y-3">
        <div class="animate-pulse h-6 w-48 bg-neutral-200 rounded"></div>
        <div class="animate-pulse h-4 w-32 bg-neutral-200 rounded"></div>
        <div class="animate-pulse h-4 w-40 bg-neutral-200 rounded"></div>
      </div>
      <div id="skill-info-content" class="hidden">
        <h3 id="skill-name" class="text-base leading-6 font-semibold text-neutral-950 mb-3"></h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
          <div>
            <span class="text-neutral-500">Category:</span>
            <span id="skill-category" class="ml-2 font-medium text-neutral-900"></span>
          </div>
          <div>
            <span class="text-neutral-500">Criticality:</span>
            <span id="skill-criticality" class="ml-2 font-medium text-neutral-900"></span>
          </div>
          <div>
            <span class="text-neutral-500">Current Benchmark:</span>
            <span id="skill-benchmark" class="ml-2 font-medium text-accent-gold-600"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Cycle Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <div id="avg-score-skeleton" class="space-y-2">
          <div class="animate-pulse h-4 w-24 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-8 w-16 bg-neutral-200 rounded"></div>
        </div>
        <div id="avg-score-content" class="hidden">
          <p class="text-xs text-neutral-500 mb-1">Team Average Score</p>
          <p id="team-avg-score" class="text-2xl font-bold text-neutral-950">-</p>
        </div>
      </div>
      
      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <div id="benchmark-gap-skeleton" class="space-y-2">
          <div class="animate-pulse h-4 w-24 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-8 w-16 bg-neutral-200 rounded"></div>
        </div>
        <div id="benchmark-gap-content" class="hidden">
          <p class="text-xs text-neutral-500 mb-1">Benchmark Gap</p>
          <p id="benchmark-gap" class="text-2xl font-bold"></p>
        </div>
      </div>

      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <div id="below-benchmark-skeleton" class="space-y-2">
          <div class="animate-pulse h-4 w-24 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-8 w-16 bg-neutral-200 rounded"></div>
        </div>
        <div id="below-benchmark-content" class="hidden">
          <p class="text-xs text-neutral-500 mb-1">% Below Benchmark</p>
          <p id="below-benchmark-pct" class="text-2xl font-bold text-neutral-950">-</p>
        </div>
      </div>

      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <div id="tni-rate-skeleton" class="space-y-2">
          <div class="animate-pulse h-4 w-20 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-8 w-16 bg-neutral-200 rounded"></div>
        </div>
        <div id="tni-rate-content" class="hidden">
          <p class="text-xs text-neutral-500 mb-1">TNI Rate</p>
          <p id="tni-rate" class="text-2xl font-bold text-neutral-950">-</p>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Score Distribution -->
      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <h3 class="text-base leading-6 font-semibold text-neutral-950 mb-4">Score Distribution</h3>
        <div id="score-distribution-skeleton" class="space-y-3">
          <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-3/4 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-1/2 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-2/3 bg-neutral-200 rounded"></div>
        </div>
        <div id="score-distribution-chart" class="hidden h-64"></div>
      </div>

      <!-- Trend Over Time -->
      <div class="bg-white border border-neutral-200 rounded-md p-4 shadow-sm">
        <h3 class="text-base leading-6 font-semibold text-neutral-950 mb-4">Trend Over Time</h3>
        <div id="trend-chart-skeleton" class="space-y-3">
          <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-3/4 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-1/2 bg-neutral-200 rounded"></div>
          <div class="animate-pulse h-4 w-2/3 bg-neutral-200 rounded"></div>
        </div>
        <div id="trend-chart" class="hidden h-64"></div>
      </div>
    </div>

    <!-- Rankings Table -->
    <div class="bg-white border border-neutral-200 rounded-md shadow-sm">
      <div class="p-4 border-b border-neutral-200">
        <h3 class="text-base leading-6 font-semibold text-neutral-950">Team Rankings</h3>
      </div>
      <div id="rankings-skeleton" class="p-4 space-y-3">
        <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
        <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
        <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
        <div class="animate-pulse h-4 w-full bg-neutral-200 rounded"></div>
      </div>
      <div id="rankings-table-container" class="hidden">
        <div class="overflow-x-auto">
          <table id="rankings-table" class="w-full text-sm leading-5">
            <thead class="bg-neutral-50 text-neutral-700">
              <tr>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Rank</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Employee</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Current Score</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Benchmark</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Gap</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Trend</th>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Actions</th>
              </tr>
            </thead>
            <tbody id="rankings-tbody" class="divide-y divide-neutral-200">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc, collection, query, where, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Get current page name from URL
        function getCurrentPage() {
            const path = window.location.pathname;
            const filename = path.split('/').pop();
            return filename.replace('.html', '') || 'team_dashboard';
        }

        // Set active navigation state
        function setActiveNavigation() {
            const currentPage = getCurrentPage();
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const pageName = link.getAttribute('data-page');
                if (pageName === currentPage) {
                    link.classList.add('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-2', 'border-accent-gold-500');
                    link.classList.remove('text-neutral-700');
                } else {
                    link.classList.remove('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-2', 'border-accent-gold-500');
                    link.classList.add('text-neutral-700');
                }
            });
        }

        // Initialize user profile and auth
        async function initializeUser() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = '/auth.html';
                    return;
                }

                try {
                    // Try to get user data from Firestore by querying uid field
                    const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid), limit(1));
                    const userSnapshot = await getDocs(userQuery);
                    let userData = null;
                    
                    if (!userSnapshot.empty) {
                        userData = { id: userSnapshot.docs[0].id, ...userSnapshot.docs[0].data() };
                    }

                    // Set user display data (with fallbacks)
                    const firstName = userData?.firstName || user.displayName?.split(' ')[0] || 'User';
                    const lastName = userData?.lastName || user.displayName?.split(' ')[1] || '';
                    const email = userData?.email || user.email || 'johndoe@example.com';
                    const fullName = `${firstName} ${lastName}`.trim();

                    // Update UI elements
                    const userAvatar = document.getElementById('user-avatar');
                    const userName = document.getElementById('user-name');
                    const dropdownUserName = document.getElementById('dropdown-user-name');
                    const dropdownUserEmail = document.getElementById('dropdown-user-email');

                    if (userAvatar) userAvatar.textContent = firstName.charAt(0).toUpperCase();
                    if (userName) userName.textContent = fullName || email.split('@')[0];
                    if (dropdownUserName) dropdownUserName.textContent = fullName || email.split('@')[0];
                    if (dropdownUserEmail) dropdownUserEmail.textContent = email;

                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to auth data
                    const fallbackName = user.displayName || user.email.split('@')[0];
                    document.getElementById('user-name').textContent = fallbackName;
                    document.getElementById('dropdown-user-name').textContent = fallbackName;
                    document.getElementById('dropdown-user-email').textContent = user.email;
                }
            });
        }

        // Toggle user profile dropdown
        function initializeUserProfileDropdown() {
            const profileBtn = document.getElementById('user-profile-btn');
            const dropdown = document.getElementById('user-profile-dropdown');
            const signOutBtn = document.getElementById('sign-out-btn');

            profileBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !profileBtn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Handle sign out
            signOutBtn?.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = '/auth.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    showToast('Error signing out', 'error');
                }
            });
        }

        // Initialize mobile navigation
        function initializeMobileNav() {
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            mobileToggle?.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            });

            overlay?.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });

            // Close mobile nav on nav link click
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });
            });
        }

        // Initialize collapsible navigation groups
        function initializeNavGroups() {
            const navGroupToggles = document.querySelectorAll('.nav-group-toggle');
            
            navGroupToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const content = toggle.nextElementSibling;
                    const chevron = toggle.querySelector('.nav-group-chevron');
                    
                    content.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-90');
                });
            });
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            initializeUserProfileDropdown();
            initializeMobileNav();
            initializeNavGroups();
            setActiveNavigation();
        });
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { 
  collection, getDocs, query, where, orderBy, limit, getDoc, doc, 
  getCountFromServer
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader } from "./scripts/main.js";

const db = getDb();

// Global state
let currentUser = null;
let currentSkillId = null;
let currentAbort = null;
let allSkills = [];
let skillCategories = [];
let skillCriticalities = [];
let assessmentCycles = [];

// Utility functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}
const withLimit = createSemaphore(2);

// Authentication
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "/auth.html?redirect=" + encodeURIComponent(location.pathname);
  } else {
    currentUser = user;
    funInitialLoad();
  }
});

// Main initialization function
async function funInitialLoad() {
  try {
    showSkeletonState();
    await funLoadSkillsAndMetadata();
    funPopulateSkillSelector();
    
    // Check for skillId parameter
    const urlParams = new URLSearchParams(window.location.search);
    const skillId = urlParams.get('skillId');
    if (skillId && allSkills.some(s => s.id === skillId)) {
      document.getElementById('skill-selector').value = skillId;
      await funLoadSkillAnalysis(skillId);
    } else {
      showEmptyState();
    }
  } catch (error) {
    console.error('Initial load error:', error);
    showToast(error?.message || 'Failed to load page data');
    showEmptyState();
  }
}

// Load skills and metadata
async function funLoadSkillsAndMetadata() {
  try {
    // Get current user's team members first by querying uid field
    const userQuery = query(collection(db, 'users'), where('uid', '==', currentUser.uid), limit(1));
    const userSnapshot = await withLimit(() => getDocs(userQuery));
    if (userSnapshot.empty) throw new Error('User not found');
    
    const userData = { id: userSnapshot.docs[0].id, ...userSnapshot.docs[0].data() };
    
    // Get team members
    const teamQuery = query(
      collection(db, 'users'),
      where('teamLeadId', '==', userData.id),
      where('employeeStatus', '==', 'active')
    );
    const teamSnapshot = await withLimit(() => getDocs(teamQuery));
    const teamMemberIds = teamSnapshot.docs.map(d => d.data().id);
    
    if (teamMemberIds.length === 0) {
      allSkills = [];
      return;
    }
    
    // Get active skill mappings for team members
    const mappingsQuery = query(
      collection(db, 'skillMappings'),
      where('employeeId', 'in', teamMemberIds),
      where('status', '==', 'active')
    );
    const mappingsSnapshot = await withLimit(() => getDocs(mappingsQuery));
    
    const skillIds = [...new Set(mappingsSnapshot.docs.map(d => d.data().skillId))];
    
    if (skillIds.length === 0) {
      allSkills = [];
      return;
    }
    
    // Fetch skills data in batches (Firestore 'in' limit is 10)
    const skillBatches = [];
    for (let i = 0; i < skillIds.length; i += 10) {
      const batch = skillIds.slice(i, i + 10);
      const skillsQuery = query(collection(db, 'skills'), where('id', 'in', batch));
      skillBatches.push(withLimit(() => getDocs(skillsQuery)));
    }
    
    const skillResults = await Promise.all(skillBatches);
    allSkills = skillResults.flatMap(snapshot => 
      snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
    );
    
    // Load categories and criticalities
    const [categoriesSnapshot, criticalitiesSnapshot, cyclesSnapshot] = await Promise.all([
      withLimit(() => getDocs(query(collection(db, 'skillCategories'), where('status', '==', 'active')))),
      withLimit(() => getDocs(query(collection(db, 'skillCriticalities'), where('status', '==', 'active')))),
      withLimit(() => getDocs(query(collection(db, 'assessmentCycles'), orderBy('startDate', 'desc'), limit(4))))
    ]);
    
    skillCategories = categoriesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    skillCriticalities = criticalitiesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    assessmentCycles = cyclesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
  } catch (error) {
    console.error('Error loading skills and metadata:', error);
    throw error;
  }
}

// Populate skill selector
function funPopulateSkillSelector() {
  const selector = document.getElementById('skill-selector');
  selector.innerHTML = '<option value="">Choose a skill to analyze...</option>';
  
  if (!allSkills || allSkills.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No skills found for your team';
    option.disabled = true;
    selector.appendChild(option);
    return;
  }
  
  // Sort skills alphabetically
  const sortedSkills = [...allSkills].sort((a, b) => 
    (a.name || '').localeCompare(b.name || '')
  );
  
  sortedSkills.forEach(skill => {
    const option = document.createElement('option');
    option.value = skill.id;
    option.textContent = skill.name || 'Unnamed Skill';
    selector.appendChild(option);
  });
}

// Load skill analysis
async function funLoadSkillAnalysis(skillId) {
  if (currentAbort) currentAbort.abort();
  currentAbort = new AbortController();
  const signal = currentAbort.signal;
  
  try {
    currentSkillId = skillId;
    showSkeletonState();
    
    // Load skill details and benchmark
    const [skillData, teamData, benchmarkData, assessmentData, trendData] = await Promise.all([
      funGetSkillDetails(skillId),
      funGetTeamMembers(),
      funGetCurrentBenchmark(skillId),
      funGetCurrentCycleAssessments(skillId),
      funGetTrendData(skillId)
    ]);
    
    if (signal.aborted) return;
    
    // Check if we have any assessment data
    if (!assessmentData || assessmentData.length === 0) {
      showNoDataState();
      return;
    }
    
    // Calculate summary metrics
    const summaryMetrics = funCalculateSummaryMetrics(assessmentData, benchmarkData?.benchmarkScore || 5);
    
    // Update UI
    funUpdateSkillInfo(skillData, benchmarkData);
    funUpdateSummaryMetrics(summaryMetrics);
    
    await yieldToFrame();
    
    // Create charts
    await funCreateScoreDistributionChart(assessmentData, benchmarkData?.benchmarkScore || 5);
    await funCreateTrendChart(trendData, benchmarkData);
    
    // Update rankings table
    const rankingsData = await funCalculateRankings(skillId, assessmentData, benchmarkData?.benchmarkScore || 5);
    funUpdateRankingsTable(rankingsData);
    
    document.getElementById('main-content').classList.remove('hidden');
    hideSkeletons();
    
  } catch (error) {
    if (signal.aborted) return;
    console.error('Error loading skill analysis:', error);
    showToast(error?.message || 'Failed to load skill analysis');
    showEmptyState();
  }
}

// Get skill details
async function funGetSkillDetails(skillId) {
  const skill = allSkills.find(s => s.id === skillId);
  if (!skill) throw new Error('Skill not found');
  
  const category = skillCategories.find(c => c.id === skill.categoryId);
  const criticality = skillCriticalities.find(c => c.id === skill.criticalityId);
  
  return {
    ...skill,
    categoryName: category?.categoryName || 'N/A',
    criticalityName: criticality?.criticalityName || 'N/A',
    criticalityWeight: criticality?.weight || 1
  };
}

// Get team members
async function funGetTeamMembers() {
  const userQuery = query(collection(db, 'users'), where('uid', '==', currentUser.uid), limit(1));
  const userSnapshot = await getDocs(userQuery);
  if (userSnapshot.empty) throw new Error('User not found');
  
  const userData = { id: userSnapshot.docs[0].id, ...userSnapshot.docs[0].data() };
  const teamQuery = query(
    collection(db, 'users'),
    where('teamLeadId', '==', userData.id),
    where('employeeStatus', '==', 'active')
  );
  
  const teamSnapshot = await getDocs(teamQuery);
  return teamSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
}

// Get current benchmark
async function funGetCurrentBenchmark(skillId) {
  const benchmarksQuery = query(
    collection(db, 'skillBenchmarks'),
    where('skillId', '==', skillId),
    where('effectiveEndDate', '==', null),
    orderBy('effectiveStartDate', 'desc'),
    limit(1)
  );
  
  const benchmarksSnapshot = await getDocs(benchmarksQuery);
  return benchmarksSnapshot.docs.length > 0 ? 
    { id: benchmarksSnapshot.docs[0].id, ...benchmarksSnapshot.docs[0].data() } : 
    null;
}

// Get current cycle assessments
async function funGetCurrentCycleAssessments(skillId) {
  const teamMembers = await funGetTeamMembers();
  const teamMemberIds = teamMembers.map(m => m.id);
  
  if (teamMemberIds.length === 0) return [];
  
  // Get current cycle
  const currentCycleQuery = query(
    collection(db, 'assessmentCycles'),
    where('isActiveCycle', '==', true),
    limit(1)
  );
  const currentCycleSnapshot = await getDocs(currentCycleQuery);
  
  if (currentCycleSnapshot.docs.length === 0) return [];
  
  const currentCycleId = currentCycleSnapshot.docs[0].id;
  
  // Fetch assessments in batches
  const assessmentBatches = [];
  for (let i = 0; i < teamMemberIds.length; i += 10) {
    const batch = teamMemberIds.slice(i, i + 10);
    const assessmentsQuery = query(
      collection(db, 'assessments'),
      where('employeeId', 'in', batch),
      where('skillId', '==', skillId),
      where('assessmentCycleId', '==', currentCycleId),
      where('status', '==', 'active')
    );
    assessmentBatches.push(getDocs(assessmentsQuery));
  }
  
  const assessmentResults = await Promise.all(assessmentBatches);
  const assessments = assessmentResults.flatMap(snapshot => 
    snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
  );
  
  // Enrich with employee data
  return assessments.map(assessment => {
    const employee = teamMembers.find(m => m.id === assessment.employeeId);
    return {
      ...assessment,
      employeeName: employee ? `${employee.firstName || ''} ${employee.lastName || ''}`.trim() : 'Unknown',
      employee
    };
  });
}

// Get trend data
async function funGetTrendData(skillId) {
  if (assessmentCycles.length === 0) return [];
  
  const teamMembers = await funGetTeamMembers();
  const teamMemberIds = teamMembers.map(m => m.id);
  
  if (teamMemberIds.length === 0) return [];
  
  const cycleIds = assessmentCycles.map(c => c.id);
  const trendData = [];
  
  // Get assessments for each cycle
  for (const cycle of assessmentCycles) {
    const assessmentBatches = [];
    for (let i = 0; i < teamMemberIds.length; i += 10) {
      const batch = teamMemberIds.slice(i, i + 10);
      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('employeeId', 'in', batch),
        where('skillId', '==', skillId),
        where('assessmentCycleId', '==', cycle.id),
        where('status', '==', 'active')
      );
      assessmentBatches.push(getDocs(assessmentsQuery));
    }
    
    const assessmentResults = await Promise.all(assessmentBatches);
    const assessments = assessmentResults.flatMap(snapshot => 
      snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
    );
    
    if (assessments.length > 0) {
      const scores = assessments.map(a => a.score || 0).filter(s => s > 0);
      const average = scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
      
      trendData.push({
        cycle: cycle.cycleName || 'Unknown Cycle',
        average: Math.round(average * 100) / 100,
        startDate: cycle.startDate,
        endDate: cycle.endDate,
        benchmark: assessments[0]?.benchmarkAtTimeOfAssessment || 5
      });
    }
  }
  
  return trendData.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
}

// Calculate summary metrics
function funCalculateSummaryMetrics(assessments, benchmark) {
  const scores = assessments.map(a => a.score || 0).filter(s => s > 0);
  
  if (scores.length === 0) {
    return {
      teamAverage: 0,
      benchmarkGap: 0,
      belowBenchmarkPct: 0,
      tniRate: 0
    };
  }
  
  const teamAverage = scores.reduce((sum, score) => sum + score, 0) / scores.length;
  const benchmarkGap = benchmark - teamAverage;
  const belowBenchmark = scores.filter(score => score < benchmark).length;
  const belowBenchmarkPct = (belowBenchmark / scores.length) * 100;
  const tniCount = assessments.filter(a => a.tniFlag === true).length;
  const tniRate = (tniCount / assessments.length) * 100;
  
  return {
    teamAverage: Math.round(teamAverage * 100) / 100,
    benchmarkGap: Math.round(benchmarkGap * 100) / 100,
    belowBenchmarkPct: Math.round(belowBenchmarkPct * 10) / 10,
    tniRate: Math.round(tniRate * 10) / 10
  };
}

// Calculate rankings
async function funCalculateRankings(skillId, currentAssessments, benchmark) {
  // Get previous cycle data for trend calculation
  const previousCycleAssessments = await funGetPreviousCycleAssessments(skillId);
  
  const rankings = currentAssessments
    .filter(assessment => assessment.score && assessment.score > 0)
    .map(assessment => {
      const previousAssessment = previousCycleAssessments.find(
        pa => pa.employeeId === assessment.employeeId
      );
      
      let trend = 'unchanged';
      let trendIcon = '→';
      if (previousAssessment && previousAssessment.score) {
        if (assessment.score > previousAssessment.score) {
          trend = 'up';
          trendIcon = '↗';
        } else if (assessment.score < previousAssessment.score) {
          trend = 'down';
          trendIcon = '↘';
        }
      }
      
      return {
        employeeId: assessment.employeeId,
        employeeName: assessment.employeeName,
        score: assessment.score,
        benchmark: benchmark,
        gap: benchmark - assessment.score,
        trend: trend,
        trendIcon: trendIcon,
        employee: assessment.employee
      };
    })
    .sort((a, b) => b.score - a.score)
    .map((item, index) => ({
      ...item,
      rank: index + 1
    }));
  
  return rankings;
}

// Get previous cycle assessments
async function funGetPreviousCycleAssessments(skillId) {
  if (assessmentCycles.length < 2) return [];
  
  const previousCycle = assessmentCycles[1]; // Second most recent
  const teamMembers = await funGetTeamMembers();
  const teamMemberIds = teamMembers.map(m => m.id);
  
  if (teamMemberIds.length === 0) return [];
  
  const assessmentBatches = [];
  for (let i = 0; i < teamMemberIds.length; i += 10) {
    const batch = teamMemberIds.slice(i, i + 10);
    const assessmentsQuery = query(
      collection(db, 'assessments'),
      where('employeeId', 'in', batch),
      where('skillId', '==', skillId),
      where('assessmentCycleId', '==', previousCycle.id),
      where('status', '==', 'active')
    );
    assessmentBatches.push(getDocs(assessmentsQuery));
  }
  
  const assessmentResults = await Promise.all(assessmentBatches);
  return assessmentResults.flatMap(snapshot => 
    snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
  );
}

// Update skill info
function funUpdateSkillInfo(skillData, benchmarkData) {
  document.getElementById('skill-name').textContent = skillData.name || 'Unknown Skill';
  document.getElementById('skill-category').textContent = skillData.categoryName || 'N/A';
  document.getElementById('skill-criticality').textContent = skillData.criticalityName || 'N/A';
  document.getElementById('skill-benchmark').textContent = benchmarkData?.benchmarkScore?.toString() || '5';
  
  document.getElementById('skill-info-skeleton').classList.add('hidden');
  document.getElementById('skill-info-content').classList.remove('hidden');
}

// Update summary metrics
function funUpdateSummaryMetrics(metrics) {
  document.getElementById('team-avg-score').textContent = metrics.teamAverage.toString();
  
  const gapElement = document.getElementById('benchmark-gap');
  gapElement.textContent = metrics.benchmarkGap > 0 ? `+${metrics.benchmarkGap}` : metrics.benchmarkGap.toString();
  gapElement.className = `text-2xl font-bold ${metrics.benchmarkGap > 0 ? 'text-danger-600' : 'text-success-600'}`;
  
  document.getElementById('below-benchmark-pct').textContent = `${metrics.belowBenchmarkPct}%`;
  document.getElementById('tni-rate').textContent = `${metrics.tniRate}%`;
  
  // Show content, hide skeletons
  ['avg-score', 'benchmark-gap', 'below-benchmark', 'tni-rate'].forEach(id => {
    document.getElementById(`${id}-skeleton`).classList.add('hidden');
    document.getElementById(`${id}-content`).classList.remove('hidden');
  });
}

// Create score distribution chart
async function funCreateScoreDistributionChart(assessments, benchmark) {
  await yieldToFrame();
  
  const scores = assessments.map(a => a.score || 0).filter(s => s > 0);
  const distribution = new Array(10).fill(0);
  
  scores.forEach(score => {
    if (score >= 1 && score <= 10) {
      distribution[score - 1]++;
    }
  });
  
  const chartElement = document.getElementById('score-distribution-chart');
  const chart = echarts.init(chartElement);
  
  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
      name: 'Score',
      nameLocation: 'middle',
      nameGap: 30
    },
    yAxis: {
      type: 'value',
      name: 'Count',
      nameLocation: 'middle',
      nameGap: 40
    },
    series: [
      {
        name: 'Employees',
        type: 'bar',
        data: distribution,
        itemStyle: {
          color: '#1B2A44'
        }
      }
    ]
  };
  
  // Add benchmark line if valid
  if (benchmark && benchmark >= 1 && benchmark <= 10) {
    option.series.push({
      name: 'Benchmark',
      type: 'line',
      data: new Array(10).fill(Math.max(...distribution) * 0.8),
      lineStyle: {
        color: '#C59D42',
        width: 3,
        type: 'dashed'
      },
      symbol: 'none',
      tooltip: {
        formatter: `Benchmark: ${benchmark}`
      }
    });
  }
  
  chart.setOption(option);
  
  document.getElementById('score-distribution-skeleton').classList.add('hidden');
  document.getElementById('score-distribution-chart').classList.remove('hidden');
}

// Create trend chart
async function funCreateTrendChart(trendData, benchmarkData) {
  await yieldToFrame();
  
  if (!trendData || trendData.length === 0) {
    document.getElementById('trend-chart-skeleton').classList.add('hidden');
    const chartElement = document.getElementById('trend-chart');
    chartElement.classList.remove('hidden');
    chartElement.innerHTML = '<div class="h-full flex items-center justify-center text-neutral-500">No trend data available</div>';
    return;
  }
  
  const chartElement = document.getElementById('trend-chart');
  const chart = echarts.init(chartElement);
  
  const categories = trendData.map(d => d.cycle);
  const averages = trendData.map(d => d.average);
  const benchmarks = trendData.map(d => d.benchmark);
  
  const option = {
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['Team Average', 'Benchmark']
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: categories,
      name: 'Assessment Cycle',
      nameLocation: 'middle',
      nameGap: 30
    },
    yAxis: {
      type: 'value',
      name: 'Score',
      nameLocation: 'middle',
      nameGap: 40,
      min: 0,
      max: 10
    },
    series: [
      {
        name: 'Team Average',
        type: 'line',
        data: averages,
        itemStyle: {
          color: '#1B2A44'
        },
        lineStyle: {
          color: '#1B2A44',
          width: 3
        },
        symbol: 'circle',
        symbolSize: 6
      },
      {
        name: 'Benchmark',
        type: 'line',
        data: benchmarks,
        itemStyle: {
          color: '#C59D42'
        },
        lineStyle: {
          color: '#C59D42',
          width: 2,
          type: 'dashed'
        },
        symbol: 'none'
      }
    ]
  };
  
  chart.setOption(option);
  
  document.getElementById('trend-chart-skeleton').classList.add('hidden');
  document.getElementById('trend-chart').classList.remove('hidden');
}

// Update rankings table
function funUpdateRankingsTable(rankings) {
  const tbody = document.getElementById('rankings-tbody');
  tbody.innerHTML = '';
  
  if (!rankings || rankings.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td colspan="7" class="px-4 py-8 text-center text-neutral-500">
        No employee rankings available
      </td>
    `;
    tbody.appendChild(row);
  } else {
    rankings.forEach(ranking => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-neutral-50 focus-within:bg-neutral-50';
      
      const gapClass = ranking.gap > 0 ? 'text-danger-600' : 'text-success-600';
      const trendClass = ranking.trend === 'up' ? 'text-success-600' : 
                         ranking.trend === 'down' ? 'text-danger-600' : 'text-neutral-500';
      
      row.innerHTML = `
        <td class="px-4 py-3">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-accent-gold-50 text-neutral-900 text-sm font-medium">
            ${ranking.rank}
          </span>
        </td>
        <td class="px-4 py-3">
          <button class="text-left hover:text-brand-primary-700 focus:text-brand-primary-700 focus:outline-none employee-link" 
                  data-employee-id="${ranking.employeeId}">
            ${ranking.employeeName || 'Unknown'}
          </button>
        </td>
        <td class="px-4 py-3 font-medium">${ranking.score}</td>
        <td class="px-4 py-3">${ranking.benchmark}</td>
        <td class="px-4 py-3 ${gapClass} font-medium">
          ${ranking.gap > 0 ? '+' + ranking.gap : ranking.gap}
        </td>
        <td class="px-4 py-3 ${trendClass} font-medium">
          ${ranking.trendIcon}
        </td>
        <td class="px-4 py-3">
          <button class="text-sm text-brand-primary-600 hover:text-brand-primary-700 focus:text-brand-primary-700 focus:outline-none view-profile-btn" 
                  data-employee-id="${ranking.employeeId}">
            View Profile
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
  
  document.getElementById('rankings-skeleton').classList.add('hidden');
  document.getElementById('rankings-table-container').classList.remove('hidden');
}

// State management functions
function showEmptyState() {
  document.getElementById('empty-state').classList.remove('hidden');
  document.getElementById('no-data-state').classList.add('hidden');
  document.getElementById('main-content').classList.add('hidden');
}

function showNoDataState() {
  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('no-data-state').classList.remove('hidden');
  document.getElementById('main-content').classList.add('hidden');
}

function showSkeletonState() {
  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('no-data-state').classList.add('hidden');
  document.getElementById('main-content').classList.remove('hidden');
  
  // Show all skeletons
  document.getElementById('skill-info-skeleton').classList.remove('hidden');
  document.getElementById('skill-info-content').classList.add('hidden');
  
  ['avg-score', 'benchmark-gap', 'below-benchmark', 'tni-rate'].forEach(id => {
    document.getElementById(`${id}-skeleton`).classList.remove('hidden');
    document.getElementById(`${id}-content`).classList.add('hidden');
  });
  
  document.getElementById('score-distribution-skeleton').classList.remove('hidden');
  document.getElementById('score-distribution-chart').classList.add('hidden');
  
  document.getElementById('trend-chart-skeleton').classList.remove('hidden');
  document.getElementById('trend-chart').classList.add('hidden');
  
  document.getElementById('rankings-skeleton').classList.remove('hidden');
  document.getElementById('rankings-table-container').classList.add('hidden');
}

function hideSkeletons() {
  document.getElementById('skill-info-skeleton').classList.add('hidden');
  ['avg-score', 'benchmark-gap', 'below-benchmark', 'tni-rate'].forEach(id => {
    document.getElementById(`${id}-skeleton`).classList.add('hidden');
  });
  document.getElementById('score-distribution-skeleton').classList.add('hidden');
  document.getElementById('trend-chart-skeleton').classList.add('hidden');
  document.getElementById('rankings-skeleton').classList.add('hidden');
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Skill selector change
  document.getElementById('skill-selector').addEventListener('change', async (e) => {
    const skillId = e.target.value;
    if (skillId) {
      await funLoadSkillAnalysis(skillId);
    } else {
      showEmptyState();
    }
  });
  
  // Refresh button
  document.getElementById('btn-refresh').addEventListener('click', () => {
    funInitialLoad();
  });
  
  // Employee profile navigation
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('employee-link') || e.target.classList.contains('view-profile-btn')) {
      const employeeId = e.target.dataset.employeeId;
      if (employeeId) {
        window.location.href = `employee_profile.html?employeeId=${employeeId}`;
      }
    }
  });
  
  // Initialize icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
});
</script>

</body>
</html>