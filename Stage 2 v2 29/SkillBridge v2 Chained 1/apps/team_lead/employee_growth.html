<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Config -->
    <script data-tiramai="web-gen">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                'primary-600': '#1B2A44',
                'primary-700': '#14233A',
                'primary-800': '#0E1A2B',
              },
              accent: {
                'gold-50': '#FFF7E6',
                'gold-500': '#C59D42',
                'gold-600': '#A97D22',
              },
              success: { '600': '#16A34A' },
              warning: { '600': '#D97706' },
              danger: { '600': '#DC2626' },
              info: { '600': '#2563EB' },
              heat: {
                green: '#16A34A',
                amber: '#F59E0B',
                red: '#DC2626'
              },
              neutral: {
                '50': '#F8FAFC',
                '200': '#E2E8F0',
                '500': '#64748B',
                '700': '#334155',
                '900': '#111827',
                '950': '#0B1220',
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-900">
    <!-- Top-Nav -->
    <header class="fixed top-0 left-0 right-0 bg-brand-primary-800 border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-toggle" class="md:hidden text-white hover:text-accent-gold-500 transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex-shrink-0">
                    <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="84" y="116" width="56" height="168" rx="8" fill="#1E40AF"/>
                        <rect x="176" y="84" width="56" height="200" rx="8" fill="#059669"/>
                        <rect x="268" y="156" width="48" height="128" rx="8" fill="#1E40AF"/>
                        <rect x="114" y="180" width="172" height="20" rx="10" fill="#F59E0B"/>
                    </svg>
                </div>
                <span class="text-xl font-semibold text-white">SkillBridge</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-2 text-white hover:text-accent-gold-500 transition-colors">
                    <div id="user-avatar" class="w-8 h-8 bg-accent-gold-500 rounded-full flex items-center justify-center text-neutral-900 text-sm font-medium">
                        U
                    </div>
                    <span id="user-name" class="hidden sm:block text-sm">Loading...</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                
                <!-- User Profile Dropdown -->
                <div id="user-profile-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 hidden z-40">
                    <div class="px-4 py-3 border-b border-neutral-200">
                        <p id="dropdown-user-name" class="text-sm font-medium text-neutral-900">Loading...</p>
                        <p id="dropdown-user-email" class="text-xs text-neutral-500">loading@example.com</p>
                    </div>
                    <button id="sign-out-btn" class="w-full px-4 py-2 text-left text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Sign out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side-Nav -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-screen sticky top-16 overflow-y-auto transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out z-20">
            <nav class="p-4 space-y-2">
                <!-- Team Dashboard -->
                <a href="team_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="team_dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Team Dashboard</span>
                </a>

                <!-- My Team with collapsible children -->
                <div class="nav-group">
                    <button class="nav-group-toggle w-full flex items-center justify-between px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>My Team</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 transform transition-transform nav-group-chevron"></i>
                    </button>
                    <div class="nav-group-content ml-8 mt-1 space-y-1 hidden">
                        <a href="my_team.html" class="nav-link block px-3 py-2 text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="my_team">
                            Team Overview
                        </a>
                    </div>
                </div>

                <!-- Team Skill Gap Analysis with children -->
                <div class="nav-group">
                    <button class="nav-group-toggle w-full flex items-center justify-between px-3 py-2 text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="grid" class="w-5 h-5"></i>
                            <span>Skill Gap Analysis</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 transform transition-transform nav-group-chevron"></i>
                    </button>
                    <div class="nav-group-content ml-8 mt-1 space-y-1 hidden">
                        <a href="skill_trend_analysis.html" class="nav-link block px-3 py-2 text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-700 rounded-md transition-colors" data-page="skill_trend_analysis">
                            <div class="flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                <span>Skill Trends</span>
                            </div>
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-20 w-full text-center text-sm text-neutral-500 bg-white rounded px-4 py-2">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto">
            
<!-- Growth Tracking Page Content -->
<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
      <button id="back-button" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-neutral-700 hover:text-brand-primary-700 transition-colors">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back to Profile
      </button>
      <div class="h-6 border-l border-neutral-300"></div>
      <h1 id="page-title" class="text-2xl leading-8 font-bold text-neutral-950">Growth Tracking for...</h1>
    </div>
    
    <div class="flex items-center gap-3">
      <button id="btn-refresh" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-neutral-500 hover:text-neutral-700 border border-neutral-200 rounded-md hover:bg-neutral-50 transition-colors" aria-label="Refresh Data">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading-container" class="space-y-6">
    <!-- Overview Stats Skeleton -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm animate-pulse">
        <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
        <div class="h-8 bg-neutral-200 rounded w-1/2"></div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm animate-pulse">
        <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
        <div class="h-8 bg-neutral-200 rounded w-1/2"></div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm animate-pulse">
        <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
        <div class="h-8 bg-neutral-200 rounded w-1/2"></div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm animate-pulse">
        <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
        <div class="h-8 bg-neutral-200 rounded w-1/2"></div>
      </div>
    </div>

    <!-- Controls Skeleton -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm animate-pulse">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <div class="h-4 bg-neutral-200 rounded w-1/4 mb-2"></div>
          <div class="h-10 bg-neutral-200 rounded"></div>
        </div>
        <div class="w-full md:w-48">
          <div class="h-4 bg-neutral-200 rounded w-1/3 mb-2"></div>
          <div class="h-10 bg-neutral-200 rounded"></div>
        </div>
      </div>
    </div>

    <!-- Charts Skeleton -->
    <div class="space-y-6">
      <div class="bg-white rounded-md border border-neutral-200 p-6 shadow-sm animate-pulse">
        <div class="h-6 bg-neutral-200 rounded w-1/3 mb-4"></div>
        <div class="h-64 bg-neutral-200 rounded mb-4"></div>
        <div class="flex items-center justify-between text-sm">
          <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden space-y-6">
    <!-- Overview Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="text-xs text-neutral-500 mb-1">Total Skills Tracked</div>
        <div id="stat-total-skills" class="text-xl font-semibold text-neutral-950">0</div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="text-xs text-neutral-500 mb-1">Average Improvement</div>
        <div id="stat-avg-improvement" class="text-xl font-semibold text-neutral-950">+0.0</div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="text-xs text-neutral-500 mb-1">Skills Improved</div>
        <div id="stat-skills-improved" class="text-xl font-semibold text-success-600">0</div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
        <div class="text-xs text-neutral-500 mb-1">Skills Declined</div>
        <div id="stat-skills-declined" class="text-xl font-semibold text-danger-600">0</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <label for="skill-filter" class="block text-sm font-medium text-neutral-900 mb-1">Skills to Display</label>
          <select id="skill-filter" multiple class="w-full border border-neutral-200 rounded-sm bg-white text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" style="min-height: 100px;">
            <!-- Options populated dynamically -->
          </select>
          <p class="mt-1 text-xs text-neutral-500">Hold Ctrl/Cmd to select multiple skills</p>
        </div>
        <div class="w-full md:w-48">
          <label for="sort-toggle" class="block text-sm font-medium text-neutral-900 mb-1">Sort By</label>
          <select id="sort-toggle" class="w-full border border-neutral-200 rounded-sm px-3 py-2 bg-white text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2">
            <option value="most-improved">Most Improved</option>
            <option value="most-declined">Most Declined</option>
            <option value="alphabetical">A–Z</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Charts Container -->
    <div id="charts-container" class="space-y-6">
      <!-- Charts will be populated dynamically -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden bg-white rounded-md border border-neutral-200 p-12 shadow-sm text-center">
      <div class="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i data-lucide="trending-up" class="w-8 h-8 text-neutral-400"></i>
      </div>
      <h3 class="text-base font-semibold text-neutral-950 mb-2">No Growth Data Available</h3>
      <p class="text-sm text-neutral-500 max-w-sm mx-auto">
        This employee doesn't have multiple assessments for any skills. Growth tracking requires at least 2 assessments per skill.
      </p>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc, query, collection, where, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Get current page name from URL
        function getCurrentPage() {
            const path = window.location.pathname;
            const filename = path.split('/').pop();
            return filename.replace('.html', '') || 'team_dashboard';
        }

        // Set active navigation state
        function setActiveNavigation() {
            const currentPage = getCurrentPage();
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const pageName = link.getAttribute('data-page');
                if (pageName === currentPage) {
                    link.classList.add('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-2', 'border-accent-gold-500');
                    link.classList.remove('text-neutral-700');
                } else {
                    link.classList.remove('bg-accent-gold-50', 'text-brand-primary-700', 'border-l-2', 'border-accent-gold-500');
                    link.classList.add('text-neutral-700');
                }
            });
        }

        // Initialize user profile and auth
        async function initializeUser() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = '/auth.html';
                    return;
                }

                try {
                    // Try to get user data from Firestore by querying uid field
                    const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid), limit(1));
                    const userSnapshot = await getDocs(userQuery);
                    let userData = null;
                    
                    if (!userSnapshot.empty) {
                        userData = { id: userSnapshot.docs[0].id, ...userSnapshot.docs[0].data() };
                    }

                    // Set user display data (with fallbacks)
                    const firstName = userData?.firstName || user.displayName?.split(' ')[0] || 'User';
                    const lastName = userData?.lastName || user.displayName?.split(' ')[1] || '';
                    const email = userData?.email || user.email || 'johndoe@example.com';
                    const fullName = `${firstName} ${lastName}`.trim();

                    // Update UI elements
                    const userAvatar = document.getElementById('user-avatar');
                    const userName = document.getElementById('user-name');
                    const dropdownUserName = document.getElementById('dropdown-user-name');
                    const dropdownUserEmail = document.getElementById('dropdown-user-email');

                    if (userAvatar) userAvatar.textContent = firstName.charAt(0).toUpperCase();
                    if (userName) userName.textContent = fullName || email.split('@')[0];
                    if (dropdownUserName) dropdownUserName.textContent = fullName || email.split('@')[0];
                    if (dropdownUserEmail) dropdownUserEmail.textContent = email;

                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to auth data
                    const fallbackName = user.displayName || user.email.split('@')[0];
                    document.getElementById('user-name').textContent = fallbackName;
                    document.getElementById('dropdown-user-name').textContent = fallbackName;
                    document.getElementById('dropdown-user-email').textContent = user.email;
                }
            });
        }

        // Toggle user profile dropdown
        function initializeUserProfileDropdown() {
            const profileBtn = document.getElementById('user-profile-btn');
            const dropdown = document.getElementById('user-profile-dropdown');
            const signOutBtn = document.getElementById('sign-out-btn');

            profileBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !profileBtn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Handle sign out
            signOutBtn?.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = '/auth.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    showToast('Error signing out', 'error');
                }
            });
        }

        // Initialize mobile navigation
        function initializeMobileNav() {
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            mobileToggle?.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            });

            overlay?.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });

            // Close mobile nav on nav link click
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });
            });
        }

        // Initialize collapsible navigation groups
        function initializeNavGroups() {
            const navGroupToggles = document.querySelectorAll('.nav-group-toggle');
            
            navGroupToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const content = toggle.nextElementSibling;
                    const chevron = toggle.querySelector('.nav-group-chevron');
                    
                    content.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-90');
                });
            });
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            initializeUserProfileDropdown();
            initializeMobileNav();
            initializeNavGroups();
            setActiveNavigation();
        });
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { 
  collection, getDocs, query, where, orderBy, limit, doc, getDoc 
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader } from "./scripts/main.js";

const db = getDb();

// Auth guard
onAuthStateChanged(auth, user => {
  if (!user) location.href = "/auth.html?redirect=" + encodeURIComponent(location.pathname);
});

// Get employee ID from URL
const urlParams = new URLSearchParams(window.location.search);
const employeeId = urlParams.get('employeeId');

if (!employeeId) {
  showToast('Employee ID is required', 'error');
  window.location.href = 'my_team.html';
}

// Global state
let employeeData = null;
let skillsData = new Map();
let assessmentsData = [];
let growthAnalysis = [];

// Concurrency control
function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}
const withLimit = createSemaphore(2);

// Abort controller for requests
let currentAbort;

// Utility functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function formatDate(isoString) {
  if (!isoString) return 'N/A';
  try {
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  } catch {
    return 'N/A';
  }
}

function formatScore(score) {
  return score != null ? score.toString() : 'N/A';
}

function calculateImprovement(first, latest) {
  if (first == null || latest == null) return { change: 0, percentage: 0 };
  const change = latest - first;
  const percentage = first !== 0 ? ((change / first) * 100) : 0;
  return { change, percentage };
}

function determineTNIChange(assessments) {
  if (!assessments || assessments.length < 2) return 'N/A';
  const first = assessments[0];
  const latest = assessments[assessments.length - 1];
  
  const wasFlag = first.tniFlag === true;
  const nowFlag = latest.tniFlag === true;
  
  if (wasFlag && !nowFlag) return 'Was: Yes → Now: No';
  if (!wasFlag && nowFlag) return 'Was: No → Now: Yes';
  if (wasFlag && nowFlag) return 'Was: Yes → Now: Yes';
  return 'Was: No → Now: No';
}

// Data fetching functions
async function funLoadEmployeeData() {
  try {
    const userDoc = await withLimit(() => getDoc(doc(db, 'users', employeeId)));
    if (!userDoc.exists()) {
      throw new Error('Employee not found');
    }
    employeeData = { id: userDoc.id, ...userDoc.data() };
    
    // Update page title
    const fullName = `${employeeData.firstName || ''} ${employeeData.lastName || ''}`.trim() || 'Unknown Employee';
    document.getElementById('page-title').textContent = `Growth Tracking for ${fullName}`;
    
    return employeeData;
  } catch (error) {
    console.error('Error loading employee:', error);
    throw error;
  }
}

async function funLoadSkillsData() {
  try {
    const skillsSnapshot = await withLimit(() => getDocs(collection(db, 'skills')));
    skillsData.clear();
    skillsSnapshot.forEach(doc => {
      const data = doc.data();
      if (data && data.status === 'active') {
        skillsData.set(doc.id, { id: doc.id, ...data });
      }
    });
    return skillsData;
  } catch (error) {
    console.error('Error loading skills:', error);
    throw error;
  }
}

async function funLoadAssessments() {
  try {
    const q = query(
      collection(db, 'assessments'),
      where('employeeId', '==', employeeId),
      where('status', '==', 'active'),
      orderBy('assessmentTimestamp', 'asc')
    );
    
    const assessmentsSnapshot = await withLimit(() => getDocs(q));
    assessmentsData = [];
    assessmentsSnapshot.forEach(doc => {
      const data = doc.data();
      if (data) {
        assessmentsData.push({ id: doc.id, ...data });
      }
    });
    
    return assessmentsData;
  } catch (error) {
    console.error('Error loading assessments:', error);
    throw error;
  }
}

// Growth analysis calculation
async function funCalculateGrowthAnalysis() {
  await yieldToFrame(); // Yield before heavy computation
  
  const skillGroups = new Map();
  
  // Group assessments by skill
  assessmentsData.forEach(assessment => {
    const { skillId } = assessment;
    if (!skillGroups.has(skillId)) {
      skillGroups.set(skillId, []);
    }
    skillGroups.get(skillId).push(assessment);
  });
  
  // Filter skills with >= 2 assessments and calculate growth
  growthAnalysis = [];
  for (const [skillId, assessments] of skillGroups) {
    if (assessments.length < 2) continue;
    
    // Sort by timestamp to ensure proper order
    assessments.sort((a, b) => new Date(a.assessmentTimestamp) - new Date(b.assessmentTimestamp));
    
    const skill = skillsData.get(skillId);
    if (!skill) continue;
    
    const first = assessments[0];
    const latest = assessments[assessments.length - 1];
    const improvement = calculateImprovement(first.score, latest.score);
    
    // Prepare chart data
    const chartData = assessments.map(a => ({
      timestamp: new Date(a.assessmentTimestamp),
      score: a.score || 0,
      benchmark: a.benchmarkAtTimeOfAssessment || 0
    }));
    
    growthAnalysis.push({
      skillId,
      skillName: skill.name || 'Unknown Skill',
      firstScore: first.score || 0,
      latestScore: latest.score || 0,
      improvement,
      tniChange: determineTNIChange(assessments),
      assessmentCount: assessments.length,
      chartData
    });
  }
  
  return growthAnalysis;
}

// UI update functions
function funUpdateOverviewStats() {
  const totalSkills = growthAnalysis.length;
  const improved = growthAnalysis.filter(a => a.improvement.change > 0).length;
  const declined = growthAnalysis.filter(a => a.improvement.change < 0).length;
  
  let avgImprovement = 0;
  if (totalSkills > 0) {
    const totalChange = growthAnalysis.reduce((sum, a) => sum + a.improvement.change, 0);
    avgImprovement = totalChange / totalSkills;
  }
  
  document.getElementById('stat-total-skills').textContent = totalSkills.toString();
  document.getElementById('stat-skills-improved').textContent = improved.toString();
  document.getElementById('stat-skills-declined').textContent = declined.toString();
  
  const avgElement = document.getElementById('stat-avg-improvement');
  const sign = avgImprovement >= 0 ? '+' : '';
  avgElement.textContent = `${sign}${avgImprovement.toFixed(1)}`;
  avgElement.className = avgImprovement >= 0 ? 'text-xl font-semibold text-success-600' : 'text-xl font-semibold text-danger-600';
}

function funPopulateSkillFilter() {
  const skillFilter = document.getElementById('skill-filter');
  skillFilter.innerHTML = '';
  
  growthAnalysis.forEach(analysis => {
    const option = document.createElement('option');
    option.value = analysis.skillId;
    option.textContent = analysis.skillName;
    option.selected = true; // Select all by default
    skillFilter.appendChild(option);
  });
}

function funSortAnalysis(sortBy) {
  switch (sortBy) {
    case 'most-improved':
      return [...growthAnalysis].sort((a, b) => b.improvement.change - a.improvement.change);
    case 'most-declined':
      return [...growthAnalysis].sort((a, b) => a.improvement.change - b.improvement.change);
    case 'alphabetical':
      return [...growthAnalysis].sort((a, b) => a.skillName.localeCompare(b.skillName));
    default:
      return growthAnalysis;
  }
}

function funGetSelectedSkills() {
  const skillFilter = document.getElementById('skill-filter');
  return Array.from(skillFilter.selectedOptions).map(option => option.value);
}

async function funRenderCharts() {
  await yieldToFrame();
  
  const selectedSkillIds = funGetSelectedSkills();
  const sortBy = document.getElementById('sort-toggle').value;
  const sortedAnalysis = funSortAnalysis(sortBy);
  const filteredAnalysis = sortedAnalysis.filter(a => selectedSkillIds.includes(a.skillId));
  
  const chartsContainer = document.getElementById('charts-container');
  chartsContainer.innerHTML = '';
  
  if (filteredAnalysis.length === 0) {
    document.getElementById('empty-state').classList.remove('hidden');
    return;
  }
  
  document.getElementById('empty-state').classList.add('hidden');
  
  // Render charts with yielding to prevent blocking
  for (let i = 0; i < filteredAnalysis.length; i++) {
    if (i > 0 && i % 2 === 0) {
      await yieldToFrame(); // Yield every 2 charts
    }
    await funRenderSingleChart(filteredAnalysis[i]);
  }
}

async function funRenderSingleChart(analysis) {
  const chartsContainer = document.getElementById('charts-container');
  
  // Create chart container
  const chartContainer = document.createElement('div');
  chartContainer.className = 'bg-white rounded-md border border-neutral-200 p-6 shadow-sm';
  chartContainer.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-base leading-6 font-semibold text-neutral-950">${analysis.skillName}</h3>
      <span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-neutral-100 text-neutral-700">
        ${analysis.assessmentCount} assessments
      </span>
    </div>
    <div class="chart-wrapper">
      <div id="chart-${analysis.skillId}" class="w-full h-64"></div>
    </div>
    <div class="flex items-center justify-between text-sm mt-4 pt-4 border-t border-neutral-200">
      <div class="flex items-center gap-4">
        <div>
          <span class="text-neutral-500">First → Latest:</span>
          <span class="font-medium">
            ${formatScore(analysis.firstScore)} → ${formatScore(analysis.latestScore)}
            <span class="ml-1 ${analysis.improvement.change >= 0 ? 'text-success-600' : 'text-danger-600'}">
              (${analysis.improvement.change >= 0 ? '+' : ''}${analysis.improvement.change.toFixed(1)})
            </span>
          </span>
        </div>
        <div>
          <span class="text-neutral-500">Improvement:</span>
          <span class="font-medium ${analysis.improvement.percentage >= 0 ? 'text-success-600' : 'text-danger-600'}">
            ${analysis.improvement.percentage >= 0 ? '+' : ''}${analysis.improvement.percentage.toFixed(1)}%
          </span>
        </div>
      </div>
      <div>
        <span class="text-neutral-500">TNI:</span>
        <span class="font-medium text-neutral-700">${analysis.tniChange}</span>
      </div>
    </div>
  `;
  
  chartsContainer.appendChild(chartContainer);
  
  // Defer chart rendering
  await funMountChart(() => funInitializeChart(analysis));
}

async function funMountChart(init) {
  await yieldToFrame();
  await new Promise(r => setTimeout(r, 0));
  init();
}

function funInitializeChart(analysis) {
  const chartId = `chart-${analysis.skillId}`;
  const chartElement = document.getElementById(chartId);
  
  if (!chartElement || !window.echarts) return;
  
  const chart = echarts.init(chartElement);
  
  // Prepare data for ECharts
  const dates = analysis.chartData.map(d => d.timestamp.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric',
    year: '2-digit'
  }));
  const scores = analysis.chartData.map(d => d.score);
  const benchmarks = analysis.chartData.map(d => d.benchmark);
  
  const option = {
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'white',
      borderColor: '#e2e8f0',
      borderWidth: 1,
      textStyle: {
        color: '#111827',
        fontSize: 12
      },
      formatter: function(params) {
        const date = dates[params[0].dataIndex];
        let html = `<div style="margin-bottom: 4px; font-weight: 600;">${date}</div>`;
        params.forEach(param => {
          const color = param.color;
          const name = param.seriesName;
          const value = param.value;
          html += `<div style="margin: 2px 0;">
            <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${color}; margin-right: 8px;"></span>
            ${name}: <strong>${value}</strong>
          </div>`;
        });
        return html;
      }
    },
    legend: {
      data: ['Score', 'Benchmark'],
      bottom: 0,
      textStyle: {
        color: '#64748b',
        fontSize: 12
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '15%',
      top: '5%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: dates,
      axisLabel: {
        color: '#64748b',
        fontSize: 11,
        rotate: 45
      },
      axisLine: {
        lineStyle: {
          color: '#e2e8f0'
        }
      }
    },
    yAxis: {
      type: 'value',
      min: 0,
      max: 10,
      interval: 2,
      axisLabel: {
        color: '#64748b',
        fontSize: 11
      },
      axisLine: {
        lineStyle: {
          color: '#e2e8f0'
        }
      },
      splitLine: {
        lineStyle: {
          color: '#f1f5f9'
        }
      }
    },
    series: [
      {
        name: 'Score',
        type: 'line',
        data: scores,
        lineStyle: {
          color: '#1B2A44',
          width: 2
        },
        itemStyle: {
          color: '#1B2A44'
        },
        symbol: 'circle',
        symbolSize: 6
      },
      {
        name: 'Benchmark',
        type: 'line',
        data: benchmarks,
        lineStyle: {
          color: '#C59D42',
          width: 2,
          type: 'dashed'
        },
        itemStyle: {
          color: '#C59D42'
        },
        symbol: 'circle',
        symbolSize: 4
      }
    ]
  };
  
  chart.setOption(option);
  
  // Handle resize
  window.addEventListener('resize', () => chart.resize());
}

// Event handlers
function funSetupEventHandlers() {
  // Back button
  document.getElementById('back-button')?.addEventListener('click', () => {
    window.location.href = `employee_profile.html?employeeId=${employeeId}`;
  });
  
  // Refresh button
  document.getElementById('btn-refresh')?.addEventListener('click', () => {
    funInitialLoad(true);
  });
  
  // Skill filter changes
  document.getElementById('skill-filter')?.addEventListener('change', () => {
    funRenderCharts();
  });
  
  // Sort changes
  document.getElementById('sort-toggle')?.addEventListener('change', () => {
    funRenderCharts();
  });
}

// Main loading function
async function funInitialLoad(forceRefresh = false) {
  if (currentAbort && !currentAbort.aborted) {
    currentAbort.abort();
  }
  currentAbort = new AbortController();
  
  try {
    // Show loading state
    document.getElementById('loading-container').classList.remove('hidden');
    document.getElementById('main-content').classList.add('hidden');
    
    // Load data sequentially with concurrency limits
    await funLoadEmployeeData();
    await yieldToFrame();
    
    await funLoadSkillsData();
    await yieldToFrame();
    
    await funLoadAssessments();
    await yieldToFrame();
    
    await funCalculateGrowthAnalysis();
    await yieldToFrame();
    
    // Check if we have any growth data
    if (growthAnalysis.length === 0) {
      document.getElementById('loading-container').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
      return;
    }
    
    // Update UI
    funUpdateOverviewStats();
    funPopulateSkillFilter();
    
    // Show main content
    document.getElementById('loading-container').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    
    // Render charts
    await funRenderCharts();
    
  } catch (error) {
    console.error('Error loading growth data:', error);
    if (!currentAbort.aborted) {
      showToast(error?.message || 'Failed to load growth data', 'error');
      
      // Show empty state on error
      document.getElementById('loading-container').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
    }
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
  funSetupEventHandlers();
  funInitialLoad();
});
</script>

</body>
</html>