<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Config Extension -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            'primary-600': '#1B2A44',
                            'primary-700': '#14233A',
                            'primary-800': '#0E1A2B',
                        },
                        accent: {
                            'gold-50': '#FFF7E6',
                            'gold-500': '#C59D42',
                            'gold-600': '#A97D22',
                        },
                        success: { '600': '#16A34A' },
                        warning: { '600': '#D97706' },
                        danger: { '600': '#DC2626' },
                        info: { '600': '#2563EB' },
                        heat: {
                            green: '#16A34A',
                            amber: '#F59E0B',
                            red: '#DC2626'
                        },
                        neutral: {
                            '50': '#F8FAFC',
                            '200': '#E2E8F0',
                            '500': '#64748B',
                            '700': '#334155',
                            '900': '#111827',
                            '950': '#0B1220',
                        }
                    },
                    fontSize: {
                        'xs': ['12px', '16px'],
                        'sm': ['14px', '20px'],
                        'base': ['16px', '24px'],
                        'xl': ['20px', '28px'],
                        '2xl': ['24px', '32px'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-900">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-brand-primary-800 border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <!-- Mobile menu toggle -->
            <button id="mobileMenuToggle" class="md:hidden text-white p-2" aria-label="Toggle menu">
                <svg class="w-5 h-5" data-lucide="menu"></svg>
            </button>
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="84" y="116" width="56" height="168" rx="8" fill="#1E40AF"/>
                    <rect x="176" y="84" width="56" height="200" rx="8" fill="#059669"/>
                    <rect x="268" y="156" width="48" height="128" rx="8" fill="#1E40AF"/>
                    <rect x="114" y="180" width="172" height="20" rx="10" fill="#F59E0B"/>
                </svg>
                <span class="text-xl font-semibold text-white">SkillBridge</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative" id="userProfileContainer">
                <button id="userProfileToggle" class="flex items-center gap-2 text-white hover:text-accent-gold-500 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2 focus:ring-offset-brand-primary-800 rounded-md p-2">
                    <div class="w-8 h-8 bg-accent-gold-500 rounded-full flex items-center justify-center">
                        <span id="userInitials" class="text-sm font-semibold text-white">JD</span>
                    </div>
                    <svg class="w-4 h-4" data-lucide="chevron-down"></svg>
                </button>
                <!-- Dropdown Menu -->
                <div id="userProfileDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 z-50">
                    <div class="px-4 py-3 border-b border-neutral-200">
                        <p id="userDisplayName" class="text-sm font-semibold text-neutral-900">John Doe</p>
                        <p id="userEmail" class="text-xs text-neutral-500">johndoe@example.com</p>
                        <p class="text-xs text-accent-gold-600 font-medium">System Administrator</p>
                    </div>
                    <button id="signOutButton" class="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <svg class="w-4 h-4" data-lucide="log-out"></svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="fixed md:sticky top-16 left-0 w-64 bg-white border-r border-neutral-200 h-[calc(100vh-4rem)] overflow-y-auto z-20 transform -translate-x-full md:translate-x-0 transition-transform duration-200">
            <nav class="p-4 space-y-1">
                <!-- Admin Dashboard -->
                <a href="dashboard.html" id="nav-dashboard" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                    <svg class="w-5 h-5" data-lucide="layout-dashboard"></svg>
                    <span>Admin Dashboard</span>
                </a>

                <!-- Employees with Children -->
                <div class="nav-group">
                    <button class="nav-group-toggle flex items-center justify-between w-full px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" data-lucide="users"></svg>
                            <span>Employees</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform" data-lucide="chevron-right"></svg>
                    </button>
                    <div class="nav-group-children hidden ml-8 space-y-1 mt-1">
                        <a href="employees_list.html" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Employee Directory</a>
                        <a href="employee_upsert.html?mode=create" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Add Employee</a>
                    </div>
                </div>

                <!-- Departments -->
                <a href="departments_list.html" id="nav-departments" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                    <svg class="w-5 h-5" data-lucide="building"></svg>
                    <span>Departments</span>
                </a>

                <!-- Skill Categories -->
                <a href="skill_categories_list.html" id="nav-skill-categories" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                    <svg class="w-5 h-5" data-lucide="layers"></svg>
                    <span>Skill Categories</span>
                </a>

                <!-- Criticality Levels -->
                <a href="skill_criticalities_list.html" id="nav-criticalities" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                    <svg class="w-5 h-5" data-lucide="sliders"></svg>
                    <span>Criticality Levels</span>
                </a>

                <!-- Skills with Children -->
                <div class="nav-group">
                    <button class="nav-group-toggle flex items-center justify-between w-full px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" data-lucide="book"></svg>
                            <span>Skills</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform" data-lucide="chevron-right"></svg>
                    </button>
                    <div class="nav-group-children hidden ml-8 space-y-1 mt-1">
                        <a href="skills_list.html" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Skills Directory</a>
                        <a href="skill_upsert.html?mode=create" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Add Skill</a>
                    </div>
                </div>

                <!-- Assessment Cycles with Children -->
                <div class="nav-group">
                    <button class="nav-group-toggle flex items-center justify-between w-full px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" data-lucide="calendar"></svg>
                            <span>Assessment Cycles</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform" data-lucide="chevron-right"></svg>
                    </button>
                    <div class="nav-group-children hidden ml-8 space-y-1 mt-1">
                        <a href="assessment_cycles_list.html" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Cycles Directory</a>
                        <a href="assessment_cycle_upsert.html?mode=create" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Create Cycle</a>
                    </div>
                </div>

                <!-- Trainer Pool with Children -->
                <div class="nav-group">
                    <button class="nav-group-toggle flex items-center justify-between w-full px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" data-lucide="users"></svg>
                            <span>Trainer Pool</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform" data-lucide="chevron-right"></svg>
                    </button>
                    <div class="nav-group-children hidden ml-8 space-y-1 mt-1">
                        <a href="trainers_list.html" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Trainer Directory</a>
                        <a href="external_trainer_upsert.html?mode=create" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Add External Trainer</a>
                    </div>
                </div>

                <!-- Training Sessions with Children -->
                <div class="nav-group">
                    <button class="nav-group-toggle flex items-center justify-between w-full px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5" data-lucide="calendar"></svg>
                            <span>Training Sessions</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform" data-lucide="chevron-right"></svg>
                    </button>
                    <div class="nav-group-children hidden ml-8 space-y-1 mt-1">
                        <a href="training_sessions_list.html" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Sessions Calendar</a>
                        <a href="training_session_upsert.html?mode=create" class="nav-item block px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-brand-primary-600">Create Session</a>
                    </div>
                </div>

                <!-- Disputes -->
                <a href="disputes_list.html" id="nav-disputes" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                    <svg class="w-5 h-5" data-lucide="alert-circle"></svg>
                    <span>Disputes</span>
                </a>

                <!-- Analytics Section -->
                <div class="border-t border-neutral-200 pt-4 mt-4">
                    <h4 class="px-3 text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-2">Analytics</h4>
                    
                    <a href="analytics_skill_gap_heatmap.html" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <svg class="w-5 h-5" data-lucide="grid"></svg>
                        <span>Skill Gap Heatmap</span>
                    </a>

                    <a href="analytics_tni_dashboard.html" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <svg class="w-5 h-5" data-lucide="bar-chart-2"></svg>
                        <span>TNI Dashboard</span>
                    </a>

                    <a href="analytics_training_forecast.html" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <svg class="w-5 h-5" data-lucide="trending-up"></svg>
                        <span>Training Forecast</span>
                    </a>

                    <a href="analytics_assessment_completion.html" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <svg class="w-5 h-5" data-lucide="pie-chart"></svg>
                        <span>Assessment Completion</span>
                    </a>

                    <a href="analytics_dispute_metrics.html" class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-brand-primary-600">
                        <svg class="w-5 h-5" data-lucide="bar-chart"></svg>
                        <span>Dispute Analytics</span>
                    </a>
                </div>
            </nav>
            
            <!-- Footer -->
            <div class="absolute bottom-4 w-full text-center text-xs text-neutral-500 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-10 md:hidden"></div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto">
            
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl leading-8 font-bold text-neutral-950">Dispute Analytics</h1>
    <p class="text-sm leading-5 text-neutral-700">Reveal quality issues and process bottlenecks to drive improvements</p>
  </div>
  <button id="btn-refresh" class="inline-flex items-center gap-2 px-4 py-2 rounded-md border border-neutral-200 bg-white text-neutral-900 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 focus:ring-offset-2" aria-label="Refresh data">
    <svg class="w-4 h-4" data-lucide="refresh-cw"></svg>
    Refresh
  </button>
</div>

<!-- Tab Navigation -->
<div class="bg-white border border-neutral-200 rounded-md mb-6">
  <nav class="flex" role="tablist">
    <button id="tab-team-lead" class="tab-button active flex-1 px-6 py-3 text-sm font-medium text-brand-primary-600 border-b-2 border-brand-primary-600 bg-accent-gold-50" role="tab" aria-selected="true" aria-controls="panel-team-lead">
      Team Lead Analysis
    </button>
    <button id="tab-resolution" class="tab-button flex-1 px-6 py-3 text-sm font-medium text-neutral-700 border-b-2 border-transparent hover:text-brand-primary-600 hover:border-neutral-200" role="tab" aria-selected="false" aria-controls="panel-resolution">
      Resolution Metrics
    </button>
  </nav>
</div>

<!-- Team Lead Analysis Tab -->
<div id="panel-team-lead" class="tab-panel" role="tabpanel" aria-labelledby="tab-team-lead">
  <!-- Team Lead Performance Table -->
  <div class="bg-white border border-neutral-200 rounded-md shadow-sm">
    <div class="px-6 py-4 border-b border-neutral-200">
      <h2 class="text-base leading-6 font-semibold text-neutral-950">Team Lead Dispute Performance</h2>
      <p class="text-xs leading-4 text-neutral-500 mt-1">Click on a team lead name to view details or dispute counts for drill-down analysis</p>
    </div>
    
    <!-- Table Skeleton -->
    <div id="team-lead-skeleton" class="p-6">
      <div class="space-y-3">
        <div class="h-4 bg-neutral-200 rounded animate-pulse"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-4/5"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-3/4"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-5/6"></div>
      </div>
    </div>
    
    <!-- Actual Table -->
    <div id="team-lead-table-container" class="hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm leading-5">
          <thead class="bg-neutral-50 text-neutral-700">
            <tr>
              <th class="text-left font-semibold px-6 py-3 border-b border-neutral-200">Team Lead</th>
              <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Department</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Total Assessments</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Total Disputes</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Dispute Rate %</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Re-escalation Rate %</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Avg Resolution Time</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Status</th>
            </tr>
          </thead>
          <tbody id="team-lead-table-body" class="divide-y divide-neutral-200">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
      
      <!-- Empty State -->
      <div id="team-lead-empty" class="hidden text-center py-12">
        <svg class="mx-auto h-12 w-12 text-neutral-400" data-lucide="users"></svg>
        <h3 class="mt-2 text-sm font-medium text-neutral-900">No team lead data</h3>
        <p class="mt-1 text-sm text-neutral-500">There are no team leads with assessment or dispute data to display.</p>
      </div>
    </div>
  </div>
</div>

<!-- Resolution Metrics Tab -->
<div id="panel-resolution" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-resolution">
  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <!-- Avg Resolution Time -->
    <div class="bg-white border border-neutral-200 rounded-md p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs leading-4 text-neutral-500 uppercase tracking-wider font-medium">Avg Resolution Time</p>
          <div id="avg-resolution-skeleton" class="h-8 w-16 bg-neutral-200 rounded animate-pulse mt-2"></div>
          <p id="avg-resolution-value" class="text-2xl leading-8 font-bold text-neutral-950 hidden">N/A</p>
        </div>
        <div class="w-12 h-12 bg-info-600 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" data-lucide="clock"></svg>
        </div>
      </div>
    </div>

    <!-- Re-escalation Rate -->
    <div class="bg-white border border-neutral-200 rounded-md p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs leading-4 text-neutral-500 uppercase tracking-wider font-medium">Re-escalation Rate</p>
          <div id="reescalation-skeleton" class="h-8 w-16 bg-neutral-200 rounded animate-pulse mt-2"></div>
          <p id="reescalation-value" class="text-2xl leading-8 font-bold text-neutral-950 hidden">N/A</p>
        </div>
        <div class="w-12 h-12 bg-warning-600 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" data-lucide="trending-up"></svg>
        </div>
      </div>
    </div>

    <!-- Total Open Disputes -->
    <div class="bg-white border border-neutral-200 rounded-md p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs leading-4 text-neutral-500 uppercase tracking-wider font-medium">Total Open Disputes</p>
          <div id="open-disputes-skeleton" class="h-8 w-12 bg-neutral-200 rounded animate-pulse mt-2"></div>
          <p id="open-disputes-value" class="text-2xl leading-8 font-bold text-neutral-950 hidden">N/A</p>
        </div>
        <div class="w-12 h-12 bg-danger-600 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" data-lucide="alert-circle"></svg>
        </div>
      </div>
    </div>

    <!-- Longest Open Dispute -->
    <div class="bg-white border border-neutral-200 rounded-md p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs leading-4 text-neutral-500 uppercase tracking-wider font-medium">Longest Open Dispute</p>
          <div id="longest-dispute-skeleton" class="h-8 w-16 bg-neutral-200 rounded animate-pulse mt-2"></div>
          <p id="longest-dispute-value" class="text-2xl leading-8 font-bold text-neutral-950 hidden">N/A</p>
        </div>
        <div class="w-12 h-12 bg-heat-red rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" data-lucide="calendar-x"></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend Chart -->
  <div class="bg-white border border-neutral-200 rounded-md shadow-sm mb-6">
    <div class="px-6 py-4 border-b border-neutral-200">
      <h2 class="text-base leading-6 font-semibold text-neutral-950">Disputes Raised vs Resolved Trend</h2>
      <p class="text-xs leading-4 text-neutral-500 mt-1">Monthly comparison of dispute volumes and resolution rates</p>
    </div>
    <div class="p-6">
      <!-- Chart Skeleton -->
      <div id="trend-chart-skeleton" class="h-64 bg-neutral-200 rounded animate-pulse"></div>
      
      <!-- Actual Chart Container -->
      <div id="trend-chart" class="hidden h-64"></div>
      
      <!-- Chart Empty State -->
      <div id="trend-chart-empty" class="hidden text-center py-16">
        <svg class="mx-auto h-12 w-12 text-neutral-400" data-lucide="bar-chart-2"></svg>
        <h3 class="mt-2 text-sm font-medium text-neutral-900">No trend data available</h3>
        <p class="mt-1 text-sm text-neutral-500">Insufficient dispute data to generate trend analysis.</p>
      </div>
    </div>
  </div>

  <!-- Admin Performance Table -->
  <div class="bg-white border border-neutral-200 rounded-md shadow-sm">
    <div class="px-6 py-4 border-b border-neutral-200">
      <h2 class="text-base leading-6 font-semibold text-neutral-950">Admin Resolution Performance</h2>
      <p class="text-xs leading-4 text-neutral-500 mt-1">System administrators handling dispute resolutions</p>
    </div>
    
    <!-- Table Skeleton -->
    <div id="admin-table-skeleton" class="p-6">
      <div class="space-y-3">
        <div class="h-4 bg-neutral-200 rounded animate-pulse"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-4/5"></div>
        <div class="h-4 bg-neutral-200 rounded animate-pulse w-3/4"></div>
      </div>
    </div>
    
    <!-- Actual Table -->
    <div id="admin-table-container" class="hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm leading-5">
          <thead class="bg-neutral-50 text-neutral-700">
            <tr>
              <th class="text-left font-semibold px-6 py-3 border-b border-neutral-200">Admin Name</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Disputes Resolved</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Avg Resolution Time</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Edit Rate %</th>
              <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Dismiss Rate %</th>
            </tr>
          </thead>
          <tbody id="admin-table-body" class="divide-y divide-neutral-200">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
      
      <!-- Empty State -->
      <div id="admin-table-empty" class="hidden text-center py-12">
        <svg class="mx-auto h-12 w-12 text-neutral-400" data-lucide="user-check"></svg>
        <h3 class="mt-2 text-sm font-medium text-neutral-900">No admin data</h3>
        <p class="mt-1 text-sm text-neutral-500">There are no admins with dispute resolution data to display.</p>
      </div>
    </div>
  </div>
</div>

<!-- Team Lead Detail Modal -->
<div id="team-lead-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg border border-neutral-200 shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-200">
      <div>
        <h2 class="text-xl leading-7 font-semibold text-neutral-950">Team Lead Dispute Details</h2>
        <p id="modal-team-lead-name" class="text-sm leading-5 text-neutral-700"></p>
      </div>
      <button id="modal-close" class="p-2 rounded-md text-neutral-400 hover:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-accent-gold-600" aria-label="Close modal">
        <svg class="w-5 h-5" data-lucide="x"></svg>
      </button>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-theme(spacing.20))]">
      <!-- Common Disputed Skills -->
      <div class="mb-6">
        <h3 class="text-base leading-6 font-semibold text-neutral-950 mb-3">Most Commonly Disputed Skills</h3>
        <div id="disputed-skills-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- Dynamic skill badges -->
        </div>
      </div>
      
      <!-- Disputes Table -->
      <div>
        <h3 class="text-base leading-6 font-semibold text-neutral-950 mb-3">Individual Disputes</h3>
        
        <!-- Modal Table Skeleton -->
        <div id="modal-table-skeleton" class="space-y-3">
          <div class="h-4 bg-neutral-200 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-200 rounded animate-pulse w-4/5"></div>
          <div class="h-4 bg-neutral-200 rounded animate-pulse w-3/4"></div>
        </div>
        
        <!-- Modal Table -->
        <div id="modal-table-container" class="hidden overflow-x-auto border border-neutral-200 rounded-md">
          <table class="w-full text-sm leading-5">
            <thead class="bg-neutral-50 text-neutral-700">
              <tr>
                <th class="text-left font-semibold px-4 py-3 border-b border-neutral-200">Dispute ID</th>
                <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Employee</th>
                <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Skills Disputed</th>
                <th class="text-center font-semibold px-3 py-3 border-b border-neutral-200">Status</th>
                <th class="text-left font-semibold px-3 py-3 border-b border-neutral-200">Resolution</th>
              </tr>
            </thead>
            <tbody id="modal-table-body" class="divide-y divide-neutral-200">
              <!-- Dynamic content -->
            </tbody>
          </table>
        </div>
        
        <!-- Modal Empty State -->
        <div id="modal-table-empty" class="hidden text-center py-8">
          <svg class="mx-auto h-8 w-8 text-neutral-400" data-lucide="file-search"></svg>
          <h3 class="mt-2 text-sm font-medium text-neutral-900">No disputes found</h3>
          <p class="mt-1 text-sm text-neutral-500">This team lead has no disputes to display.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Overlay for Modal -->
<div id="modal-overlay" class="hidden fixed inset-0 bg-black/50 z-40 md:hidden"></div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        mobileMenuToggle?.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            mobileOverlay.classList.toggle('hidden');
        });

        mobileOverlay?.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            mobileOverlay.classList.add('hidden');
        });

        // Navigation group toggles
        document.querySelectorAll('.nav-group-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                const children = toggle.nextElementSibling;
                const icon = toggle.querySelector('svg:last-child');
                
                children.classList.toggle('hidden');
                icon.classList.toggle('rotate-90');
            });
        });

        // User profile dropdown
        const userProfileToggle = document.getElementById('userProfileToggle');
        const userProfileDropdown = document.getElementById('userProfileDropdown');

        userProfileToggle?.addEventListener('click', () => {
            userProfileDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userProfileToggle?.contains(e.target) && !userProfileDropdown?.contains(e.target)) {
                userProfileDropdown?.classList.add('hidden');
            }
        });

        // Sign out functionality
        document.getElementById('signOutButton')?.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Failed to sign out', 'error');
            }
        });

        // Auth state management
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/auth.html';
                return;
            }

            // Load user profile data
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userData = userDoc.exists() ? userDoc.data() : null;

                // Update UI with user data
                const displayName = userData?.firstName && userData?.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : user.displayName || 'John Doe';
                
                const email = user.email || 'johndoe@example.com';
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();

                document.getElementById('userDisplayName').textContent = displayName;
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userInitials').textContent = initials;

            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to default values
                document.getElementById('userDisplayName').textContent = 'John Doe';
                document.getElementById('userEmail').textContent = user.email || 'johndoe@example.com';
                document.getElementById('userInitials').textContent = 'JD';
            }
        });

        // Set active navigation item based on current page
        function setActiveNavItem() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href && currentPath.includes(href.split('?')[0])) {
                    item.classList.add('bg-accent-gold-50', 'text-brand-primary-600', 'border-l-2', 'border-brand-primary-600');
                    item.classList.remove('text-neutral-700', 'text-neutral-600');
                    
                    // Expand parent group if needed
                    const parentGroup = item.closest('.nav-group');
                    if (parentGroup) {
                        const children = parentGroup.querySelector('.nav-group-children');
                        const icon = parentGroup.querySelector('.nav-group-toggle svg:last-child');
                        children?.classList.remove('hidden');
                        icon?.classList.add('rotate-90');
                    }
                }
            });
        }

        // Initialize active nav state
        setActiveNavItem();
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    collection, getDocs, doc, getDoc, query, where, orderBy, limit,
    getCountFromServer, Timestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { auth, getDb } from './scripts/firebase.js';
  import { showToast, showLoader, hideLoader } from './scripts/main.js';

  const db = getDb();
  let currentAbort;
  let teamLeadData = [];
  let isInitialLoad = true;

  // Auth check
  onAuthStateChanged(auth, user => {
    if (!user) {
      location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
      return;
    }
    if (isInitialLoad) {
      isInitialLoad = false;
      funInitialLoad();
    }
  });

  // Initialize Lucide icons
  lucide.createIcons();

  // Utility functions
  function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      });
    } catch {
      return 'N/A';
    }
  }

  function formatDaysAgo(dateStr) {
    if (!dateStr) return 'N/A';
    try {
      const date = new Date(dateStr);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return `${diffDays} days`;
    } catch {
      return 'N/A';
    }
  }

  function getStatusIndicator(disputeRate, reescalationRate) {
    const rate = parseFloat(disputeRate) || 0;
    const reRate = parseFloat(reescalationRate) || 0;
    
    if (rate <= 5 && reRate <= 10) {
      return { color: 'bg-success-600', text: 'Good', textColor: 'text-white' };
    } else if (rate <= 15 && reRate <= 25) {
      return { color: 'bg-warning-600', text: 'At Risk', textColor: 'text-white' };
    } else {
      return { color: 'bg-danger-600', text: 'Poor', textColor: 'text-white' };
    }
  }

  // Abortable fetch wrapper
  async function abortableFetch(fetchFn) {
    if (currentAbort) currentAbort.abort();
    currentAbort = new AbortController();
    const signal = currentAbort.signal;

    try {
      const result = await fetchFn();
      if (signal.aborted) return null;
      return result;
    } catch (error) {
      if (signal.aborted) return null;
      console.error('Fetch error:', error);
      showToast(error?.message || 'Failed to fetch data', 'error');
      return null;
    }
  }

  // Concurrency limiter
  function createSemaphore(max = 2) {
    const queue = [];
    let active = 0;
    const next = () => {
      if (active >= max || queue.length === 0) return;
      active++;
      const { fn, res, rej } = queue.shift();
      Promise.resolve()
        .then(fn)
        .then(v => res(v))
        .catch(e => rej(e))
        .finally(() => { active--; next(); });
    };
    return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
  }
  const withLimit = createSemaphore(2);

  // Data fetching functions
  async function funFetchTeamLeadAnalysis() {
    return abortableFetch(async () => {
      const [assessmentsSnapshot, disputesSnapshot, usersSnapshot, departmentsSnapshot] = await Promise.all([
        withLimit(() => getDocs(query(collection(db, 'assessments'), where('status', '==', 'active')))),
        withLimit(() => getDocs(collection(db, 'disputes'))),
        getDocs(query(collection(db, 'users'), where('role', '==', 'teamLead'))),
        getDocs(collection(db, 'departments'))
      ]);

      // Create lookup maps
      const departmentMap = new Map();
      departmentsSnapshot.docs.forEach(doc => {
        departmentMap.set(doc.id, doc.data().name);
      });

      const teamLeadMap = new Map();
      usersSnapshot.docs.forEach(doc => {
        const data = doc.data();
        teamLeadMap.set(doc.id, {
          name: `${data.firstName || ''} ${data.lastName || ''}`.trim(),
          departmentId: data.departmentId
        });
      });

      // Process assessments by team lead
      const assessmentsByTeamLead = new Map();
      assessmentsSnapshot.docs.forEach(doc => {
        const data = doc.data();
        const teamLeadId = data.assessedByEmployeeId;
        if (teamLeadId && teamLeadMap.has(teamLeadId)) {
          if (!assessmentsByTeamLead.has(teamLeadId)) {
            assessmentsByTeamLead.set(teamLeadId, []);
          }
          assessmentsByTeamLead.get(teamLeadId).push({ id: doc.id, ...data });
        }
      });

      // Process disputes by team lead
      const disputesByTeamLead = new Map();
      const reescalationsByTeamLead = new Map();
      
      await Promise.all(disputesSnapshot.docs.map(async disputeDoc => {
        const disputeData = disputeDoc.data();
        const employeeId = disputeData.employeeId;
        
        if (!employeeId) return;
        
        // Find assessments for this employee to determine team lead
        const employeeAssessments = assessmentsSnapshot.docs.filter(doc => 
          doc.data().employeeId === employeeId
        );
        
        for (const assessmentDoc of employeeAssessments) {
          const teamLeadId = assessmentDoc.data().assessedByEmployeeId;
          if (teamLeadId && teamLeadMap.has(teamLeadId)) {
            if (!disputesByTeamLead.has(teamLeadId)) {
              disputesByTeamLead.set(teamLeadId, []);
            }
            disputesByTeamLead.get(teamLeadId).push({ id: disputeDoc.id, ...disputeData });

            // Check for re-escalations in audit trail
            const auditTrail = disputeData.auditTrail || [];
            const hasReescalation = auditTrail.some(entry => 
              entry.action === 'reopen' || entry.action === 're-escalated'
            );
            
            if (hasReescalation) {
              if (!reescalationsByTeamLead.has(teamLeadId)) {
                reescalationsByTeamLead.set(teamLeadId, 0);
              }
              reescalationsByTeamLead.set(teamLeadId, reescalationsByTeamLead.get(teamLeadId) + 1);
            }
            break; // Only count once per team lead
          }
        }
      }));

      // Calculate metrics
      const results = [];
      teamLeadMap.forEach((teamLead, teamLeadId) => {
        const assessments = assessmentsByTeamLead.get(teamLeadId) || [];
        const disputes = disputesByTeamLead.get(teamLeadId) || [];
        const reescalations = reescalationsByTeamLead.get(teamLeadId) || 0;
        
        const totalAssessments = assessments.length;
        const totalDisputes = disputes.length;
        const disputeRate = totalAssessments > 0 ? ((totalDisputes / totalAssessments) * 100).toFixed(1) : '0.0';
        const resolvedDisputes = disputes.filter(d => d.status === 'resolved').length;
        const reescalationRate = resolvedDisputes > 0 ? ((reescalations / resolvedDisputes) * 100).toFixed(1) : '0.0';
        
        // Calculate average resolution time
        const resolvedDisputesWithTime = disputes.filter(d => 
          d.status === 'resolved' && d.submissionDate && d.resolutionTimestamp
        );
        
        let avgResolutionTime = 'N/A';
        if (resolvedDisputesWithTime.length > 0) {
          const totalDays = resolvedDisputesWithTime.reduce((sum, dispute) => {
            const submitDate = new Date(dispute.submissionDate);
            const resolveDate = new Date(dispute.resolutionTimestamp);
            const daysDiff = Math.ceil((resolveDate - submitDate) / (1000 * 60 * 60 * 24));
            return sum + Math.max(daysDiff, 0);
          }, 0);
          avgResolutionTime = `${Math.round(totalDays / resolvedDisputesWithTime.length)} days`;
        }

        results.push({
          teamLeadId,
          name: teamLead.name || 'N/A',
          department: departmentMap.get(teamLead.departmentId) || 'N/A',
          totalAssessments,
          totalDisputes,
          disputeRate: parseFloat(disputeRate),
          reescalationRate: parseFloat(reescalationRate),
          avgResolutionTime,
          disputes
        });
      });

      return results.sort((a, b) => b.disputeRate - a.disputeRate);
    });
  }

  async function funFetchResolutionMetrics() {
    return abortableFetch(async () => {
      const [disputesSnapshot, usersSnapshot] = await Promise.all([
        withLimit(() => getDocs(collection(db, 'disputes'))),
        withLimit(() => getDocs(query(collection(db, 'users'), where('systemRole', '==', 'systemAdmin'))))
      ]);

      const disputes = disputesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const resolvedDisputes = disputes.filter(d => d.status === 'resolved');
      const openDisputes = disputes.filter(d => d.status === 'open');

      // Calculate KPIs
      let avgResolutionTime = 0;
      if (resolvedDisputes.length > 0) {
        const totalDays = resolvedDisputes.reduce((sum, dispute) => {
          if (dispute.submissionDate && dispute.resolutionTimestamp) {
            const submitDate = new Date(dispute.submissionDate);
            const resolveDate = new Date(dispute.resolutionTimestamp);
            const daysDiff = Math.ceil((resolveDate - submitDate) / (1000 * 60 * 60 * 24));
            return sum + Math.max(daysDiff, 0);
          }
          return sum;
        }, 0);
        avgResolutionTime = Math.round(totalDays / resolvedDisputes.length);
      }

      // Re-escalation rate
      const reescalations = disputes.filter(d => {
        const auditTrail = d.auditTrail || [];
        return auditTrail.some(entry => entry.action === 'reopen' || entry.action === 're-escalated');
      }).length;
      const reescalationRate = resolvedDisputes.length > 0 ? 
        ((reescalations / resolvedDisputes.length) * 100).toFixed(1) : 0;

      // Longest open dispute
      let longestOpenDays = 0;
      if (openDisputes.length > 0) {
        const now = new Date();
        longestOpenDays = Math.max(...openDisputes.map(dispute => {
          if (dispute.submissionDate) {
            const submitDate = new Date(dispute.submissionDate);
            return Math.ceil((now - submitDate) / (1000 * 60 * 60 * 24));
          }
          return 0;
        }));
      }

      // Admin performance
      const adminMap = new Map();
      usersSnapshot.docs.forEach(doc => {
        const data = doc.data();
        adminMap.set(doc.id, `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'N/A');
      });

      const adminStats = new Map();
      resolvedDisputes.forEach(dispute => {
        const adminId = dispute.resolvedByAdminId;
        if (adminId && adminMap.has(adminId)) {
          if (!adminStats.has(adminId)) {
            adminStats.set(adminId, {
              name: adminMap.get(adminId),
              resolved: 0,
              totalDays: 0,
              edits: 0,
              dismissals: 0
            });
          }
          
          const stats = adminStats.get(adminId);
          stats.resolved++;
          
          // Resolution time
          if (dispute.submissionDate && dispute.resolutionTimestamp) {
            const submitDate = new Date(dispute.submissionDate);
            const resolveDate = new Date(dispute.resolutionTimestamp);
            const daysDiff = Math.ceil((resolveDate - submitDate) / (1000 * 60 * 60 * 24));
            stats.totalDays += Math.max(daysDiff, 0);
          }
          
          // Resolution type
          if (dispute.resolutionAction === 'editRating') stats.edits++;
          else if (dispute.resolutionAction === 'dismiss') stats.dismissals++;
        }
      });

      const adminPerformance = Array.from(adminStats.entries()).map(([adminId, stats]) => ({
        adminId,
        name: stats.name,
        disputesResolved: stats.resolved,
        avgResolutionTime: stats.resolved > 0 ? `${Math.round(stats.totalDays / stats.resolved)} days` : 'N/A',
        editRate: stats.resolved > 0 ? ((stats.edits / stats.resolved) * 100).toFixed(1) : '0.0',
        dismissRate: stats.resolved > 0 ? ((stats.dismissals / stats.resolved) * 100).toFixed(1) : '0.0'
      })).sort((a, b) => b.disputesResolved - a.disputesResolved);

      // Trend data (simplified monthly aggregation)
      const trendData = funCalculateTrendData(disputes);

      return {
        kpis: {
          avgResolutionTime: avgResolutionTime > 0 ? `${avgResolutionTime} days` : 'N/A',
          reescalationRate: `${reescalationRate}%`,
          totalOpenDisputes: openDisputes.length.toString(),
          longestOpenDispute: longestOpenDays > 0 ? `${longestOpenDays} days` : 'N/A'
        },
        adminPerformance,
        trendData
      };
    });
  }

  function funCalculateTrendData(disputes) {
    const monthlyData = new Map();
    
    disputes.forEach(dispute => {
      if (dispute.submissionDate) {
        const date = new Date(dispute.submissionDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!monthlyData.has(monthKey)) {
          monthlyData.set(monthKey, { raised: 0, resolved: 0 });
        }
        
        monthlyData.get(monthKey).raised++;
        
        if (dispute.status === 'resolved' && dispute.resolutionTimestamp) {
          const resolveDate = new Date(dispute.resolutionTimestamp);
          const resolveMonthKey = `${resolveDate.getFullYear()}-${String(resolveDate.getMonth() + 1).padStart(2, '0')}`;
          
          if (!monthlyData.has(resolveMonthKey)) {
            monthlyData.set(resolveMonthKey, { raised: 0, resolved: 0 });
          }
          
          monthlyData.get(resolveMonthKey).resolved++;
        }
      }
    });

    // Get last 6 months
    const months = Array.from(monthlyData.keys())
      .sort()
      .slice(-6)
      .map(month => ({
        month,
        raised: monthlyData.get(month)?.raised || 0,
        resolved: monthlyData.get(month)?.resolved || 0
      }));

    return months;
  }

  // Rendering functions
  function funRenderTeamLeadTable(data) {
    const tbody = document.getElementById('team-lead-table-body');
    const container = document.getElementById('team-lead-table-container');
    const skeleton = document.getElementById('team-lead-skeleton');
    const empty = document.getElementById('team-lead-empty');

    skeleton.classList.add('hidden');
    
    if (!data || data.length === 0) {
      container.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    tbody.innerHTML = data.map(row => {
      const status = getStatusIndicator(row.disputeRate, row.reescalationRate);
      return `
        <tr class="hover:bg-neutral-50 focus-within:bg-neutral-50">
          <td class="px-6 py-3">
            <button class="team-lead-btn text-left font-medium text-brand-primary-600 hover:text-brand-primary-700 focus:outline-none focus:ring-2 focus:ring-accent-gold-600 rounded" 
                    data-team-lead-id="${row.teamLeadId}" data-team-lead-name="${row.name}">
              ${row.name}
            </button>
          </td>
          <td class="px-3 py-3 text-neutral-900">${row.department}</td>
          <td class="px-3 py-3 text-center text-neutral-900">${row.totalAssessments.toLocaleString()}</td>
          <td class="px-3 py-3 text-center">
            ${row.totalDisputes > 0 ? 
              `<button class="team-lead-disputes-btn text-brand-primary-600 hover:text-brand-primary-700 font-medium focus:outline-none focus:ring-2 focus:ring-accent-gold-600 rounded" 
                       data-team-lead-id="${row.teamLeadId}" data-team-lead-name="${row.name}">
                ${row.totalDisputes.toLocaleString()}
               </button>` : 
              `<span class="text-neutral-900">${row.totalDisputes}</span>`
            }
          </td>
          <td class="px-3 py-3 text-center text-neutral-900">${row.disputeRate.toFixed(1)}%</td>
          <td class="px-3 py-3 text-center text-neutral-900">${row.reescalationRate.toFixed(1)}%</td>
          <td class="px-3 py-3 text-center text-neutral-900">${row.avgResolutionTime}</td>
          <td class="px-3 py-3 text-center">
            <span class="inline-flex items-center px-2 py-1 text-xs rounded-full ${status.color} ${status.textColor}">
              ${status.text}
            </span>
          </td>
        </tr>
      `;
    }).join('');

    container.classList.remove('hidden');
    empty.classList.add('hidden');

    // Add event listeners
    tbody.querySelectorAll('.team-lead-btn, .team-lead-disputes-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const teamLeadId = e.target.dataset.teamLeadId;
        const teamLeadName = e.target.dataset.teamLeadName;
        funShowTeamLeadModal(teamLeadId, teamLeadName);
      });
    });

    // Store data for modal use
    teamLeadData = data;
  }

  function funRenderResolutionMetrics(data) {
    // Render KPIs
    const kpis = data.kpis;
    
    ['avg-resolution', 'reescalation', 'open-disputes', 'longest-dispute'].forEach(id => {
      document.getElementById(`${id}-skeleton`).classList.add('hidden');
      document.getElementById(`${id}-value`).classList.remove('hidden');
    });

    document.getElementById('avg-resolution-value').textContent = kpis.avgResolutionTime;
    document.getElementById('reescalation-value').textContent = kpis.reescalationRate;
    document.getElementById('open-disputes-value').textContent = kpis.totalOpenDisputes;
    document.getElementById('longest-dispute-value').textContent = kpis.longestOpenDispute;

    // Render trend chart
    funRenderTrendChart(data.trendData);

    // Render admin table
    funRenderAdminTable(data.adminPerformance);
  }

  async function funRenderTrendChart(trendData) {
    const container = document.getElementById('trend-chart');
    const skeleton = document.getElementById('trend-chart-skeleton');
    const empty = document.getElementById('trend-chart-empty');

    await new Promise(r => requestAnimationFrame(() => r()));

    skeleton.classList.add('hidden');

    if (!trendData || trendData.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    container.classList.remove('hidden');

    const chart = echarts.init(container);
    const option = {
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'cross' }
      },
      legend: {
        data: ['Disputes Raised', 'Disputes Resolved'],
        bottom: 0
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '15%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: trendData.map(item => {
          const [year, month] = item.month.split('-');
          const date = new Date(year, month - 1);
          return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        }),
        axisLabel: { fontSize: 11 }
      },
      yAxis: {
        type: 'value',
        axisLabel: { fontSize: 11 }
      },
      series: [
        {
          name: 'Disputes Raised',
          type: 'bar',
          data: trendData.map(item => item.raised),
          itemStyle: { color: '#DC2626' }
        },
        {
          name: 'Disputes Resolved',
          type: 'bar',
          data: trendData.map(item => item.resolved),
          itemStyle: { color: '#16A34A' }
        }
      ]
    };

    chart.setOption(option);

    // Handle resize
    const resizeHandler = () => chart.resize();
    window.addEventListener('resize', resizeHandler);
  }

  function funRenderAdminTable(data) {
    const tbody = document.getElementById('admin-table-body');
    const container = document.getElementById('admin-table-container');
    const skeleton = document.getElementById('admin-table-skeleton');
    const empty = document.getElementById('admin-table-empty');

    skeleton.classList.add('hidden');
    
    if (!data || data.length === 0) {
      container.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    tbody.innerHTML = data.map(row => `
      <tr class="hover:bg-neutral-50">
        <td class="px-6 py-3 text-neutral-900 font-medium">${row.name}</td>
        <td class="px-3 py-3 text-center text-neutral-900">${row.disputesResolved.toLocaleString()}</td>
        <td class="px-3 py-3 text-center text-neutral-900">${row.avgResolutionTime}</td>
        <td class="px-3 py-3 text-center text-neutral-900">${row.editRate}%</td>
        <td class="px-3 py-3 text-center text-neutral-900">${row.dismissRate}%</td>
      </tr>
    `).join('');

    container.classList.remove('hidden');
    empty.classList.add('hidden');
  }

  // Modal functions
  async function funShowTeamLeadModal(teamLeadId, teamLeadName) {
    const modal = document.getElementById('team-lead-modal');
    const modalName = document.getElementById('modal-team-lead-name');
    
    modalName.textContent = teamLeadName;
    modal.classList.remove('hidden');
    
    // Show skeleton
    document.getElementById('modal-table-skeleton').classList.remove('hidden');
    document.getElementById('modal-table-container').classList.add('hidden');
    document.getElementById('modal-table-empty').classList.add('hidden');
    
    // Find team lead data
    const teamLead = teamLeadData.find(tl => tl.teamLeadId === teamLeadId);
    if (!teamLead) {
      document.getElementById('modal-table-empty').classList.remove('hidden');
      document.getElementById('modal-table-skeleton').classList.add('hidden');
      return;
    }

    // Load detailed dispute data
    await funLoadTeamLeadDisputeDetails(teamLeadId, teamLead.disputes);
  }

  async function funLoadTeamLeadDisputeDetails(teamLeadId, disputes) {
    try {
      // Fetch additional data
      const [skillsSnapshot, usersSnapshot] = await Promise.all([
        withLimit(() => getDocs(collection(db, 'skills'))),
        withLimit(() => getDocs(collection(db, 'users')))
      ]);

      const skillsMap = new Map();
      skillsSnapshot.docs.forEach(doc => {
        skillsMap.set(doc.id, doc.data().name);
      });

      const usersMap = new Map();
      usersSnapshot.docs.forEach(doc => {
        const data = doc.data();
        usersMap.set(doc.id, `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'N/A');
      });

      // Process common disputed skills
      const skillCount = new Map();
      disputes.forEach(dispute => {
        const disputedSkills = dispute.disputedSkills || [];
        disputedSkills.forEach(skill => {
          if (skill.skillId) {
            const skillName = skillsMap.get(skill.skillId) || 'Unknown Skill';
            skillCount.set(skillName, (skillCount.get(skillName) || 0) + 1);
          }
        });
      });

      const topSkills = Array.from(skillCount.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      // Render common skills
      const skillsContainer = document.getElementById('disputed-skills-container');
      skillsContainer.innerHTML = topSkills.map(([skillName, count]) => `
        <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-md border border-neutral-200">
          <span class="text-sm font-medium text-neutral-900">${skillName}</span>
          <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-danger-600 text-white">
            ${count} dispute${count !== 1 ? 's' : ''}
          </span>
        </div>
      `).join('');

      if (topSkills.length === 0) {
        skillsContainer.innerHTML = '<p class="text-sm text-neutral-500 col-span-full text-center py-4">No disputed skills data available</p>';
      }

      // Render disputes table
      funRenderModalDisputesTable(disputes, skillsMap, usersMap);

    } catch (error) {
      console.error('Error loading dispute details:', error);
      showToast('Failed to load dispute details', 'error');
      document.getElementById('modal-table-empty').classList.remove('hidden');
      document.getElementById('modal-table-skeleton').classList.add('hidden');
    }
  }

  function funRenderModalDisputesTable(disputes, skillsMap, usersMap) {
    const tbody = document.getElementById('modal-table-body');
    const container = document.getElementById('modal-table-container');
    const skeleton = document.getElementById('modal-table-skeleton');
    const empty = document.getElementById('modal-table-empty');

    skeleton.classList.add('hidden');

    if (!disputes || disputes.length === 0) {
      container.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    tbody.innerHTML = disputes.map(dispute => {
      const skillsList = (dispute.disputedSkills || [])
        .map(skill => skillsMap.get(skill.skillId) || 'Unknown')
        .join(', ');
      
      const statusClass = dispute.status === 'resolved' ? 'bg-success-600 text-white' : 'bg-warning-600 text-white';
      
      return `
        <tr class="hover:bg-neutral-50">
          <td class="px-4 py-3">
            <a href="dispute_detail.html?disputeId=${dispute.id}" 
               class="text-brand-primary-600 hover:text-brand-primary-700 font-medium focus:outline-none focus:ring-2 focus:ring-accent-gold-600 rounded">
              ${dispute.id.substring(0, 8)}...
            </a>
          </td>
          <td class="px-3 py-3 text-neutral-900">${usersMap.get(dispute.employeeId) || 'N/A'}</td>
          <td class="px-3 py-3 text-neutral-700 text-sm">${skillsList || 'N/A'}</td>
          <td class="px-3 py-3 text-center">
            <span class="inline-flex items-center px-2 py-1 text-xs rounded-full ${statusClass}">
              ${dispute.status}
            </span>
          </td>
          <td class="px-3 py-3 text-neutral-700 text-sm">${dispute.resolutionNotes || dispute.rejectionReason || 'N/A'}</td>
        </tr>
      `;
    }).join('');

    container.classList.remove('hidden');
    empty.classList.add('hidden');
  }

  // Tab management
  function funSwitchTab(activeTabId) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active', 'text-brand-primary-600', 'border-brand-primary-600', 'bg-accent-gold-50');
      btn.classList.add('text-neutral-700', 'border-transparent');
      btn.setAttribute('aria-selected', 'false');
    });

    // Update panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
      panel.classList.add('hidden');
    });

    // Activate selected
    const activeTab = document.getElementById(activeTabId);
    const activePanel = document.getElementById(activeTabId.replace('tab-', 'panel-'));
    
    activeTab.classList.add('active', 'text-brand-primary-600', 'border-brand-primary-600', 'bg-accent-gold-50');
    activeTab.classList.remove('text-neutral-700', 'border-transparent');
    activeTab.setAttribute('aria-selected', 'true');
    activePanel.classList.remove('hidden');
  }

  // Main initialization
  async function funInitialLoad(forceRefresh = false) {
    try {
      if (!forceRefresh) {
        // Show skeletons
        document.getElementById('team-lead-skeleton').classList.remove('hidden');
        document.getElementById('team-lead-table-container').classList.add('hidden');
      }

      // Load data based on active tab
      const activeTab = document.querySelector('.tab-button.active')?.id || 'tab-team-lead';
      
      if (activeTab === 'tab-team-lead') {
        const teamLeadData = await funFetchTeamLeadAnalysis();
        if (teamLeadData) {
          funRenderTeamLeadTable(teamLeadData);
        }
      } else {
        const resolutionData = await funFetchResolutionMetrics();
        if (resolutionData) {
          funRenderResolutionMetrics(resolutionData);
        }
      }

    } catch (error) {
      console.error('Error in initial load:', error);
      showToast('Failed to load analytics data', 'error');
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.getElementById('tab-team-lead')?.addEventListener('click', () => {
      funSwitchTab('tab-team-lead');
      funInitialLoad();
    });

    document.getElementById('tab-resolution')?.addEventListener('click', () => {
      funSwitchTab('tab-resolution');
      funInitialLoad();
    });

    // Refresh button
    document.getElementById('btn-refresh')?.addEventListener('click', () => {
      funInitialLoad(true);
    });

    // Modal controls
    document.getElementById('modal-close')?.addEventListener('click', () => {
      document.getElementById('team-lead-modal').classList.add('hidden');
    });

    document.getElementById('modal-overlay')?.addEventListener('click', () => {
      document.getElementById('team-lead-modal').classList.add('hidden');
    });

    // ESC key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('team-lead-modal').classList.add('hidden');
      }
    });

    // Modal backdrop click
    document.getElementById('team-lead-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'team-lead-modal') {
        document.getElementById('team-lead-modal').classList.add('hidden');
      }
    });
  });
</script>

</body>
</html>