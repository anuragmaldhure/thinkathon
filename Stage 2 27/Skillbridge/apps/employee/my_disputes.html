<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Custom Tailwind Configuration -->
    <script data-tiramai="web-gen">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1e293b',
              secondary: '#475569',
              accent: '#2563eb',
              gold: '#CBA35C',
              success: '#16A34A',
              warning: '#D97706',
              error: '#DC2626',
              info: '#0EA5E9',
              neutral: {
                50: '#F8FAFC',
                100: '#F1F5F9',
                200: '#E2E8F0',
                400: '#94A3B8',
                700: '#334155',
                900: '#0F172A',
              }
            },
            fontFamily: {
              sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
            },
            boxShadow: {
              sm: '0 1px 2px rgba(15,23,42,0.06)',
              DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
              lg: '0 8px 24px rgba(15,23,42,0.12)',
            }
          }
        }
      }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <!-- Logo SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="flex-shrink-0">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-lg font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-secondary hover:text-primary hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                <span class="sr-only">Open main menu</span>
                <svg class="w-6 h-6" data-lucide="menu"></svg>
            </button>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="inline-flex items-center gap-2 bg-white border border-neutral-200 rounded-md px-3 py-2 text-sm hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="w-6 h-6 rounded-full bg-accent text-white text-xs font-medium flex items-center justify-center" id="user-avatar">
                        U
                    </div>
                    <span id="user-name" class="text-neutral-700">Loading...</span>
                    <svg class="w-4 h-4 text-secondary" data-lucide="chevron-down"></svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 z-40">
                    <div class="px-4 py-3 border-b border-neutral-100">
                        <p id="dropdown-name" class="text-sm font-medium text-primary">John Doe</p>
                        <p id="dropdown-email" class="text-xs text-secondary">johndoe@example.com</p>
                        <p class="text-xs text-neutral-400 mt-1">Employee</p>
                    </div>
                    <button id="sign-out-btn" class="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <svg class="w-4 h-4" data-lucide="log-out"></svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-[73px]">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] sticky top-[73px] overflow-y-auto md:block hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- Made with TiramAi footer -->
            <div class="absolute bottom-4 w-full text-center text-xs text-neutral-400 bg-white rounded px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>

        <!-- Mobile Sidebar -->
        <aside id="mobile-sidebar" class="hidden fixed left-0 top-[73px] w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] overflow-y-auto z-30 md:hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px]">
            
<!-- Main content container -->
<div class="container mx-auto max-w-7xl">
  <!-- Header Banner -->
  <div class="mb-6">
    <div class="bg-warning/10 border border-warning/20 rounded-lg p-4">
      <div class="flex items-center gap-3">
        <svg class="w-6 h-6 text-warning" data-lucide="alert-triangle"></svg>
        <div>
          <h2 class="text-lg font-semibold text-primary">Resolutions awaiting your response</h2>
          <p class="text-sm text-secondary mt-1">
            <span id="pending-count" class="font-medium">0</span> dispute(s) require your attention
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-primary">My Disputes</h1>
      <p class="text-sm text-secondary mt-1">Track and manage your assessment disputes</p>
    </div>
    <button id="raise-dispute-btn" class="inline-flex items-center gap-2 bg-accent text-white rounded-md px-4 py-2 hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
      <svg class="w-5 h-5" data-lucide="plus"></svg>
      Raise Dispute
    </button>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-center gap-4">
      <div class="flex flex-col sm:flex-row gap-4 flex-1">
        <div class="min-w-0 flex-1">
          <label class="block text-xs font-medium text-secondary mb-1">Search</label>
          <input 
            type="text" 
            id="search-input" 
            placeholder="Search by Dispute ID or Reason" 
            class="w-full border border-neutral-200 rounded px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
          >
        </div>
        <div class="min-w-0 sm:w-40">
          <label class="block text-xs font-medium text-secondary mb-1">Status</label>
          <select id="status-filter" class="w-full border border-neutral-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <option value="">All Status</option>
            <option value="open">Open</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
        <div class="min-w-0 sm:w-48">
          <label class="block text-xs font-medium text-secondary mb-1">Cycle</label>
          <select id="cycle-filter" class="w-full border border-neutral-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>
      <button id="refresh-btn" class="inline-flex items-center gap-2 text-sm text-secondary hover:text-primary px-3 py-2 rounded hover:bg-neutral-50" aria-label="Refresh">
        <svg class="w-4 h-4" data-lucide="refresh-cw"></svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- Data Grid -->
  <div class="bg-white rounded-lg border border-neutral-200 overflow-hidden">
    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="divide-y divide-neutral-100">
      <div class="px-6 py-4 bg-neutral-50 border-b border-neutral-200">
        <div class="flex items-center justify-between">
          <div class="h-4 bg-neutral-200 rounded w-32 animate-pulse"></div>
          <div class="h-4 bg-neutral-200 rounded w-24 animate-pulse"></div>
        </div>
      </div>
      <div class="px-6 py-4">
        <div class="space-y-3">
          <div class="h-4 bg-neutral-100 rounded w-3/4 animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded w-1/2 animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded w-2/3 animate-pulse"></div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div id="disputes-table" class="hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 sticky top-0 border-b border-neutral-200">
          <tr class="text-left text-xs font-medium text-secondary">
            <th class="px-6 py-3">Dispute ID</th>
            <th class="px-6 py-3">Cycle</th>
            <th class="px-6 py-3">Created At</th>
            <th class="px-6 py-3">Items</th>
            <th class="px-6 py-3">Status</th>
            <th class="px-6 py-3">Awaiting Response</th>
            <th class="px-6 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="disputes-tbody" class="divide-y divide-neutral-100 text-sm">
          <!-- Rows will be inserted here -->
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
      <svg class="w-12 h-12 text-neutral-300 mx-auto mb-4" data-lucide="file-text"></svg>
      <h3 class="text-lg font-medium text-neutral-700 mb-2">No disputes found</h3>
      <p class="text-neutral-500 max-w-sm mx-auto">You haven't raised any disputes yet. Click "Raise Dispute" to create your first one.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div id="pagination-container" class="hidden flex items-center justify-between mt-6">
    <div class="text-sm text-neutral-600">
      Showing <span id="pagination-info">1-10 of 0</span> disputes
    </div>
    <div class="flex items-center gap-2">
      <button id="prev-page" class="inline-flex items-center gap-1 px-3 py-2 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed">
        <svg class="w-4 h-4" data-lucide="chevron-left"></svg>
        Previous
      </button>
      <span id="page-numbers" class="flex items-center gap-1">
        <!-- Page numbers will be inserted here -->
      </span>
      <button id="next-page" class="inline-flex items-center gap-1 px-3 py-2 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed">
        Next
        <svg class="w-4 h-4" data-lucide="chevron-right"></svg>
      </button>
    </div>
  </div>
</div>

<!-- Raise Dispute Modal -->
<div id="raise-dispute-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-200">
      <h3 class="text-lg font-semibold text-primary">Raise Dispute</h3>
      <button id="close-raise-modal" class="text-secondary hover:text-primary p-1">
        <svg class="w-5 h-5" data-lucide="x"></svg>
      </button>
    </div>
    
    <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
      <div class="p-6 space-y-6">
        <!-- Assessment Context -->
        <div class="bg-neutral-50 rounded-lg p-4">
          <h4 class="font-semibold text-primary mb-3">Assessment Context</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div>
              <label class="block text-xs text-secondary mb-1">Active Cycle</label>
              <div id="modal-cycle-name" class="text-neutral-700 font-medium">Loading...</div>
            </div>
            <div>
              <label class="block text-xs text-secondary mb-1">Team Lead</label>
              <div id="modal-team-lead" class="text-neutral-700 font-medium">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Select Skills -->
        <div>
          <h4 class="font-semibold text-primary mb-3">Select Skills to Dispute</h4>
          
          <!-- Skills Table Loading -->
          <div id="skills-loading" class="border border-neutral-200 rounded-lg p-4">
            <div class="space-y-3">
              <div class="h-4 bg-neutral-100 rounded w-full animate-pulse"></div>
              <div class="h-4 bg-neutral-100 rounded w-3/4 animate-pulse"></div>
              <div class="h-4 bg-neutral-100 rounded w-1/2 animate-pulse"></div>
            </div>
          </div>

          <!-- Skills Table -->
          <div id="skills-table" class="hidden border border-neutral-200 rounded-lg overflow-hidden">
            <table class="w-full">
              <thead class="bg-neutral-50">
                <tr class="text-left text-xs font-medium text-secondary">
                  <th class="px-4 py-3 w-12">Select</th>
                  <th class="px-4 py-3">Skill</th>
                  <th class="px-4 py-3">Team Lead Score</th>
                  <th class="px-4 py-3">Benchmark</th>
                  <th class="px-4 py-3">Comment</th>
                </tr>
              </thead>
              <tbody id="skills-tbody" class="divide-y divide-neutral-100 text-sm">
                <!-- Skills will be inserted here -->
              </tbody>
            </table>
          </div>

          <!-- No Skills Message -->
          <div id="no-skills-message" class="hidden text-center py-8 text-neutral-500">
            <svg class="w-8 h-8 mx-auto mb-2 text-neutral-300" data-lucide="file-x"></svg>
            <p>No assessment items found for the current cycle.</p>
          </div>
        </div>

        <!-- Reason for Dispute -->
        <div>
          <label class="block text-sm font-medium text-secondary mb-2">
            Reason for Dispute <span class="text-error">*</span>
          </label>
          <textarea 
            id="dispute-reason" 
            rows="4" 
            placeholder="Please provide a detailed explanation of your dispute..."
            class="w-full border border-neutral-200 rounded-md px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
            required
          ></textarea>
          <p id="reason-error" class="hidden text-xs text-error mt-1">Reason for dispute is required.</p>
        </div>
      </div>
    </div>

    <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3">
      <button id="cancel-raise" class="px-4 py-2 text-sm border border-neutral-200 rounded hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        Cancel
      </button>
      <button id="submit-dispute" class="px-4 py-2 text-sm bg-accent text-white rounded hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
        Submit Dispute
      </button>
    </div>
  </div>
</div>

<!-- Dispute Details Modal -->
<div id="dispute-details-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-200">
      <h3 class="text-lg font-semibold text-primary">Dispute Details</h3>
      <button id="close-details-modal" class="text-secondary hover:text-primary p-1">
        <svg class="w-5 h-5" data-lucide="x"></svg>
      </button>
    </div>
    
    <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
      <div class="p-6 space-y-6">
        <!-- Header Info -->
        <div class="bg-neutral-50 rounded-lg p-4">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
            <div>
              <label class="block text-xs text-secondary mb-1">Dispute ID</label>
              <div id="details-dispute-id" class="text-neutral-700 font-medium">-</div>
            </div>
            <div>
              <label class="block text-xs text-secondary mb-1">Cycle</label>
              <div id="details-cycle" class="text-neutral-700 font-medium">-</div>
            </div>
            <div>
              <label class="block text-xs text-secondary mb-1">Status</label>
              <div id="details-status" class="text-neutral-700 font-medium">-</div>
            </div>
          </div>
        </div>

        <!-- Reason -->
        <div>
          <h4 class="font-semibold text-primary mb-2">Reason for Dispute</h4>
          <div id="details-reason" class="text-sm text-neutral-700 bg-neutral-50 rounded-lg p-4">-</div>
        </div>

        <!-- Items -->
        <div>
          <h4 class="font-semibold text-primary mb-3">Disputed Items</h4>
          <div id="details-items" class="border border-neutral-200 rounded-lg overflow-hidden">
            <!-- Items table will be inserted here -->
          </div>
        </div>

        <!-- History -->
        <div>
          <h4 class="font-semibold text-primary mb-3">History</h4>
          <div id="details-history" class="space-y-3">
            <!-- History items will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <div id="details-actions" class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3">
      <button id="details-close" class="px-4 py-2 text-sm border border-neutral-200 rounded hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        Close
      </button>
      <!-- Agree/Disagree buttons will be shown conditionally -->
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const mobileSidebar = document.getElementById('mobile-sidebar');

        // User profile dropdown toggle
        userProfileBtn?.addEventListener('click', () => {
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userProfileBtn?.contains(e.target) && !userDropdown?.contains(e.target)) {
                userDropdown?.classList.add('hidden');
            }
        });

        // Mobile menu toggle
        mobileMenuBtn?.addEventListener('click', () => {
            mobileSidebar.classList.toggle('hidden');
            mobileOverlay.classList.toggle('hidden');
        });

        mobileOverlay?.addEventListener('click', () => {
            mobileSidebar.classList.add('hidden');
            mobileOverlay.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn?.addEventListener('click', async () => {
            try {
                showLoader();
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Failed to sign out', 'error');
            } finally {
                hideLoader();
            }
        });

        // Set active nav link based on current page
        function setActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('bg-accent', 'text-white');
                link.classList.add('text-neutral-700');
                
                const linkPage = link.getAttribute('data-page');
                if (linkPage === currentPage) {
                    link.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
                    link.classList.add('bg-accent', 'text-white');
                }
            });
        }

        // Auth state management
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let userData = userDoc.exists() ? userDoc.data() : null;

                // Fallback to Firebase Auth data
                const displayName = userData?.firstName && userData?.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : user.displayName || user.email.split('@')[0];
                
                const email = userData?.email || user.email;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();

                // Update UI
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = email;

            } catch (error) {
                console.error('Error fetching user data:', error);
                // Fallback to basic auth data
                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = user.email;
            }
        });

        // Initialize active nav state
        setActiveNavLink();
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    collection, getDocs, setDoc, addDoc, doc, getDoc, updateDoc, deleteDoc, writeBatch,
    query, where, orderBy, limit, startAfter, endBefore, onSnapshot, Timestamp,
    getCountFromServer, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { auth, getDb } from "./scripts/firebase.js";
  import { showToast, showLoader, hideLoader } from "./scripts/main.js";

  const db = getDb();
  let currentUser = null;
  let currentEmployee = null;
  let activeCycle = null;
  let disputes = [];
  let filteredDisputes = [];
  let currentPage = 1;
  const itemsPerPage = 10;
  let searchTimeout = null;

  // DOM Elements
  const pendingCount = document.getElementById('pending-count');
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const cycleFilter = document.getElementById('cycle-filter');
  const refreshBtn = document.getElementById('refresh-btn');
  const disputesTable = document.getElementById('disputes-table');
  const disputesTbody = document.getElementById('disputes-tbody');
  const loadingSkeleton = document.getElementById('loading-skeleton');
  const emptyState = document.getElementById('empty-state');
  const paginationContainer = document.getElementById('pagination-container');
  const raiseDisputeBtn = document.getElementById('raise-dispute-btn');

  // Modal elements
  const raiseDisputeModal = document.getElementById('raise-dispute-modal');
  const disputeDetailsModal = document.getElementById('dispute-details-modal');

  // Initialize
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
      return;
    }

    currentUser = user;
    await funInitializeData();
  });

  // Initialization function
  async function funInitializeData() {
    try {
      showLoader();
      
      // Get current employee
      const employeeQuery = query(collection(db, 'employees'), where('userId', '==', currentUser.uid));
      const employeeSnapshot = await getDocs(employeeQuery);
      
      if (employeeSnapshot.empty) {
        showToast('Employee record not found', 'error');
        return;
      }

      currentEmployee = { id: employeeSnapshot.docs[0].id, ...employeeSnapshot.docs[0].data() };
      
      // Load cycles and disputes
      await Promise.all([
        funLoadCycles(),
        funLoadDisputes()
      ]);

      await new Promise(r => requestAnimationFrame(() => r()));
      funInitializeEventListeners();
      
    } catch (error) {
      console.error('Error initializing:', error);
      showToast('Failed to load page data', 'error');
    } finally {
      hideLoader();
    }
  }

  // Load assessment cycles
  async function funLoadCycles() {
    try {
      const cyclesQuery = query(
        collection(db, 'assessmentCycles'),
        where('status', '==', 'active'),
        orderBy('startDate', 'desc')
      );
      const cyclesSnapshot = await getDocs(cyclesQuery);
      
      cycleFilter.innerHTML = '<option value="">All Cycles</option>';
      let hasActiveCycle = false;

      cyclesSnapshot.docs.forEach(cycleDoc => {
        const cycle = { id: cycleDoc.id, ...cycleDoc.data() };
        const option = document.createElement('option');
        option.value = cycle.id;
        option.textContent = cycle.name || 'Unnamed Cycle';
        cycleFilter.appendChild(option);

        // Set as active cycle (first one or most recent)
        if (!hasActiveCycle) {
          activeCycle = cycle;
          hasActiveCycle = true;
          cycleFilter.value = cycle.id;
        }
      });

      if (!hasActiveCycle) {
        cycleFilter.innerHTML = '<option value="">No active cycles</option>';
      }

    } catch (error) {
      console.error('Error loading cycles:', error);
      cycleFilter.innerHTML = '<option value="">Error loading cycles</option>';
    }
  }

  // Load disputes
  async function funLoadDisputes(refresh = false) {
    try {
      if (!refresh) {
        loadingSkeleton.classList.remove('hidden');
        disputesTable.classList.add('hidden');
        emptyState.classList.add('hidden');
      }

      const disputesQuery = query(
        collection(db, 'disputes'),
        where('employeeId', '==', currentEmployee?.id || ''),
        orderBy('createdAt', 'desc')
      );

      const disputesSnapshot = await getDocs(disputesQuery);
      disputes = [];

      // Process disputes with additional data
      for (const disputeDoc of disputesSnapshot.docs) {
        const dispute = { id: disputeDoc.id, ...disputeDoc.data() };
        
        // Get cycle name
        if (dispute.cycleId) {
          try {
            const cycleDoc = await getDoc(doc(db, 'assessmentCycles', dispute.cycleId));
            dispute.cycleName = cycleDoc.exists() ? cycleDoc.data().name : 'Unknown Cycle';
          } catch (error) {
            dispute.cycleName = 'Unknown Cycle';
          }
        }

        // Calculate awaiting response
        dispute.awaitingResponse = funCalculateAwaitingResponse(dispute);
        disputes.push(dispute);
      }

      funUpdatePendingCount();
      funApplyFilters();
      
    } catch (error) {
      console.error('Error loading disputes:', error);
      showToast('Failed to load disputes', 'error');
    } finally {
      loadingSkeleton.classList.add('hidden');
    }
  }

  // Calculate if awaiting employee response
  function funCalculateAwaitingResponse(dispute) {
    if (dispute.status !== 'resolved') return false;
    
    const history = dispute.history || [];
    const lastAdminAction = history
      .filter(entry => ['resolveDispute', 'overrideScore', 'dismissDispute'].includes(entry.action))
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

    if (!lastAdminAction) return false;

    const lastEmployeeResponse = history
      .filter(entry => ['employeeAgree', 'employeeDisagree'].includes(entry.action))
      .filter(entry => new Date(entry.timestamp) > new Date(lastAdminAction.timestamp))
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

    return !lastEmployeeResponse;
  }

  // Update pending count
  function funUpdatePendingCount() {
    const pendingCount = disputes.filter(d => d.awaitingResponse).length;
    document.getElementById('pending-count').textContent = pendingCount;
  }

  // Apply filters
  function funApplyFilters() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const statusValue = statusFilter.value;
    const cycleValue = cycleFilter.value;

    filteredDisputes = disputes.filter(dispute => {
      const matchesSearch = !searchTerm || 
        dispute.id.toLowerCase().includes(searchTerm) ||
        (dispute.reasonForDispute || '').toLowerCase().includes(searchTerm);
      
      const matchesStatus = !statusValue || dispute.status === statusValue;
      const matchesCycle = !cycleValue || dispute.cycleId === cycleValue;

      return matchesSearch && matchesStatus && matchesCycle;
    });

    currentPage = 1;
    funRenderTable();
  }

  // Render table
  function funRenderTable() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageDisputes = filteredDisputes.slice(startIndex, endIndex);

    if (filteredDisputes.length === 0) {
      disputesTable.classList.add('hidden');
      emptyState.classList.remove('hidden');
      paginationContainer.classList.add('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    disputesTable.classList.remove('hidden');
    
    disputesTbody.innerHTML = '';

    pageDisputes.forEach(dispute => {
      const row = document.createElement('tr');
      row.className = 'odd:bg-white even:bg-neutral-50 hover:bg-neutral-100';
      row.innerHTML = `
        <td class="px-6 py-3 text-neutral-700">
          <span class="font-mono text-xs">${dispute.id.slice(-8).toUpperCase()}</span>
        </td>
        <td class="px-6 py-3 text-neutral-700">${dispute.cycleName || 'N/A'}</td>
        <td class="px-6 py-3 text-neutral-700">${funFormatDate(dispute.createdAt)}</td>
        <td class="px-6 py-3 text-neutral-700">${(dispute.items || []).length}</td>
        <td class="px-6 py-3">
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
            dispute.status === 'open' 
              ? 'bg-warning/10 text-warning border border-warning/20'
              : 'bg-success/10 text-success border border-success/20'
          }">
            <span class="w-1.5 h-1.5 rounded-full ${
              dispute.status === 'open' ? 'bg-warning' : 'bg-success'
            }"></span>
            ${dispute.status === 'open' ? 'Open' : 'Resolved'}
          </span>
        </td>
        <td class="px-6 py-3">
          <span class="text-sm ${dispute.awaitingResponse ? 'text-error font-medium' : 'text-neutral-500'}">
            ${dispute.awaitingResponse ? 'Yes' : 'No'}
          </span>
        </td>
        <td class="px-6 py-3">
          <div class="flex items-center gap-2">
            <button 
              onclick="funOpenDisputeDetails('${dispute.id}')" 
              class="text-accent hover:text-[#1d4ed8] text-sm font-medium"
            >
              View Details
            </button>
            ${dispute.awaitingResponse ? `
              <button 
                onclick="funQuickAgree('${dispute.id}')" 
                class="text-success hover:text-green-700 text-sm font-medium"
              >
                Agree
              </button>
              <button 
                onclick="funQuickDisagree('${dispute.id}')" 
                class="text-error hover:text-red-700 text-sm font-medium"
              >
                Disagree
              </button>
            ` : ''}
          </div>
        </td>
      `;
      disputesTbody.appendChild(row);
    });

    funUpdatePagination();
  }

  // Update pagination
  function funUpdatePagination() {
    const totalPages = Math.ceil(filteredDisputes.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredDisputes.length);

    if (totalPages <= 1) {
      paginationContainer.classList.add('hidden');
      return;
    }

    paginationContainer.classList.remove('hidden');
    document.getElementById('pagination-info').textContent = `${startIndex}-${endIndex} of ${filteredDisputes.length}`;

    // Update pagination buttons
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;

    // Generate page numbers
    const pageNumbers = document.getElementById('page-numbers');
    pageNumbers.innerHTML = '';
    
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `px-3 py-2 text-sm border rounded ${
        i === currentPage 
          ? 'bg-accent text-white border-accent' 
          : 'border-neutral-200 hover:bg-neutral-50'
      }`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        currentPage = i;
        funRenderTable();
      };
      pageNumbers.appendChild(pageBtn);
    }
  }

  // Format date
  function funFormatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      return new Date(dateString).toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric'
      });
    } catch (error) {
      return 'N/A';
    }
  }

  // Initialize event listeners
  function funInitializeEventListeners() {
    // Search with debounce
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(funApplyFilters, 300);
    });

    // Filters
    statusFilter.addEventListener('change', funApplyFilters);
    cycleFilter.addEventListener('change', funApplyFilters);

    // Refresh
    refreshBtn.addEventListener('click', () => funLoadDisputes(true));

    // Pagination
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        funRenderTable();
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredDisputes.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        funRenderTable();
      }
    });

    // Raise Dispute Modal
    raiseDisputeBtn.addEventListener('click', funOpenRaiseDisputeModal);
    document.getElementById('close-raise-modal').addEventListener('click', funCloseRaiseDisputeModal);
    document.getElementById('cancel-raise').addEventListener('click', funCloseRaiseDisputeModal);
    document.getElementById('submit-dispute').addEventListener('click', funSubmitDispute);

    // Details Modal
    document.getElementById('close-details-modal').addEventListener('click', funCloseDetailsModal);
    document.getElementById('details-close').addEventListener('click', funCloseDetailsModal);

    // Modal backdrop clicks
    raiseDisputeModal.addEventListener('click', (e) => {
      if (e.target === raiseDisputeModal) funCloseRaiseDisputeModal();
    });
    disputeDetailsModal.addEventListener('click', (e) => {
      if (e.target === disputeDetailsModal) funCloseDetailsModal();
    });

    // ESC key handling
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!raiseDisputeModal.classList.contains('hidden')) {
          funCloseRaiseDisputeModal();
        }
        if (!disputeDetailsModal.classList.contains('hidden')) {
          funCloseDetailsModal();
        }
      }
    });
  }

  // Open raise dispute modal
  async function funOpenRaiseDisputeModal() {
    raiseDisputeModal.classList.remove('hidden');
    
    try {
      // Load modal context data
      if (activeCycle) {
        document.getElementById('modal-cycle-name').textContent = activeCycle.name || 'Unknown Cycle';
      }

      // Load team lead info
      if (currentEmployee?.teamLeadId) {
        const teamLeadDoc = await getDoc(doc(db, 'employees', currentEmployee.teamLeadId));
        if (teamLeadDoc.exists()) {
          document.getElementById('modal-team-lead').textContent = teamLeadDoc.data().name || 'Unknown';
        }
      }

      // Load assessment items
      await funLoadAssessmentItems();

    } catch (error) {
      console.error('Error loading modal data:', error);
      showToast('Failed to load assessment data', 'error');
    }
  }

  // Load assessment items for modal
  async function funLoadAssessmentItems() {
    const skillsLoading = document.getElementById('skills-loading');
    const skillsTable = document.getElementById('skills-table');
    const noSkillsMessage = document.getElementById('no-skills-message');
    const skillsTbody = document.getElementById('skills-tbody');

    skillsLoading.classList.remove('hidden');
    skillsTable.classList.add('hidden');
    noSkillsMessage.classList.add('hidden');

    try {
      if (!activeCycle) {
        skillsLoading.classList.add('hidden');
        noSkillsMessage.classList.remove('hidden');
        return;
      }

      // Get current assessment
      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('cycleId', '==', activeCycle.id),
        where('employeeId', '==', currentEmployee.id)
      );

      const assessmentsSnapshot = await getDocs(assessmentsQuery);
      
      if (assessmentsSnapshot.empty) {
        skillsLoading.classList.add('hidden');
        noSkillsMessage.classList.remove('hidden');
        return;
      }

      const assessment = assessmentsSnapshot.docs[0].data();
      const items = assessment.items || [];

      if (items.length === 0) {
        skillsLoading.classList.add('hidden');
        noSkillsMessage.classList.remove('hidden');
        return;
      }

      skillsTbody.innerHTML = '';

      // Load skills data
      for (const item of items) {
        if (!item.skillId) continue;

        try {
          const skillDoc = await getDoc(doc(db, 'skills', item.skillId));
          if (!skillDoc.exists()) continue;

          const skill = skillDoc.data();
          
          const row = document.createElement('tr');
          row.className = 'hover:bg-neutral-50';
          row.innerHTML = `
            <td class="px-4 py-3">
              <input type="checkbox" value="${item.assessmentItemId || item.skillId}" class="rounded border-neutral-300 text-accent focus:ring-accent">
            </td>
            <td class="px-4 py-3 font-medium text-neutral-700">${skill.name || 'Unknown Skill'}</td>
            <td class="px-4 py-3 text-neutral-700">${item.score || 'N/A'}/10</td>
            <td class="px-4 py-3 text-neutral-700">${item.benchmarkScoreSnapshot || 'N/A'}/10</td>
            <td class="px-4 py-3 text-neutral-700">${item.comment || 'No comment'}</td>
          `;
          skillsTbody.appendChild(row);

        } catch (error) {
          console.error('Error loading skill:', error);
        }
      }

      skillsLoading.classList.add('hidden');
      skillsTable.classList.remove('hidden');

    } catch (error) {
      console.error('Error loading assessment items:', error);
      skillsLoading.classList.add('hidden');
      noSkillsMessage.classList.remove('hidden');
    }
  }

  // Close raise dispute modal
  function funCloseRaiseDisputeModal() {
    raiseDisputeModal.classList.add('hidden');
    document.getElementById('dispute-reason').value = '';
    document.getElementById('reason-error').classList.add('hidden');
    
    // Uncheck all checkboxes
    const checkboxes = document.querySelectorAll('#skills-tbody input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
  }

  // Submit dispute
  async function funSubmitDispute() {
    const reasonTextarea = document.getElementById('dispute-reason');
    const reasonError = document.getElementById('reason-error');
    const submitBtn = document.getElementById('submit-dispute');

    // Validation
    const reason = reasonTextarea.value.trim();
    const selectedCheckboxes = document.querySelectorAll('#skills-tbody input[type="checkbox"]:checked');

    reasonError.classList.add('hidden');

    if (!reason) {
      reasonError.classList.remove('hidden');
      reasonTextarea.focus();
      return;
    }

    if (selectedCheckboxes.length === 0) {
      showToast('Please select at least one skill to dispute', 'error');
      return;
    }

    try {
      submitBtn.disabled = true;
      showLoader();

      // Get assessment data
      const assessmentsQuery = query(
        collection(db, 'assessments'),
        where('cycleId', '==', activeCycle.id),
        where('employeeId', '==', currentEmployee.id)
      );

      const assessmentsSnapshot = await getDocs(assessmentsQuery);
      if (assessmentsSnapshot.empty) {
        showToast('Assessment not found', 'error');
        return;
      }

      const assessment = { id: assessmentsSnapshot.docs[0].id, ...assessmentsSnapshot.docs[0].data() };
      const items = assessment.items || [];

      // Build dispute items
      const disputeItems = [];
      selectedCheckboxes.forEach(checkbox => {
        const itemId = checkbox.value;
        const item = items.find(i => (i.assessmentItemId || i.skillId) === itemId);
        if (item) {
          disputeItems.push({
            skillId: item.skillId,
            assessmentItemId: item.assessmentItemId || item.skillId,
            teamLeadScoreAtCreate: item.score || 0,
            benchmarkVersionIdAtCreate: item.benchmarkVersionId || null,
            benchmarkScoreSnapshotAtCreate: item.benchmarkScoreSnapshot || 0
          });
        }
      });

      // Create dispute
      const disputeData = {
        cycleId: activeCycle.id,
        employeeId: currentEmployee.id,
        teamLeadId: currentEmployee.teamLeadId || '',
        assessmentId: assessment.id,
        reasonForDispute: reason,
        items: disputeItems,
        status: 'open',
        history: [{
          action: 'create',
          actorId: currentUser.uid,
          timestamp: new Date().toISOString()
        }],
        createdAt: new Date().toISOString(),
        createdByEmployeeId: currentEmployee.id
      };

      await addDoc(collection(db, 'disputes'), disputeData);

      // Create audit log
      await addDoc(collection(db, 'auditLogs'), {
        entityType: 'dispute',
        entityId: '', // Will be filled by server
        action: 'create',
        actorId: currentUser.uid,
        timestamp: new Date().toISOString(),
        before: {},
        after: disputeData,
        reason: 'Employee raised dispute'
      });

      showToast('Dispute submitted successfully', 'success');
      funCloseRaiseDisputeModal();
      await funLoadDisputes(true);

    } catch (error) {
      console.error('Error submitting dispute:', error);
      showToast('Failed to submit dispute', 'error');
    } finally {
      submitBtn.disabled = false;
      hideLoader();
    }
  }

  // Quick agree action
  async function funQuickAgree(disputeId) {
    if (!confirm('Are you sure you want to agree with this resolution?')) return;
    
    try {
      showLoader();
      await funUpdateDisputeResponse(disputeId, 'employeeAgree');
      showToast('Response recorded successfully', 'success');
      await funLoadDisputes(true);
    } catch (error) {
      console.error('Error agreeing with dispute:', error);
      showToast('Failed to record response', 'error');
    } finally {
      hideLoader();
    }
  }

  // Quick disagree action
  async function funQuickDisagree(disputeId) {
    if (!confirm('Are you sure you want to disagree with this resolution? This will reopen the dispute.')) return;
    
    try {
      showLoader();
      await funUpdateDisputeResponse(disputeId, 'employeeDisagree');
      showToast('Response recorded successfully', 'success');
      await funLoadDisputes(true);
    } catch (error) {
      console.error('Error disagreeing with dispute:', error);
      showToast('Failed to record response', 'error');
    } finally {
      hideLoader();
    }
  }

  // Update dispute response
  async function funUpdateDisputeResponse(disputeId, action) {
    const disputeRef = doc(db, 'disputes', disputeId);
    const disputeDoc = await getDoc(disputeRef);
    
    if (!disputeDoc.exists()) {
      throw new Error('Dispute not found');
    }

    const disputeData = disputeDoc.data();
    const updatedHistory = [...(disputeData.history || []), {
      action: action,
      actorId: currentUser.uid,
      timestamp: new Date().toISOString()
    }];

    const updates = {
      history: updatedHistory
    };

    if (action === 'employeeDisagree') {
      updates.status = 'open';
    }

    await updateDoc(disputeRef, updates);

    // Create audit log
    await addDoc(collection(db, 'auditLogs'), {
      entityType: 'dispute',
      entityId: disputeId,
      action: 'update',
      actorId: currentUser.uid,
      timestamp: new Date().toISOString(),
      before: disputeData,
      after: { ...disputeData, ...updates },
      reason: `Employee ${action === 'employeeAgree' ? 'agreed' : 'disagreed'} with resolution`
    });
  }

  // Open dispute details modal
  async function funOpenDisputeDetails(disputeId) {
    const dispute = disputes.find(d => d.id === disputeId);
    if (!dispute) return;

    disputeDetailsModal.classList.remove('hidden');

    try {
      // Fill basic info
      document.getElementById('details-dispute-id').textContent = dispute.id.slice(-8).toUpperCase();
      document.getElementById('details-cycle').textContent = dispute.cycleName || 'N/A';
      document.getElementById('details-reason').textContent = dispute.reasonForDispute || 'N/A';
      
      const statusElement = document.getElementById('details-status');
      statusElement.innerHTML = `
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
          dispute.status === 'open' 
            ? 'bg-warning/10 text-warning border border-warning/20'
            : 'bg-success/10 text-success border border-success/20'
        }">
          <span class="w-1.5 h-1.5 rounded-full ${
            dispute.status === 'open' ? 'bg-warning' : 'bg-success'
          }"></span>
          ${dispute.status === 'open' ? 'Open' : 'Resolved'}
        </span>
      `;

      // Fill items
      await funRenderDisputeItems(dispute);

      // Fill history
      funRenderDisputeHistory(dispute);

      // Show/hide action buttons
      funUpdateDetailsActions(dispute);

    } catch (error) {
      console.error('Error loading dispute details:', error);
      showToast('Failed to load dispute details', 'error');
    }
  }

  // Render dispute items
  async function funRenderDisputeItems(dispute) {
    const itemsContainer = document.getElementById('details-items');
    
    if (!dispute.items || dispute.items.length === 0) {
      itemsContainer.innerHTML = '<div class="p-4 text-center text-neutral-500">No items</div>';
      return;
    }

    const itemsHtml = [];
    
    for (const item of dispute.items) {
      try {
        const skillDoc = await getDoc(doc(db, 'skills', item.skillId));
        const skillName = skillDoc.exists() ? skillDoc.data().name : 'Unknown Skill';
        
        itemsHtml.push(`
          <div class="p-4 border-b border-neutral-100 last:border-b-0">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <div class="font-medium text-neutral-700">${skillName}</div>
                <div class="text-xs text-neutral-500 mt-1">
                  Team Lead Score: ${item.teamLeadScoreAtCreate || 'N/A'}/10 • 
                  Benchmark: ${item.benchmarkScoreSnapshotAtCreate || 'N/A'}/10
                </div>
              </div>
            </div>
          </div>
        `);
      } catch (error) {
        console.error('Error loading skill:', error);
        itemsHtml.push(`
          <div class="p-4 border-b border-neutral-100 last:border-b-0">
            <div class="font-medium text-neutral-700">Unknown Skill</div>
            <div class="text-xs text-neutral-500 mt-1">
              Team Lead Score: ${item.teamLeadScoreAtCreate || 'N/A'}/10 • 
              Benchmark: ${item.benchmarkScoreSnapshotAtCreate || 'N/A'}/10
            </div>
          </div>
        `);
      }
    }

    itemsContainer.innerHTML = itemsHtml.join('');
  }

  // Render dispute history
  function funRenderDisputeHistory(dispute) {
    const historyContainer = document.getElementById('details-history');
    const history = dispute.history || [];

    if (history.length === 0) {
      historyContainer.innerHTML = '<div class="text-center text-neutral-500 py-4">No history</div>';
      return;
    }

    const sortedHistory = [...history].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    const historyHtml = sortedHistory.map(entry => {
      const actionLabels = {
        'create': 'Dispute Created',
        'employeeAgree': 'Employee Agreed',
        'employeeDisagree': 'Employee Disagreed',
        'resolveDispute': 'Admin Resolved',
        'overrideScore': 'Score Overridden',
        'dismissDispute': 'Dispute Dismissed'
      };

      return `
        <div class="flex items-center gap-3 p-3 bg-neutral-50 rounded-lg">
          <div class="w-2 h-2 rounded-full bg-accent"></div>
          <div class="flex-1">
            <div class="font-medium text-sm text-neutral-700">${actionLabels[entry.action] || entry.action}</div>
            <div class="text-xs text-neutral-500">${funFormatDate(entry.timestamp)}</div>
          </div>
        </div>
      `;
    }).join('');

    historyContainer.innerHTML = historyHtml;
  }

  // Update details modal actions
  function funUpdateDetailsActions(dispute) {
    const actionsContainer = document.getElementById('details-actions');
    const closeBtn = document.getElementById('details-close');

    // Remove any existing agree/disagree buttons
    const existingButtons = actionsContainer.querySelectorAll('.dispute-action-btn');
    existingButtons.forEach(btn => btn.remove());

    if (dispute.awaitingResponse) {
      const agreeBtn = document.createElement('button');
      agreeBtn.className = 'dispute-action-btn px-4 py-2 text-sm bg-success text-white rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-success focus:ring-offset-2';
      agreeBtn.textContent = 'Agree';
      agreeBtn.onclick = async () => {
        try {
          await funQuickAgree(dispute.id);
          funCloseDetailsModal();
        } catch (error) {
          // Error already handled in funQuickAgree
        }
      };

      const disagreeBtn = document.createElement('button');
      disagreeBtn.className = 'dispute-action-btn px-4 py-2 text-sm bg-error text-white rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-error focus:ring-offset-2';
      disagreeBtn.textContent = 'Disagree';
      disagreeBtn.onclick = async () => {
        try {
          await funQuickDisagree(dispute.id);
          funCloseDetailsModal();
        } catch (error) {
          // Error already handled in funQuickDisagree
        }
      };

      actionsContainer.insertBefore(disagreeBtn, closeBtn);
      actionsContainer.insertBefore(agreeBtn, disagreeBtn);
    }
  }

  // Close details modal
  function funCloseDetailsModal() {
    disputeDetailsModal.classList.add('hidden');
  }

  // Make functions available globally
  window.funOpenDisputeDetails = funOpenDisputeDetails;
  window.funQuickAgree = funQuickAgree;
  window.funQuickDisagree = funQuickDisagree;

  // Initialize Lucide icons
  lucide.createIcons();
</script>

</body>
</html>