<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Custom Tailwind Configuration -->
    <script data-tiramai="web-gen">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1e293b',
              secondary: '#475569',
              accent: '#2563eb',
              gold: '#CBA35C',
              success: '#16A34A',
              warning: '#D97706',
              error: '#DC2626',
              info: '#0EA5E9',
              neutral: {
                50: '#F8FAFC',
                100: '#F1F5F9',
                200: '#E2E8F0',
                400: '#94A3B8',
                700: '#334155',
                900: '#0F172A',
              }
            },
            fontFamily: {
              sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
            },
            boxShadow: {
              sm: '0 1px 2px rgba(15,23,42,0.06)',
              DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
              lg: '0 8px 24px rgba(15,23,42,0.12)',
            }
          }
        }
      }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <!-- Logo SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="flex-shrink-0">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-lg font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-secondary hover:text-primary hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                <span class="sr-only">Open main menu</span>
                <svg class="w-6 h-6" data-lucide="menu"></svg>
            </button>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="inline-flex items-center gap-2 bg-white border border-neutral-200 rounded-md px-3 py-2 text-sm hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="w-6 h-6 rounded-full bg-accent text-white text-xs font-medium flex items-center justify-center" id="user-avatar">
                        U
                    </div>
                    <span id="user-name" class="text-neutral-700">Loading...</span>
                    <svg class="w-4 h-4 text-secondary" data-lucide="chevron-down"></svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 z-40">
                    <div class="px-4 py-3 border-b border-neutral-100">
                        <p id="dropdown-name" class="text-sm font-medium text-primary">John Doe</p>
                        <p id="dropdown-email" class="text-xs text-secondary">johndoe@example.com</p>
                        <p class="text-xs text-neutral-400 mt-1">Employee</p>
                    </div>
                    <button id="sign-out-btn" class="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <svg class="w-4 h-4" data-lucide="log-out"></svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-[73px]">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] sticky top-[73px] overflow-y-auto md:block hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- Made with TiramAi footer -->
            <div class="absolute bottom-4 w-full text-center text-xs text-neutral-400 bg-white rounded px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>

        <!-- Mobile Sidebar -->
        <aside id="mobile-sidebar" class="hidden fixed left-0 top-[73px] w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] overflow-y-auto z-30 md:hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px]">
            
<!-- Training & Feedback Page Content -->
<div class="space-y-6">
  <!-- Page Header -->
  <div class="bg-white rounded-md shadow p-6 border border-neutral-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-[clamp(1.5rem,2.5vw,2rem)] leading-10 font-bold text-primary">Training & Feedback</h1>
        <p class="text-sm text-secondary mt-2">Manage your assigned training sessions and provide feedback</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-refresh" class="inline-flex items-center gap-2 text-sm text-secondary hover:text-primary hover:bg-neutral-50 px-3 py-2 rounded-md transition-colors" aria-label="Refresh training data">
          <svg class="w-4 h-4" data-lucide="refresh-cw"></svg>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="bg-white rounded-md shadow border border-neutral-200">
    <div class="border-b border-neutral-200">
      <nav class="flex overflow-x-auto" role="tablist">
        <button id="tab-upcoming" role="tab" aria-selected="true" class="tab-btn whitespace-nowrap px-6 py-4 text-sm font-medium text-accent border-b-2 border-accent bg-white" data-tab="upcoming">
          Upcoming
          <span id="count-upcoming" class="ml-2 inline-flex items-center justify-center w-5 h-5 text-xs bg-accent text-white rounded-full">0</span>
        </button>
        <button id="tab-ongoing" role="tab" aria-selected="false" class="tab-btn whitespace-nowrap px-6 py-4 text-sm font-medium text-secondary border-b-2 border-transparent hover:text-primary hover:border-neutral-200" data-tab="ongoing">
          Ongoing
          <span id="count-ongoing" class="ml-2 inline-flex items-center justify-center w-5 h-5 text-xs bg-neutral-400 text-white rounded-full">0</span>
        </button>
        <button id="tab-completed" role="tab" aria-selected="false" class="tab-btn whitespace-nowrap px-6 py-4 text-sm font-medium text-secondary border-b-2 border-transparent hover:text-primary hover:border-neutral-200" data-tab="completed">
          Completed
          <span id="count-completed" class="ml-2 inline-flex items-center justify-center w-5 h-5 text-xs bg-neutral-400 text-white rounded-full">0</span>
        </button>
      </nav>
    </div>

    <!-- Search Bar -->
    <div class="p-4 border-b border-neutral-200">
      <div class="relative max-w-md">
        <input
          type="text"
          id="search-input"
          placeholder="Search by title, skill name..."
          class="w-full pl-10 pr-4 py-2 border border-neutral-200 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 text-sm"
        />
        <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-3" data-lucide="search"></svg>
      </div>
    </div>

    <!-- Training Sessions Grid -->
    <div id="sessions-container" class="p-4">
      <!-- Loading skeleton -->
      <div id="loading-skeleton" class="space-y-4">
        <div class="animate-pulse">
          <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/2 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
        </div>
        <div class="animate-pulse">
          <div class="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/2 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
        </div>
      </div>

      <!-- Data Table -->
      <div id="data-table" class="hidden">
        <div class="overflow-x-auto">
          <table class="w-full border border-neutral-200 rounded-md overflow-hidden">
            <thead class="bg-neutral-50 sticky top-0">
              <tr class="text-secondary text-xs">
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Title</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Skill</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Mode</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Start Date/Time</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">End Date/Time</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Status</th>
                <th class="text-left px-4 py-3 border-b border-neutral-200 font-semibold">Feedback</th>
                <th class="text-right px-4 py-3 border-b border-neutral-200 font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="table-body" class="text-sm">
              <!-- Dynamic rows will be inserted here -->
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4">
          <div class="text-sm text-secondary">
            Showing <span id="page-info">0-0 of 0</span> sessions
          </div>
          <div class="flex items-center gap-2">
            <button id="prev-page" class="px-3 py-2 text-sm border border-neutral-200 rounded-md hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              Previous
            </button>
            <span id="page-numbers" class="flex items-center gap-1">
              <!-- Page numbers will be inserted here -->
            </span>
            <button id="next-page" class="px-3 py-2 text-sm border border-neutral-200 rounded-md hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <svg class="w-16 h-16 text-neutral-300 mx-auto mb-4" data-lucide="book-open"></svg>
        <h3 class="text-lg font-semibold text-primary mb-2">No training sessions found</h3>
        <p class="text-secondary text-sm">No training sessions match your current criteria</p>
      </div>
    </div>
  </div>
</div>

<!-- Submit Feedback Modal -->
<div id="feedback-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between p-6 border-b border-neutral-200">
      <h2 class="text-lg font-semibold text-primary">Submit Training Feedback</h2>
      <button id="close-feedback-modal" class="text-secondary hover:text-primary">
        <svg class="w-5 h-5" data-lucide="x"></svg>
      </button>
    </div>

    <form id="feedback-form" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-secondary mb-2">Training Session</label>
        <p id="feedback-session-title" class="text-sm text-neutral-700 bg-neutral-50 p-3 rounded-md">Loading...</p>
      </div>

      <div>
        <label for="rating-input" class="block text-sm font-medium text-secondary mb-2">
          Rating <span class="text-error">*</span>
        </label>
        <div class="space-y-2">
          <input
            type="range"
            id="rating-input"
            min="1"
            max="10"
            value="5"
            class="w-full h-2 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-accent"
          />
          <div class="flex justify-between text-xs text-secondary">
            <span>1 - Poor</span>
            <span id="rating-display" class="font-medium text-accent">5</span>
            <span>10 - Excellent</span>
          </div>
        </div>
      </div>

      <div>
        <label for="comments-input" class="block text-sm font-medium text-secondary mb-2">
          Comments <span id="comments-required-indicator" class="text-error hidden">*</span>
        </label>
        <textarea
          id="comments-input"
          rows="4"
          placeholder="Share your thoughts about the training session..."
          class="w-full border border-neutral-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 text-sm resize-none"
        ></textarea>
        <p id="comments-help" class="text-xs text-neutral-400 mt-1">Optional feedback to help improve future sessions</p>
      </div>

      <div class="flex gap-3 pt-4">
        <button
          type="button"
          id="cancel-feedback"
          class="flex-1 px-4 py-2 text-sm border border-neutral-200 rounded-md hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
        >
          Cancel
        </button>
        <button
          type="submit"
          id="submit-feedback"
          class="flex-1 px-4 py-2 text-sm bg-accent text-white rounded-md hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
        >
          Submit Feedback
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View Feedback Modal -->
<div id="view-feedback-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between p-6 border-b border-neutral-200">
      <h2 class="text-lg font-semibold text-primary">Training Feedback</h2>
      <button id="close-view-feedback-modal" class="text-secondary hover:text-primary">
        <svg class="w-5 h-5" data-lucide="x"></svg>
      </button>
    </div>

    <div class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-secondary mb-2">Training Session</label>
        <p id="view-session-title" class="text-sm text-neutral-700 bg-neutral-50 p-3 rounded-md">Loading...</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-secondary mb-2">Your Rating</label>
        <div class="flex items-center gap-2">
          <div class="bg-accent text-white px-3 py-1 rounded-full text-sm font-medium">
            <span id="view-rating">N/A</span>/10
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-secondary mb-2">Your Comments</label>
        <div class="bg-neutral-50 p-3 rounded-md min-h-[80px]">
          <p id="view-comments" class="text-sm text-neutral-700">No comments provided</p>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-secondary mb-2">Submitted On</label>
        <p id="view-submitted-at" class="text-sm text-neutral-600">N/A</p>
      </div>

      <div class="pt-4">
        <button
          id="close-view-feedback"
          class="w-full px-4 py-2 text-sm bg-accent text-white rounded-md hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const mobileSidebar = document.getElementById('mobile-sidebar');

        // User profile dropdown toggle
        userProfileBtn?.addEventListener('click', () => {
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userProfileBtn?.contains(e.target) && !userDropdown?.contains(e.target)) {
                userDropdown?.classList.add('hidden');
            }
        });

        // Mobile menu toggle
        mobileMenuBtn?.addEventListener('click', () => {
            mobileSidebar.classList.toggle('hidden');
            mobileOverlay.classList.toggle('hidden');
        });

        mobileOverlay?.addEventListener('click', () => {
            mobileSidebar.classList.add('hidden');
            mobileOverlay.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn?.addEventListener('click', async () => {
            try {
                showLoader();
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Failed to sign out', 'error');
            } finally {
                hideLoader();
            }
        });

        // Set active nav link based on current page
        function setActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('bg-accent', 'text-white');
                link.classList.add('text-neutral-700');
                
                const linkPage = link.getAttribute('data-page');
                if (linkPage === currentPage) {
                    link.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
                    link.classList.add('bg-accent', 'text-white');
                }
            });
        }

        // Auth state management
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let userData = userDoc.exists() ? userDoc.data() : null;

                // Fallback to Firebase Auth data
                const displayName = userData?.firstName && userData?.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : user.displayName || user.email.split('@')[0];
                
                const email = userData?.email || user.email;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();

                // Update UI
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = email;

            } catch (error) {
                console.error('Error fetching user data:', error);
                // Fallback to basic auth data
                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = user.email;
            }
        });

        // Initialize active nav state
        setActiveNavLink();
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import {
  collection, getDocs, doc, getDoc, addDoc, updateDoc, query, where, orderBy, limit, startAfter,
  Timestamp, getCountFromServer
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from './scripts/firebase.js';
import { showToast, showLoader, hideLoader } from './scripts/main.js';

const db = getDb();

// State management
let currentUser = null;
let currentEmployee = null;
let currentTab = 'upcoming';
let currentPage = 1;
let pageSize = 10;
let searchQuery = '';
let filterSkillId = null; // From URL params
let allSessions = [];
let filteredSessions = [];
let currentAbort = null;
let orgSettings = null;

// DOM Elements
const tabButtons = document.querySelectorAll('.tab-btn');
const searchInput = document.getElementById('search-input');
const sessionsContainer = document.getElementById('sessions-container');
const loadingSkeleton = document.getElementById('loading-skeleton');
const dataTable = document.getElementById('data-table');
const tableBody = document.getElementById('table-body');
const emptyState = document.getElementById('empty-state');
const pageInfo = document.getElementById('page-info');
const prevPageBtn = document.getElementById('prev-page');
const nextPageBtn = document.getElementById('next-page');
const pageNumbers = document.getElementById('page-numbers');
const refreshBtn = document.getElementById('btn-refresh');

// Modal elements
const feedbackModal = document.getElementById('feedback-modal');
const viewFeedbackModal = document.getElementById('view-feedback-modal');
const feedbackForm = document.getElementById('feedback-form');
const ratingInput = document.getElementById('rating-input');
const ratingDisplay = document.getElementById('rating-display');
const commentsInput = document.getElementById('comments-input');
const commentsRequiredIndicator = document.getElementById('comments-required-indicator');
const commentsHelp = document.getElementById('comments-help');

// Current feedback session
let currentFeedbackSession = null;
let isEditingFeedback = false;

// Utility functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}

const withLimit = createSemaphore(2);

// Format date for display
function formatDateTime(isoString) {
  if (!isoString) return 'N/A';
  try {
    const date = new Date(isoString);
    return date.toLocaleDateString('en-IN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    }) + ' ' + date.toLocaleTimeString('en-IN', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
  } catch (error) {
    return 'N/A';
  }
}

// Get URL parameters
function getUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const skillId = urlParams.get('filter_skill_id');
  return { skillId };
}

// Abortable fetch function
async function funAbortableFetch(buildQuery) {
  if (currentAbort) currentAbort.abort();
  currentAbort = new AbortController();
  const signal = currentAbort.signal;

  try {
    const q = buildQuery();
    const snapshot = await getDocs(q);
    if (signal.aborted) return { items: [], error: 'Aborted' };
    return {
      items: snapshot.docs.map(d => ({ id: d.id, ...d.data() })),
      cursor: snapshot.docs.at(-1) || null,
    };
  } catch (err) {
    if (signal.aborted) return { items: [], error: 'Aborted' };
    console.error('Fetch error:', err);
    return { items: [], error: err?.message || "Failed to load data" };
  }
}

// Load organization settings
async function funLoadOrgSettings() {
  try {
    const result = await withLimit(async () => {
      const q = query(
        collection(db, 'orgSettings'),
        where('effectiveEndDate', '==', null),
        orderBy('effectiveStartDate', 'desc'),
        limit(1)
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.length > 0 ? { id: snapshot.docs[0].id, ...snapshot.docs[0].data() } : null;
    });
    orgSettings = result;
  } catch (error) {
    console.error('Error loading org settings:', error);
    orgSettings = null;
  }
}

// Load current employee data
async function funLoadCurrentEmployee(userId) {
  try {
    const result = await withLimit(async () => {
      const q = query(collection(db, 'employees'), where('userId', '==', userId), limit(1));
      const snapshot = await getDocs(q);
      return snapshot.docs.length > 0 ? { id: snapshot.docs[0].id, ...snapshot.docs[0].data() } : null;
    });
    return result;
  } catch (error) {
    console.error('Error loading employee:', error);
    return null;
  }
}

// Load skills data
async function funLoadSkills() {
  try {
    const result = await withLimit(async () => {
      const q = query(
        collection(db, 'skills'),
        where('status', '==', 'active'),
        orderBy('name')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    });
    return result;
  } catch (error) {
    console.error('Error loading skills:', error);
    return [];
  }
}

// Load training sessions
async function funLoadTrainingSessions() {
  if (!currentEmployee) return;

  try {
    const result = await funAbortableFetch(() => 
      query(
        collection(db, 'trainingSessions'),
        where('attendees', 'array-contains', currentEmployee.id),
        orderBy('startDateTime', 'desc')
      )
    );

    if (result.error === 'Aborted') return;
    if (result.error) {
      showToast(result.error, 'error');
      return;
    }

    allSessions = result.items || [];
    await yieldToFrame();
    funProcessSessions();
  } catch (error) {
    console.error('Error loading sessions:', error);
    showToast('Failed to load training sessions', 'error');
  }
}

// Load training feedback for current employee
async function funLoadTrainingFeedback() {
  if (!currentEmployee) return {};

  try {
    const result = await withLimit(async () => {
      const q = query(
        collection(db, 'trainingFeedback'),
        where('employeeId', '==', currentEmployee.id),
        where('status', '==', 'active')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    });

    // Create a map of sessionId -> feedback
    const feedbackMap = {};
    result.forEach(feedback => {
      feedbackMap[feedback.sessionId] = feedback;
    });

    return feedbackMap;
  } catch (error) {
    console.error('Error loading feedback:', error);
    return {};
  }
}

// Process and categorize sessions
async function funProcessSessions() {
  if (!allSessions.length) {
    funShowEmptyState();
    return;
  }

  const now = new Date().toISOString();
  const skills = await funLoadSkills();
  const skillsMap = {};
  skills.forEach(skill => {
    skillsMap[skill.id] = skill;
  });

  const feedbackMap = await funLoadTrainingFeedback();

  // Add computed fields to sessions
  allSessions = allSessions.map(session => {
    const skill = skillsMap[session.skillId];
    
    // Determine tab membership
    let tabCategory = 'completed'; // default
    
    if (session.status === 'scheduled') {
      const startTime = new Date(session.startDateTime);
      const endTime = new Date(session.endDateTime);
      const currentTime = new Date(now);
      
      if (currentTime < startTime) {
        tabCategory = 'upcoming';
      } else if (currentTime >= startTime && currentTime <= endTime) {
        tabCategory = 'ongoing';
      } else {
        tabCategory = 'completed';
      }
    } else if (session.status === 'completed') {
      tabCategory = 'completed';
    }

    // Generate title
    const title = session.title || (skill ? `Skill Training - ${skill.name}` : `Training Session ${session.id.slice(-6)}`);

    // Check feedback status
    const feedback = feedbackMap[session.id];
    const feedbackStatus = {
      exists: !!feedback,
      canSubmit: tabCategory === 'completed' && !feedback,
      feedback: feedback || null
    };

    return {
      ...session,
      skill,
      title,
      tabCategory,
      feedbackStatus
    };
  });

  // Apply skill filter if provided
  if (filterSkillId) {
    allSessions = allSessions.filter(session => session.skillId === filterSkillId);
  }

  await yieldToFrame();
  funApplyFilters();
}

// Apply current filters and search
function funApplyFilters() {
  let filtered = allSessions.filter(session => session.tabCategory === currentTab);

  // Apply search filter
  if (searchQuery.trim()) {
    const query = searchQuery.toLowerCase();
    filtered = filtered.filter(session => 
      session.title?.toLowerCase().includes(query) ||
      session.skill?.name?.toLowerCase().includes(query)
    );
  }

  filteredSessions = filtered;
  funUpdateTabCounts();
  funRenderCurrentPage();
}

// Update tab counts
function funUpdateTabCounts() {
  const counts = {
    upcoming: allSessions.filter(s => s.tabCategory === 'upcoming').length,
    ongoing: allSessions.filter(s => s.tabCategory === 'ongoing').length,
    completed: allSessions.filter(s => s.tabCategory === 'completed').length
  };

  document.getElementById('count-upcoming').textContent = counts.upcoming;
  document.getElementById('count-ongoing').textContent = counts.ongoing;
  document.getElementById('count-completed').textContent = counts.completed;
}

// Render current page
function funRenderCurrentPage() {
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const pageItems = filteredSessions.slice(startIndex, endIndex);

  if (pageItems.length === 0) {
    funShowEmptyState();
    return;
  }

  funShowDataTable();
  funRenderTableRows(pageItems);
  funUpdatePaginationControls();
}

// Show data table
function funShowDataTable() {
  loadingSkeleton.classList.add('hidden');
  dataTable.classList.remove('hidden');
  emptyState.classList.add('hidden');
}

// Show empty state
function funShowEmptyState() {
  loadingSkeleton.classList.add('hidden');
  dataTable.classList.add('hidden');
  emptyState.classList.remove('hidden');
}

// Render table rows
function funRenderTableRows(sessions) {
  tableBody.innerHTML = '';

  sessions.forEach(session => {
    const row = document.createElement('tr');
    row.className = 'odd:bg-white even:bg-neutral-50 hover:bg-neutral-50';

    // Status badge
    let statusBadge = '';
    if (session.status === 'scheduled') {
      if (session.tabCategory === 'upcoming') {
        statusBadge = '<span class="inline-flex items-center gap-1 text-white bg-info rounded-full px-2 py-0.5 text-xs">Scheduled</span>';
      } else if (session.tabCategory === 'ongoing') {
        statusBadge = '<span class="inline-flex items-center gap-1 text-white bg-warning rounded-full px-2 py-0.5 text-xs">In Progress</span>';
      }
    } else if (session.status === 'completed') {
      statusBadge = '<span class="inline-flex items-center gap-1 text-white bg-success rounded-full px-2 py-0.5 text-xs">Completed</span>';
    } else {
      statusBadge = '<span class="inline-flex items-center gap-1 text-white bg-neutral-400 rounded-full px-2 py-0.5 text-xs">Unknown</span>';
    }

    // Feedback status
    let feedbackColumn = '';
    if (session.tabCategory === 'completed') {
      if (session.feedbackStatus.canSubmit) {
        feedbackColumn = `
          <button class="provide-feedback-btn inline-flex items-center gap-1 text-accent hover:text-[#1d4ed8] text-sm font-medium" data-session-id="${session.id}">
            <svg class="w-4 h-4" data-lucide="message-square-plus"></svg>
            Provide Feedback
          </button>
        `;
      } else if (session.feedbackStatus.exists) {
        const submittedDate = formatDateTime(session.feedbackStatus.feedback.submittedAt);
        feedbackColumn = `
          <div class="text-success text-sm flex flex-col">
            <span class="font-medium">Submitted</span>
            <span class="text-xs text-neutral-400">${submittedDate}</span>
          </div>
        `;
      } else {
        feedbackColumn = '<span class="text-neutral-400 text-sm">Not Available</span>';
      }
    } else {
      feedbackColumn = '<span class="text-neutral-400 text-sm">Not Available</span>';
    }

    // Actions
    let actions = '';
    if (session.feedbackStatus.exists) {
      actions += `
        <button class="view-feedback-btn text-accent hover:text-[#1d4ed8] text-sm mr-2" data-session-id="${session.id}">
          View Feedback
        </button>
      `;
    }
    actions += `
      <button class="view-skill-impact-btn text-info hover:text-[#0284c7] text-sm" data-skill-id="${session.skillId}">
        View Skill Impact
      </button>
    `;

    row.innerHTML = `
      <td class="px-4 py-3 text-neutral-700">
        <div class="font-medium">${session.title || 'N/A'}</div>
      </td>
      <td class="px-4 py-3 text-neutral-700">${session.skill?.name || 'N/A'}</td>
      <td class="px-4 py-3 text-neutral-700">
        <span class="capitalize">${session.mode || 'N/A'}</span>
      </td>
      <td class="px-4 py-3 text-neutral-700 font-mono text-[0.8125rem]">${formatDateTime(session.startDateTime)}</td>
      <td class="px-4 py-3 text-neutral-700 font-mono text-[0.8125rem]">${formatDateTime(session.endDateTime)}</td>
      <td class="px-4 py-3">${statusBadge}</td>
      <td class="px-4 py-3">${feedbackColumn}</td>
      <td class="px-4 py-3 text-right">
        <div class="flex justify-end gap-2">
          ${actions}
        </div>
      </td>
    `;

    tableBody.appendChild(row);
  });

  // Initialize icons
  lucide.createIcons();

  // Add event listeners
  document.querySelectorAll('.provide-feedback-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const sessionId = e.currentTarget.dataset.sessionId;
      funOpenFeedbackModal(sessionId, false);
    });
  });

  document.querySelectorAll('.view-feedback-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const sessionId = e.currentTarget.dataset.sessionId;
      funOpenViewFeedbackModal(sessionId);
    });
  });

  document.querySelectorAll('.view-skill-impact-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const skillId = e.currentTarget.dataset.skillId;
      if (skillId && skillId !== 'null') {
        window.location.href = `/my_skill_dashboard.html?openTimelineForSkillId=${skillId}`;
      } else {
        showToast('Skill information not available', 'error');
      }
    });
  });
}

// Update pagination controls
function funUpdatePaginationControls() {
  const totalItems = filteredSessions.length;
  const totalPages = Math.ceil(totalItems / pageSize);
  const startIndex = (currentPage - 1) * pageSize + 1;
  const endIndex = Math.min(currentPage * pageSize, totalItems);

  // Update page info
  pageInfo.textContent = `${startIndex}-${endIndex} of ${totalItems}`;

  // Update buttons
  prevPageBtn.disabled = currentPage <= 1;
  nextPageBtn.disabled = currentPage >= totalPages;

  // Update page numbers
  pageNumbers.innerHTML = '';
  for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    pageBtn.className = `px-3 py-1 text-sm rounded-md ${
      i === currentPage
        ? 'bg-accent text-white'
        : 'text-neutral-700 hover:bg-neutral-100'
    }`;
    
    if (i !== currentPage) {
      pageBtn.addEventListener('click', () => {
        currentPage = i;
        funRenderCurrentPage();
      });
    }

    pageNumbers.appendChild(pageBtn);
  }
}

// Open feedback modal
async function funOpenFeedbackModal(sessionId, isEdit = false) {
  const session = allSessions.find(s => s.id === sessionId);
  if (!session) return;

  currentFeedbackSession = session;
  isEditingFeedback = isEdit;

  // Update modal title and session info
  document.getElementById('feedback-session-title').textContent = session.title;

  // Reset form
  ratingInput.value = '5';
  ratingDisplay.textContent = '5';
  commentsInput.value = '';
  commentsRequiredIndicator.classList.add('hidden');
  commentsHelp.textContent = 'Optional feedback to help improve future sessions';

  // If editing, populate existing data
  if (isEdit && session.feedbackStatus.feedback) {
    const feedback = session.feedbackStatus.feedback;
    ratingInput.value = feedback.rating || '5';
    ratingDisplay.textContent = feedback.rating || '5';
    commentsInput.value = feedback.comments || '';
  }

  // Update comments requirement based on rating
  funUpdateCommentsRequirement();

  feedbackModal.classList.remove('hidden');
  ratingInput.focus();
}

// Open view feedback modal
function funOpenViewFeedbackModal(sessionId) {
  const session = allSessions.find(s => s.id === sessionId);
  if (!session || !session.feedbackStatus.feedback) return;

  const feedback = session.feedbackStatus.feedback;

  document.getElementById('view-session-title').textContent = session.title;
  document.getElementById('view-rating').textContent = feedback.rating || 'N/A';
  document.getElementById('view-comments').textContent = feedback.comments || 'No comments provided';
  document.getElementById('view-submitted-at').textContent = formatDateTime(feedback.submittedAt);

  viewFeedbackModal.classList.remove('hidden');
}

// Update comments requirement based on rating and org settings
function funUpdateCommentsRequirement() {
  const rating = parseInt(ratingInput.value);
  const threshold = orgSettings?.mandatoryCommentThreshold || 7;

  if (rating < threshold) {
    commentsRequiredIndicator.classList.remove('hidden');
    commentsHelp.textContent = `Comments are required for ratings below ${threshold}`;
    commentsInput.required = true;
  } else {
    commentsRequiredIndicator.classList.add('hidden');
    commentsHelp.textContent = 'Optional feedback to help improve future sessions';
    commentsInput.required = false;
  }
}

// Submit feedback
async function funSubmitFeedback(e) {
  e.preventDefault();

  if (!currentFeedbackSession) return;

  const rating = parseInt(ratingInput.value);
  const comments = commentsInput.value.trim();
  const threshold = orgSettings?.mandatoryCommentThreshold || 7;

  // Validate required fields
  if (rating < threshold && !comments) {
    showToast('Comments are required for low ratings', 'error');
    commentsInput.focus();
    return;
  }

  try {
    showLoader();

    const feedbackData = {
      sessionId: currentFeedbackSession.id,
      employeeId: currentEmployee.id,
      rating,
      comments,
      submittedAt: new Date().toISOString(),
      status: 'active'
    };

    if (isEditingFeedback && currentFeedbackSession.feedbackStatus.feedback) {
      // Update existing feedback
      const feedbackId = currentFeedbackSession.feedbackStatus.feedback.id;
      await updateDoc(doc(db, 'trainingFeedback', feedbackId), feedbackData);
      showToast('Feedback updated successfully!', 'success');
    } else {
      // Create new feedback
      await addDoc(collection(db, 'trainingFeedback'), feedbackData);
      showToast('Feedback submitted successfully!', 'success');
    }

    // Close modal and refresh data
    feedbackModal.classList.add('hidden');
    currentFeedbackSession = null;
    isEditingFeedback = false;

    // Refresh sessions to update feedback status
    await funLoadTrainingSessions();

  } catch (error) {
    console.error('Error submitting feedback:', error);
    showToast('Failed to submit feedback. Please try again.', 'error');
  } finally {
    hideLoader();
  }
}

// Tab switching
function funSwitchTab(tabName) {
  if (currentTab === tabName) return;

  currentTab = tabName;
  currentPage = 1;

  // Update tab buttons
  tabButtons.forEach(btn => {
    const isActive = btn.dataset.tab === tabName;
    btn.setAttribute('aria-selected', isActive);
    
    if (isActive) {
      btn.className = 'tab-btn whitespace-nowrap px-6 py-4 text-sm font-medium text-accent border-b-2 border-accent bg-white';
    } else {
      btn.className = 'tab-btn whitespace-nowrap px-6 py-4 text-sm font-medium text-secondary border-b-2 border-transparent hover:text-primary hover:border-neutral-200';
    }
  });

  funApplyFilters();
}

// Search with debounce
function funDebounceSearch() {
  clearTimeout(funDebounceSearch.timeout);
  funDebounceSearch.timeout = setTimeout(() => {
    searchQuery = searchInput.value.trim();
    currentPage = 1;
    funApplyFilters();
  }, 300);
}

// Initialize page
async function funInitialize() {
  loadingSkeleton.classList.remove('hidden');
  dataTable.classList.add('hidden');
  emptyState.classList.add('hidden');

  // Get URL parameters
  const params = getUrlParams();
  filterSkillId = params.skillId;

  try {
    await Promise.all([
      funLoadOrgSettings(),
      funLoadTrainingSessions()
    ]);
  } catch (error) {
    console.error('Error during initialization:', error);
    funShowEmptyState();
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Tab buttons
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      funSwitchTab(btn.dataset.tab);
    });
  });

  // Search input
  searchInput.addEventListener('input', funDebounceSearch);

  // Pagination
  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      funRenderCurrentPage();
    }
  });

  nextPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredSessions.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      funRenderCurrentPage();
    }
  });

  // Refresh button
  refreshBtn.addEventListener('click', funInitialize);

  // Modal controls
  document.getElementById('close-feedback-modal').addEventListener('click', () => {
    feedbackModal.classList.add('hidden');
    currentFeedbackSession = null;
    isEditingFeedback = false;
  });

  document.getElementById('cancel-feedback').addEventListener('click', () => {
    feedbackModal.classList.add('hidden');
    currentFeedbackSession = null;
    isEditingFeedback = false;
  });

  document.getElementById('close-view-feedback-modal').addEventListener('click', () => {
    viewFeedbackModal.classList.add('hidden');
  });

  document.getElementById('close-view-feedback').addEventListener('click', () => {
    viewFeedbackModal.classList.add('hidden');
  });

  // Rating input
  ratingInput.addEventListener('input', () => {
    ratingDisplay.textContent = ratingInput.value;
    funUpdateCommentsRequirement();
  });

  // Feedback form
  feedbackForm.addEventListener('submit', funSubmitFeedback);

  // Close modals on backdrop click
  feedbackModal.addEventListener('click', (e) => {
    if (e.target === feedbackModal) {
      feedbackModal.classList.add('hidden');
      currentFeedbackSession = null;
      isEditingFeedback = false;
    }
  });

  viewFeedbackModal.addEventListener('click', (e) => {
    if (e.target === viewFeedbackModal) {
      viewFeedbackModal.classList.add('hidden');
    }
  });

  // ESC key to close modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!feedbackModal.classList.contains('hidden')) {
        feedbackModal.classList.add('hidden');
        currentFeedbackSession = null;
        isEditingFeedback = false;
      }
      if (!viewFeedbackModal.classList.contains('hidden')) {
        viewFeedbackModal.classList.add('hidden');
      }
    }
  });

  // Initialize icons
  lucide.createIcons();
});

// Auth state management
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'auth.html?redirect=' + encodeURIComponent(location.pathname + location.search);
    return;
  }

  currentUser = user;
  currentEmployee = await funLoadCurrentEmployee(user.uid);

  if (!currentEmployee) {
    showToast('Employee profile not found', 'error');
    return;
  }

  await funInitialize();
});
</script>

</body>
</html>