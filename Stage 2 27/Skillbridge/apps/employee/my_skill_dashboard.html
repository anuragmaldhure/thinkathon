<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Custom Tailwind Configuration -->
    <script data-tiramai="web-gen">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1e293b',
              secondary: '#475569',
              accent: '#2563eb',
              gold: '#CBA35C',
              success: '#16A34A',
              warning: '#D97706',
              error: '#DC2626',
              info: '#0EA5E9',
              neutral: {
                50: '#F8FAFC',
                100: '#F1F5F9',
                200: '#E2E8F0',
                400: '#94A3B8',
                700: '#334155',
                900: '#0F172A',
              }
            },
            fontFamily: {
              sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
            },
            boxShadow: {
              sm: '0 1px 2px rgba(15,23,42,0.06)',
              DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
              lg: '0 8px 24px rgba(15,23,42,0.12)',
            }
          }
        }
      }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <!-- Logo SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="flex-shrink-0">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-lg font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-secondary hover:text-primary hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                <span class="sr-only">Open main menu</span>
                <svg class="w-6 h-6" data-lucide="menu"></svg>
            </button>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="inline-flex items-center gap-2 bg-white border border-neutral-200 rounded-md px-3 py-2 text-sm hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="w-6 h-6 rounded-full bg-accent text-white text-xs font-medium flex items-center justify-center" id="user-avatar">
                        U
                    </div>
                    <span id="user-name" class="text-neutral-700">Loading...</span>
                    <svg class="w-4 h-4 text-secondary" data-lucide="chevron-down"></svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg border border-neutral-200 py-2 z-40">
                    <div class="px-4 py-3 border-b border-neutral-100">
                        <p id="dropdown-name" class="text-sm font-medium text-primary">John Doe</p>
                        <p id="dropdown-email" class="text-xs text-secondary">johndoe@example.com</p>
                        <p class="text-xs text-neutral-400 mt-1">Employee</p>
                    </div>
                    <button id="sign-out-btn" class="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <svg class="w-4 h-4" data-lucide="log-out"></svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-[73px]">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] sticky top-[73px] overflow-y-auto md:block hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- Made with TiramAi footer -->
            <div class="absolute bottom-4 w-full text-center text-xs text-neutral-400 bg-white rounded px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>

        <!-- Mobile Sidebar -->
        <aside id="mobile-sidebar" class="hidden fixed left-0 top-[73px] w-64 bg-white border-r border-neutral-200 h-[calc(100vh-73px)] overflow-y-auto z-30 md:hidden">
            <nav class="p-4 space-y-2">
                <!-- My Skill Dashboard -->
                <div>
                    <a href="my_skill_dashboard.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-100 hover:text-primary group" data-page="my_skill_dashboard">
                        <svg class="w-5 h-5 text-secondary group-hover:text-accent" data-lucide="layout-dashboard"></svg>
                        <span class="font-medium">My Skill Dashboard</span>
                    </a>
                    
                    <!-- Collapsible children -->
                    <div class="ml-8 mt-2 space-y-1">
                        <a href="training_and_feedback.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="training_and_feedback">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="book-open"></svg>
                            <span>Training & Feedback</span>
                        </a>
                        <a href="my_disputes.html" class="nav-link flex items-center gap-3 px-3 py-2 rounded text-xs text-neutral-600 hover:bg-neutral-50 hover:text-primary" data-page="my_disputes">
                            <svg class="w-4 h-4 text-neutral-400" data-lucide="gavel"></svg>
                            <span>My Disputes</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px]">
            
<!-- Header Section with Active Cycle and Summary -->
<div class="space-y-6">
  <!-- Active Cycle Banner -->
  <div id="cycle-banner" class="hidden bg-neutral-100 border-l-4 border-accent px-4 py-3 rounded">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-accent" data-lucide="calendar"></svg>
      <div>
        <p class="text-sm font-medium text-primary">Active Assessment Cycle</p>
        <p id="cycle-name" class="text-xs text-secondary">Loading...</p>
        <p id="cycle-dates" class="text-xs text-neutral-400">Loading...</p>
      </div>
    </div>
  </div>

  <!-- No Active Cycle Banner -->
  <div id="no-cycle-banner" class="hidden bg-warning/10 border-l-4 border-warning px-4 py-3 rounded">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-warning" data-lucide="alert-triangle"></svg>
      <div>
        <p class="text-sm font-medium text-warning">No Active Assessment Cycle</p>
        <p class="text-xs text-neutral-600">There is currently no active assessment cycle. Some features may be limited.</p>
      </div>
    </div>
  </div>

  <!-- Page Header with Summary Stats -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-primary">My Skill Dashboard</h1>
      <p class="text-sm text-secondary mt-1">Track your skill gaps and development progress</p>
    </div>
    
    <!-- Summary Cards -->
    <div class="flex flex-wrap gap-4">
      <div class="bg-white rounded-md border border-neutral-200 px-4 py-3 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="h-3 w-3 rounded-full bg-success"></span>
          <span class="text-xs font-medium text-secondary">Green</span>
          <span id="green-count" class="text-sm font-bold text-primary">0</span>
        </div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 px-4 py-3 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="h-3 w-3 rounded-full bg-warning"></span>
          <span class="text-xs font-medium text-secondary">Amber</span>
          <span id="amber-count" class="text-sm font-bold text-primary">0</span>
        </div>
      </div>
      <div class="bg-white rounded-md border border-neutral-200 px-4 py-3 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="h-3 w-3 rounded-full bg-error"></span>
          <span class="text-xs font-medium text-secondary">Red</span>
          <span id="red-count" class="text-sm font-bold text-primary">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search Section -->
  <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
    <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
      <!-- Search -->
      <div class="lg:col-span-2">
        <label class="block text-xs font-medium text-secondary mb-1">Search Skills</label>
        <div class="relative">
          <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-1/2 transform -translate-y-1/2" data-lucide="search"></svg>
          <input 
            type="text" 
            id="search-input"
            placeholder="Search by skill name..."
            class="w-full pl-10 pr-3 py-2 border border-neutral-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
          >
        </div>
      </div>

      <!-- Category Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Category</label>
        <select id="category-filter" multiple class="w-full border border-neutral-200 rounded text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 bg-white">
          <option value="">All Categories</option>
        </select>
      </div>

      <!-- Criticality Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Criticality</label>
        <select id="criticality-filter" multiple class="w-full border border-neutral-200 rounded text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 bg-white">
          <option value="">All Levels</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Status</label>
        <select id="status-filter" multiple class="w-full border border-neutral-200 rounded text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 bg-white">
          <option value="">All Status</option>
          <option value="Green">Green</option>
          <option value="Amber">Amber</option>
          <option value="Red">Red</option>
        </select>
      </div>

      <!-- TNI Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">TNI</label>
        <select id="tni-filter" class="w-full border border-neutral-200 rounded text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 bg-white">
          <option value="">All</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <!-- Assessed Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Assessed</label>
        <select id="assessed-filter" class="w-full border border-neutral-200 rounded text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 bg-white">
          <option value="">All</option>
          <option value="Yes">Current Cycle</option>
          <option value="No">Not in Current</option>
        </select>
      </div>
    </div>
    
    <!-- Filter Actions -->
    <div class="flex items-center justify-between mt-4 pt-4 border-t border-neutral-200">
      <button 
        id="clear-filters" 
        class="inline-flex items-center gap-2 text-sm text-secondary hover:text-primary"
      >
        <svg class="w-4 h-4" data-lucide="x"></svg>
        Clear Filters
      </button>
      
      <div class="flex items-center gap-3">
        <button 
          id="refresh-btn"
          class="inline-flex items-center gap-2 text-sm text-secondary hover:text-primary"
          aria-label="Refresh data"
        >
          <svg class="w-4 h-4" data-lucide="refresh-cw"></svg>
          Refresh
        </button>
        
        <div class="text-xs text-neutral-400">
          <span id="results-count">0</span> skills found
        </div>
      </div>
    </div>
  </div>

  <!-- Skills Data Grid -->
  <div class="bg-white rounded-md border border-neutral-200 shadow-sm overflow-hidden">
    <!-- Table Header with Sorting -->
    <div class="bg-neutral-50 border-b border-neutral-200 px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h3 class="text-sm font-semibold text-primary">Skills</h3>
          <select id="sort-by" class="text-xs border border-neutral-200 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <option value="weightedGap">Sort by Weighted Gap</option>
            <option value="gap">Sort by Gap</option>
            <option value="skillName">Sort by Skill Name</option>
            <option value="categoryName">Sort by Category</option>
            <option value="latestScore">Sort by Latest Score</option>
            <option value="criticalityWeight">Sort by Criticality</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-xs text-secondary">Page size:</label>
          <select id="page-size" class="text-xs border border-neutral-200 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-neutral-50 border-b border-neutral-200 text-xs text-secondary">
          <tr>
            <th class="text-left px-4 py-3 font-medium min-w-[200px]">Skill</th>
            <th class="text-left px-4 py-3 font-medium min-w-[120px]">Criticality</th>
            <th class="text-center px-4 py-3 font-medium min-w-[100px]">Latest Score</th>
            <th class="text-left px-4 py-3 font-medium min-w-[120px]">Benchmark</th>
            <th class="text-center px-4 py-3 font-medium min-w-[80px]">Gap</th>
            <th class="text-center px-4 py-3 font-medium min-w-[80px]">Status</th>
            <th class="text-center px-4 py-3 font-medium min-w-[60px]">TNI</th>
            <th class="text-center px-4 py-3 font-medium min-w-[80px]">Assessed</th>
            <th class="text-center px-4 py-3 font-medium min-w-[200px]">Actions</th>
          </tr>
        </thead>
        <tbody id="skills-table-body" class="divide-y divide-neutral-100">
          <!-- Skills will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="hidden p-4">
      <div class="space-y-3">
        <div class="animate-pulse">
          <div class="grid grid-cols-9 gap-4">
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
          </div>
        </div>
        <div class="animate-pulse">
          <div class="grid grid-cols-9 gap-4">
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
          </div>
        </div>
        <div class="animate-pulse">
          <div class="grid grid-cols-9 gap-4">
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded"></div>
            <div class="h-4 bg-neutral-200 rounded col-span-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden p-12 text-center">
      <svg class="w-12 h-12 text-neutral-400 mx-auto mb-4" data-lucide="search"></svg>
      <h3 class="text-lg font-medium text-primary mb-2">No skills found</h3>
      <p class="text-sm text-secondary mb-4">Try adjusting your filters or search terms.</p>
      <button 
        id="clear-filters-empty" 
        class="inline-flex items-center gap-2 bg-accent text-white px-4 py-2 rounded-md text-sm hover:bg-accent/90 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
      >
        Clear All Filters
      </button>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="bg-neutral-50 border-t border-neutral-200 px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <span class="text-xs text-secondary">
            Showing <span id="page-start">1</span> to <span id="page-end">10</span> of <span id="total-count">0</span> skills
          </span>
        </div>
        
        <div class="flex items-center gap-2">
          <button 
            id="prev-page" 
            class="inline-flex items-center gap-1 px-3 py-1 text-xs border border-neutral-200 rounded bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <svg class="w-3 h-3" data-lucide="chevron-left"></svg>
            Previous
          </button>
          
          <span class="px-3 py-1 text-xs text-secondary">
            Page <span id="current-page">1</span> of <span id="total-pages">1</span>
          </span>
          
          <button 
            id="next-page" 
            class="inline-flex items-center gap-1 px-3 py-1 text-xs border border-neutral-200 rounded bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Next
            <svg class="w-3 h-3" data-lucide="chevron-right"></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Skill Timeline Modal -->
<div id="timeline-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
  <!-- Desktop: Side drawer -->
  <div class="hidden md:block">
    <div class="fixed right-0 top-0 h-full w-[480px] bg-white shadow-lg transform translate-x-full transition-transform duration-300" id="timeline-drawer">
      <div class="flex flex-col h-full">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-neutral-200">
          <div class="flex-1 min-w-0">
            <h2 id="modal-skill-name" class="text-lg font-semibold text-primary truncate">Skill Timeline</h2>
            <div class="flex items-center gap-2 mt-1">
              <span id="modal-skill-category" class="inline-block px-2 py-1 text-xs font-medium bg-neutral-100 text-neutral-700 rounded-full">Category</span>
              <span id="modal-skill-criticality" class="inline-block px-2 py-1 text-xs font-medium bg-accent/10 text-accent rounded-full">Criticality</span>
            </div>
          </div>
          <button id="close-timeline-modal" class="ml-4 p-2 hover:bg-neutral-100 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <svg class="w-5 h-5 text-secondary" data-lucide="x"></svg>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6">
          <!-- Controls -->
          <div class="flex items-center justify-between mb-6 pb-4 border-b border-neutral-200">
            <div class="flex items-center gap-4">
              <div>
                <label class="block text-xs font-medium text-secondary mb-1">Time Range</label>
                <select id="time-range" class="text-xs border border-neutral-200 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                  <option value="all">All Time</option>
                  <option value="12m">Last 12 Months</option>
                  <option value="6m">Last 6 Months</option>
                </select>
              </div>
              
              <div class="flex items-center gap-2">
                <input type="checkbox" id="show-markers" class="rounded border-neutral-300 text-accent focus:ring-accent focus:ring-offset-0" checked>
                <label for="show-markers" class="text-xs text-secondary">Show training markers</label>
              </div>
            </div>
            
            <button id="export-csv" class="inline-flex items-center gap-2 text-xs text-accent hover:text-accent/80 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 rounded">
              <svg class="w-4 h-4" data-lucide="download"></svg>
              Export CSV
            </button>
          </div>

          <!-- Chart Container -->
          <div class="mb-6">
            <div id="timeline-chart" class="h-64 bg-neutral-50 rounded border border-neutral-200 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-8 h-8 text-neutral-400 mx-auto mb-2" data-lucide="trending-up"></svg>
                <p class="text-sm text-secondary">Timeline chart will load here</p>
              </div>
            </div>
          </div>

          <!-- Timeline Table -->
          <div class="border border-neutral-200 rounded overflow-hidden">
            <div class="bg-neutral-50 px-4 py-3 border-b border-neutral-200">
              <h3 class="text-sm font-semibold text-primary">Assessment History</h3>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-neutral-50 border-b border-neutral-200 text-xs text-secondary">
                  <tr>
                    <th class="text-left px-4 py-2 font-medium">Date</th>
                    <th class="text-center px-4 py-2 font-medium">Score</th>
                    <th class="text-center px-4 py-2 font-medium">Benchmark</th>
                    <th class="text-center px-4 py-2 font-medium">Gap</th>
                    <th class="text-center px-4 py-2 font-medium">TNI</th>
                    <th class="text-left px-4 py-2 font-medium">Type</th>
                    <th class="text-left px-4 py-2 font-medium">Cycle</th>
                  </tr>
                </thead>
                <tbody id="timeline-table-body" class="divide-y divide-neutral-100">
                  <!-- Timeline entries will be populated here -->
                </tbody>
              </table>
            </div>

            <!-- Loading state for timeline -->
            <div id="timeline-loading" class="p-8 text-center">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-accent border-t-transparent"></div>
              <p class="text-sm text-secondary mt-2">Loading timeline data...</p>
            </div>

            <!-- Empty timeline state -->
            <div id="timeline-empty" class="hidden p-8 text-center">
              <svg class="w-8 h-8 text-neutral-400 mx-auto mb-2" data-lucide="clock"></svg>
              <p class="text-sm text-secondary">No assessment history available for this skill.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile: Full screen -->
  <div class="md:hidden">
    <div class="fixed inset-0 bg-white transform translate-y-full transition-transform duration-300" id="timeline-mobile">
      <div class="flex flex-col h-full">
        <!-- Mobile Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-neutral-200">
          <div class="flex-1 min-w-0">
            <h2 id="mobile-modal-skill-name" class="text-lg font-semibold text-primary truncate">Skill Timeline</h2>
            <div class="flex items-center gap-2 mt-1">
              <span id="mobile-modal-skill-category" class="inline-block px-2 py-1 text-xs font-medium bg-neutral-100 text-neutral-700 rounded-full">Category</span>
            </div>
          </div>
          <button id="close-timeline-mobile" class="ml-4 p-2 hover:bg-neutral-100 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <svg class="w-5 h-5 text-secondary" data-lucide="x"></svg>
          </button>
        </div>

        <!-- Mobile Content (same structure but responsive) -->
        <div class="flex-1 overflow-y-auto p-4">
          <!-- Same content as desktop but mobile optimized -->
          <div class="space-y-4">
            <!-- Mobile controls -->
            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-secondary mb-1">Time Range</label>
                <select id="mobile-time-range" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                  <option value="all">All Time</option>
                  <option value="12m">Last 12 Months</option>
                  <option value="6m">Last 6 Months</option>
                </select>
              </div>
              
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="mobile-show-markers" class="rounded border-neutral-300 text-accent focus:ring-accent focus:ring-offset-0" checked>
                  <label for="mobile-show-markers" class="text-sm text-secondary">Show training markers</label>
                </div>
                
                <button id="mobile-export-csv" class="inline-flex items-center gap-2 text-sm text-accent hover:text-accent/80">
                  <svg class="w-4 h-4" data-lucide="download"></svg>
                  Export
                </button>
              </div>
            </div>

            <!-- Mobile Chart Container -->
            <div id="mobile-timeline-chart" class="h-64 bg-neutral-50 rounded border border-neutral-200 flex items-center justify-center">
              <div class="text-center">
                <svg class="w-8 h-8 text-neutral-400 mx-auto mb-2" data-lucide="trending-up"></svg>
                <p class="text-sm text-secondary">Timeline chart will load here</p>
              </div>
            </div>

            <!-- Mobile Timeline Table - simplified for mobile -->
            <div class="border border-neutral-200 rounded overflow-hidden">
              <div class="bg-neutral-50 px-4 py-3 border-b border-neutral-200">
                <h3 class="text-sm font-semibold text-primary">Assessment History</h3>
              </div>
              
              <div id="mobile-timeline-list" class="divide-y divide-neutral-100">
                <!-- Mobile timeline entries will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileOverlay = document.getElementById('mobile-overlay');
        const mobileSidebar = document.getElementById('mobile-sidebar');

        // User profile dropdown toggle
        userProfileBtn?.addEventListener('click', () => {
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userProfileBtn?.contains(e.target) && !userDropdown?.contains(e.target)) {
                userDropdown?.classList.add('hidden');
            }
        });

        // Mobile menu toggle
        mobileMenuBtn?.addEventListener('click', () => {
            mobileSidebar.classList.toggle('hidden');
            mobileOverlay.classList.toggle('hidden');
        });

        mobileOverlay?.addEventListener('click', () => {
            mobileSidebar.classList.add('hidden');
            mobileOverlay.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn?.addEventListener('click', async () => {
            try {
                showLoader();
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Failed to sign out', 'error');
            } finally {
                hideLoader();
            }
        });

        // Set active nav link based on current page
        function setActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('bg-accent', 'text-white');
                link.classList.add('text-neutral-700');
                
                const linkPage = link.getAttribute('data-page');
                if (linkPage === currentPage) {
                    link.classList.remove('text-neutral-700', 'hover:bg-neutral-100');
                    link.classList.add('bg-accent', 'text-white');
                }
            });
        }

        // Auth state management
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                let userData = userDoc.exists() ? userDoc.data() : null;

                // Fallback to Firebase Auth data
                const displayName = userData?.firstName && userData?.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : user.displayName || user.email.split('@')[0];
                
                const email = userData?.email || user.email;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();

                // Update UI
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = email;

            } catch (error) {
                console.error('Error fetching user data:', error);
                // Fallback to basic auth data
                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-avatar').textContent = initials.substring(0, 2);
                document.getElementById('dropdown-name').textContent = displayName;
                document.getElementById('dropdown-email').textContent = user.email;
            }
        });

        // Initialize active nav state
        setActiveNavLink();
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
  // Firebase imports
  import { 
    collection, getDocs, getDoc, doc, query, where, orderBy, limit, startAfter, 
    getCountFromServer, Timestamp 
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { auth, getDb } from "./scripts/firebase.js";
  import { showToast, showLoader, hideLoader } from "./scripts/main.js";

  // Global variables
  let currentUser = null;
  let activeCycle = null;
  let db = null;
  let currentData = [];
  let filteredData = [];
  let paginatedData = [];
  let currentPage = 1;
  let pageSize = 10;
  let totalCount = 0;
  let lastVisible = null;
  let isLoading = false;
  let filters = {
    search: '',
    categories: [],
    criticalities: [],
    statuses: [],
    tni: '',
    assessed: ''
  };
  let sortBy = 'weightedGap';
  let sortDir = 'desc';

  // DOM elements
  const elements = {
    cycleBanner: document.getElementById('cycle-banner'),
    noCycleBanner: document.getElementById('no-cycle-banner'),
    cycleName: document.getElementById('cycle-name'),
    cycleDates: document.getElementById('cycle-dates'),
    greenCount: document.getElementById('green-count'),
    amberCount: document.getElementById('amber-count'),
    redCount: document.getElementById('red-count'),
    searchInput: document.getElementById('search-input'),
    categoryFilter: document.getElementById('category-filter'),
    criticalityFilter: document.getElementById('criticality-filter'),
    statusFilter: document.getElementById('status-filter'),
    tniFilter: document.getElementById('tni-filter'),
    assessedFilter: document.getElementById('assessed-filter'),
    clearFilters: document.getElementById('clear-filters'),
    clearFiltersEmpty: document.getElementById('clear-filters-empty'),
    refreshBtn: document.getElementById('refresh-btn'),
    resultsCount: document.getElementById('results-count'),
    sortBy: document.getElementById('sort-by'),
    pageSize: document.getElementById('page-size'),
    skillsTableBody: document.getElementById('skills-table-body'),
    loadingSkeleton: document.getElementById('loading-skeleton'),
    emptyState: document.getElementById('empty-state'),
    pagination: document.getElementById('pagination'),
    pageStart: document.getElementById('page-start'),
    pageEnd: document.getElementById('page-end'),
    totalCountSpan: document.getElementById('total-count'),
    currentPageSpan: document.getElementById('current-page'),
    totalPagesSpan: document.getElementById('total-pages'),
    prevPage: document.getElementById('prev-page'),
    nextPage: document.getElementById('next-page'),
    timelineModal: document.getElementById('timeline-modal'),
    timelineDrawer: document.getElementById('timeline-drawer'),
    timelineMobile: document.getElementById('timeline-mobile'),
    closeTimelineModal: document.getElementById('close-timeline-modal'),
    closeTimelineMobile: document.getElementById('close-timeline-mobile')
  };

  // Utility functions
  const createSemaphore = (max = 2) => {
    const queue = [];
    let active = 0;
    const next = () => {
      if (active >= max || queue.length === 0) return;
      active++;
      const { fn, res, rej } = queue.shift();
      Promise.resolve()
        .then(fn)
        .then(v => res(v))
        .catch(e => rej(e))
        .finally(() => { active--; next(); });
    };
    return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
  };

  const withLimit = createSemaphore(2);
  const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

  let currentAbortController = null;

  const abortableQuery = async (queryFn) => {
    if (currentAbortController) currentAbortController.abort();
    currentAbortController = new AbortController();
    const signal = currentAbortController.signal;

    try {
      const result = await queryFn();
      if (signal.aborted) return null;
      return result;
    } catch (err) {
      if (signal.aborted) return null;
      throw err;
    }
  };

  const formatDate = (dateStr) => {
    if (!dateStr) return 'N/A';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IN', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    } catch {
      return 'N/A';
    }
  };

  const formatScore = (score) => {
    return score != null && score !== undefined ? score.toString() : 'N/A';
  };

  const calculateGap = (benchmark, score) => {
    if (benchmark == null || score == null) return 0;
    return Math.max(0, benchmark - score);
  };

  const getStatusColor = (gap, tniIgnoreThreshold = 1) => {
    if (gap <= 0) return 'Green';
    if (gap <= tniIgnoreThreshold) return 'Amber';
    return 'Red';
  };

  const getTNIFlag = (gap) => gap > 0 ? 'Yes' : 'No';

  // Data loading functions
  const funLoadActiveCycle = async () => {
    try {
      const today = new Date().toISOString();
      const cyclesRef = collection(db, 'assessmentCycles');
      const q = query(cyclesRef, where('status', '==', 'active'));
      
      const snapshot = await withLimit(() => getDocs(q));
      const cycles = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data && data.startDate && data.endDate) {
          if (today >= data.startDate && today <= data.endDate) {
            cycles.push({ id: doc.id, ...data });
          }
        }
      });

      // Pick the most recent active cycle if multiple
      activeCycle = cycles.length > 0 ? cycles.sort((a, b) => 
        new Date(b.startDate) - new Date(a.startDate))[0] : null;

      funUpdateCycleBanner();
      return activeCycle;
    } catch (error) {
      console.error('Error loading active cycle:', error);
      showToast('Failed to load assessment cycle information');
      return null;
    }
  };

  const funUpdateCycleBanner = () => {
    if (activeCycle) {
      elements.cycleBanner.classList.remove('hidden');
      elements.noCycleBanner.classList.add('hidden');
      elements.cycleName.textContent = activeCycle.name || 'N/A';
      
      const startDate = formatDate(activeCycle.startDate);
      const endDate = formatDate(activeCycle.endDate);
      elements.cycleDates.textContent = `${startDate} - ${endDate}`;
    } else {
      elements.cycleBanner.classList.add('hidden');
      elements.noCycleBanner.classList.remove('hidden');
    }
  };

  const funLoadOrgSettings = async () => {
    try {
      const settingsRef = collection(db, 'orgSettings');
      const q = query(settingsRef, where('effectiveEndDate', '==', null));
      
      const snapshot = await withLimit(() => getDocs(q));
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        return doc.data();
      }
      
      // Default settings if none found
      return {
        tniIgnoreThreshold: 1,
        reassessmentDelayDays: 14,
        mandatoryCommentThreshold: 7
      };
    } catch (error) {
      console.error('Error loading org settings:', error);
      return {
        tniIgnoreThreshold: 1,
        reassessmentDelayDays: 14,
        mandatoryCommentThreshold: 7
      };
    }
  };

  const funLoadReferenceData = async () => {
    try {
      const [categoriesSnapshot, criticalitiesSnapshot] = await Promise.all([
        withLimit(() => getDocs(query(collection(db, 'skillCategories'), where('status', '==', 'active')))),
        withLimit(() => getDocs(query(collection(db, 'skillCriticalities'), where('status', '==', 'active'))))
      ]);

      const categories = {};
      const criticalities = {};

      categoriesSnapshot.forEach(doc => {
        const data = doc.data();
        if (data) {
          categories[doc.id] = data;
        }
      });

      criticalitiesSnapshot.forEach(doc => {
        const data = doc.data();
        if (data) {
          criticalities[doc.id] = data;
        }
      });

      return { categories, criticalities };
    } catch (error) {
      console.error('Error loading reference data:', error);
      return { categories: {}, criticalities: {} };
    }
  };

  const funLoadEmployeeSkills = async () => {
    try {
      if (!currentUser?.uid) return [];

      // Get employee record
      const employeesRef = collection(db, 'employees');
      const empQuery = query(employeesRef, where('userId', '==', currentUser.uid));
      const empSnapshot = await withLimit(() => getDocs(empQuery));
      
      if (empSnapshot.empty) {
        showToast('Employee record not found');
        return [];
      }

      const employee = empSnapshot.docs[0];
      const employeeId = employee.id;

      // Get skill mappings
      const mappingsRef = collection(db, 'employeeSkillMappings');
      const mappingsQuery = query(
        mappingsRef, 
        where('employeeId', '==', employeeId),
        where('status', '==', 'active')
      );

      const mappingsSnapshot = await withLimit(() => getDocs(mappingsQuery));
      const skillIds = mappingsSnapshot.docs.map(doc => doc.data()?.skillId).filter(Boolean);

      if (skillIds.length === 0) return [];

      // Get skills data
      const skills = {};
      const skillsRef = collection(db, 'skills');
      
      // Load skills in batches of 10 (Firestore limit for 'in' queries)
      const skillBatches = [];
      for (let i = 0; i < skillIds.length; i += 10) {
        const batch = skillIds.slice(i, i + 10);
        const skillQuery = query(skillsRef, where('__name__', 'in', batch.map(id => doc(skillsRef, id))));
        skillBatches.push(withLimit(() => getDocs(skillQuery)));
      }

      const skillSnapshots = await Promise.all(skillBatches);
      skillSnapshots.forEach(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data && data.status === 'active') {
            skills[doc.id] = { id: doc.id, ...data };
          }
        });
      });

      return Object.values(skills);
    } catch (error) {
      console.error('Error loading employee skills:', error);
      showToast('Failed to load skills data');
      return [];
    }
  };

  const funLoadAssessmentsForSkills = async (skillIds) => {
    try {
      if (!currentUser?.uid || skillIds.length === 0) return {};

      // Get employee ID
      const employeesRef = collection(db, 'employees');
      const empQuery = query(employeesRef, where('userId', '==', currentUser.uid));
      const empSnapshot = await withLimit(() => getDocs(empQuery));
      
      if (empSnapshot.empty) return {};

      const employeeId = empSnapshot.docs[0].id;

      // Get assessments for this employee
      const assessmentsRef = collection(db, 'assessments');
      const assessQuery = query(
        assessmentsRef,
        where('employeeId', '==', employeeId),
        orderBy('submittedAt', 'desc')
      );

      const assessmentsSnapshot = await withLimit(() => getDocs(assessQuery));
      const skillAssessments = {};

      // Process assessments to find latest score per skill
      assessmentsSnapshot.forEach(doc => {
        const assessment = doc.data();
        if (!assessment?.items || !Array.isArray(assessment.items)) return;

        assessment.items.forEach(item => {
          if (!item?.skillId || !skillIds.includes(item.skillId)) return;

          const skillId = item.skillId;
          const existing = skillAssessments[skillId];
          
          // Prefer assessment from active cycle, otherwise take most recent
          const isActiveCycle = activeCycle && assessment.cycleId === activeCycle.id;
          const shouldUpdate = !existing || 
            (isActiveCycle && (!existing.isActiveCycle || assessment.submittedAt > existing.submittedAt)) ||
            (!isActiveCycle && !existing.isActiveCycle && assessment.submittedAt > existing.submittedAt);

          if (shouldUpdate) {
            skillAssessments[skillId] = {
              ...item,
              assessmentId: doc.id,
              submittedAt: assessment.submittedAt,
              cycleId: assessment.cycleId,
              type: assessment.type,
              isActiveCycle
            };
          }
        });
      });

      return skillAssessments;
    } catch (error) {
      console.error('Error loading assessments:', error);
      return {};
    }
  };

  const funLoadBenchmarkVersions = async (skillIds) => {
    try {
      if (skillIds.length === 0) return {};

      const benchmarks = {};
      const benchmarkRef = collection(db, 'skillBenchmarkVersions');

      // Load benchmarks in batches
      const benchmarkBatches = [];
      for (let i = 0; i < skillIds.length; i += 10) {
        const batch = skillIds.slice(i, i + 10);
        const benchmarkQuery = query(benchmarkRef, where('skillId', 'in', batch));
        benchmarkBatches.push(withLimit(() => getDocs(benchmarkQuery)));
      }

      const benchmarkSnapshots = await Promise.all(benchmarkBatches);
      benchmarkSnapshots.forEach(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data?.skillId) return;

          const skillId = data.skillId;
          if (!benchmarks[skillId]) benchmarks[skillId] = [];
          benchmarks[skillId].push({ id: doc.id, ...data });
        });
      });

      // Sort benchmarks by effective date and find current ones
      Object.keys(benchmarks).forEach(skillId => {
        benchmarks[skillId].sort((a, b) => {
          const aDate = a.effectiveStartDate ? new Date(a.effectiveStartDate) : new Date(0);
          const bDate = b.effectiveStartDate ? new Date(b.effectiveStartDate) : new Date(0);
          return bDate - aDate;
        });
      });

      return benchmarks;
    } catch (error) {
      console.error('Error loading benchmark versions:', error);
      return {};
    }
  };

  const funGetCurrentBenchmark = (skillBenchmarks) => {
    if (!skillBenchmarks || skillBenchmarks.length === 0) return null;
    
    // Find the current benchmark (effectiveEndDate is null)
    const current = skillBenchmarks.find(b => !b.effectiveEndDate);
    if (current) return current;
    
    // If no current benchmark, return the most recent
    return skillBenchmarks[0];
  };

  const funGetBenchmarkForAssessment = (skillBenchmarks, assessment) => {
    if (!skillBenchmarks || !assessment) return null;

    // Use snapshot if available
    if (assessment.benchmarkScoreSnapshot != null) {
      return { score: assessment.benchmarkScoreSnapshot, isSnapshot: true };
    }

    // Use benchmarkVersionId if available
    if (assessment.benchmarkVersionId) {
      const version = skillBenchmarks.find(b => b.id === assessment.benchmarkVersionId);
      if (version) return { score: version.score, version: version.id };
    }

    // Fallback to current benchmark
    const current = funGetCurrentBenchmark(skillBenchmarks);
    return current ? { score: current.score, version: current.id } : null;
  };

  const funProcessSkillsData = async (skills, referenceData, orgSettings) => {
    try {
      if (skills.length === 0) return [];

      const skillIds = skills.map(s => s.id);
      const [assessments, benchmarks] = await Promise.all([
        funLoadAssessmentsForSkills(skillIds),
        funLoadBenchmarkVersions(skillIds)
      ]);

      await yieldToFrame(); // Yield to prevent blocking

      const processedSkills = skills.map(skill => {
        const category = referenceData.categories[skill.categoryId] || { name: 'Unknown', id: skill.categoryId };
        const criticality = referenceData.criticalities[skill.criticalityId] || { name: 'Unknown', weight: 1, id: skill.criticalityId };
        const assessment = assessments[skill.id];
        const skillBenchmarks = benchmarks[skill.id] || [];

        let latestScore = null;
        let benchmarkUsed = null;
        let benchmarkVersion = null;
        let isCurrentCycle = false;
        let isPostTraining = false;

        if (assessment) {
          latestScore = assessment.score;
          isCurrentCycle = assessment.isActiveCycle;
          
          const benchmarkInfo = funGetBenchmarkForAssessment(skillBenchmarks, assessment);
          if (benchmarkInfo) {
            benchmarkUsed = benchmarkInfo.score;
            benchmarkVersion = benchmarkInfo.version || 'Snapshot';
          }

          // Check for post-training assessment
          if (assessment.type === 'reassessment') {
            isPostTraining = true;
          }
        }

        // Use current benchmark as fallback
        if (benchmarkUsed == null) {
          const current = funGetCurrentBenchmark(skillBenchmarks);
          if (current) {
            benchmarkUsed = current.score;
            benchmarkVersion = current.id;
          }
        }

        const gap = calculateGap(benchmarkUsed, latestScore);
        const weightedGap = gap * (criticality.weight || 1);
        const statusColor = getStatusColor(gap, orgSettings.tniIgnoreThreshold);
        const tniFlag = getTNIFlag(gap);
        const assessedInCurrentCycle = isCurrentCycle;

        return {
          id: skill.id,
          name: skill.name || 'Unnamed Skill',
          category: category.name,
          categoryId: category.id,
          criticality: criticality.name,
          criticalityWeight: criticality.weight || 1,
          criticalityId: criticality.id,
          latestScore,
          benchmarkUsed,
          benchmarkVersion,
          gap,
          weightedGap,
          statusColor,
          tniFlag,
          assessedInCurrentCycle,
          isPostTraining,
          hasAssessment: !!assessment,
          assessmentId: assessment?.assessmentId
        };
      });

      return processedSkills;
    } catch (error) {
      console.error('Error processing skills data:', error);
      showToast('Error processing skills data');
      return [];
    }
  };

  const funLoadAllData = async (forceReload = false) => {
    try {
      if (isLoading) return;
      isLoading = true;

      funShowLoadingState();

      const [activeCycleResult, orgSettings, referenceData] = await Promise.all([
        funLoadActiveCycle(),
        funLoadOrgSettings(),
        funLoadReferenceData()
      ]);

      const skills = await funLoadEmployeeSkills();
      const processedData = await funProcessSkillsData(skills, referenceData, orgSettings);

      currentData = processedData;
      
      await yieldToFrame();
      
      funPopulateFilters(referenceData);
      funApplyFiltersAndPagination();
      funUpdateSummaryStats();
      
    } catch (error) {
      console.error('Error loading data:', error);
      showToast('Failed to load dashboard data');
      funShowEmptyState();
    } finally {
      isLoading = false;
      funHideLoadingState();
    }
  };

  const funPopulateFilters = (referenceData) => {
    // Populate category filter
    elements.categoryFilter.innerHTML = '<option value="">All Categories</option>';
    Object.values(referenceData.categories).forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      elements.categoryFilter.appendChild(option);
    });

    // Populate criticality filter
    elements.criticalityFilter.innerHTML = '<option value="">All Levels</option>';
    Object.values(referenceData.criticalities)
      .sort((a, b) => (b.weight || 0) - (a.weight || 0))
      .forEach(criticality => {
        const option = document.createElement('option');
        option.value = criticality.id;
        option.textContent = `${criticality.name} (${criticality.weight || 1})`;
        elements.criticalityFilter.appendChild(option);
      });
  };

  const funApplyFilters = () => {
    let filtered = [...currentData];

    // Search filter
    if (filters.search) {
      const searchTerm = filters.search.toLowerCase();
      filtered = filtered.filter(item => 
        item.name?.toLowerCase().includes(searchTerm) ||
        item.category?.toLowerCase().includes(searchTerm)
      );
    }

    // Category filter
    if (filters.categories.length > 0) {
      filtered = filtered.filter(item => filters.categories.includes(item.categoryId));
    }

    // Criticality filter
    if (filters.criticalities.length > 0) {
      filtered = filtered.filter(item => filters.criticalities.includes(item.criticalityId));
    }

    // Status filter
    if (filters.statuses.length > 0) {
      filtered = filtered.filter(item => filters.statuses.includes(item.statusColor));
    }

    // TNI filter
    if (filters.tni) {
      filtered = filtered.filter(item => item.tniFlag === filters.tni);
    }

    // Assessed filter
    if (filters.assessed) {
      const shouldBeAssessed = filters.assessed === 'Yes';
      filtered = filtered.filter(item => item.assessedInCurrentCycle === shouldBeAssessed);
    }

    return filtered;
  };

  const funApplySorting = (data) => {
    return [...data].sort((a, b) => {
      let aVal, bVal;
      
      switch (sortBy) {
        case 'weightedGap':
          aVal = a.weightedGap || 0;
          bVal = b.weightedGap || 0;
          break;
        case 'gap':
          aVal = a.gap || 0;
          bVal = b.gap || 0;
          break;
        case 'skillName':
          aVal = a.name || '';
          bVal = b.name || '';
          break;
        case 'categoryName':
          aVal = a.category || '';
          bVal = b.category || '';
          break;
        case 'latestScore':
          aVal = a.latestScore ?? -1;
          bVal = b.latestScore ?? -1;
          break;
        case 'criticalityWeight':
          aVal = a.criticalityWeight || 0;
          bVal = b.criticalityWeight || 0;
          break;
        default:
          aVal = a.weightedGap || 0;
          bVal = b.weightedGap || 0;
      }

      if (typeof aVal === 'string') {
        return sortDir === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
      }
      
      return sortDir === 'desc' ? bVal - aVal : aVal - bVal;
    });
  };

  const funApplyFiltersAndPagination = () => {
    filteredData = funApplyFilters();
    filteredData = funApplySorting(filteredData);
    
    totalCount = filteredData.length;
    const totalPages = Math.ceil(totalCount / pageSize);
    
    // Reset to page 1 if current page is beyond available pages
    if (currentPage > totalPages) currentPage = 1;
    
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalCount);
    
    paginatedData = filteredData.slice(startIndex, endIndex);
    
    funUpdateUI();
  };

  const funUpdateUI = () => {
    funRenderSkillsTable();
    funUpdatePagination();
    funUpdateResultsCount();
  };

  const funRenderSkillsTable = () => {
    const tbody = elements.skillsTableBody;
    tbody.innerHTML = '';

    if (paginatedData.length === 0) {
      funShowEmptyState();
      return;
    }

    funHideEmptyState();

    paginatedData.forEach(skill => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-neutral-50';
      
      row.innerHTML = `
        <td class="px-4 py-3">
          <div class="flex flex-col">
            <span class="font-medium text-primary">${skill.name || 'N/A'}</span>
            <span class="inline-block mt-1 px-2 py-1 text-xs font-medium bg-neutral-100 text-neutral-700 rounded-full w-fit">
              ${skill.category || 'N/A'}
            </span>
          </div>
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-col">
            <span class="font-medium text-primary">${skill.criticality || 'N/A'}</span>
            <span class="text-xs text-secondary">Weight: ${skill.criticalityWeight || 1}</span>
          </div>
        </td>
        <td class="px-4 py-3 text-center">
          <div class="flex flex-col items-center">
            <span class="font-medium text-primary">${formatScore(skill.latestScore)}</span>
            ${skill.isPostTraining ? '<span class="inline-block mt-1 px-2 py-0.5 text-xs font-medium bg-info/10 text-info rounded-full">Post-training</span>' : ''}
          </div>
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-col">
            <span class="font-medium text-primary">${formatScore(skill.benchmarkUsed)}</span>
            <span class="text-xs text-secondary">
              ${skill.benchmarkVersion || 'N/A'}
              ${!skill.assessedInCurrentCycle && skill.hasAssessment ? 
                '<span class="inline-block ml-1 px-1 py-0.5 bg-warning/10 text-warning rounded text-xs">Previous Cycle</span>' : ''}
            </span>
          </div>
        </td>
        <td class="px-4 py-3 text-center">
          <span class="font-medium ${skill.gap > 0 ? 'text-error' : 'text-success'}">${skill.gap || 0}</span>
        </td>
        <td class="px-4 py-3 text-center">
          <div class="flex items-center justify-center gap-2">
            <span class="h-2 w-2 rounded-full ${
              skill.statusColor === 'Green' ? 'bg-success' :
              skill.statusColor === 'Amber' ? 'bg-warning' : 'bg-error'
            }"></span>
            <span class="text-sm font-medium">${skill.statusColor}</span>
          </div>
        </td>
        <td class="px-4 py-3 text-center">
          <span class="text-sm font-medium ${skill.tniFlag === 'Yes' ? 'text-error' : 'text-success'}">${skill.tniFlag}</span>
        </td>
        <td class="px-4 py-3 text-center">
          <span class="text-sm font-medium ${skill.assessedInCurrentCycle ? 'text-success' : 'text-neutral-400'}">${skill.assessedInCurrentCycle ? 'Yes' : 'No'}</span>
        </td>
        <td class="px-4 py-3">
          <div class="flex items-center justify-center gap-2">
            <button 
              onclick="funViewTimeline('${skill.id}')"
              class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-accent hover:text-accent/80 bg-accent/10 hover:bg-accent/20 rounded focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"
            >
              <svg class="w-3 h-3" data-lucide="trending-up"></svg>
              Timeline
            </button>
            <button 
              onclick="funRaiseDispute('${skill.id}')"
              class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-error hover:text-error/80 bg-error/10 hover:bg-error/20 rounded focus:outline-none focus:ring-2 focus:ring-error focus:ring-offset-2 ${
                !skill.assessedInCurrentCycle || !activeCycle ? 'opacity-50 cursor-not-allowed' : ''
              }"
              ${!skill.assessedInCurrentCycle || !activeCycle ? 'disabled' : ''}
            >
              <svg class="w-3 h-3" data-lucide="flag"></svg>
              Dispute
            </button>
            <button 
              onclick="funViewTraining('${skill.id}')"
              class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium text-success hover:text-success/80 bg-success/10 hover:bg-success/20 rounded focus:outline-none focus:ring-2 focus:ring-success focus:ring-offset-2"
            >
              <svg class="w-3 h-3" data-lucide="book-open"></svg>
              Training
            </button>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
    });

    // Reinitialize Lucide icons for new content
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  };

  const funUpdatePagination = () => {
    const totalPages = Math.ceil(totalCount / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalCount);

    elements.pageStart.textContent = totalCount > 0 ? startIndex + 1 : 0;
    elements.pageEnd.textContent = endIndex;
    elements.totalCountSpan.textContent = totalCount;
    elements.currentPageSpan.textContent = currentPage;
    elements.totalPagesSpan.textContent = totalPages;

    elements.prevPage.disabled = currentPage <= 1;
    elements.nextPage.disabled = currentPage >= totalPages;

    elements.pagination.classList.toggle('hidden', totalCount === 0);
  };

  const funUpdateResultsCount = () => {
    elements.resultsCount.textContent = totalCount;
  };

  const funUpdateSummaryStats = () => {
    const stats = { green: 0, amber: 0, red: 0 };
    
    currentData.forEach(skill => {
      const status = skill.statusColor?.toLowerCase();
      if (status === 'green') stats.green++;
      else if (status === 'amber') stats.amber++;
      else if (status === 'red') stats.red++;
    });

    elements.greenCount.textContent = stats.green;
    elements.amberCount.textContent = stats.amber;
    elements.redCount.textContent = stats.red;
  };

  const funShowLoadingState = () => {
    elements.loadingSkeleton.classList.remove('hidden');
    elements.emptyState.classList.add('hidden');
    elements.skillsTableBody.innerHTML = '';
  };

  const funHideLoadingState = () => {
    elements.loadingSkeleton.classList.add('hidden');
  };

  const funShowEmptyState = () => {
    elements.emptyState.classList.remove('hidden');
    elements.pagination.classList.add('hidden');
  };

  const funHideEmptyState = () => {
    elements.emptyState.classList.add('hidden');
  };

  const funClearFilters = () => {
    filters = {
      search: '',
      categories: [],
      criticalities: [],
      statuses: [],
      tni: '',
      assessed: ''
    };

    elements.searchInput.value = '';
    elements.categoryFilter.value = '';
    elements.criticalityFilter.value = '';
    elements.statusFilter.value = '';
    elements.tniFilter.value = '';
    elements.assessedFilter.value = '';

    currentPage = 1;
    funApplyFiltersAndPagination();
  };

  // Global functions for button clicks
  window.funViewTimeline = (skillId) => {
    const skill = currentData.find(s => s.id === skillId);
    if (!skill) return;

    funOpenTimelineModal(skill);
  };

  window.funRaiseDispute = (skillId) => {
    const skill = currentData.find(s => s.id === skillId);
    if (!skill || !skill.assessedInCurrentCycle || !activeCycle) return;

    const params = new URLSearchParams({
      openRaiseModal: 'true',
      prefillSkillIds: JSON.stringify([skillId]),
      prefillAssessmentId: skill.assessmentId || ''
    });

    window.location.href = `/my_disputes.html?${params.toString()}`;
  };

  window.funViewTraining = (skillId) => {
    const params = new URLSearchParams({
      filter_skill_id: skillId
    });

    window.location.href = `/training_and_feedback.html?${params.toString()}`;
  };

  const funOpenTimelineModal = (skill) => {
    // Populate modal header
    document.getElementById('modal-skill-name').textContent = skill.name;
    document.getElementById('modal-skill-category').textContent = skill.category;
    document.getElementById('modal-skill-criticality').textContent = `${skill.criticality} (${skill.criticalityWeight})`;
    
    document.getElementById('mobile-modal-skill-name').textContent = skill.name;
    document.getElementById('mobile-modal-skill-category').textContent = skill.category;

    // Show modal
    elements.timelineModal.classList.remove('hidden');
    
    // Animate in
    setTimeout(() => {
      elements.timelineDrawer.style.transform = 'translateX(0)';
      elements.timelineMobile.style.transform = 'translateY(0)';
    }, 10);

    // Load timeline data
    funLoadTimelineData(skill.id);
  };

  const funCloseTimelineModal = () => {
    elements.timelineDrawer.style.transform = 'translateX(100%)';
    elements.timelineMobile.style.transform = 'translateY(100%)';
    
    setTimeout(() => {
      elements.timelineModal.classList.add('hidden');
    }, 300);
  };

  const funLoadTimelineData = async (skillId) => {
    try {
      document.getElementById('timeline-loading').classList.remove('hidden');
      document.getElementById('timeline-empty').classList.add('hidden');
      
      if (!currentUser?.uid) return;

      // Get employee ID
      const employeesRef = collection(db, 'employees');
      const empQuery = query(employeesRef, where('userId', '==', currentUser.uid));
      const empSnapshot = await withLimit(() => getDocs(empQuery));
      
      if (empSnapshot.empty) {
        document.getElementById('timeline-empty').classList.remove('hidden');
        return;
      }

      const employeeId = empSnapshot.docs[0].id;

      // Get assessments for this skill
      const assessmentsRef = collection(db, 'assessments');
      const assessQuery = query(
        assessmentsRef,
        where('employeeId', '==', employeeId),
        orderBy('submittedAt', 'desc')
      );

      const [assessmentsSnapshot, cyclesSnapshot, benchmarksSnapshot] = await Promise.all([
        withLimit(() => getDocs(assessQuery)),
        withLimit(() => getDocs(collection(db, 'assessmentCycles'))),
        withLimit(() => getDocs(query(collection(db, 'skillBenchmarkVersions'), where('skillId', '==', skillId))))
      ]);

      // Build cycles map
      const cycles = {};
      cyclesSnapshot.forEach(doc => {
        cycles[doc.id] = doc.data();
      });

      // Build benchmarks map
      const benchmarks = [];
      benchmarksSnapshot.forEach(doc => {
        benchmarks.push({ id: doc.id, ...doc.data() });
      });
      benchmarks.sort((a, b) => new Date(a.effectiveStartDate || 0) - new Date(b.effectiveStartDate || 0));

      // Process timeline entries
      const timelineEntries = [];
      assessmentsSnapshot.forEach(doc => {
        const assessment = doc.data();
        if (!assessment?.items) return;

        const skillItem = assessment.items.find(item => item.skillId === skillId);
        if (!skillItem) return;

        const cycle = cycles[assessment.cycleId];
        let benchmarkSnapshot = skillItem.benchmarkScoreSnapshot;
        
        if (benchmarkSnapshot == null && skillItem.benchmarkVersionId) {
          const version = benchmarks.find(b => b.id === skillItem.benchmarkVersionId);
          if (version) benchmarkSnapshot = version.score;
        }

        if (benchmarkSnapshot == null) {
          // Find appropriate benchmark for assessment date
          const assessmentDate = new Date(assessment.submittedAt);
          let appropriateBenchmark = null;
          
          for (const benchmark of benchmarks) {
            const startDate = new Date(benchmark.effectiveStartDate || 0);
            const endDate = benchmark.effectiveEndDate ? new Date(benchmark.effectiveEndDate) : new Date();
            
            if (assessmentDate >= startDate && assessmentDate <= endDate) {
              appropriateBenchmark = benchmark;
              break;
            }
          }
          
          if (!appropriateBenchmark && benchmarks.length > 0) {
            appropriateBenchmark = benchmarks[benchmarks.length - 1]; // Use latest
          }
          
          benchmarkSnapshot = appropriateBenchmark?.score;
        }

        const gap = calculateGap(benchmarkSnapshot, skillItem.score);
        const tniAtTime = getTNIFlag(gap);

        timelineEntries.push({
          date: assessment.submittedAt,
          score: skillItem.score,
          benchmark: benchmarkSnapshot,
          gap,
          tni: tniAtTime,
          type: assessment.type || 'initial',
          cycle: cycle?.name || 'N/A'
        });
      });

      timelineEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

      funRenderTimelineTable(timelineEntries);
      
    } catch (error) {
      console.error('Error loading timeline data:', error);
      showToast('Failed to load timeline data');
      document.getElementById('timeline-empty').classList.remove('hidden');
    } finally {
      document.getElementById('timeline-loading').classList.add('hidden');
    }
  };

  const funRenderTimelineTable = (entries) => {
    const tbody = document.getElementById('timeline-table-body');
    tbody.innerHTML = '';

    if (entries.length === 0) {
      document.getElementById('timeline-empty').classList.remove('hidden');
      return;
    }

    entries.forEach(entry => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-neutral-50';
      
      row.innerHTML = `
        <td class="px-4 py-2 text-sm">${formatDate(entry.date)}</td>
        <td class="px-4 py-2 text-sm text-center font-medium">${formatScore(entry.score)}</td>
        <td class="px-4 py-2 text-sm text-center">${formatScore(entry.benchmark)}</td>
        <td class="px-4 py-2 text-sm text-center ${entry.gap > 0 ? 'text-error' : 'text-success'} font-medium">${entry.gap}</td>
        <td class="px-4 py-2 text-sm text-center">
          <span class="inline-flex items-center gap-1">
            <span class="h-2 w-2 rounded-full ${entry.tni === 'Yes' ? 'bg-error' : 'bg-success'}"></span>
            ${entry.tni}
          </span>
        </td>
        <td class="px-4 py-2 text-sm capitalize">${entry.type}</td>
        <td class="px-4 py-2 text-sm">${entry.cycle}</td>
      `;
      
      tbody.appendChild(row);
    });
  };

  // Event listeners
  const setupEventListeners = () => {
    // Search input with debouncing
    let searchTimeout;
    elements.searchInput?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        filters.search = e.target.value.trim();
        currentPage = 1;
        funApplyFiltersAndPagination();
      }, 300);
    });

    // Filter changes
    elements.categoryFilter?.addEventListener('change', (e) => {
      filters.categories = Array.from(e.target.selectedOptions).map(opt => opt.value).filter(Boolean);
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    elements.criticalityFilter?.addEventListener('change', (e) => {
      filters.criticalities = Array.from(e.target.selectedOptions).map(opt => opt.value).filter(Boolean);
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    elements.statusFilter?.addEventListener('change', (e) => {
      filters.statuses = Array.from(e.target.selectedOptions).map(opt => opt.value).filter(Boolean);
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    elements.tniFilter?.addEventListener('change', (e) => {
      filters.tni = e.target.value;
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    elements.assessedFilter?.addEventListener('change', (e) => {
      filters.assessed = e.target.value;
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    // Sort and pagination
    elements.sortBy?.addEventListener('change', (e) => {
      sortBy = e.target.value;
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    elements.pageSize?.addEventListener('change', (e) => {
      pageSize = parseInt(e.target.value) || 10;
      currentPage = 1;
      funApplyFiltersAndPagination();
    });

    // Pagination buttons
    elements.prevPage?.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        funApplyFiltersAndPagination();
      }
    });

    elements.nextPage?.addEventListener('click', () => {
      const totalPages = Math.ceil(totalCount / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        funApplyFiltersAndPagination();
      }
    });

    // Clear filters buttons
    elements.clearFilters?.addEventListener('click', funClearFilters);
    elements.clearFiltersEmpty?.addEventListener('click', funClearFilters);

    // Refresh button
    elements.refreshBtn?.addEventListener('click', () => funLoadAllData(true));

    // Modal controls
    elements.closeTimelineModal?.addEventListener('click', funCloseTimelineModal);
    elements.closeTimelineMobile?.addEventListener('click', funCloseTimelineModal);

    // Close modal on backdrop click
    elements.timelineModal?.addEventListener('click', (e) => {
      if (e.target === elements.timelineModal) {
        funCloseTimelineModal();
      }
    });

    // ESC key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !elements.timelineModal.classList.contains('hidden')) {
        funCloseTimelineModal();
      }
    });

    // CSV export buttons (placeholder functionality)
    document.getElementById('export-csv')?.addEventListener('click', () => {
      showToast('CSV export functionality coming soon');
    });

    document.getElementById('mobile-export-csv')?.addEventListener('click', () => {
      showToast('CSV export functionality coming soon');
    });
  };

  // Initialize the application
  const init = async () => {
    try {
      db = getDb();
      
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = `auth.html?redirect=${encodeURIComponent(window.location.pathname)}`;
          return;
        }

        currentUser = user;
        await funLoadAllData();
      });

      setupEventListeners();
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

    } catch (error) {
      console.error('Error initializing application:', error);
      showToast('Failed to initialize application');
    }
  };

  // Start the application
  init();
</script>

</body>
</html>