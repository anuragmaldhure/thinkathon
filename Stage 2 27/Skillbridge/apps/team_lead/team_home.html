<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Tailwind Configuration -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e293b',
                        secondary: '#475569',
                        accent: '#2563eb',
                        gold: '#CBA35C',
                        success: '#16A34A',
                        warning: '#D97706',
                        error: '#DC2626',
                        info: '#0EA5E9',
                        neutral: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                            400: '#94A3B8',
                            700: '#334155',
                            900: '#0F172A',
                        }
                    },
                    fontFamily: {
                        sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                    },
                    spacing: {
                        '18': '72px'
                    }
                }
            }
        }
    </script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-18">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
            </div>
            <span class="text-lg font-semibold text-primary">SkillBridge</span>
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button id="mobileMenuToggle" class="md:hidden p-2 rounded-md hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <i data-lucide="menu" class="w-6 h-6 text-secondary"></i>
        </button>

        <!-- Desktop Navigation Right -->
        <div class="hidden md:flex items-center gap-4">
            <div class="relative">
                <button id="userProfileDropdown" class="flex items-center gap-2 p-2 rounded-md hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <span id="userDisplayName" class="text-sm text-secondary hidden lg:block">Loading...</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-secondary"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="userDropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow border border-neutral-200 py-1 z-40">
                    <div class="px-4 py-2 border-b border-neutral-200">
                        <p id="dropdownUserEmail" class="text-sm text-neutral-700 font-medium">Loading...</p>
                        <p class="text-xs text-neutral-400">Team Lead</p>
                    </div>
                    <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-18">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-screen sticky top-18 overflow-y-auto hidden md:block">
            <nav class="p-4 space-y-2">
                <!-- Team Home -->
                <div class="space-y-1">
                    <a href="team_home.html" 
                       class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-accent transition-colors duration-150"
                       data-page="team_home">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span class="font-medium">Team Home</span>
                    </a>
                    
                    <!-- Team Home Children -->
                    <div class="ml-8 space-y-1">
                        <a href="team_dashboard.html" 
                           class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-accent transition-colors duration-150"
                           data-page="team_dashboard">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                            <span>Team Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- Navigation Section Divider -->
                <div class="pt-4 border-t border-neutral-200 mt-6">
                    <p class="text-xs text-neutral-400 font-medium uppercase tracking-wide mb-2">Analytics & Insights</p>
                </div>

            </nav>
            
            <!-- Footer Attribution -->
            <div class="absolute bottom-20 w-full text-center text-xs text-neutral-400 bg-white px-4 py-2">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>
        
        <!-- Mobile Sidebar -->
        <aside id="mobileSidebar" class="fixed left-0 top-18 w-64 h-screen bg-white border-r border-neutral-200 transform -translate-x-full transition-transform duration-300 z-50 md:hidden overflow-y-auto">
            <nav class="p-4 space-y-2">
                <!-- Mobile User Profile -->
                <div class="pb-4 border-b border-neutral-200 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <p id="mobileUserEmail" class="text-sm font-medium text-neutral-700">Loading...</p>
                            <p class="text-xs text-neutral-400">Team Lead</p>
                        </div>
                    </div>
                    <button id="mobileSignOutBtn" class="w-full mt-2 flex items-center gap-2 px-3 py-2 text-sm text-neutral-600 hover:bg-neutral-50 rounded-md">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Sign Out
                    </button>
                </div>

                <!-- Team Home -->
                <div class="space-y-1">
                    <a href="team_home.html" 
                       class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-700 hover:bg-neutral-50 hover:text-accent transition-colors duration-150"
                       data-page="team_home">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span class="font-medium">Team Home</span>
                    </a>
                    
                    <!-- Team Home Children -->
                    <div class="ml-8 space-y-1">
                        <a href="team_dashboard.html" 
                           class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-neutral-600 hover:bg-neutral-50 hover:text-accent transition-colors duration-150"
                           data-page="team_dashboard">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                            <span>Team Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- Navigation Section Divider -->
                <div class="pt-4 border-t border-neutral-200 mt-6">
                    <p class="text-xs text-neutral-400 font-medium uppercase tracking-wide mb-2">Analytics & Insights</p>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto">
            
<!-- Cycle Awareness Banner -->
<section id="cycle-banner" class="bg-white rounded-md border border-neutral-200 p-6 mb-6 shadow-sm">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="flex-1">
      <div class="flex items-center gap-3 mb-2">
        <div id="cycle-status-indicator" class="w-3 h-3 rounded-full bg-neutral-400"></div>
        <h2 id="cycle-name" class="text-lg font-semibold text-neutral-900">Loading cycle...</h2>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-sm text-neutral-700">
        <span id="cycle-dates">—</span>
        <span id="cycle-remaining" class="font-medium">—</span>
        <span id="pending-assessments-count" class="text-neutral-600">—</span>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="refresh-cycle" class="p-2 text-neutral-500 hover:text-neutral-700 rounded-md hover:bg-neutral-50" aria-label="Refresh cycle data">
        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
      </button>
      <button id="notifications-bell" class="relative p-2 text-neutral-500 hover:text-accent rounded-md hover:bg-neutral-50" aria-label="Open notifications">
        <i data-lucide="bell" class="w-5 h-5"></i>
        <span id="unread-count-badge" class="hidden absolute -top-1 -right-1 bg-error text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
      </button>
    </div>
  </div>
</section>

<!-- KPIs Strip -->
<section class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs text-neutral-600 mb-1">Total Active Reports</p>
        <p id="kpi-total-reports" class="text-xl font-semibold text-neutral-900">—</p>
      </div>
      <div class="w-8 h-8 bg-accent/10 rounded-md flex items-center justify-center">
        <i data-lucide="users" class="w-4 h-4 text-accent"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs text-neutral-600 mb-1">Pending Assessments</p>
        <p id="kpi-pending-assessments" class="text-xl font-semibold text-warning">—</p>
      </div>
      <div class="w-8 h-8 bg-warning/10 rounded-md flex items-center justify-center">
        <i data-lucide="clock" class="w-4 h-4 text-warning"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs text-neutral-600 mb-1">Completed Assessments</p>
        <p id="kpi-completed-assessments" class="text-xl font-semibold text-success">—</p>
      </div>
      <div class="w-8 h-8 bg-success/10 rounded-md flex items-center justify-center">
        <i data-lucide="check-circle" class="w-4 h-4 text-success"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-md border border-neutral-200 p-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs text-neutral-600 mb-1">Unread Notifications</p>
        <p id="kpi-unread-notifications" class="text-xl font-semibold text-info">—</p>
      </div>
      <div class="w-8 h-8 bg-info/10 rounded-md flex items-center justify-center">
        <i data-lucide="mail" class="w-4 h-4 text-info"></i>
      </div>
    </div>
  </div>
</section>

<!-- Data Grid Section -->
<section class="bg-white rounded-md border border-neutral-200 shadow-sm">
  <!-- Header -->
  <div class="p-6 border-b border-neutral-200">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-neutral-900 mb-1">Direct Reports</h2>
        <p class="text-sm text-neutral-600">Manage your team's skill assessments and development</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="relative">
          <input id="search-input" type="text" placeholder="Search by name, email, or job title..." 
                 class="w-full sm:w-80 pl-10 pr-4 py-2 border border-neutral-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-neutral-400"></i>
        </div>
        <button id="refresh-data" class="p-2 text-neutral-500 hover:text-neutral-700 rounded-md hover:bg-neutral-50" aria-label="Refresh data">
          <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters and Pagination Controls -->
  <div class="p-4 border-b border-neutral-200 bg-neutral-50">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center gap-4">
        <span class="text-sm text-neutral-600">Show:</span>
        <select id="page-size" class="border border-neutral-200 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="10">10 per page</option>
          <option value="25" selected>25 per page</option>
          <option value="50">50 per page</option>
        </select>
      </div>
      <div class="flex items-center gap-4">
        <span id="showing-info" class="text-sm text-neutral-600">—</span>
        <div class="flex items-center gap-2">
          <button id="prev-page" class="p-2 text-neutral-400 hover:text-neutral-600 disabled:opacity-50" disabled aria-label="Previous page">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <span id="page-info" class="text-sm text-neutral-600">—</span>
          <button id="next-page" class="p-2 text-neutral-400 hover:text-neutral-600 disabled:opacity-50" disabled aria-label="Next page">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Container -->
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-neutral-50 sticky top-0 z-10">
        <tr class="text-secondary text-xs">
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium">
            <button class="flex items-center gap-1 hover:text-accent" data-sort="name">
              Employee <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
            </button>
          </th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium hidden md:table-cell">
            <button class="flex items-center gap-1 hover:text-accent" data-sort="email">
              Email <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
            </button>
          </th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium hidden lg:table-cell">
            <button class="flex items-center gap-1 hover:text-accent" data-sort="jobTitle">
              Job Title <i data-lucide="arrow-up-down" class="w-3 h-3"></i>
            </button>
          </th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium hidden lg:table-cell">Department</th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium">Status</th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium">Pending Assessment</th>
          <th class="text-left px-4 py-3 border-b border-neutral-200 font-medium hidden sm:table-cell">Last Submitted</th>
          <th class="text-right px-4 py-3 border-b border-neutral-200 font-medium">Actions</th>
        </tr>
      </thead>
      <tbody id="employees-table-body" class="text-sm">
        <!-- Skeleton loader -->
        <tr class="skeleton-row odd:bg-white even:bg-neutral-50">
          <td class="px-4 py-3"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden md:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-16 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-12 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden sm:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="flex gap-2 justify-end"><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div></div></td>
        </tr>
        <tr class="skeleton-row odd:bg-white even:bg-neutral-50">
          <td class="px-4 py-3"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden md:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-16 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-12 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden sm:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="flex gap-2 justify-end"><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div></div></td>
        </tr>
        <tr class="skeleton-row odd:bg-white even:bg-neutral-50">
          <td class="px-4 py-3"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden md:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-16 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-12 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden sm:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="flex gap-2 justify-end"><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div></div></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden p-12 text-center">
    <div class="w-16 h-16 mx-auto mb-4 bg-neutral-100 rounded-full flex items-center justify-center">
      <i data-lucide="users" class="w-8 h-8 text-neutral-400"></i>
    </div>
    <h3 class="text-lg font-medium text-neutral-900 mb-2">No direct reports found</h3>
    <p class="text-neutral-600 max-w-sm mx-auto">
      Team membership is determined by the teamLeadId field in employee records. 
      Contact your system administrator if you expect to see team members here.
    </p>
  </div>
</section>

<!-- Notifications Modal -->
<div id="notifications-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50" aria-hidden="true">
  <div class="fixed right-0 top-0 h-full w-full max-w-md bg-white shadow-lg transform translate-x-full transition-transform duration-300" id="notifications-drawer">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-neutral-200">
      <h3 class="text-lg font-semibold text-neutral-900">Notifications</h3>
      <div class="flex items-center gap-2">
        <button id="mark-all-read" class="text-sm text-accent hover:text-[#1d4ed8] font-medium">Mark all as read</button>
        <button id="close-notifications" class="p-1 hover:bg-neutral-100 rounded-md">
          <i data-lucide="x" class="w-5 h-5 text-neutral-600"></i>
        </button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="flex border-b border-neutral-200">
      <button class="notification-filter flex-1 py-3 px-4 text-sm font-medium text-accent border-b-2 border-accent" data-filter="all">All</button>
      <button class="notification-filter flex-1 py-3 px-4 text-sm text-neutral-600 hover:text-accent" data-filter="assessmentDeadline">Deadlines</button>
      <button class="notification-filter flex-1 py-3 px-4 text-sm text-neutral-600 hover:text-accent" data-filter="reassessmentOpen">Reassessments</button>
      <button class="notification-filter flex-1 py-3 px-4 text-sm text-neutral-600 hover:text-accent" data-filter="disputeResolvedInfo">Disputes</button>
    </div>

    <!-- Notifications List -->
    <div id="notifications-list" class="flex-1 overflow-y-auto">
      <!-- Loading skeleton -->
      <div class="notification-skeleton p-4 border-b border-neutral-200">
        <div class="flex items-start gap-3">
          <div class="w-2 h-2 rounded-full bg-neutral-200 animate-pulse mt-2"></div>
          <div class="flex-1">
            <div class="h-4 bg-neutral-200 rounded animate-pulse mb-2"></div>
            <div class="h-3 bg-neutral-200 rounded animate-pulse w-3/4 mb-2"></div>
            <div class="h-3 bg-neutral-200 rounded animate-pulse w-1/2"></div>
          </div>
        </div>
      </div>
      <div class="notification-skeleton p-4 border-b border-neutral-200">
        <div class="flex items-start gap-3">
          <div class="w-2 h-2 rounded-full bg-neutral-200 animate-pulse mt-2"></div>
          <div class="flex-1">
            <div class="h-4 bg-neutral-200 rounded animate-pulse mb-2"></div>
            <div class="h-3 bg-neutral-200 rounded animate-pulse w-3/4 mb-2"></div>
            <div class="h-3 bg-neutral-200 rounded animate-pulse w-1/2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="notifications-empty" class="hidden p-8 text-center">
      <div class="w-12 h-12 mx-auto mb-4 bg-neutral-100 rounded-full flex items-center justify-center">
        <i data-lucide="bell" class="w-6 h-6 text-neutral-400"></i>
      </div>
      <p class="text-neutral-600">No notifications found</p>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // DOM Elements
        const userProfileDropdown = document.getElementById('userProfileDropdown');
        const userDropdownMenu = document.getElementById('userDropdownMenu');
        const userDisplayName = document.getElementById('userDisplayName');
        const dropdownUserEmail = document.getElementById('dropdownUserEmail');
        const mobileUserEmail = document.getElementById('mobileUserEmail');
        const signOutBtn = document.getElementById('signOutBtn');
        const mobileSignOutBtn = document.getElementById('mobileSignOutBtn');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const mobileSidebar = document.getElementById('mobileSidebar');

        // Mobile Menu Toggle
        mobileMenuToggle?.addEventListener('click', () => {
            mobileOverlay.classList.remove('hidden');
            mobileSidebar.classList.remove('-translate-x-full');
        });

        mobileOverlay?.addEventListener('click', () => {
            mobileOverlay.classList.add('hidden');
            mobileSidebar.classList.add('-translate-x-full');
        });

        // User Profile Dropdown Toggle
        userProfileDropdown?.addEventListener('click', () => {
            userDropdownMenu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userProfileDropdown?.contains(e.target)) {
                userDropdownMenu?.classList.add('hidden');
            }
        });

        // Sign Out Functionality
        const handleSignOut = async () => {
            try {
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Error signing out. Please try again.', 'error');
            }
        };

        signOutBtn?.addEventListener('click', handleSignOut);
        mobileSignOutBtn?.addEventListener('click', handleSignOut);

        // Navigation Active State
        function setActiveNavigation() {
            const currentPage = window.location.pathname.split('/').pop().replace('.html', '') || 'team_home';
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const pageName = link.getAttribute('data-page');
                if (pageName === currentPage) {
                    link.classList.add('bg-accent', 'text-white');
                    link.classList.remove('text-neutral-700', 'text-neutral-600', 'hover:bg-neutral-50', 'hover:text-accent');
                } else {
                    link.classList.remove('bg-accent', 'text-white');
                    link.classList.add('hover:bg-neutral-50', 'hover:text-accent');
                }
            });
        }

        // Auth State Management
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                // Try to get user data from Firestore
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                let displayName = '';
                let userEmail = user.email || 'user@skillbridge.com';
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const firstName = userData.firstName || '';
                    const lastName = userData.lastName || '';
                    displayName = firstName && lastName ? `${firstName} ${lastName}` : userEmail.split('@')[0];
                } else {
                    // Fallback for users without Firestore data
                    displayName = userEmail === 'johndoe@example.com' ? 'John Doe' : userEmail.split('@')[0];
                }

                // Update UI elements
                if (userDisplayName) userDisplayName.textContent = displayName;
                if (dropdownUserEmail) dropdownUserEmail.textContent = userEmail;
                if (mobileUserEmail) mobileUserEmail.textContent = userEmail;
                
            } catch (error) {
                console.error('Error fetching user data:', error);
                // Fallback to email-based display
                const userEmail = user.email || 'user@skillbridge.com';
                const displayName = userEmail.split('@')[0];
                
                if (userDisplayName) userDisplayName.textContent = displayName;
                if (dropdownUserEmail) dropdownUserEmail.textContent = userEmail;
                if (mobileUserEmail) mobileUserEmail.textContent = userEmail;
            }
        });

        // Initialize navigation state
        document.addEventListener('DOMContentLoaded', () => {
            setActiveNavigation();
        });
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import { onAuthStateChanged, getAuth } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import {
  collection, getDocs, query, where, orderBy, limit, startAfter, doc, getDoc,
  getCountFromServer, onSnapshot, Timestamp
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader } from "./scripts/main.js";

const db = getDb();

// Global state
let currentUser = null;
let currentTeamLeadEmployeeId = null;
let activeCycle = null;
let directReports = [];
let filteredReports = [];
let currentPage = 1;
let pageSize = 25;
let sortField = 'name';
let sortDirection = 'asc';
let searchTerm = '';
let departments = new Map();
let currentAbortController = null;
let notifications = [];
let currentFilter = 'all';

// DOM Elements
const cycleBanner = document.getElementById('cycle-banner');
const cycleStatusIndicator = document.getElementById('cycle-status-indicator');
const cycleName = document.getElementById('cycle-name');
const cycleDates = document.getElementById('cycle-dates');
const cycleRemaining = document.getElementById('cycle-remaining');
const pendingAssessmentsCount = document.getElementById('pending-assessments-count');
const refreshCycleBtn = document.getElementById('refresh-cycle');
const notificationsBell = document.getElementById('notifications-bell');
const unreadCountBadge = document.getElementById('unread-count-badge');

// KPI Elements
const kpiTotalReports = document.getElementById('kpi-total-reports');
const kpiPendingAssessments = document.getElementById('kpi-pending-assessments');
const kpiCompletedAssessments = document.getElementById('kpi-completed-assessments');
const kpiUnreadNotifications = document.getElementById('kpi-unread-notifications');

// Table Elements
const searchInput = document.getElementById('search-input');
const refreshDataBtn = document.getElementById('refresh-data');
const pageSizeSelect = document.getElementById('page-size');
const showingInfo = document.getElementById('showing-info');
const pageInfo = document.getElementById('page-info');
const prevPageBtn = document.getElementById('prev-page');
const nextPageBtn = document.getElementById('next-page');
const tableBody = document.getElementById('employees-table-body');
const emptyState = document.getElementById('empty-state');

// Modal Elements
const notificationsModal = document.getElementById('notifications-modal');
const notificationsDrawer = document.getElementById('notifications-drawer');
const closeNotificationsBtn = document.getElementById('close-notifications');
const markAllReadBtn = document.getElementById('mark-all-read');
const notificationsList = document.getElementById('notifications-list');
const notificationsEmpty = document.getElementById('notifications-empty');

// Utility Functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function createAbortController() {
  if (currentAbortController) currentAbortController.abort();
  currentAbortController = new AbortController();
  return currentAbortController;
}

function formatDate(dateStr) {
  if (!dateStr) return '—';
  try {
    return new Date(dateStr).toLocaleDateString('en-IN', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  } catch (error) {
    return '—';
  }
}

function formatRelativeTime(dateStr) {
  if (!dateStr) return '—';
  try {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor(diffMs / (1000 * 60));

    if (diffDays > 0) return `${diffDays}d ago`;
    if (diffHours > 0) return `${diffHours}h ago`;
    if (diffMinutes > 0) return `${diffMinutes}m ago`;
    return 'Just now';
  } catch (error) {
    return '—';
  }
}

function calculateDaysRemaining(endDate) {
  if (!endDate) return 0;
  try {
    const end = new Date(endDate);
    const now = new Date();
    const diffTime = end - now;
    return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
  } catch (error) {
    return 0;
  }
}

function getStatusColor(daysRemaining) {
  if (daysRemaining > 7) return 'success';
  if (daysRemaining >= 3) return 'warning';
  return 'error';
}

// Data Loading Functions
async function funLoadCurrentTeamLead() {
  if (!currentUser) return null;

  try {
    const q = query(
      collection(db, 'employees'),
      where('userId', '==', currentUser.uid),
      limit(1)
    );
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const employee = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
      currentTeamLeadEmployeeId = employee.id;
      return employee;
    }
    return null;
  } catch (error) {
    console.error('Error loading team lead:', error);
    showToast(error?.message || 'Failed to load team lead data');
    return null;
  }
}

async function funLoadActiveCycle() {
  try {
    const now = new Date().toISOString();
    const q = query(
      collection(db, 'assessmentCycles'),
      where('status', '==', 'active'),
      where('startDate', '<=', now),
      where('endDate', '>=', now),
      orderBy('startDate', 'desc'),
      limit(1)
    );
    // requires composite index: assessmentCycles (status, startDate, endDate)
    
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      activeCycle = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
      return activeCycle;
    }
    activeCycle = null;
    return null;
  } catch (error) {
    console.error('Error loading active cycle:', error);
    showToast(error?.message || 'Failed to load active cycle');
    return null;
  }
}

async function funLoadDepartments() {
  try {
    const q = query(collection(db, 'departments'), where('status', '==', 'active'));
    const snapshot = await getDocs(q);
    
    departments.clear();
    snapshot.forEach(doc => {
      departments.set(doc.id, doc.data().name || 'Unknown Department');
    });
  } catch (error) {
    console.error('Error loading departments:', error);
  }
}

async function funLoadDirectReports(refresh = false) {
  if (!currentTeamLeadEmployeeId) return [];

  const abortController = createAbortController();
  const signal = abortController.signal;

  try {
    const q = query(
      collection(db, 'employees'),
      where('teamLeadId', '==', currentTeamLeadEmployeeId),
      where('status', '==', 'active'),
      orderBy('name')
    );
    
    const snapshot = await getDocs(q);
    if (signal.aborted) return [];

    // Process employees with additional computed data
    const employees = [];
    for (const doc of snapshot.docs) {
      if (signal.aborted) break;
      
      const employee = { id: doc.id, ...doc.data() };
      
      // Check if pending assessment
      employee.pendingAssessment = await funCheckPendingAssessment(employee.id);
      
      // Get last submitted date
      employee.lastSubmitted = await funGetLastSubmittedDate(employee.id);
      
      employees.push(employee);
    }

    if (!signal.aborted) {
      directReports = employees;
      funApplyFilters();
    }

    return employees;
  } catch (error) {
    if (!signal.aborted) {
      console.error('Error loading direct reports:', error);
      showToast(error?.message || 'Failed to load direct reports');
    }
    return [];
  }
}

async function funCheckPendingAssessment(employeeId) {
  if (!activeCycle || !currentTeamLeadEmployeeId) return false;

  try {
    // Check if has active skill mappings
    const mappingsQ = query(
      collection(db, 'employeeSkillMappings'),
      where('employeeId', '==', employeeId),
      where('status', '==', 'active'),
      limit(1)
    );
    const mappingsSnapshot = await getDocs(mappingsQ);
    if (mappingsSnapshot.empty) return false;

    // Check if already has submitted assessment for this cycle
    const assessmentQ = query(
      collection(db, 'assessments'),
      where('cycleId', '==', activeCycle.id),
      where('employeeId', '==', employeeId),
      where('teamLeadId', '==', currentTeamLeadEmployeeId),
      where('status', '==', 'submitted'),
      limit(1)
    );
    // requires composite index: assessments (cycleId, employeeId, teamLeadId, status)
    
    const assessmentSnapshot = await getDocs(assessmentQ);
    return assessmentSnapshot.empty; // Pending if no submitted assessment exists
  } catch (error) {
    console.error('Error checking pending assessment:', error);
    return false;
  }
}

async function funGetLastSubmittedDate(employeeId) {
  if (!activeCycle || !currentTeamLeadEmployeeId) return null;

  try {
    const q = query(
      collection(db, 'assessments'),
      where('cycleId', '==', activeCycle.id),
      where('employeeId', '==', employeeId),
      where('teamLeadId', '==', currentTeamLeadEmployeeId),
      orderBy('submittedAt', 'desc'),
      limit(1)
    );
    // requires composite index: assessments (cycleId, employeeId, teamLeadId, submittedAt)
    
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      const assessment = snapshot.docs[0].data();
      return assessment.submittedAt;
    }
    return null;
  } catch (error) {
    console.error('Error getting last submitted date:', error);
    return null;
  }
}

async function funLoadUnreadNotificationsCount() {
  if (!currentTeamLeadEmployeeId) return 0;

  try {
    const q = query(
      collection(db, 'notifications'),
      where('recipientEmployeeId', '==', currentTeamLeadEmployeeId),
      where('readAt', '==', null)
    );
    const countSnapshot = await getCountFromServer(q);
    return countSnapshot.data().count || 0;
  } catch (error) {
    console.error('Error loading unread notifications count:', error);
    return 0;
  }
}

async function funLoadNotifications() {
  if (!currentTeamLeadEmployeeId) return [];

  try {
    const q = query(
      collection(db, 'notifications'),
      where('recipientEmployeeId', '==', currentTeamLeadEmployeeId),
      orderBy('readAt'),
      orderBy('createdAt', 'desc'),
      limit(50)
    );
    // requires composite index: notifications (recipientEmployeeId, readAt, createdAt)
    
    const snapshot = await getDocs(q);
    const notificationsData = [];
    
    for (const doc of snapshot.docs) {
      const notification = { id: doc.id, ...doc.data() };
      
      // Enrich with related data
      if (notification.cycleId) {
        try {
          const cycleDoc = await getDoc(doc(db, 'assessmentCycles', notification.cycleId));
          if (cycleDoc.exists()) {
            notification.cycleName = cycleDoc.data().name;
          }
        } catch (error) {
          console.error('Error loading cycle data for notification:', error);
        }
      }
      
      if (notification.relatedEmployeeId) {
        try {
          const employeeDoc = await getDoc(doc(db, 'employees', notification.relatedEmployeeId));
          if (employeeDoc.exists()) {
            notification.relatedEmployeeName = employeeDoc.data().name;
          }
        } catch (error) {
          console.error('Error loading employee data for notification:', error);
        }
      }
      
      notificationsData.push(notification);
    }
    
    notifications = notificationsData;
    return notificationsData;
  } catch (error) {
    console.error('Error loading notifications:', error);
    showToast(error?.message || 'Failed to load notifications');
    return [];
  }
}

// UI Update Functions
function funUpdateCycleBanner() {
  if (!activeCycle) {
    cycleName.textContent = 'No active cycle';
    cycleDates.textContent = '—';
    cycleRemaining.textContent = '—';
    pendingAssessmentsCount.textContent = '—';
    cycleStatusIndicator.className = 'w-3 h-3 rounded-full bg-neutral-400';
    return;
  }

  cycleName.textContent = activeCycle.name || 'Unknown Cycle';
  
  const startDate = formatDate(activeCycle.startDate);
  const endDate = formatDate(activeCycle.endDate);
  cycleDates.textContent = `${startDate} - ${endDate}`;

  const daysRemaining = calculateDaysRemaining(activeCycle.endDate);
  cycleRemaining.textContent = `${daysRemaining} days remaining`;

  const statusColor = getStatusColor(daysRemaining);
  const colorClasses = {
    success: 'bg-success',
    warning: 'bg-warning',
    error: 'bg-error'
  };
  cycleStatusIndicator.className = `w-3 h-3 rounded-full ${colorClasses[statusColor]}`;

  // Update pending assessments count
  const pendingCount = directReports.filter(emp => emp.pendingAssessment).length;
  pendingAssessmentsCount.textContent = `${pendingCount} pending assessments`;
}

async function funUpdateKPIs() {
  kpiTotalReports.textContent = directReports.length.toString();
  
  const pendingCount = directReports.filter(emp => emp.pendingAssessment).length;
  kpiPendingAssessments.textContent = pendingCount.toString();
  
  const completedCount = directReports.filter(emp => emp.lastSubmitted).length;
  kpiCompletedAssessments.textContent = completedCount.toString();
  
  const unreadCount = await funLoadUnreadNotificationsCount();
  kpiUnreadNotifications.textContent = unreadCount.toString();
  
  // Update notification bell badge
  if (unreadCount > 0) {
    unreadCountBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
    unreadCountBadge.classList.remove('hidden');
  } else {
    unreadCountBadge.classList.add('hidden');
  }
}

function funApplyFilters() {
  let filtered = [...directReports];

  // Apply search filter
  if (searchTerm.trim()) {
    const term = searchTerm.toLowerCase();
    filtered = filtered.filter(emp => 
      (emp.name || '').toLowerCase().includes(term) ||
      (emp.email || '').toLowerCase().includes(term) ||
      (emp.jobTitle || '').toLowerCase().includes(term)
    );
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let aVal = a[sortField] || '';
    let bVal = b[sortField] || '';
    
    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
    if (typeof bVal === 'string') bVal = bVal.toLowerCase();
    
    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  filteredReports = filtered;
  currentPage = 1;
  funRenderTable();
}

function funRenderTable() {
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const pageData = filteredReports.slice(startIndex, endIndex);

  // Clear skeleton
  const skeletonRows = tableBody.querySelectorAll('.skeleton-row');
  skeletonRows.forEach(row => row.remove());

  // Clear existing data rows
  const dataRows = tableBody.querySelectorAll('.data-row');
  dataRows.forEach(row => row.remove());

  if (pageData.length === 0 && filteredReports.length === 0) {
    emptyState.classList.remove('hidden');
    tableBody.closest('.overflow-x-auto').classList.add('hidden');
    return;
  }

  emptyState.classList.add('hidden');
  tableBody.closest('.overflow-x-auto').classList.remove('hidden');

  pageData.forEach((employee, index) => {
    const row = document.createElement('tr');
    row.className = `data-row ${(startIndex + index) % 2 === 0 ? 'bg-white' : 'bg-neutral-50'} hover:bg-neutral-100`;
    
    const departmentName = departments.get(employee.departmentId) || 'Unknown';
    const lastSubmittedFormatted = employee.lastSubmitted ? formatDate(employee.lastSubmitted) : '—';
    
    row.innerHTML = `
      <td class="px-4 py-3">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
            <span class="text-white text-sm font-medium">${(employee.name || 'U').charAt(0).toUpperCase()}</span>
          </div>
          <div>
            <p class="font-medium text-neutral-900">${employee.name || 'Unknown'}</p>
            <p class="text-xs text-neutral-500 md:hidden">${employee.email || '—'}</p>
          </div>
        </div>
      </td>
      <td class="px-4 py-3 hidden md:table-cell text-neutral-700">${employee.email || '—'}</td>
      <td class="px-4 py-3 hidden lg:table-cell text-neutral-700">${employee.jobTitle || '—'}</td>
      <td class="px-4 py-3 hidden lg:table-cell text-neutral-700">${departmentName}</td>
      <td class="px-4 py-3">
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${employee.status === 'active' ? 'bg-success/10 text-success' : 'bg-neutral-100 text-neutral-600'}">
          <span class="w-1.5 h-1.5 rounded-full ${employee.status === 'active' ? 'bg-success' : 'bg-neutral-400'}"></span>
          ${employee.status || 'Unknown'}
        </span>
      </td>
      <td class="px-4 py-3">
        ${employee.pendingAssessment ? 
          '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-warning/10 text-warning"><span class="w-1.5 h-1.5 rounded-full bg-warning"></span>Yes</span>' :
          '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-success/10 text-success"><span class="w-1.5 h-1.5 rounded-full bg-success"></span>No</span>'
        }
      </td>
      <td class="px-4 py-3 hidden sm:table-cell text-neutral-700">${lastSubmittedFormatted}</td>
      <td class="px-4 py-3">
        <div class="flex items-center gap-2 justify-end">
          <button class="open-workspace-btn p-2 text-neutral-500 hover:text-accent rounded-md hover:bg-neutral-50" 
                  data-employee-id="${employee.id}" 
                  data-pending="${employee.pendingAssessment}"
                  title="Open Workspace">
            <i data-lucide="external-link" class="w-4 h-4"></i>
          </button>
          <button class="start-assessment-btn p-2 text-neutral-500 hover:text-accent rounded-md hover:bg-neutral-50 ${!activeCycle || !employee.pendingAssessment ? 'opacity-50 cursor-not-allowed' : ''}" 
                  data-employee-id="${employee.id}"
                  ${!activeCycle || !employee.pendingAssessment ? 'disabled' : ''}
                  title="Start Assessment">
            <i data-lucide="clipboard-check" class="w-4 h-4"></i>
          </button>
        </div>
      </td>
    `;
    
    tableBody.appendChild(row);
  });

  // Update pagination info
  const totalItems = filteredReports.length;
  const totalPages = Math.ceil(totalItems / pageSize) || 1;
  
  showingInfo.textContent = totalItems > 0 ? 
    `Showing ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems}` : 
    'No results found';
    
  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  
  prevPageBtn.disabled = currentPage <= 1;
  nextPageBtn.disabled = currentPage >= totalPages;
  
  // Re-initialize icons for new rows
  lucide.createIcons();
}

function funRenderNotifications() {
  const filtered = currentFilter === 'all' ? 
    notifications : 
    notifications.filter(n => n.type === currentFilter);

  // Clear skeletons
  const skeletons = notificationsList.querySelectorAll('.notification-skeleton');
  skeletons.forEach(skeleton => skeleton.remove());

  // Clear existing notifications
  const existing = notificationsList.querySelectorAll('.notification-item');
  existing.forEach(item => item.remove());

  if (filtered.length === 0) {
    notificationsEmpty.classList.remove('hidden');
    return;
  }

  notificationsEmpty.classList.add('hidden');

  // Sort unread first, then by date
  const sorted = filtered.sort((a, b) => {
    if ((!a.readAt) !== (!b.readAt)) {
      return !a.readAt ? -1 : 1;
    }
    return new Date(b.createdAt) - new Date(a.createdAt);
  });

  sorted.forEach(notification => {
    const div = document.createElement('div');
    div.className = `notification-item p-4 border-b border-neutral-200 cursor-pointer hover:bg-neutral-50 ${!notification.readAt ? 'bg-blue-50/50' : ''}`;
    div.dataset.notificationId = notification.id;
    
    const typeIcon = {
      assessmentDeadline: 'clock',
      reassessmentOpen: 'refresh-cw',
      disputeResolvedInfo: 'info'
    }[notification.type] || 'bell';

    div.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-2 h-2 rounded-full mt-2 ${!notification.readAt ? 'bg-accent' : 'bg-neutral-300'}"></div>
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <i data-lucide="${typeIcon}" class="w-4 h-4 text-neutral-400 mt-0.5 flex-shrink-0"></i>
            <p class="text-sm text-neutral-900 flex-1 ${!notification.readAt ? 'font-medium' : ''}">${notification.message || 'No message'}</p>
          </div>
          <div class="mt-2 space-y-1">
            ${notification.cycleName ? `<p class="text-xs text-neutral-600">Cycle: ${notification.cycleName}</p>` : ''}
            ${notification.relatedEmployeeName ? `<p class="text-xs text-neutral-600">Employee: ${notification.relatedEmployeeName}</p>` : ''}
            <p class="text-xs text-neutral-500" title="${formatDate(notification.createdAt)}">${formatRelativeTime(notification.createdAt)}</p>
          </div>
        </div>
      </div>
    `;
    
    notificationsList.appendChild(div);
  });

  lucide.createIcons();
}

// Event Handlers
async function funInitialLoad(refresh = false) {
  try {
    if (refresh) {
      // Show skeleton loaders
      tableBody.innerHTML = `
        <tr class="skeleton-row odd:bg-white even:bg-neutral-50">
          <td class="px-4 py-3"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden md:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-16 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-12 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden sm:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="flex gap-2 justify-end"><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div></div></td>
        </tr>
        <tr class="skeleton-row odd:bg-white even:bg-neutral-50">
          <td class="px-4 py-3"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden md:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden lg:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-16 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="h-6 w-12 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3 hidden sm:table-cell"><div class="h-4 bg-neutral-200 rounded animate-pulse"></div></td>
          <td class="px-4 py-3"><div class="flex gap-2 justify-end"><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div><div class="h-8 w-8 bg-neutral-200 rounded animate-pulse"></div></div></td>
        </tr>
      `;
    }

    // Load all data
    await funLoadCurrentTeamLead();
    await funLoadActiveCycle();
    await funLoadDepartments();
    await funLoadDirectReports(refresh);
    
    // Update UI
    funUpdateCycleBanner();
    await funUpdateKPIs();
    
  } catch (error) {
    console.error('Error during initial load:', error);
    showToast(error?.message || 'Failed to load data');
  }
}

// Search and Filter Handlers
let searchTimeout;
searchInput.addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    searchTerm = e.target.value;
    funApplyFilters();
  }, 300);
});

// Sorting Handlers
document.addEventListener('click', (e) => {
  const sortButton = e.target.closest('[data-sort]');
  if (sortButton) {
    const field = sortButton.dataset.sort;
    if (field === sortField) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortField = field;
      sortDirection = 'asc';
    }
    funApplyFilters();
  }
});

// Pagination Handlers
pageSizeSelect.addEventListener('change', (e) => {
  pageSize = parseInt(e.target.value);
  currentPage = 1;
  funRenderTable();
});

prevPageBtn.addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    funRenderTable();
  }
});

nextPageBtn.addEventListener('click', () => {
  const totalPages = Math.ceil(filteredReports.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    funRenderTable();
  }
});

// Action Handlers
document.addEventListener('click', (e) => {
  const openBtn = e.target.closest('.open-workspace-btn');
  if (openBtn) {
    const employeeId = openBtn.dataset.employeeId;
    const isPending = openBtn.dataset.pending === 'true';
    const activeTab = isPending ? 'assessments' : 'mapping';
    window.location.href = `employee_workspace.html?employeeId=${employeeId}&activeTab=${activeTab}`;
    return;
  }

  const assessmentBtn = e.target.closest('.start-assessment-btn');
  if (assessmentBtn && !assessmentBtn.disabled) {
    const employeeId = assessmentBtn.dataset.employeeId;
    window.location.href = `employee_workspace.html?employeeId=${employeeId}&activeTab=assessments`;
    return;
  }
});

// Refresh Handlers
refreshCycleBtn.addEventListener('click', () => funInitialLoad(true));
refreshDataBtn.addEventListener('click', () => funInitialLoad(true));

// Notifications Modal Handlers
notificationsBell.addEventListener('click', async () => {
  notificationsModal.classList.remove('hidden');
  notificationsDrawer.classList.remove('translate-x-full');
  
  // Load notifications
  await funLoadNotifications();
  funRenderNotifications();
});

closeNotificationsBtn.addEventListener('click', () => {
  notificationsDrawer.classList.add('translate-x-full');
  setTimeout(() => {
    notificationsModal.classList.add('hidden');
  }, 300);
});

notificationsModal.addEventListener('click', (e) => {
  if (e.target === notificationsModal) {
    notificationsDrawer.classList.add('translate-x-full');
    setTimeout(() => {
      notificationsModal.classList.add('hidden');
    }, 300);
  }
});

// Notification filter handlers
document.addEventListener('click', (e) => {
  const filterBtn = e.target.closest('.notification-filter');
  if (filterBtn) {
    document.querySelectorAll('.notification-filter').forEach(btn => {
      btn.classList.remove('text-accent', 'border-b-2', 'border-accent');
      btn.classList.add('text-neutral-600');
    });
    
    filterBtn.classList.add('text-accent', 'border-b-2', 'border-accent');
    filterBtn.classList.remove('text-neutral-600');
    
    currentFilter = filterBtn.dataset.filter;
    funRenderNotifications();
  }
});

// Notification click handler
document.addEventListener('click', async (e) => {
  const notificationItem = e.target.closest('.notification-item');
  if (notificationItem) {
    const notificationId = notificationItem.dataset.notificationId;
    const notification = notifications.find(n => n.id === notificationId);
    
    if (notification) {
      // Mark as read
      if (!notification.readAt) {
        try {
          const notificationRef = doc(db, 'notifications', notificationId);
          await updateDoc(notificationRef, {
            readAt: new Date().toISOString()
          });
          notification.readAt = new Date().toISOString();
          funRenderNotifications();
          await funUpdateKPIs();
        } catch (error) {
          console.error('Error marking notification as read:', error);
        }
      }
      
      // Navigate if has related employee
      if (notification.relatedEmployeeId) {
        let url = `employee_workspace.html?employeeId=${notification.relatedEmployeeId}&activeTab=assessments`;
        if (notification.relatedSkillIds && notification.relatedSkillIds.length > 0) {
          url += `&focusSkillIds=${notification.relatedSkillIds.join(',')}`;
        }
        window.location.href = url;
      }
    }
  }
});

markAllReadBtn.addEventListener('click', async () => {
  try {
    const unreadNotifications = notifications.filter(n => !n.readAt);
    if (unreadNotifications.length === 0) return;
    
    showLoader();
    const batch = writeBatch(db);
    const now = new Date().toISOString();
    
    unreadNotifications.forEach(notification => {
      const notificationRef = doc(db, 'notifications', notification.id);
      batch.update(notificationRef, { readAt: now });
      notification.readAt = now;
    });
    
    await batch.commit();
    funRenderNotifications();
    await funUpdateKPIs();
    hideLoader();
    showToast('All notifications marked as read');
  } catch (error) {
    hideLoader();
    console.error('Error marking all as read:', error);
    showToast(error?.message || 'Failed to mark notifications as read');
  }
});

// Auth State Management
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
    return;
  }
  
  currentUser = user;
  funInitialLoad();
});

// Initialize icons
lucide.createIcons();
</script>

</body>
</html>