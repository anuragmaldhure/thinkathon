<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Configuration -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e293b',
                        secondary: '#475569',
                        accent: '#2563eb',
                        gold: '#CBA35C',
                        success: '#16A34A',
                        warning: '#D97706',
                        error: '#DC2626',
                        info: '#0EA5E9',
                        neutral: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                            400: '#94A3B8',
                            700: '#334155',
                            900: '#0F172A',
                        }
                    },
                    fontFamily: {
                        sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                    },
                    boxShadow: {
                        sm: '0 1px 2px rgba(15,23,42,0.06)',
                        DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
                        lg: '0 8px 24px rgba(15,23,42,0.12)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-btn" class="md:hidden p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150">
                <i data-lucide="menu" class="w-6 h-6 text-secondary"></i>
            </button>
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="h-8 w-8">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-xl font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-3 p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="flex flex-col items-end">
                        <span id="user-name" class="text-sm font-medium text-neutral-700">Loading...</span>
                        <span id="user-role" class="text-xs text-neutral-400">System Admin</span>
                    </div>
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                </button>
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-neutral-200 z-40">
                    <div class="py-2">
                        <button id="sign-out-btn" class="w-full px-4 py-2 text-left text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto hidden md:block">
            <nav class="p-4 space-y-1">
                <!-- Analytics Hub -->
                <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Analytics Hub</span>
                </a>

                <!-- Organization Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                    <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="building-2" class="w-5 h-5"></i>
                        <span>Org Configuration</span>
                    </a>
                    <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span>Org Settings</span>
                    </a>
                </div>

                <!-- Core Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                    <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                        <span>Skill Framework</span>
                    </a>
                    <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Employees & Hierarchy</span>
                    </a>
                    <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>Training Management</span>
                    </a>
                </div>

                <!-- Operations Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                    <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="gavel" class="w-5 h-5"></i>
                        <span>Disputes Center</span>
                    </a>
                    <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        <span>Assessment Viewer</span>
                    </a>
                    <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-search" class="w-5 h-5"></i>
                        <span>Audit Log Viewer</span>
                    </a>
                </div>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-6 w-full text-center text-xs text-neutral-400 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay" class="hidden fixed inset-0 z-40 md:hidden">
            <div class="fixed inset-0 bg-neutral-900 bg-opacity-50" id="mobile-nav-backdrop"></div>
            <aside class="fixed left-0 top-16 h-[calc(100vh-4rem)] w-64 bg-white border-r border-neutral-200 overflow-y-auto">
                <nav class="p-4 space-y-1">
                    <!-- Same navigation structure as desktop -->
                    <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Analytics Hub</span>
                    </a>
                    
                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                        <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="building-2" class="w-5 h-5"></i>
                            <span>Org Configuration</span>
                        </a>
                        <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>Org Settings</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                        <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="book-open" class="w-5 h-5"></i>
                            <span>Skill Framework</span>
                        </a>
                        <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Employees & Hierarchy</span>
                        </a>
                        <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>Training Management</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                        <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="gavel" class="w-5 h-5"></i>
                            <span>Disputes Center</span>
                        </a>
                        <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span>Assessment Viewer</span>
                        </a>
                        <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-search" class="w-5 h-5"></i>
                            <span>Audit Log Viewer</span>
                        </a>
                    </div>
                </nav>
            </aside>
        </div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px] mx-auto">
            
<!-- Disputes Center Page -->
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-[clamp(1.5rem,2.5vw,2rem)] leading-10 font-bold text-primary">Disputes Center</h1>
      <p class="text-sm text-secondary mt-1">End-to-end management of assessment disputes with detailed evidence and re-escalation handling.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-refresh" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-secondary hover:text-primary hover:bg-neutral-100 rounded-md transition-colors duration-150" aria-label="Refresh data">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        <span class="hidden sm:inline">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white rounded-lg border border-neutral-200 p-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Department Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Department</label>
        <select id="filter-department" class="w-full border border-neutral-200 rounded px-3 py-2 text-sm text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Departments</option>
        </select>
      </div>

      <!-- Team Lead Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Team Lead</label>
        <select id="filter-team-lead" class="w-full border border-neutral-200 rounded px-3 py-2 text-sm text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Team Leads</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Status</label>
        <select id="filter-status" class="w-full border border-neutral-200 rounded px-3 py-2 text-sm text-neutral-700 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Statuses</option>
          <option value="open">Open</option>
          <option value="resolved">Resolved</option>
        </select>
      </div>

      <!-- Search -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Search</label>
        <input id="search-input" type="text" placeholder="Search disputes..." class="w-full border border-neutral-200 rounded px-3 py-2 text-sm text-neutral-700 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Total Disputes -->
    <div class="bg-white rounded-lg border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Total Disputes</p>
          <p id="stat-total" class="text-2xl font-bold text-primary mt-1">--</p>
        </div>
        <div class="w-8 h-8 bg-info rounded-full flex items-center justify-center">
          <i data-lucide="gavel" class="w-4 h-4 text-white"></i>
        </div>
      </div>
    </div>

    <!-- Open Disputes -->
    <div class="bg-white rounded-lg border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Open Disputes</p>
          <p id="stat-open" class="text-2xl font-bold text-warning mt-1">--</p>
        </div>
        <div class="w-8 h-8 bg-warning rounded-full flex items-center justify-center">
          <i data-lucide="alert-circle" class="w-4 h-4 text-white"></i>
        </div>
      </div>
    </div>

    <!-- Resolved Disputes -->
    <div class="bg-white rounded-lg border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Resolved Disputes</p>
          <p id="stat-resolved" class="text-2xl font-bold text-success mt-1">--</p>
        </div>
        <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center">
          <i data-lucide="check-circle" class="w-4 h-4 text-white"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Disputes Table -->
  <div class="bg-white rounded-lg border border-neutral-200 overflow-hidden">
    <!-- Table Header -->
    <div class="px-6 py-4 border-b border-neutral-200">
      <h2 class="text-lg font-semibold text-primary">Disputes</h2>
    </div>

    <!-- Loading Skeleton -->
    <div id="disputes-skeleton" class="p-6">
      <div class="space-y-4">
        <div class="animate-pulse flex space-x-4">
          <div class="rounded-full bg-neutral-200 h-10 w-10"></div>
          <div class="flex-1 space-y-2 py-1">
            <div class="h-4 bg-neutral-200 rounded w-3/4"></div>
            <div class="h-4 bg-neutral-200 rounded w-1/2"></div>
          </div>
        </div>
        <div class="animate-pulse flex space-x-4">
          <div class="rounded-full bg-neutral-200 h-10 w-10"></div>
          <div class="flex-1 space-y-2 py-1">
            <div class="h-4 bg-neutral-200 rounded w-2/3"></div>
            <div class="h-4 bg-neutral-200 rounded w-1/3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Content -->
    <div id="disputes-table-container" class="hidden">
      <table class="w-full">
        <thead class="bg-neutral-50 sticky top-0">
          <tr class="text-xs font-medium text-secondary uppercase tracking-wide">
            <th class="text-left px-6 py-3 border-b border-neutral-200">Dispute ID</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Cycle</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Employee</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Team Lead</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Assessment ID</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Status</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Created</th>
            <th class="text-left px-6 py-3 border-b border-neutral-200">Last Updated</th>
          </tr>
        </thead>
        <tbody id="disputes-tbody" class="text-sm">
          <!-- Table rows will be populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="disputes-empty" class="hidden p-12 text-center">
      <div class="w-12 h-12 mx-auto mb-4 bg-neutral-100 rounded-full flex items-center justify-center">
        <i data-lucide="search" class="w-6 h-6 text-neutral-400"></i>
      </div>
      <h3 class="text-lg font-medium text-neutral-700 mb-2">No disputes found</h3>
      <p class="text-sm text-neutral-500">There are no disputes matching your current filters.</p>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="hidden px-6 py-4 border-t border-neutral-200 flex items-center justify-between">
      <div class="text-sm text-neutral-700">
        Showing <span id="page-start">1</span> to <span id="page-end">25</span> of <span id="total-count">0</span> disputes
      </div>
      <div class="flex items-center gap-2">
        <button id="prev-page" class="px-3 py-1 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Previous
        </button>
        <button id="next-page" class="px-3 py-1 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Review Drawer -->
<div id="review-drawer" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="drawer-backdrop"></div>
  
  <!-- Drawer Panel -->
  <div class="absolute right-0 top-0 h-full w-full max-w-4xl bg-white shadow-lg">
    <div class="flex flex-col h-full">
      <!-- Drawer Header -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-200">
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-semibold text-primary">Dispute Review</h2>
          <span id="drawer-dispute-id" class="text-sm text-neutral-500"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="open-assessment-btn" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-accent hover:text-accent/80 hover:bg-accent/10 rounded-md transition-colors duration-150">
            <i data-lucide="external-link" class="w-4 h-4"></i>
            Open Assessment
          </button>
          <button id="close-drawer" class="p-2 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-md transition-colors duration-150">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Drawer Content -->
      <div class="flex-1 overflow-y-auto">
        <!-- Dispute Info -->
        <div class="p-6 border-b border-neutral-200">
          <div class="grid grid-cols-2 gap-6">
            <div>
              <h3 class="text-sm font-medium text-secondary uppercase tracking-wide mb-3">Dispute Information</h3>
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-700">Employee:</span>
                  <span id="dispute-employee" class="text-sm font-medium text-neutral-900">--</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-700">Team Lead:</span>
                  <span id="dispute-team-lead" class="text-sm font-medium text-neutral-900">--</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-700">Cycle:</span>
                  <span id="dispute-cycle" class="text-sm font-medium text-neutral-900">--</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-700">Status:</span>
                  <span id="dispute-status" class="text-sm font-medium">--</span>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-secondary uppercase tracking-wide mb-3">Reason for Dispute</h3>
              <p id="dispute-reason" class="text-sm text-neutral-700 bg-neutral-50 p-3 rounded border">--</p>
            </div>
          </div>
        </div>

        <!-- Disputed Items -->
        <div class="p-6">
          <h3 class="text-lg font-semibold text-primary mb-4">Disputed Assessment Items</h3>
          <div id="disputed-items" class="space-y-4">
            <!-- Items will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Drawer Footer -->
      <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-between">
        <button id="audit-trail-btn" class="inline-flex items-center gap-2 px-3 py-2 text-sm text-secondary hover:text-primary hover:bg-neutral-100 rounded-md transition-colors duration-150">
          <i data-lucide="file-search" class="w-4 h-4"></i>
          View Audit Trail
        </button>
        <div class="flex items-center gap-3">
          <button id="cancel-resolution" class="px-4 py-2 text-sm border border-neutral-200 text-neutral-700 hover:bg-neutral-50 rounded-md transition-colors duration-150">
            Cancel
          </button>
          <button id="save-resolution" class="px-4 py-2 text-sm bg-accent text-white hover:bg-accent/90 rounded-md transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Save Resolution
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Resolution Modal -->
<div id="confirm-resolution-modal" class="fixed inset-0 z-60 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-backdrop"></div>
  
  <!-- Modal Panel -->
  <div class="absolute inset-0 flex items-center justify-center p-6">
    <div class="bg-white rounded-lg shadow-lg border border-neutral-200 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-neutral-200">
        <h2 class="text-lg font-semibold text-primary">Confirm Resolution</h2>
        <p class="text-sm text-secondary mt-1">Review the resolution details before finalizing.</p>
      </div>

      <!-- Modal Content -->
      <div class="p-6">
        <!-- Resolution Summary -->
        <div class="mb-6">
          <h3 class="text-sm font-medium text-secondary uppercase tracking-wide mb-3">Resolution Summary</h3>
          <div id="resolution-summary" class="space-y-2">
            <!-- Summary items will be populated by JavaScript -->
          </div>
        </div>

        <!-- Admin Note -->
        <div>
          <label class="block text-sm font-medium text-secondary mb-2">Admin Note (Optional)</label>
          <textarea id="admin-note" rows="3" placeholder="Add any additional notes about this resolution..." class="w-full border border-neutral-200 rounded px-3 py-2 text-sm text-neutral-700 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2"></textarea>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3">
        <button id="cancel-confirm" class="px-4 py-2 text-sm border border-neutral-200 text-neutral-700 hover:bg-neutral-50 rounded-md transition-colors duration-150">
          Cancel
        </button>
        <button id="confirm-resolution" class="px-4 py-2 text-sm bg-accent text-white hover:bg-accent/90 rounded-md transition-colors duration-150">
          Confirm Resolution
        </button>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Auth state management
        let currentUser = null;

        // Initialize auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user);
            } else {
                // Redirect to auth page if not authenticated
                window.location.href = 'auth.html';
            }
        });

        // Load user profile data
        async function loadUserProfile(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                    document.getElementById('user-name').textContent = fullName || user.email;
                } else {
                    // Fallback to email if no user doc exists
                    document.getElementById('user-name').textContent = user.email;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to email on error
                document.getElementById('user-name').textContent = user.email;
            }
        }

        // User dropdown functionality
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');

        userProfileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            userDropdown.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            }
        });

        // Mobile navigation
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const mobileNavBackdrop = document.getElementById('mobile-nav-backdrop');

        mobileMenuBtn.addEventListener('click', () => {
            mobileNavOverlay.classList.remove('hidden');
        });

        mobileNavBackdrop.addEventListener('click', () => {
            mobileNavOverlay.classList.add('hidden');
        });

        // Close mobile nav on navigation
        document.querySelectorAll('#mobile-nav-overlay .nav-item').forEach(link => {
            link.addEventListener('click', () => {
                mobileNavOverlay.classList.add('hidden');
            });
        });

        // Active navigation state
        function updateActiveNavState() {
            const currentPath = window.location.pathname;
            const pageName = currentPath.replace('/', '').replace('.html', '');
            
            // Remove active state from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-accent', 'text-white');
                item.classList.add('text-neutral-700');
            });

            // Add active state to current page
            document.querySelectorAll(`[data-page="${pageName}"]`).forEach(item => {
                item.classList.add('bg-accent', 'text-white');
                item.classList.remove('text-neutral-700');
            });
        }

        // Update active state on load
        updateActiveNavState();

        // Update active state on navigation (for SPA behavior)
        window.addEventListener('popstate', updateActiveNavState);
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import {
  collection, getDocs, doc, getDoc, updateDoc, writeBatch, setDoc,
  query, where, orderBy, limit, startAfter, onSnapshot, Timestamp,
  getCountFromServer
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";

const db = getDb();

// Auth guard
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
  }
});

// State management
let currentUser = null;
let disputes = [];
let filteredDisputes = [];
let departments = [];
let employees = [];
let assessmentCycles = [];
let skills = [];
let orgSettings = null;
let currentDispute = null;
let pendingActions = new Map(); // disputeId -> { skillId: { action, newScore?, adminComment? } }

// Pagination state
let currentPage = 1;
const itemsPerPage = 25;
let totalCount = 0;

// Search debouncing
let searchTimeout;

// Abort controller for search/filter operations
let currentAbort;

// Initialize page
document.addEventListener('DOMContentLoaded', async () => {
  lucide.createIcons();
  await funInitializeAuth();
  await funInitialLoad();
  setupEventListeners();
  
  // Check for specific dispute to open
  const urlParams = new URLSearchParams(window.location.search);
  const disputeId = urlParams.get('disputeId');
  if (disputeId) {
    setTimeout(() => funOpenDispute(disputeId), 100);
  }
  
  // Apply pre-filters from URL params
  const status = urlParams.get('status');
  const departmentId = urlParams.get('departmentId');
  if (status) document.getElementById('filter-status').value = status;
  if (departmentId) document.getElementById('filter-department').value = departmentId;
});

// Authentication
async function funInitializeAuth() {
  return new Promise((resolve) => {
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      resolve();
    });
  });
}

// Concurrency control
function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}
const withLimit = createSemaphore(2);

// Abortable fetch wrapper
async function funFetchPage(buildQuery) {
  if (currentAbort) currentAbort.abort();
  currentAbort = new AbortController();
  const signal = currentAbort.signal;

  try {
    const q = buildQuery();
    const snapshot = await getDocs(q);
    if (signal.aborted) return { items: [], cursor: null };
    
    return {
      items: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      cursor: snapshot.docs.at(-1) || null,
    };
  } catch (err) {
    if (signal.aborted) return { items: [], cursor: null };
    showToast(err?.message || "Failed to load data");
    return { items: [], cursor: null };
  }
}

// Initial data load
async function funInitialLoad(forceRefresh = false) {
  try {
    document.getElementById('disputes-skeleton').classList.remove('hidden');
    document.getElementById('disputes-table-container').classList.add('hidden');
    document.getElementById('disputes-empty').classList.add('hidden');
    
    // Load reference data in sequence with concurrency limit
    await withLimit(() => funLoadDepartments());
    await withLimit(() => funLoadEmployees());
    await Promise.all([
      withLimit(() => funLoadAssessmentCycles()),
      withLimit(() => funLoadSkills()),
      withLimit(() => funLoadOrgSettings())
    ]);
    
    // Load disputes and stats
    await Promise.all([
      funLoadDisputes(),
      funLoadStats()
    ]);
    
    funPopulateFilters();
    funApplyFilters();
    
  } catch (error) {
    console.error('Error in initial load:', error);
    showToast('Failed to load disputes data');
  } finally {
    document.getElementById('disputes-skeleton').classList.add('hidden');
  }
}

// Load departments
async function funLoadDepartments() {
  try {
    const q = query(
      collection(db, 'departments'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    departments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading departments:', error);
    departments = [];
  }
}

// Load employees
async function funLoadEmployees() {
  try {
    const q = query(
      collection(db, 'employees'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading employees:', error);
    employees = [];
  }
}

// Load assessment cycles
async function funLoadAssessmentCycles() {
  try {
    const q = query(
      collection(db, 'assessmentCycles'),
      orderBy('startDate', 'desc')
    );
    const snapshot = await getDocs(q);
    assessmentCycles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading assessment cycles:', error);
    assessmentCycles = [];
  }
}

// Load skills
async function funLoadSkills() {
  try {
    const q = query(
      collection(db, 'skills'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    skills = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading skills:', error);
    skills = [];
  }
}

// Load org settings (current)
async function funLoadOrgSettings() {
  try {
    const q = query(
      collection(db, 'orgSettings'),
      where('effectiveEndDate', '==', null),
      limit(1)
    );
    const snapshot = await getDocs(q);
    orgSettings = snapshot.empty ? null : snapshot.docs[0].data();
  } catch (error) {
    console.error('Error loading org settings:', error);
    orgSettings = null;
  }
}

// Load disputes with server-side pagination
async function funLoadDisputes() {
  try {
    const { items } = await funFetchPage(() => {
      let q = collection(db, 'disputes');
      q = query(q, orderBy('createdAt', 'desc'), limit(itemsPerPage * 5)); // Load more for filtering
      return q;
    });
    disputes = items;
  } catch (error) {
    console.error('Error loading disputes:', error);
    disputes = [];
  }
}

// Load stats using count aggregation
async function funLoadStats() {
  try {
    // Total disputes
    const totalSnapshot = await getCountFromServer(collection(db, 'disputes'));
    const totalCount = totalSnapshot.data().count;
    document.getElementById('stat-total').textContent = totalCount.toLocaleString('en-IN');

    // Open disputes  
    const openSnapshot = await getCountFromServer(
      query(collection(db, 'disputes'), where('status', '==', 'open'))
    );
    const openCount = openSnapshot.data().count;
    document.getElementById('stat-open').textContent = openCount.toLocaleString('en-IN');

    // Resolved disputes
    const resolvedSnapshot = await getCountFromServer(
      query(collection(db, 'disputes'), where('status', '==', 'resolved'))
    );
    const resolvedCount = resolvedSnapshot.data().count;
    document.getElementById('stat-resolved').textContent = resolvedCount.toLocaleString('en-IN');

  } catch (error) {
    console.error('Error loading stats:', error);
    document.getElementById('stat-total').textContent = 'N/A';
    document.getElementById('stat-open').textContent = 'N/A';
    document.getElementById('stat-resolved').textContent = 'N/A';
  }
}

// Populate filter dropdowns
function funPopulateFilters() {
  // Populate departments
  const departmentSelect = document.getElementById('filter-department');
  departmentSelect.innerHTML = '<option value="">All Departments</option>';
  departments.forEach(dept => {
    const option = document.createElement('option');
    option.value = dept.id;
    option.textContent = dept.name || 'N/A';
    departmentSelect.appendChild(option);
  });

  // Populate team leads (employees who are team leads)
  const teamLeadSelect = document.getElementById('filter-team-lead');
  teamLeadSelect.innerHTML = '<option value="">All Team Leads</option>';
  const teamLeads = employees.filter(emp => 
    disputes.some(dispute => dispute.teamLeadId === emp.id)
  );
  teamLeads.forEach(tl => {
    const option = document.createElement('option');
    option.value = tl.id;
    option.textContent = tl.name || 'N/A';
    teamLeadSelect.appendChild(option);
  });
}

// Apply filters and search
function funApplyFilters() {
  const departmentFilter = document.getElementById('filter-department').value;
  const teamLeadFilter = document.getElementById('filter-team-lead').value;
  const statusFilter = document.getElementById('filter-status').value;
  const searchFilter = document.getElementById('search-input').value.toLowerCase();

  filteredDisputes = disputes.filter(dispute => {
    // Department filter
    if (departmentFilter) {
      const employee = employees.find(emp => emp.id === dispute.employeeId);
      if (!employee || employee.departmentId !== departmentFilter) return false;
    }

    // Team lead filter  
    if (teamLeadFilter && dispute.teamLeadId !== teamLeadFilter) return false;

    // Status filter
    if (statusFilter && dispute.status !== statusFilter) return false;

    // Search filter
    if (searchFilter) {
      const employee = employees.find(emp => emp.id === dispute.employeeId);
      const teamLead = employees.find(emp => emp.id === dispute.teamLeadId);
      const cycle = assessmentCycles.find(cycle => cycle.id === dispute.cycleId);
      
      const searchText = [
        dispute.id,
        dispute.assessmentId,
        dispute.reasonForDispute,
        employee?.name,
        teamLead?.name,
        cycle?.name
      ].filter(Boolean).join(' ').toLowerCase();
      
      if (!searchText.includes(searchFilter)) return false;
    }

    return true;
  });

  // Reset pagination
  currentPage = 1;
  totalCount = filteredDisputes.length;
  
  funRenderDisputes();
  funUpdatePagination();
}

// Render disputes table
function funRenderDisputes() {
  const tbody = document.getElementById('disputes-tbody');
  const tableContainer = document.getElementById('disputes-table-container');
  const emptyState = document.getElementById('disputes-empty');

  if (filteredDisputes.length === 0) {
    tableContainer.classList.add('hidden');
    emptyState.classList.remove('hidden');
    document.getElementById('pagination-container').classList.add('hidden');
    return;
  }

  tableContainer.classList.remove('hidden');
  emptyState.classList.add('hidden');

  // Calculate page items
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, filteredDisputes.length);
  const pageItems = filteredDisputes.slice(startIndex, endIndex);

  tbody.innerHTML = '';
  
  pageItems.forEach(dispute => {
    const row = document.createElement('tr');
    row.className = 'odd:bg-white even:bg-neutral-50 hover:bg-neutral-100 cursor-pointer transition-colors duration-150';
    row.onclick = () => funOpenDispute(dispute.id);

    // Get related data
    const employee = employees.find(emp => emp.id === dispute.employeeId);
    const teamLead = employees.find(emp => emp.id === dispute.teamLeadId);
    const cycle = assessmentCycles.find(c => c.id === dispute.cycleId);
    
    // Calculate last history timestamp
    const lastHistoryTimestamp = dispute.history && dispute.history.length > 0 
      ? Math.max(...dispute.history.map(h => new Date(h.at).getTime()))
      : new Date(dispute.createdAt).getTime();

    row.innerHTML = `
      <td class="px-6 py-3 text-neutral-700">
        <span class="font-mono text-xs">${dispute.id || 'N/A'}</span>
      </td>
      <td class="px-6 py-3 text-neutral-700">${cycle?.name || 'N/A'}</td>
      <td class="px-6 py-3 text-neutral-700">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
            <span class="text-xs font-medium text-white">${(employee?.name || 'N')[0].toUpperCase()}</span>
          </div>
          <span>${employee?.name || 'N/A'}</span>
        </div>
      </td>
      <td class="px-6 py-3 text-neutral-700">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-secondary rounded-full flex items-center justify-center">
            <span class="text-xs font-medium text-white">${(teamLead?.name || 'N')[0].toUpperCase()}</span>
          </div>
          <span>${teamLead?.name || 'N/A'}</span>
        </div>
      </td>
      <td class="px-6 py-3 text-neutral-700">
        <span class="font-mono text-xs">${dispute.assessmentId || 'N/A'}</span>
      </td>
      <td class="px-6 py-3">
        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full ${
          dispute.status === 'open' 
            ? 'bg-warning text-white' 
            : 'bg-success text-white'
        }">
          <span class="h-2 w-2 rounded-full ${
            dispute.status === 'open' ? 'bg-white' : 'bg-white'
          }"></span>
          ${dispute.status === 'open' ? 'Open' : 'Resolved'}
        </span>
      </td>
      <td class="px-6 py-3 text-neutral-700">
        ${new Date(dispute.createdAt).toLocaleDateString('en-IN', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        })}
      </td>
      <td class="px-6 py-3 text-neutral-700">
        ${new Date(lastHistoryTimestamp).toLocaleDateString('en-IN', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        })}
      </td>
    `;

    tbody.appendChild(row);
  });

  document.getElementById('pagination-container').classList.remove('hidden');
}

// Update pagination
function funUpdatePagination() {
  const startItem = totalCount > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
  const endItem = Math.min(currentPage * itemsPerPage, totalCount);
  
  document.getElementById('page-start').textContent = startItem;
  document.getElementById('page-end').textContent = endItem;
  document.getElementById('total-count').textContent = totalCount;
  
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  
  prevBtn.disabled = currentPage <= 1;
  nextBtn.disabled = currentPage >= Math.ceil(totalCount / itemsPerPage);
}

// Open dispute in drawer
async function funOpenDispute(disputeId) {
  try {
    showLoader();
    
    // Get dispute details
    const disputeDoc = await getDoc(doc(db, 'disputes', disputeId));
    if (!disputeDoc.exists()) {
      showToast('Dispute not found');
      return;
    }

    currentDispute = { id: disputeDoc.id, ...disputeDoc.data() };
    pendingActions.clear();
    
    // Get assessment details
    const assessmentDoc = await getDoc(doc(db, 'assessments', currentDispute.assessmentId));
    if (!assessmentDoc.exists()) {
      showToast('Associated assessment not found');
      return;
    }

    const assessment = assessmentDoc.data();
    
    // Populate drawer
    await funPopulateDrawer(currentDispute, assessment);
    
    document.getElementById('review-drawer').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error opening dispute:', error);
    showToast('Failed to load dispute details');
  } finally {
    hideLoader();
  }
}

// Populate drawer with dispute details
async function funPopulateDrawer(dispute, assessment) {
  const employee = employees.find(emp => emp.id === dispute.employeeId);
  const teamLead = employees.find(emp => emp.id === dispute.teamLeadId);
  const cycle = assessmentCycles.find(c => c.id === dispute.cycleId);

  // Basic info
  document.getElementById('drawer-dispute-id').textContent = `#${dispute.id}`;
  document.getElementById('dispute-employee').textContent = employee?.name || 'N/A';
  document.getElementById('dispute-team-lead').textContent = teamLead?.name || 'N/A';
  document.getElementById('dispute-cycle').textContent = cycle?.name || 'N/A';
  document.getElementById('dispute-reason').textContent = dispute.reasonForDispute || 'N/A';
  
  const statusElement = document.getElementById('dispute-status');
  statusElement.textContent = dispute.status === 'open' ? 'Open' : 'Resolved';
  statusElement.className = `text-sm font-medium ${dispute.status === 'open' ? 'text-warning' : 'text-success'}`;

  // Populate disputed items
  const itemsContainer = document.getElementById('disputed-items');
  itemsContainer.innerHTML = '';

  if (dispute.items && dispute.items.length > 0) {
    for (const item of dispute.items) {
      const skill = skills.find(s => s.id === item.skillId);
      const assessmentItem = assessment.items?.find(ai => ai.skillId === item.skillId);
      
      if (!assessmentItem) continue;

      const itemDiv = document.createElement('div');
      itemDiv.className = 'border border-neutral-200 rounded-lg p-4';
      itemDiv.innerHTML = `
        <div class="grid grid-cols-2 gap-6">
          <!-- Original Assessment -->
          <div>
            <h4 class="text-sm font-medium text-secondary mb-3">Team Lead's Assessment</h4>
            <div class="bg-neutral-50 rounded p-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs text-neutral-600">Skill:</span>
                <span class="text-sm font-medium">${skill?.name || 'N/A'}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-neutral-600">Original Score:</span>
                <span class="text-sm font-bold">${item.originalScore || assessmentItem.score}/10</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-neutral-600">Benchmark:</span>
                <span class="text-sm font-medium">${assessmentItem.benchmarkAtAssessment || 'N/A'}/10</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-neutral-600">Gap:</span>
                <span class="text-sm ${assessmentItem.gap > 0 ? 'text-error' : 'text-success'}">${assessmentItem.gap || 0}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-neutral-600">TNI Status:</span>
                <span class="text-sm ${assessmentItem.tni ? 'text-error' : 'text-success'}">${assessmentItem.tni ? 'Required' : 'Not Required'}</span>
              </div>
              ${assessmentItem.comment ? `
                <div class="pt-2 border-t border-neutral-200">
                  <span class="text-xs text-neutral-600">Comment:</span>
                  <p class="text-sm text-neutral-700 mt-1">${assessmentItem.comment}</p>
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Employee Dispute -->
          <div>
            <h4 class="text-sm font-medium text-secondary mb-3">Employee's Response</h4>
            <div class="bg-blue-50 rounded p-3 space-y-2">
              <div class="pt-1">
                <span class="text-xs text-neutral-600">Reason for Dispute:</span>
                <p class="text-sm text-neutral-700 mt-1">${item.employeeReason || item.reason || 'N/A'}</p>
              </div>
            </div>

            <!-- Admin Actions -->
            ${dispute.status === 'open' ? `
              <div class="mt-4">
                <h5 class="text-xs font-medium text-secondary uppercase tracking-wide mb-3">Admin Action</h5>
                <div class="space-y-3">
                  <!-- Action Selection -->
                  <div>
                    <label class="block text-xs text-neutral-700 mb-1">Action</label>
                    <select class="action-select w-full border border-neutral-200 rounded px-3 py-2 text-sm" data-skill-id="${item.skillId}">
                      <option value="">Select Action</option>
                      <option value="Override">Override Score</option>
                      <option value="Dismiss">Dismiss Dispute</option>
                    </select>
                  </div>

                  <!-- Override Score Input -->
                  <div class="override-score-input hidden">
                    <label class="block text-xs text-neutral-700 mb-1">New Score (1-10)</label>
                    <input type="number" min="1" max="10" class="new-score-input w-full border border-neutral-200 rounded px-3 py-2 text-sm" data-skill-id="${item.skillId}">
                  </div>

                  <!-- Dismiss Comment Input -->
                  <div class="dismiss-comment-input hidden">
                    <label class="block text-xs text-neutral-700 mb-1">Admin Comment (Required)</label>
                    <textarea rows="2" class="admin-comment-input w-full border border-neutral-200 rounded px-3 py-2 text-sm" data-skill-id="${item.skillId}" placeholder="Explain why this dispute is being dismissed..."></textarea>
                  </div>

                  <!-- Calculated Impact -->
                  <div class="impact-display hidden bg-yellow-50 border border-yellow-200 rounded p-2">
                    <div class="text-xs text-yellow-800 font-medium mb-1">Recalculated Values:</div>
                    <div class="impact-values text-xs text-yellow-700"></div>
                  </div>
                </div>
              </div>
            ` : (item.adminAction ? `
              <!-- Resolved Action -->
              <div class="mt-4 bg-green-50 border border-green-200 rounded p-3">
                <div class="text-xs font-medium text-green-800 mb-2">Resolution: ${item.adminAction}</div>
                ${item.newScore ? `<div class="text-xs text-green-700">New Score: ${item.newScore}/10</div>` : ''}
                ${item.adminComment ? `<div class="text-xs text-green-700 mt-1">Comment: ${item.adminComment}</div>` : ''}
              </div>
            ` : '')}
          </div>
        </div>
      `;

      itemsContainer.appendChild(itemDiv);
    }

    // Setup action handlers if dispute is open
    if (dispute.status === 'open') {
      setupItemActionHandlers();
    }
  }

  // Update save button state
  funUpdateSaveButton();
}

// Setup action handlers for dispute items
function setupItemActionHandlers() {
  document.querySelectorAll('.action-select').forEach(select => {
    select.addEventListener('change', (e) => {
      const skillId = e.target.dataset.skillId;
      const action = e.target.value;
      const container = e.target.closest('.space-y-3');
      
      // Hide all inputs
      container.querySelector('.override-score-input')?.classList.add('hidden');
      container.querySelector('.dismiss-comment-input')?.classList.add('hidden');
      container.querySelector('.impact-display')?.classList.add('hidden');
      
      if (action === 'Override') {
        container.querySelector('.override-score-input')?.classList.remove('hidden');
      } else if (action === 'Dismiss') {
        container.querySelector('.dismiss-comment-input')?.classList.remove('hidden');
      }

      // Update pending actions
      if (action) {
        pendingActions.set(skillId, { action });
      } else {
        pendingActions.delete(skillId);
      }
      
      funUpdateSaveButton();
      funCalculateImpact(skillId);
    });
  });

  // Score inputs
  document.querySelectorAll('.new-score-input').forEach(input => {
    input.addEventListener('input', (e) => {
      const skillId = e.target.dataset.skillId;
      const newScore = parseInt(e.target.value);
      
      if (pendingActions.has(skillId) && !isNaN(newScore) && newScore >= 1 && newScore <= 10) {
        const action = pendingActions.get(skillId);
        pendingActions.set(skillId, { ...action, newScore });
        funCalculateImpact(skillId);
      }
      
      funUpdateSaveButton();
    });
  });

  // Comment inputs
  document.querySelectorAll('.admin-comment-input').forEach(textarea => {
    textarea.addEventListener('input', (e) => {
      const skillId = e.target.dataset.skillId;
      const adminComment = e.target.value.trim();
      
      if (pendingActions.has(skillId)) {
        const action = pendingActions.get(skillId);
        pendingActions.set(skillId, { ...action, adminComment });
      }
      
      funUpdateSaveButton();
    });
  });
}

// Calculate impact of score changes
function funCalculateImpact(skillId) {
  const action = pendingActions.get(skillId);
  if (!action || action.action !== 'Override' || !action.newScore) return;

  const container = document.querySelector(`[data-skill-id="${skillId}"]`).closest('.space-y-3');
  const impactDisplay = container.querySelector('.impact-display');
  const impactValues = container.querySelector('.impact-values');
  
  if (!impactDisplay || !impactValues || !currentDispute) return;

  try {
    // Find the disputed item and assessment item
    const disputeItem = currentDispute.items?.find(item => item.skillId === skillId);
    if (!disputeItem) return;

    // Get current assessment (we need to fetch it again or use cached version)
    // For simplicity, calculate based on what we know
    const newScore = action.newScore;
    const benchmark = disputeItem.benchmarkAtAssessment || 5; // fallback
    const tniThreshold = orgSettings?.tniIgnoreThreshold || 1;
    
    const gap = benchmark - newScore;
    const tni = gap > tniThreshold;
    const skill = skills.find(s => s.id === skillId);
    const weight = skill ? (skill.criticalityWeight || 1) : 1;
    const weightedGap = Math.max(0, gap - tniThreshold) * weight;

    impactValues.innerHTML = `
      <div>Gap: ${gap} (was: ${disputeItem.originalGap || 'N/A'})</div>
      <div>TNI: ${tni ? 'Required' : 'Not Required'} (was: ${disputeItem.originalTni ? 'Required' : 'Not Required'})</div>
      <div>Weighted Gap: ${weightedGap.toFixed(2)} (was: ${disputeItem.originalWeightedGap || 'N/A'})</div>
    `;
    
    impactDisplay.classList.remove('hidden');
  } catch (error) {
    console.error('Error calculating impact:', error);
  }
}

// Update save button state
function funUpdateSaveButton() {
  const saveButton = document.getElementById('save-resolution');
  let allValid = pendingActions.size > 0;

  for (const [skillId, action] of pendingActions) {
    if (action.action === 'Override' && (!action.newScore || action.newScore < 1 || action.newScore > 10)) {
      allValid = false;
      break;
    }
    if (action.action === 'Dismiss' && !action.adminComment?.trim()) {
      allValid = false;
      break;
    }
  }

  saveButton.disabled = !allValid;
}

// Save resolution
async function funSaveResolution() {
  if (pendingActions.size === 0) {
    showToast('No actions selected');
    return;
  }

  // Show confirmation modal
  funShowConfirmationModal();
}

// Show confirmation modal
function funShowConfirmationModal() {
  const modal = document.getElementById('confirm-resolution-modal');
  const summaryContainer = document.getElementById('resolution-summary');
  
  // Generate summary
  summaryContainer.innerHTML = '';
  
  for (const [skillId, action] of pendingActions) {
    const skill = skills.find(s => s.id === skillId);
    const summaryItem = document.createElement('div');
    summaryItem.className = 'flex items-center justify-between py-2 px-3 bg-neutral-50 rounded';
    
    let actionText = '';
    if (action.action === 'Override') {
      actionText = `Override score to ${action.newScore}/10`;
    } else if (action.action === 'Dismiss') {
      actionText = 'Dismiss dispute';
    }
    
    summaryItem.innerHTML = `
      <span class="text-sm font-medium">${skill?.name || 'Unknown Skill'}</span>
      <span class="text-sm text-secondary">${actionText}</span>
    `;
    
    summaryContainer.appendChild(summaryItem);
  }
  
  modal.classList.remove('hidden');
}

// Confirm resolution
async function funConfirmResolution() {
  try {
    showLoader();
    
    const adminNote = document.getElementById('admin-note').value.trim();
    const batch = writeBatch(db);
    const timestamp = new Date().toISOString();
    
    // Get current assessment
    const assessmentDoc = await getDoc(doc(db, 'assessments', currentDispute.assessmentId));
    if (!assessmentDoc.exists()) {
      throw new Error('Assessment not found');
    }
    
    const assessment = { id: assessmentDoc.id, ...assessmentDoc.data() };
    const updatedItems = [...(assessment.items || [])];
    
    // Apply actions and update assessment items
    for (const [skillId, action] of pendingActions) {
      const itemIndex = updatedItems.findIndex(item => item.skillId === skillId);
      if (itemIndex === -1) continue;
      
      const item = updatedItems[itemIndex];
      const benchmark = item.benchmarkAtAssessment || 5;
      const tniThreshold = orgSettings?.tniIgnoreThreshold || 1;
      const skill = skills.find(s => s.id === skillId);
      const weight = skill ? (skill.criticalityWeight || 1) : 1;
      
      if (action.action === 'Override') {
        // Update score and recalculate
        item.score = action.newScore;
        item.gap = benchmark - action.newScore;
        item.tni = item.gap > tniThreshold;
        item.weightedGap = Math.max(0, item.gap - tniThreshold) * weight;
      }
      
      // Create audit log
      const auditId = `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      batch.set(doc(db, 'auditLogs', auditId), {
        id: auditId,
        entityType: 'dispute',
        entityId: currentDispute.id,
        action: action.action === 'Override' ? 'overrideScore' : 'dismissDispute',
        actorId: currentUser.uid,
        timestamp,
        before: { skillId, originalScore: item.score, status: 'open' },
        after: { 
          skillId, 
          newScore: action.newScore || item.score, 
          adminComment: action.adminComment || '',
          status: 'resolved' 
        },
        reason: action.adminComment || adminNote || 'Dispute resolution'
      });
    }
    
    // Update assessment
    batch.updateDoc(doc(db, 'assessments', currentDispute.assessmentId), {
      items: updatedItems,
      updatedAt: timestamp,
      updatedBy: currentUser.uid
    });
    
    // Update dispute
    const updatedDisputeItems = currentDispute.items?.map(item => {
      const action = pendingActions.get(item.skillId);
      if (action) {
        return {
          ...item,
          adminAction: action.action,
          newScore: action.newScore || undefined,
          adminComment: action.adminComment || undefined
        };
      }
      return item;
    }) || [];
    
    const historyEntry = {
      at: timestamp,
      action: 'resolved',
      actorId: currentUser.uid,
      note: adminNote || 'Dispute resolved by admin'
    };
    
    batch.updateDoc(doc(db, 'disputes', currentDispute.id), {
      status: 'resolved',
      items: updatedDisputeItems,
      history: [...(currentDispute.history || []), historyEntry],
      resolvedAt: timestamp,
      resolvedBy: currentUser.uid
    });
    
    // Create notifications
    const employee = employees.find(emp => emp.id === currentDispute.employeeId);
    const teamLead = employees.find(emp => emp.id === currentDispute.teamLeadId);
    
    if (employee) {
      const empNotificationId = `notif_${Date.now()}_emp_${Math.random().toString(36).substr(2, 9)}`;
      batch.set(doc(db, 'notifications', empNotificationId), {
        id: empNotificationId,
        recipientEmployeeId: employee.id,
        type: 'disputeResolvedInfo',
        cycleId: currentDispute.cycleId,
        message: `Your dispute for assessment has been resolved. Please check the updated scores.`,
        createdAt: timestamp
      });
    }
    
    if (teamLead) {
      const tlNotificationId = `notif_${Date.now()}_tl_${Math.random().toString(36).substr(2, 9)}`;
      batch.set(doc(db, 'notifications', tlNotificationId), {
        id: tlNotificationId,
        recipientEmployeeId: teamLead.id,
        type: 'disputeResolvedInfo',
        cycleId: currentDispute.cycleId,
        message: `A dispute for your assessment has been resolved by admin.`,
        createdAt: timestamp
      });
    }
    
    // Commit batch
    await batch.commit();
    
    showToast('Dispute resolved successfully');
    
    // Close modal and drawer
    document.getElementById('confirm-resolution-modal').classList.add('hidden');
    document.getElementById('review-drawer').classList.add('hidden');
    
    // Refresh data
    await funInitialLoad(true);
    
  } catch (error) {
    console.error('Error resolving dispute:', error);
    showToast('Failed to resolve dispute');
  } finally {
    hideLoader();
  }
}

// Event listeners
function setupEventListeners() {
  // Refresh button
  document.getElementById('btn-refresh').addEventListener('click', () => funInitialLoad(true));

  // Filters
  document.getElementById('filter-department').addEventListener('change', funApplyFilters);
  document.getElementById('filter-team-lead').addEventListener('change', funApplyFilters);
  document.getElementById('filter-status').addEventListener('change', funApplyFilters);

  // Search with debouncing
  document.getElementById('search-input').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      funApplyFilters();
    }, 300);
  });

  // Pagination
  document.getElementById('prev-page').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      funRenderDisputes();
      funUpdatePagination();
    }
  });

  document.getElementById('next-page').addEventListener('click', () => {
    if (currentPage < Math.ceil(totalCount / itemsPerPage)) {
      currentPage++;
      funRenderDisputes();
      funUpdatePagination();
    }
  });

  // Drawer events
  document.getElementById('close-drawer').addEventListener('click', () => {
    document.getElementById('review-drawer').classList.add('hidden');
  });

  document.getElementById('drawer-backdrop').addEventListener('click', () => {
    document.getElementById('review-drawer').classList.add('hidden');
  });

  document.getElementById('open-assessment-btn').addEventListener('click', () => {
    if (currentDispute) {
      const returnTo = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = `assessment_viewer.html?assessmentId=${currentDispute.assessmentId}&source=dispute&returnTo=${returnTo}`;
    }
  });

  document.getElementById('audit-trail-btn').addEventListener('click', () => {
    if (currentDispute) {
      const returnTo = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = `audit_log_viewer.html?entityType=dispute&entityId=${currentDispute.id}&returnTo=${returnTo}`;
    }
  });

  // Resolution buttons
  document.getElementById('cancel-resolution').addEventListener('click', () => {
    document.getElementById('review-drawer').classList.add('hidden');
  });

  document.getElementById('save-resolution').addEventListener('click', funSaveResolution);

  // Modal events
  document.getElementById('modal-backdrop').addEventListener('click', () => {
    document.getElementById('confirm-resolution-modal').classList.add('hidden');
  });

  document.getElementById('cancel-confirm').addEventListener('click', () => {
    document.getElementById('confirm-resolution-modal').classList.add('hidden');
  });

  document.getElementById('confirm-resolution').addEventListener('click', funConfirmResolution);

  // Escape key handlers
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const drawer = document.getElementById('review-drawer');
      const modal = document.getElementById('confirm-resolution-modal');
      
      if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      } else if (!drawer.classList.contains('hidden')) {
        drawer.classList.add('hidden');
      }
    }
  });
}
</script>

</body>
</html>