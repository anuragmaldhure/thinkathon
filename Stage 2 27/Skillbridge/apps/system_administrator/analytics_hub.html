<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Configuration -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e293b',
                        secondary: '#475569',
                        accent: '#2563eb',
                        gold: '#CBA35C',
                        success: '#16A34A',
                        warning: '#D97706',
                        error: '#DC2626',
                        info: '#0EA5E9',
                        neutral: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                            400: '#94A3B8',
                            700: '#334155',
                            900: '#0F172A',
                        }
                    },
                    fontFamily: {
                        sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                    },
                    boxShadow: {
                        sm: '0 1px 2px rgba(15,23,42,0.06)',
                        DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
                        lg: '0 8px 24px rgba(15,23,42,0.12)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-btn" class="md:hidden p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150">
                <i data-lucide="menu" class="w-6 h-6 text-secondary"></i>
            </button>
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="h-8 w-8">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-xl font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-3 p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="flex flex-col items-end">
                        <span id="user-name" class="text-sm font-medium text-neutral-700">Loading...</span>
                        <span id="user-role" class="text-xs text-neutral-400">System Admin</span>
                    </div>
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                </button>
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-neutral-200 z-40">
                    <div class="py-2">
                        <button id="sign-out-btn" class="w-full px-4 py-2 text-left text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto hidden md:block">
            <nav class="p-4 space-y-1">
                <!-- Analytics Hub -->
                <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Analytics Hub</span>
                </a>

                <!-- Organization Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                    <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="building-2" class="w-5 h-5"></i>
                        <span>Org Configuration</span>
                    </a>
                    <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span>Org Settings</span>
                    </a>
                </div>

                <!-- Core Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                    <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                        <span>Skill Framework</span>
                    </a>
                    <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Employees & Hierarchy</span>
                    </a>
                    <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>Training Management</span>
                    </a>
                </div>

                <!-- Operations Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                    <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="gavel" class="w-5 h-5"></i>
                        <span>Disputes Center</span>
                    </a>
                    <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        <span>Assessment Viewer</span>
                    </a>
                    <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-search" class="w-5 h-5"></i>
                        <span>Audit Log Viewer</span>
                    </a>
                </div>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-6 w-full text-center text-xs text-neutral-400 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay" class="hidden fixed inset-0 z-40 md:hidden">
            <div class="fixed inset-0 bg-neutral-900 bg-opacity-50" id="mobile-nav-backdrop"></div>
            <aside class="fixed left-0 top-16 h-[calc(100vh-4rem)] w-64 bg-white border-r border-neutral-200 overflow-y-auto">
                <nav class="p-4 space-y-1">
                    <!-- Same navigation structure as desktop -->
                    <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Analytics Hub</span>
                    </a>
                    
                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                        <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="building-2" class="w-5 h-5"></i>
                            <span>Org Configuration</span>
                        </a>
                        <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>Org Settings</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                        <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="book-open" class="w-5 h-5"></i>
                            <span>Skill Framework</span>
                        </a>
                        <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Employees & Hierarchy</span>
                        </a>
                        <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>Training Management</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                        <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="gavel" class="w-5 h-5"></i>
                            <span>Disputes Center</span>
                        </a>
                        <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span>Assessment Viewer</span>
                        </a>
                        <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-search" class="w-5 h-5"></i>
                            <span>Audit Log Viewer</span>
                        </a>
                    </div>
                </nav>
            </aside>
        </div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px] mx-auto">
            
<!-- Analytics Hub Dashboard -->
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div>
      <h1 class="text-[clamp(1.5rem,2.5vw,2rem)] leading-10 font-bold text-primary">Analytics Hub</h1>
      <p class="text-sm text-secondary mt-1">Monitor organization-wide gaps, training coverage, and performance metrics</p>
    </div>
    <button id="refresh-all-btn" class="inline-flex items-center gap-2 text-sm text-secondary hover:text-primary transition-colors duration-150">
      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
      Refresh All Data
    </button>
  </div>

  <!-- Filters Bar -->
  <div class="bg-white rounded-md border border-neutral-200 p-4 space-y-4">
    <h3 class="text-sm font-semibold text-primary">Filters</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
      <!-- Cycle Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Assessment Cycle</label>
        <select id="cycle-filter" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Cycles</option>
        </select>
      </div>
      
      <!-- Department Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Department</label>
        <select id="department-filter" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Departments</option>
        </select>
      </div>
      
      <!-- Skill Category Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Skill Category</label>
        <select id="category-filter" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Categories</option>
        </select>
      </div>
      
      <!-- Criticality Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Criticality</label>
        <select id="criticality-filter" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="">All Levels</option>
        </select>
      </div>
      
      <!-- Role Filter -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Job Title</label>
        <input type="text" id="role-filter" placeholder="Search by title" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
      </div>
      
      <!-- Date Range -->
      <div>
        <label class="block text-xs font-medium text-secondary mb-1">Date Range</label>
        <select id="date-range-filter" class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="180">Last 6 Months</option>
          <option value="">All Time</option>
        </select>
      </div>
    </div>
  </div>

  <!-- KPI Tiles -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Below Benchmark KPI -->
    <div class="bg-white rounded-md border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Below Benchmark</p>
          <p id="below-benchmark-count" class="text-2xl font-bold text-error mt-1">--</p>
          <p id="below-benchmark-percent" class="text-sm text-secondary">-- of assessed</p>
        </div>
        <div class="w-10 h-10 bg-error/10 rounded-md flex items-center justify-center">
          <i data-lucide="alert-circle" class="w-5 h-5 text-error"></i>
        </div>
      </div>
    </div>

    <!-- Critical Skills KPI -->
    <div class="bg-white rounded-md border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Critical Gaps</p>
          <p id="critical-gaps-count" class="text-2xl font-bold text-warning mt-1">--</p>
          <p class="text-sm text-secondary">High priority</p>
        </div>
        <div class="w-10 h-10 bg-warning/10 rounded-md flex items-center justify-center">
          <i data-lucide="zap" class="w-5 h-5 text-warning"></i>
        </div>
      </div>
    </div>

    <!-- Training Coverage KPI -->
    <div class="bg-white rounded-md border border-neutral-200 p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Training Coverage</p>
          <p id="training-coverage-percent" class="text-2xl font-bold text-info mt-1">--%</p>
          <p class="text-sm text-secondary">vs demand</p>
        </div>
        <div class="w-10 h-10 bg-info/10 rounded-md flex items-center justify-center">
          <i data-lucide="calendar" class="w-5 h-5 text-info"></i>
        </div>
      </div>
    </div>

    <!-- Disputes KPI -->
    <div class="bg-white rounded-md border border-neutral-200 p-4 cursor-pointer hover:bg-neutral-50 transition-colors duration-150" id="disputes-kpi">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-secondary uppercase tracking-wide">Open Disputes</p>
          <p id="open-disputes-count" class="text-2xl font-bold text-warning mt-1">--</p>
          <p id="avg-resolution-time" class="text-sm text-secondary">-- avg resolution</p>
        </div>
        <div class="w-10 h-10 bg-warning/10 rounded-md flex items-center justify-center">
          <i data-lucide="gavel" class="w-5 h-5 text-warning"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Skill Gap Heatmap -->
    <div class="bg-white rounded-md border border-neutral-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-primary">Skill Gap Heatmap</h3>
        <div class="flex items-center gap-2">
          <label class="text-xs font-medium text-secondary">View by:</label>
          <select id="heatmap-view-toggle" class="text-sm border border-neutral-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            <option value="departments">Departments</option>
            <option value="roles">Job Titles</option>
          </select>
          <button id="refresh-heatmap-btn" class="p-1 hover:bg-neutral-100 rounded transition-colors duration-150">
            <i data-lucide="refresh-cw" class="w-4 h-4 text-secondary"></i>
          </button>
        </div>
      </div>
      <div id="heatmap-container" class="h-80 overflow-auto">
        <!-- Skeleton loading state -->
        <div id="heatmap-skeleton" class="space-y-2">
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
        </div>
        <!-- Actual heatmap will be rendered here -->
        <div id="heatmap-chart" class="hidden"></div>
      </div>
    </div>

    <!-- Training Demand vs Coverage Chart -->
    <div class="bg-white rounded-md border border-neutral-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-primary">Training Demand vs Coverage</h3>
        <div class="flex items-center gap-2">
          <button id="toggle-chart-view" class="text-sm border border-neutral-200 rounded px-2 py-1 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
            Secondary Axis
          </button>
          <button id="refresh-chart-btn" class="p-1 hover:bg-neutral-100 rounded transition-colors duration-150">
            <i data-lucide="refresh-cw" class="w-4 h-4 text-secondary"></i>
          </button>
        </div>
      </div>
      <div id="demand-chart-container" class="h-80">
        <!-- Skeleton loading state -->
        <div id="demand-chart-skeleton" class="space-y-2">
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
        </div>
        <!-- Actual chart will be rendered here -->
        <div id="demand-chart" class="hidden"></div>
      </div>
    </div>

    <!-- TNI List -->
    <div class="bg-white rounded-md border border-neutral-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-primary">Training Needs Identification</h3>
        <button id="refresh-tni-btn" class="p-1 hover:bg-neutral-100 rounded transition-colors duration-150">
          <i data-lucide="refresh-cw" class="w-4 h-4 text-secondary"></i>
        </button>
      </div>
      
      <!-- Search and Controls -->
      <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <input type="text" id="tni-search" placeholder="Search skills..." class="flex-1 text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        <select id="tni-page-size" class="text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <option value="10">10 per page</option>
          <option value="25" selected>25 per page</option>
          <option value="50">50 per page</option>
        </select>
      </div>
      
      <div class="overflow-x-auto">
        <!-- Skeleton loading state -->
        <div id="tni-table-skeleton" class="space-y-2">
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
        </div>
        
        <!-- TNI Table -->
        <table id="tni-table" class="w-full border border-neutral-200 rounded-md overflow-hidden hidden">
          <thead class="bg-neutral-50">
            <tr class="text-secondary text-xs">
              <th class="text-left px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" data-sort="skillName">
                Skill <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
              </th>
              <th class="text-left px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" data-sort="employeeCount">
                Employees Needing Training <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
              </th>
              <th class="text-left px-4 py-3 border-b border-neutral-200 cursor-pointer hover:bg-neutral-100" data-sort="avgWeightedGap">
                Avg Weighted Gap <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
              </th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Actions</th>
            </tr>
          </thead>
          <tbody id="tni-table-body" class="text-sm">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div id="tni-pagination" class="flex items-center justify-between mt-4 hidden">
        <p class="text-sm text-secondary">
          Showing <span id="tni-showing-start">0</span> to <span id="tni-showing-end">0</span> of <span id="tni-total-count">0</span> skills
        </p>
        <div class="flex items-center gap-2">
          <button id="tni-prev-btn" class="px-3 py-1 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed">
            Previous
          </button>
          <span id="tni-page-info" class="text-sm text-secondary">Page 1 of 1</span>
          <button id="tni-next-btn" class="px-3 py-1 text-sm border border-neutral-200 rounded hover:bg-neutral-50 disabled:opacity-50 disabled:cursor-not-allowed">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Internal Trainer Availability -->
    <div class="bg-white rounded-md border border-neutral-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-primary">Internal Trainer Availability</h3>
        <button id="refresh-trainers-btn" class="p-1 hover:bg-neutral-100 rounded transition-colors duration-150">
          <i data-lucide="refresh-cw" class="w-4 h-4 text-secondary"></i>
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <!-- Skeleton loading state -->
        <div id="trainers-table-skeleton" class="space-y-2">
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
          <div class="h-4 bg-neutral-100 rounded animate-pulse"></div>
        </div>
        
        <!-- Trainers Table -->
        <table id="trainers-table" class="w-full border border-neutral-200 rounded-md overflow-hidden hidden">
          <thead class="bg-neutral-50">
            <tr class="text-secondary text-xs">
              <th class="text-left px-4 py-3 border-b border-neutral-200">Skill</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Available Trainers</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Upcoming Sessions</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Actions</th>
            </tr>
          </thead>
          <tbody id="trainers-table-body" class="text-sm">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer Actions -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-secondary">
    <a href="assessment_viewer.html" class="hover:text-primary transition-colors duration-150">
      <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
      View All Assessments
    </a>
    <a href="training_management.html" class="hover:text-primary transition-colors duration-150">
      <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
      Manage Training Sessions
    </a>
    <span class="text-xs">Last updated: <span id="last-updated">Never</span></span>
  </div>
</div>

<!-- Drill-through Modal: Employees Requiring Training -->
<div id="employees-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="bg-black/50 backdrop-blur-sm absolute inset-0" id="employees-modal-backdrop"></div>
  <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden relative">
    <div class="flex items-center justify-between p-6 border-b border-neutral-200">
      <h3 class="text-lg font-semibold text-primary">Employees Requiring Training</h3>
      <button id="close-employees-modal" class="p-2 hover:bg-neutral-100 rounded transition-colors duration-150">
        <i data-lucide="x" class="w-5 h-5 text-secondary"></i>
      </button>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[60vh]">
      <!-- Skill Info -->
      <div class="mb-4 p-3 bg-neutral-50 rounded border">
        <p class="font-medium text-primary" id="modal-skill-name">Skill Name</p>
        <p class="text-sm text-secondary" id="modal-skill-category">Category</p>
      </div>
      
      <!-- Search -->
      <div class="mb-4">
        <input type="text" id="employees-search" placeholder="Search employees..." class="w-full text-sm border border-neutral-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
      </div>
      
      <!-- Employees Table -->
      <div class="overflow-x-auto">
        <table class="w-full border border-neutral-200 rounded-md overflow-hidden">
          <thead class="bg-neutral-50">
            <tr class="text-secondary text-xs">
              <th class="text-left px-4 py-3 border-b border-neutral-200">
                <input type="checkbox" id="select-all-employees" class="rounded border-neutral-200 focus:ring-accent">
              </th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Employee Code</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Name</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Job Title</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Department</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Team Lead</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Gap</th>
              <th class="text-left px-4 py-3 border-b border-neutral-200">Weighted Gap</th>
            </tr>
          </thead>
          <tbody id="employees-table-body" class="text-sm">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="flex items-center justify-between p-6 border-t border-neutral-200">
      <p class="text-sm text-secondary">
        <span id="selected-count">0</span> employee(s) selected
      </p>
      <div class="flex items-center gap-3">
        <button id="cancel-selection" class="px-4 py-2 text-sm border border-neutral-200 rounded hover:bg-neutral-50 transition-colors duration-150">
          Cancel
        </button>
        <button id="create-training-session" class="px-4 py-2 text-sm bg-accent text-white rounded hover:bg-[#1d4ed8] transition-colors duration-150" disabled>
          Create Training Session
        </button>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Auth state management
        let currentUser = null;

        // Initialize auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user);
            } else {
                // Redirect to auth page if not authenticated
                window.location.href = 'auth.html';
            }
        });

        // Load user profile data
        async function loadUserProfile(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                    document.getElementById('user-name').textContent = fullName || user.email;
                } else {
                    // Fallback to email if no user doc exists
                    document.getElementById('user-name').textContent = user.email;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to email on error
                document.getElementById('user-name').textContent = user.email;
            }
        }

        // User dropdown functionality
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');

        userProfileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            userDropdown.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            }
        });

        // Mobile navigation
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const mobileNavBackdrop = document.getElementById('mobile-nav-backdrop');

        mobileMenuBtn.addEventListener('click', () => {
            mobileNavOverlay.classList.remove('hidden');
        });

        mobileNavBackdrop.addEventListener('click', () => {
            mobileNavOverlay.classList.add('hidden');
        });

        // Close mobile nav on navigation
        document.querySelectorAll('#mobile-nav-overlay .nav-item').forEach(link => {
            link.addEventListener('click', () => {
                mobileNavOverlay.classList.add('hidden');
            });
        });

        // Active navigation state
        function updateActiveNavState() {
            const currentPath = window.location.pathname;
            const pageName = currentPath.replace('/', '').replace('.html', '');
            
            // Remove active state from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-accent', 'text-white');
                item.classList.add('text-neutral-700');
            });

            // Add active state to current page
            document.querySelectorAll(`[data-page="${pageName}"]`).forEach(item => {
                item.classList.add('bg-accent', 'text-white');
                item.classList.remove('text-neutral-700');
            });
        }

        // Update active state on load
        updateActiveNavState();

        // Update active state on navigation (for SPA behavior)
        window.addEventListener('popstate', updateActiveNavState);
    </script>

    
<script id="analytics-hub-script" type="module" data-tiramai="web-gen">
// Firebase imports
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import {
  collection, getDocs, query, where, orderBy, limit, startAfter, getCountFromServer, Timestamp
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader } from "./scripts/main.js";

// Initialize Firebase
const db = getDb();

// Global state
let globalFilters = {
  cycleId: null,
  departmentId: null,
  role: '',
  categoryId: null,
  criticalityId: null,
  dateRange: 30
};

let currentData = {
  skills: new Map(),
  employees: new Map(),
  departments: new Map(),
  cycles: new Map(),
  categories: new Map(),
  criticalities: new Map(),
  assessments: [],
  trainingSessions: [],
  disputes: [],
  trainers: new Map(),
  trainerEligibilities: []
};

let currentPage = 1;
let pageSize = 25;
let tniData = [];
let filteredTniData = [];
let sortField = 'employeeCount';
let sortDirection = 'desc';

// Concurrency control
function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}
const withLimit = createSemaphore(2);

// Utility functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function formatDate(isoString) {
  if (!isoString) return 'N/A';
  try {
    return new Date(isoString).toLocaleDateString('en-IN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch (error) {
    console.warn('Error formatting date:', isoString, error);
    return 'N/A';
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Auth check
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname);
  } else {
    funInitializeAnalytics();
  }
});

// Main initialization function
async function funInitializeAnalytics() {
  try {
    // Check URL parameters for preselection
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('cycleId')) globalFilters.cycleId = urlParams.get('cycleId');
    if (urlParams.get('departmentId')) globalFilters.departmentId = urlParams.get('departmentId');
    
    await funLoadInitialData();
    funSetupEventListeners();
    funApplyUrlParameters();
  } catch (error) {
    console.error('Error initializing analytics:', error);
    showToast('Failed to load analytics data', 'error');
  }
}

// Load initial data with concurrency control
async function funLoadInitialData() {
  showLoader();
  
  try {
    // Load core reference data first (parallel)
    const corePromises = [
      withLimit(() => funLoadSkills()),
      withLimit(() => funLoadDepartments()),
      withLimit(() => funLoadEmployees()),
      withLimit(() => funLoadSkillCategories()),
      withLimit(() => funLoadSkillCriticalities()),
      withLimit(() => funLoadAssessmentCycles())
    ];
    
    await Promise.all(corePromises);
    
    // Small gap to prevent overwhelming Firestore
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Load transactional data (sequential with gaps)
    await withLimit(() => funLoadAssessments());
    await new Promise(resolve => setTimeout(resolve, 50));
    await withLimit(() => funLoadTrainingSessions());
    await new Promise(resolve => setTimeout(resolve, 50));
    await withLimit(() => funLoadDisputes());
    await new Promise(resolve => setTimeout(resolve, 50));
    await withLimit(() => funLoadTrainers());
    
    funPopulateFilters();
    await funRefreshAllData();
    
  } catch (error) {
    console.error('Error loading initial data:', error);
    showToast('Failed to load initial data', 'error');
  } finally {
    hideLoader();
  }
}

// Data loading functions with proper error handling
async function funLoadSkills() {
  try {
    const q = query(
      collection(db, 'skills'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.skills.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading skills:', error);
    throw error;
  }
}

async function funLoadDepartments() {
  try {
    const q = query(
      collection(db, 'departments'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.departments.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading departments:', error);
    throw error;
  }
}

async function funLoadEmployees() {
  try {
    const q = query(
      collection(db, 'employees'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.employees.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading employees:', error);
    throw error;
  }
}

async function funLoadSkillCategories() {
  try {
    const q = query(
      collection(db, 'skillCategories'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.categories.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading skill categories:', error);
    throw error;
  }
}

async function funLoadSkillCriticalities() {
  try {
    const q = query(
      collection(db, 'skillCriticalities'),
      where('status', '==', 'active'),
      orderBy('weight', 'desc')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.criticalities.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading skill criticalities:', error);
    throw error;
  }
}

async function funLoadAssessmentCycles() {
  try {
    const q = query(
      collection(db, 'assessmentCycles'),
      where('status', '==', 'active'),
      orderBy('startDate', 'desc')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.cycles.set(doc.id, { id: doc.id, ...doc.data() });
    });
  } catch (error) {
    console.error('Error loading assessment cycles:', error);
    throw error;
  }
}

async function funLoadAssessments() {
  try {
    let q = collection(db, 'assessments');
    
    // Apply filters if available
    const constraints = [where('status', '==', 'submitted')];
    
    if (globalFilters.cycleId) {
      constraints.push(where('cycleId', '==', globalFilters.cycleId));
    }
    
    // Apply date range if needed
    if (globalFilters.dateRange) {
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - globalFilters.dateRange);
      constraints.push(where('submittedAt', '>=', cutoffDate.toISOString()));
    }
    
    q = query(q, ...constraints, orderBy('submittedAt', 'desc'), limit(1000));
    
    const snapshot = await getDocs(q);
    currentData.assessments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading assessments:', error);
    throw error;
  }
}

async function funLoadTrainingSessions() {
  try {
    let q = collection(db, 'trainingSessions');
    
    const constraints = [where('status', 'in', ['scheduled', 'completed'])];
    
    // Apply date range filter
    if (globalFilters.dateRange) {
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - globalFilters.dateRange);
      constraints.push(where('startDateTime', '>=', cutoffDate.toISOString()));
    }
    
    q = query(q, ...constraints, orderBy('startDateTime', 'desc'), limit(500));
    
    const snapshot = await getDocs(q);
    currentData.trainingSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading training sessions:', error);
    throw error;
  }
}

async function funLoadDisputes() {
  try {
    const q = query(
      collection(db, 'disputes'),
      orderBy('createdAt', 'desc'),
      limit(100)
    );
    const snapshot = await getDocs(q);
    currentData.disputes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading disputes:', error);
    throw error;
  }
}

async function funLoadTrainers() {
  try {
    const q = query(
      collection(db, 'trainers'),
      where('status', '==', 'active'),
      orderBy('name')
    );
    const snapshot = await getDocs(q);
    snapshot.docs.forEach(doc => {
      currentData.trainers.set(doc.id, { id: doc.id, ...doc.data() });
    });
    
    // Load trainer eligibilities
    const eligQ = query(collection(db, 'trainerEligibilities'));
    const eligSnapshot = await getDocs(eligQ);
    currentData.trainerEligibilities = eligSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error loading trainers:', error);
    throw error;
  }
}

// Populate filter dropdowns
function funPopulateFilters() {
  // Cycles
  const cycleSelect = document.getElementById('cycle-filter');
  if (cycleSelect) {
    cycleSelect.innerHTML = '<option value="">All Cycles</option>';
    for (const [id, cycle] of currentData.cycles) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = cycle.name || 'N/A';
      cycleSelect.appendChild(option);
    }
  }
  
  // Departments
  const deptSelect = document.getElementById('department-filter');
  if (deptSelect) {
    deptSelect.innerHTML = '<option value="">All Departments</option>';
    for (const [id, dept] of currentData.departments) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = dept.name || 'N/A';
      deptSelect.appendChild(option);
    }
  }
  
  // Categories
  const catSelect = document.getElementById('category-filter');
  if (catSelect) {
    catSelect.innerHTML = '<option value="">All Categories</option>';
    for (const [id, cat] of currentData.categories) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = cat.name || 'N/A';
      catSelect.appendChild(option);
    }
  }
  
  // Criticalities
  const critSelect = document.getElementById('criticality-filter');
  if (critSelect) {
    critSelect.innerHTML = '<option value="">All Levels</option>';
    for (const [id, crit] of currentData.criticalities) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = crit.name || 'N/A';
      critSelect.appendChild(option);
    }
  }
}

// Apply URL parameters
function funApplyUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  
  if (urlParams.get('cycleId')) {
    const cycleSelect = document.getElementById('cycle-filter');
    if (cycleSelect) cycleSelect.value = urlParams.get('cycleId');
    globalFilters.cycleId = urlParams.get('cycleId');
  }
  
  if (urlParams.get('departmentId')) {
    const deptSelect = document.getElementById('department-filter');
    if (deptSelect) deptSelect.value = urlParams.get('departmentId');
    globalFilters.departmentId = urlParams.get('departmentId');
  }
}

// Setup event listeners
function funSetupEventListeners() {
  // Filter change handlers
  const filterElements = [
    'cycle-filter', 'department-filter', 'category-filter', 
    'criticality-filter', 'date-range-filter'
  ];
  
  filterElements.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('change', funHandleFilterChange);
    }
  });
  
  // Role filter with debounce
  const roleFilter = document.getElementById('role-filter');
  if (roleFilter) {
    roleFilter.addEventListener('input', debounce(funHandleFilterChange, 300));
  }
  
  // Refresh buttons
  document.getElementById('refresh-all-btn')?.addEventListener('click', () => funRefreshAllData(true));
  document.getElementById('refresh-heatmap-btn')?.addEventListener('click', () => funRefreshHeatmap(true));
  document.getElementById('refresh-chart-btn')?.addEventListener('click', () => funRefreshChart(true));
  document.getElementById('refresh-tni-btn')?.addEventListener('click', () => funRefreshTNIData(true));
  document.getElementById('refresh-trainers-btn')?.addEventListener('click', () => funRefreshTrainersData(true));
  
  // Heatmap view toggle
  const heatmapToggle = document.getElementById('heatmap-view-toggle');
  if (heatmapToggle) {
    heatmapToggle.addEventListener('change', funRefreshHeatmap);
  }
  
  // Chart toggle
  const chartToggle = document.getElementById('toggle-chart-view');
  if (chartToggle) {
    chartToggle.addEventListener('click', funToggleChartView);
  }
  
  // TNI table interactions
  document.getElementById('tni-search')?.addEventListener('input', debounce(funFilterTNIData, 300));
  document.getElementById('tni-page-size')?.addEventListener('change', funHandleTNIPageSizeChange);
  document.getElementById('tni-prev-btn')?.addEventListener('click', () => funChangeTNIPage(-1));
  document.getElementById('tni-next-btn')?.addEventListener('click', () => funChangeTNIPage(1));
  
  // TNI table sorting
  document.querySelectorAll('#tni-table [data-sort]').forEach(header => {
    header.addEventListener('click', () => funSortTNIData(header.dataset.sort));
  });
  
  // Disputes KPI click
  document.getElementById('disputes-kpi')?.addEventListener('click', funNavigateToDisputes);
  
  // Modal handlers
  funSetupModalEventListeners();
}

// Modal event listeners
function funSetupModalEventListeners() {
  const modal = document.getElementById('employees-modal');
  const backdrop = document.getElementById('employees-modal-backdrop');
  const closeBtn = document.getElementById('close-employees-modal');
  const cancelBtn = document.getElementById('cancel-selection');
  const createBtn = document.getElementById('create-training-session');
  
  [backdrop, closeBtn, cancelBtn].forEach(el => {
    el?.addEventListener('click', funCloseEmployeesModal);
  });
  
  createBtn?.addEventListener('click', funCreateTrainingSession);
  
  // Employee search
  document.getElementById('employees-search')?.addEventListener('input', 
    debounce(funFilterEmployeesModal, 300));
  
  // Select all checkbox
  document.getElementById('select-all-employees')?.addEventListener('change', funToggleSelectAllEmployees);
}

// Filter change handler
function funHandleFilterChange() {
  // Update global filters
  globalFilters.cycleId = document.getElementById('cycle-filter')?.value || null;
  globalFilters.departmentId = document.getElementById('department-filter')?.value || null;
  globalFilters.categoryId = document.getElementById('category-filter')?.value || null;
  globalFilters.criticalityId = document.getElementById('criticality-filter')?.value || null;
  globalFilters.role = document.getElementById('role-filter')?.value || '';
  globalFilters.dateRange = parseInt(document.getElementById('date-range-filter')?.value || '30');
  
  // Re-fetch filtered data and refresh displays
  funLoadAssessments().then(() => {
    funRefreshAllData();
  });
}

// Refresh all data
async function funRefreshAllData(showLoadingToast = false) {
  if (showLoadingToast) showToast('Refreshing data...', 'info');
  
  try {
    await Promise.all([
      funUpdateKPIs(),
      funRefreshHeatmap(),
      funRefreshChart(),
      funRefreshTNIData(),
      funRefreshTrainersData()
    ]);
    
    // Update last updated timestamp
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('en-IN');
    
    if (showLoadingToast) showToast('Data refreshed successfully', 'success');
  } catch (error) {
    console.error('Error refreshing data:', error);
    showToast('Error refreshing some data', 'error');
  }
}

// Update KPI tiles
async function funUpdateKPIs() {
  try {
    await yieldToFrame(); // Prevent blocking
    
    // Filter assessments based on current filters
    let filteredAssessments = currentData.assessments;
    
    if (globalFilters.departmentId) {
      filteredAssessments = filteredAssessments.filter(assessment => {
        const employee = currentData.employees.get(assessment.employeeId);
        return employee?.departmentId === globalFilters.departmentId;
      });
    }
    
    if (globalFilters.role) {
      const roleFilter = globalFilters.role.toLowerCase();
      filteredAssessments = filteredAssessments.filter(assessment => {
        const employee = currentData.employees.get(assessment.employeeId);
        return employee?.jobTitle?.toLowerCase().includes(roleFilter);
      });
    }
    
    // Calculate below benchmark percentage
    let belowBenchmarkCount = 0;
    let totalAssessedEmployees = new Set();
    
    filteredAssessments.forEach(assessment => {
      totalAssessedEmployees.add(assessment.employeeId);
      
      if (assessment.items?.some(item => item.tni === true)) {
        belowBenchmarkCount++;
      }
    });
    
    const belowBenchmarkPercent = totalAssessedEmployees.size > 0 ? 
      Math.round((belowBenchmarkCount / totalAssessedEmployees.size) * 100) : 0;
    
    document.getElementById('below-benchmark-count').textContent = belowBenchmarkCount;
    document.getElementById('below-benchmark-percent').textContent = 
      `${belowBenchmarkPercent}% of ${totalAssessedEmployees.size} assessed`;
    
    // Calculate critical gaps (high criticality skills with TNI)
    let criticalGapsCount = 0;
    const criticalSkills = new Set();
    
    for (const [skillId, skill] of currentData.skills) {
      const criticality = currentData.criticalities.get(skill.criticalityId);
      if (criticality?.weight >= 0.8) { // Assuming weight >= 0.8 is high criticality
        criticalSkills.add(skillId);
      }
    }
    
    filteredAssessments.forEach(assessment => {
      assessment.items?.forEach(item => {
        if (item.tni === true && criticalSkills.has(item.skillId)) {
          criticalGapsCount++;
        }
      });
    });
    
    document.getElementById('critical-gaps-count').textContent = criticalGapsCount;
    
    // Calculate training coverage vs demand
    const demandCount = filteredAssessments.reduce((count, assessment) => {
      return count + (assessment.items?.filter(item => item.tni === true).length || 0);
    }, 0);
    
    const scheduledTrainingSessions = currentData.trainingSessions.filter(session => 
      session.status === 'scheduled'
    );
    
    const coverageCount = scheduledTrainingSessions.reduce((count, session) => {
      return count + (session.attendees?.length || 0);
    }, 0);
    
    const coveragePercent = demandCount > 0 ? Math.round((coverageCount / demandCount) * 100) : 0;
    
    document.getElementById('training-coverage-percent').textContent = `${coveragePercent}%`;
    
    // Calculate disputes metrics
    const openDisputes = currentData.disputes.filter(dispute => dispute.status === 'open');
    document.getElementById('open-disputes-count').textContent = openDisputes.length;
    
    // Calculate average resolution time for resolved disputes
    const resolvedDisputes = currentData.disputes.filter(dispute => dispute.status === 'resolved');
    let avgResolutionDays = 0;
    
    if (resolvedDisputes.length > 0) {
      const totalDays = resolvedDisputes.reduce((total, dispute) => {
        const created = new Date(dispute.createdAt);
        const resolved = dispute.history?.find(h => h.status === 'resolved');
        if (resolved) {
          const resolvedDate = new Date(resolved.timestamp);
          return total + Math.ceil((resolvedDate - created) / (1000 * 60 * 60 * 24));
        }
        return total;
      }, 0);
      
      avgResolutionDays = Math.round(totalDays / resolvedDisputes.length);
    }
    
    document.getElementById('avg-resolution-time').textContent = 
      avgResolutionDays > 0 ? `${avgResolutionDays} days avg` : 'No data';
    
  } catch (error) {
    console.error('Error updating KPIs:', error);
    showToast('Error updating KPI metrics', 'error');
  }
}

// Refresh heatmap
async function funRefreshHeatmap(showSkeleton = false) {
  const skeleton = document.getElementById('heatmap-skeleton');
  const chart = document.getElementById('heatmap-chart');
  const container = document.getElementById('heatmap-container');
  
  if (showSkeleton) {
    skeleton?.classList.remove('hidden');
    chart?.classList.add('hidden');
  }
  
  try {
    await yieldToFrame();
    
    const viewBy = document.getElementById('heatmap-view-toggle')?.value || 'departments';
    
    // Process data for heatmap
    const heatmapData = await funProcessHeatmapData(viewBy);
    
    await yieldToFrame();
    
    // Render heatmap
    if (chart && heatmapData.length > 0) {
      funRenderHeatmapTable(heatmapData, viewBy);
      chart.classList.remove('hidden');
    } else if (chart) {
      chart.innerHTML = '<div class="text-center text-secondary py-8">No data available for heatmap</div>';
      chart.classList.remove('hidden');
    }
    
  } catch (error) {
    console.error('Error refreshing heatmap:', error);
    showToast('Error refreshing heatmap', 'error');
  } finally {
    skeleton?.classList.add('hidden');
  }
}

// Process heatmap data
async function funProcessHeatmapData(viewBy) {
  try {
    const matrix = new Map();
    
    // Filter assessments based on current filters
    let filteredAssessments = currentData.assessments;
    
    if (globalFilters.departmentId && viewBy === 'departments') {
      filteredAssessments = filteredAssessments.filter(assessment => {
        const employee = currentData.employees.get(assessment.employeeId);
        return employee?.departmentId === globalFilters.departmentId;
      });
    }
    
    // Build matrix
    filteredAssessments.forEach(assessment => {
      const employee = currentData.employees.get(assessment.employeeId);
      if (!employee) return;
      
      const groupKey = viewBy === 'departments' ? 
        currentData.departments.get(employee.departmentId)?.name || 'Unknown' :
        employee.jobTitle || 'Unknown';
      
      assessment.items?.forEach(item => {
        const skill = currentData.skills.get(item.skillId);
        if (!skill) return;
        
        const key = `${skill.name}|${groupKey}`;
        
        if (!matrix.has(key)) {
          matrix.set(key, {
            skillName: skill.name,
            skillId: skill.id,
            groupName: groupKey,
            totalEmployees: 0,
            tniEmployees: 0,
            totalWeightedGap: 0,
            employees: []
          });
        }
        
        const cell = matrix.get(key);
        cell.totalEmployees++;
        cell.totalWeightedGap += item.weightedGap || 0;
        
        if (item.tni === true) {
          cell.tniEmployees++;
        }
        
        // Store employee data for drill-through
        cell.employees.push({
          employeeId: assessment.employeeId,
          employeeCode: employee.employeeCode,
          name: employee.name,
          jobTitle: employee.jobTitle,
          department: currentData.departments.get(employee.departmentId)?.name || 'Unknown',
          teamLead: currentData.employees.get(employee.teamLeadId)?.name || 'N/A',
          gap: item.gap || 0,
          weightedGap: item.weightedGap || 0,
          tni: item.tni || false
        });
      });
    });
    
    // Convert to array and calculate percentages
    return Array.from(matrix.values()).map(cell => ({
      ...cell,
      tniPercentage: cell.totalEmployees > 0 ? (cell.tniEmployees / cell.totalEmployees) * 100 : 0,
      avgWeightedGap: cell.totalEmployees > 0 ? cell.totalWeightedGap / cell.totalEmployees : 0
    }));
    
  } catch (error) {
    console.error('Error processing heatmap data:', error);
    return [];
  }
}

// Render heatmap as table
function funRenderHeatmapTable(data, viewBy) {
  const chart = document.getElementById('heatmap-chart');
  if (!chart) return;
  
  // Group data by skills
  const skillGroups = new Map();
  data.forEach(cell => {
    if (!skillGroups.has(cell.skillName)) {
      skillGroups.set(cell.skillName, []);
    }
    skillGroups.get(cell.skillName).push(cell);
  });
  
  // Get unique groups for header
  const uniqueGroups = [...new Set(data.map(cell => cell.groupName))].sort();
  
  let html = `
    <table class="w-full text-xs border border-neutral-200">
      <thead class="bg-neutral-50">
        <tr>
          <th class="text-left p-2 border-b border-neutral-200 font-medium">Skill</th>
          ${uniqueGroups.map(group => 
            `<th class="text-center p-2 border-b border-neutral-200 font-medium">${group}</th>`
          ).join('')}
        </tr>
      </thead>
      <tbody>
  `;
  
  for (const [skillName, cells] of skillGroups) {
    html += `<tr class="border-b border-neutral-200">`;
    html += `<td class="p-2 font-medium text-neutral-700">${skillName}</td>`;
    
    uniqueGroups.forEach(group => {
      const cell = cells.find(c => c.groupName === group);
      if (cell) {
        const intensity = Math.min(100, cell.tniPercentage);
        const bgColor = intensity > 70 ? 'bg-error/20' : 
                       intensity > 40 ? 'bg-warning/20' : 
                       intensity > 20 ? 'bg-info/20' : 'bg-success/20';
        
        html += `
          <td class="p-2 text-center cursor-pointer hover:bg-neutral-100 ${bgColor}" 
              data-skill-id="${cell.skillId}" 
              data-skill-name="${cell.skillName}"
              data-group-name="${cell.groupName}"
              onclick="funOpenEmployeesModal('${cell.skillId}', '${cell.skillName}', ${JSON.stringify(cell.employees).replace(/"/g, '&quot;')})">
            <div class="text-sm font-medium">${cell.tniEmployees}/${cell.totalEmployees}</div>
            <div class="text-xs text-secondary">${intensity.toFixed(1)}%</div>
          </td>
        `;
      } else {
        html += `<td class="p-2 text-center text-neutral-400">-</td>`;
      }
    });
    
    html += `</tr>`;
  }
  
  html += `</tbody></table>`;
  
  chart.innerHTML = html;
}

// Open employees modal
window.funOpenEmployeesModal = function(skillId, skillName, employees) {
  const modal = document.getElementById('employees-modal');
  const skillNameEl = document.getElementById('modal-skill-name');
  const skillCategoryEl = document.getElementById('modal-skill-category');
  const tbody = document.getElementById('employees-table-body');
  
  if (!modal || !skillNameEl || !skillCategoryEl || !tbody) return;
  
  // Set skill info
  const skill = currentData.skills.get(skillId);
  const category = skill ? currentData.categories.get(skill.categoryId) : null;
  
  skillNameEl.textContent = skillName;
  skillCategoryEl.textContent = category?.name || 'Unknown Category';
  
  // Store employee data for modal operations
  modal.employeeData = employees || [];
  modal.skillId = skillId;
  
  // Populate employee table
  funRenderEmployeesTable(modal.employeeData);
  
  // Show modal
  modal.classList.remove('hidden');
  
  // Focus trap
  const firstFocusable = modal.querySelector('input, button');
  firstFocusable?.focus();
};

// Render employees table in modal
function funRenderEmployeesTable(employees) {
  const tbody = document.getElementById('employees-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  employees.forEach((employee, index) => {
    const row = document.createElement('tr');
    row.className = 'border-b border-neutral-200 hover:bg-neutral-50';
    
    const statusColor = employee.tni ? 'text-error' : 'text-success';
    const statusText = employee.tni ? 'Red' : 'Green';
    
    row.innerHTML = `
      <td class="px-4 py-3">
        <input type="checkbox" class="employee-checkbox rounded border-neutral-200 focus:ring-accent" 
               data-employee-id="${employee.employeeId}" data-index="${index}">
      </td>
      <td class="px-4 py-3 text-neutral-700">${employee.employeeCode || 'N/A'}</td>
      <td class="px-4 py-3 text-neutral-700 font-medium">${employee.name || 'N/A'}</td>
      <td class="px-4 py-3 text-neutral-700">${employee.jobTitle || 'N/A'}</td>
      <td class="px-4 py-3 text-neutral-700">${employee.department || 'N/A'}</td>
      <td class="px-4 py-3 text-neutral-700">${employee.teamLead || 'N/A'}</td>
      <td class="px-4 py-3">
        <span class="text-sm ${statusColor} font-medium">${statusText}</span>
      </td>
      <td class="px-4 py-3 text-neutral-700">${(employee.weightedGap || 0).toFixed(2)}</td>
    `;
    
    tbody.appendChild(row);
    
    // Add event listener to checkbox
    const checkbox = row.querySelector('.employee-checkbox');
    checkbox?.addEventListener('change', funUpdateSelectedCount);
  });
  
  funUpdateSelectedCount();
}

// Update selected count and button state
function funUpdateSelectedCount() {
  const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
  const count = checkboxes.length;
  
  document.getElementById('selected-count').textContent = count;
  
  const createBtn = document.getElementById('create-training-session');
  if (createBtn) {
    createBtn.disabled = count === 0;
    createBtn.className = count === 0 ? 
      'px-4 py-2 text-sm bg-neutral-200 text-neutral-400 rounded cursor-not-allowed' :
      'px-4 py-2 text-sm bg-accent text-white rounded hover:bg-[#1d4ed8] transition-colors duration-150';
  }
}

// Toggle select all employees
function funToggleSelectAllEmployees() {
  const selectAll = document.getElementById('select-all-employees');
  const checkboxes = document.querySelectorAll('.employee-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll?.checked || false;
  });
  
  funUpdateSelectedCount();
}

// Filter employees in modal
function funFilterEmployeesModal() {
  const modal = document.getElementById('employees-modal');
  const searchTerm = document.getElementById('employees-search')?.value?.toLowerCase() || '';
  
  if (!modal?.employeeData) return;
  
  const filteredEmployees = modal.employeeData.filter(employee => {
    return (employee.name?.toLowerCase().includes(searchTerm)) ||
           (employee.employeeCode?.toLowerCase().includes(searchTerm)) ||
           (employee.jobTitle?.toLowerCase().includes(searchTerm)) ||
           (employee.department?.toLowerCase().includes(searchTerm));
  });
  
  funRenderEmployeesTable(filteredEmployees);
}

// Close employees modal
function funCloseEmployeesModal() {
  const modal = document.getElementById('employees-modal');
  modal?.classList.add('hidden');
  
  // Reset form
  document.getElementById('employees-search').value = '';
  document.getElementById('select-all-employees').checked = false;
  funUpdateSelectedCount();
}

// Create training session
function funCreateTrainingSession() {
  const modal = document.getElementById('employees-modal');
  const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
  
  if (!modal?.skillId || selectedCheckboxes.length === 0) {
    showToast('Please select at least one employee', 'warning');
    return;
  }
  
  const selectedEmployeeIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.employeeId);
  
  // Navigate to training management with preselected data
  const params = new URLSearchParams({
    tab: 'sessions',
    'preselect.skillId': modal.skillId,
    'preselect.employeeIds': selectedEmployeeIds.join(','),
    returnTo: 'analytics_hub'
  });
  
  window.location.href = `/training_management.html?${params}`;
}

// Refresh chart
async function funRefreshChart(showSkeleton = false) {
  const skeleton = document.getElementById('demand-chart-skeleton');
  const chart = document.getElementById('demand-chart');
  
  if (showSkeleton) {
    skeleton?.classList.remove('hidden');
    chart?.classList.add('hidden');
  }
  
  try {
    await yieldToFrame();
    
    // Process chart data
    const chartData = await funProcessChartData();
    
    await yieldToFrame();
    
    // Render chart
    if (chart && chartData.length > 0) {
      await funRenderDemandChart(chartData);
      chart.classList.remove('hidden');
    } else if (chart) {
      chart.innerHTML = '<div class="text-center text-secondary py-8">No data available for chart</div>';
      chart.classList.remove('hidden');
    }
    
  } catch (error) {
    console.error('Error refreshing chart:', error);
    showToast('Error refreshing chart', 'error');
  } finally {
    skeleton?.classList.add('hidden');
  }
}

// Process chart data
async function funProcessChartData() {
  try {
    const skillDemand = new Map();
    
    // Calculate demand from assessments
    currentData.assessments.forEach(assessment => {
      assessment.items?.forEach(item => {
        if (item.tni === true) {
          const skillName = currentData.skills.get(item.skillId)?.name || 'Unknown';
          
          if (!skillDemand.has(skillName)) {
            skillDemand.set(skillName, {
              skillName,
              demand: 0,
              coverage: 0,
              demandWeighted: 0
            });
          }
          
          const data = skillDemand.get(skillName);
          data.demand++;
          data.demandWeighted += item.weightedGap || 0;
        }
      });
    });
    
    // Calculate coverage from training sessions
    currentData.trainingSessions.forEach(session => {
      if (session.status === 'scheduled') {
        const skillName = currentData.skills.get(session.skillId)?.name || 'Unknown';
        
        if (skillDemand.has(skillName)) {
          skillDemand.get(skillName).coverage += session.attendees?.length || 0;
        } else {
          skillDemand.set(skillName, {
            skillName,
            demand: 0,
            coverage: session.attendees?.length || 0,
            demandWeighted: 0
          });
        }
      }
    });
    
    return Array.from(skillDemand.values())
      .filter(item => item.demand > 0 || item.coverage > 0)
      .sort((a, b) => b.demandWeighted - a.demandWeighted)
      .slice(0, 10); // Top 10 skills
    
  } catch (error) {
    console.error('Error processing chart data:', error);
    return [];
  }
}

// Render demand chart using ECharts
async function funRenderDemandChart(data) {
  const chartEl = document.getElementById('demand-chart');
  if (!chartEl || typeof echarts === 'undefined') return;
  
  await yieldToFrame();
  
  try {
    const chart = echarts.init(chartEl);
    
    const option = {
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: function(params) {
          let result = `<strong>${params[0].axisValue}</strong><br/>`;
          params.forEach(param => {
            result += `${param.marker} ${param.seriesName}: ${param.value}<br/>`;
          });
          return result;
        }
      },
      legend: {
        data: ['Training Demand (Weighted Gap)', 'Scheduled Coverage'],
        bottom: 0
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '15%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: data.map(item => item.skillName),
        axisLabel: {
          rotate: 45,
          fontSize: 10
        }
      },
      yAxis: [
        {
          type: 'value',
          name: 'Weighted Gap',
          position: 'left',
          axisLabel: {
            formatter: '{value}'
          }
        },
        {
          type: 'value',
          name: 'Coverage Count',
          position: 'right',
          axisLabel: {
            formatter: '{value}'
          }
        }
      ],
      series: [
        {
          name: 'Training Demand (Weighted Gap)',
          type: 'bar',
          yAxisIndex: 0,
          data: data.map(item => item.demandWeighted.toFixed(2)),
          itemStyle: {
            color: '#D97706' // Warning color
          }
        },
        {
          name: 'Scheduled Coverage',
          type: 'line',
          yAxisIndex: 1,
          data: data.map(item => item.coverage),
          itemStyle: {
            color: '#2563eb' // Accent color
          },
          lineStyle: {
            width: 3
          }
        }
      ]
    };
    
    chart.setOption(option);
    
    // Handle resize
    window.addEventListener('resize', () => chart.resize());
    
  } catch (error) {
    console.error('Error rendering chart:', error);
    chartEl.innerHTML = '<div class="text-center text-error py-8">Error rendering chart</div>';
  }
}

// Toggle chart view
function funToggleChartView() {
  // This could toggle between different chart configurations
  // For now, we'll just refresh the chart
  funRefreshChart();
}

// Refresh TNI data
async function funRefreshTNIData(showSkeleton = false) {
  const skeleton = document.getElementById('tni-table-skeleton');
  const table = document.getElementById('tni-table');
  const pagination = document.getElementById('tni-pagination');
  
  if (showSkeleton) {
    skeleton?.classList.remove('hidden');
    table?.classList.add('hidden');
    pagination?.classList.add('hidden');
  }
  
  try {
    await yieldToFrame();
    
    // Process TNI data
    tniData = await funProcessTNIData();
    funFilterTNIData(); // This will also update pagination
    
    table?.classList.remove('hidden');
    pagination?.classList.remove('hidden');
    
  } catch (error) {
    console.error('Error refreshing TNI data:', error);
    showToast('Error refreshing TNI data', 'error');
  } finally {
    skeleton?.classList.add('hidden');
  }
}

// Process TNI data
async function funProcessTNIData() {
  try {
    const skillStats = new Map();
    
    // Filter assessments and aggregate by skill
    let filteredAssessments = currentData.assessments;
    
    if (globalFilters.departmentId) {
      filteredAssessments = filteredAssessments.filter(assessment => {
        const employee = currentData.employees.get(assessment.employeeId);
        return employee?.departmentId === globalFilters.departmentId;
      });
    }
    
    filteredAssessments.forEach(assessment => {
      assessment.items?.forEach(item => {
        if (item.tni === true) {
          const skill = currentData.skills.get(item.skillId);
          if (!skill) return;
          
          // Apply category and criticality filters
          if (globalFilters.categoryId && skill.categoryId !== globalFilters.categoryId) return;
          if (globalFilters.criticalityId && skill.criticalityId !== globalFilters.criticalityId) return;
          
          const skillKey = item.skillId;
          
          if (!skillStats.has(skillKey)) {
            skillStats.set(skillKey, {
              skillId: item.skillId,
              skillName: skill.name || 'Unknown',
              categoryName: currentData.categories.get(skill.categoryId)?.name || 'Unknown',
              criticalityName: currentData.criticalities.get(skill.criticalityId)?.name || 'Unknown',
              employeeCount: 0,
              totalWeightedGap: 0,
              employees: []
            });
          }
          
          const stats = skillStats.get(skillKey);
          stats.employeeCount++;
          stats.totalWeightedGap += item.weightedGap || 0;
          
          const employee = currentData.employees.get(assessment.employeeId);
          if (employee) {
            stats.employees.push({
              employeeId: assessment.employeeId,
              employeeCode: employee.employeeCode,
              name: employee.name,
              jobTitle: employee.jobTitle,
              department: currentData.departments.get(employee.departmentId)?.name || 'Unknown',
              teamLead: currentData.employees.get(employee.teamLeadId)?.name || 'N/A',
              gap: item.gap || 0,
              weightedGap: item.weightedGap || 0
            });
          }
        }
      });
    });
    
    // Calculate averages and return array
    return Array.from(skillStats.values()).map(stats => ({
      ...stats,
      avgWeightedGap: stats.employeeCount > 0 ? stats.totalWeightedGap / stats.employeeCount : 0
    }));
    
  } catch (error) {
    console.error('Error processing TNI data:', error);
    return [];
  }
}

// Filter TNI data based on search
function funFilterTNIData() {
  const searchTerm = document.getElementById('tni-search')?.value?.toLowerCase() || '';
  
  filteredTniData = tniData.filter(item => {
    return item.skillName?.toLowerCase().includes(searchTerm) ||
           item.categoryName?.toLowerCase().includes(searchTerm) ||
           item.criticalityName?.toLowerCase().includes(searchTerm);
  });
  
  // Sort data
  funSortTNIDataInternal();
  
  // Reset to first page
  currentPage = 1;
  funUpdateTNITable();
  funUpdateTNIPagination();
}

// Sort TNI data
function funSortTNIData(field) {
  if (sortField === field) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDirection = 'desc';
  }
  
  funSortTNIDataInternal();
  funUpdateTNITable();
  
  // Update sort indicators
  document.querySelectorAll('#tni-table [data-sort]').forEach(header => {
    const icon = header.querySelector('i');
    if (header.dataset.sort === field) {
      icon.setAttribute('data-lucide', sortDirection === 'asc' ? 'arrow-up' : 'arrow-down');
    } else {
      icon.setAttribute('data-lucide', 'arrow-up-down');
    }
  });
  
  // Re-initialize icons
  lucide.createIcons();
}

// Internal sort function
function funSortTNIDataInternal() {
  filteredTniData.sort((a, b) => {
    let aVal = a[sortField];
    let bVal = b[sortField];
    
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });
}

// Update TNI table
function funUpdateTNITable() {
  const tbody = document.getElementById('tni-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const pageData = filteredTniData.slice(startIndex, endIndex);
  
  pageData.forEach(item => {
    const row = document.createElement('tr');
    row.className = 'border-b border-neutral-200 hover:bg-neutral-50';
    
    row.innerHTML = `
      <td class="px-4 py-3">
        <div class="font-medium text-neutral-700">${item.skillName}</div>
        <div class="text-xs text-secondary">${item.categoryName}</div>
      </td>
      <td class="px-4 py-3 text-center">
        <span class="font-medium text-neutral-700">${item.employeeCount}</span>
        <div class="text-xs text-secondary">${item.criticalityName}</div>
      </td>
      <td class="px-4 py-3 text-center font-medium text-neutral-700">
        ${item.avgWeightedGap.toFixed(2)}
      </td>
      <td class="px-4 py-3">
        <div class="flex gap-2">
          <button class="text-xs px-2 py-1 bg-accent text-white rounded hover:bg-[#1d4ed8] transition-colors duration-150"
                  onclick="funOpenEmployeesModal('${item.skillId}', '${item.skillName}', ${JSON.stringify(item.employees).replace(/"/g, '&quot;')})">
            View Employees
          </button>
          <button class="text-xs px-2 py-1 border border-neutral-200 text-neutral-700 rounded hover:bg-neutral-50 transition-colors duration-150"
                  onclick="funCreateTrainingForSkill('${item.skillId}', ${JSON.stringify(item.employees.map(e => e.employeeId)).replace(/"/g, '&quot;')})">
            Create Training
          </button>
        </div>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

// Create training for skill
window.funCreateTrainingForSkill = function(skillId, employeeIds) {
  const params = new URLSearchParams({
    tab: 'sessions',
    'preselect.skillId': skillId,
    'preselect.employeeIds': Array.isArray(employeeIds) ? employeeIds.join(',') : employeeIds,
    returnTo: 'analytics_hub'
  });
  
  window.location.href = `/training_management.html?${params}`;
};

// Handle TNI page size change
function funHandleTNIPageSizeChange() {
  pageSize = parseInt(document.getElementById('tni-page-size')?.value || '25');
  currentPage = 1;
  funUpdateTNITable();
  funUpdateTNIPagination();
}

// Change TNI page
function funChangeTNIPage(direction) {
  const totalPages = Math.ceil(filteredTniData.length / pageSize);
  currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
  
  funUpdateTNITable();
  funUpdateTNIPagination();
}

// Update TNI pagination
function funUpdateTNIPagination() {
  const totalPages = Math.ceil(filteredTniData.length / pageSize);
  const startIndex = (currentPage - 1) * pageSize + 1;
  const endIndex = Math.min(currentPage * pageSize, filteredTniData.length);
  
  document.getElementById('tni-showing-start').textContent = filteredTniData.length > 0 ? startIndex : 0;
  document.getElementById('tni-showing-end').textContent = endIndex;
  document.getElementById('tni-total-count').textContent = filteredTniData.length;
  document.getElementById('tni-page-info').textContent = `Page ${currentPage} of ${totalPages || 1}`;
  
  const prevBtn = document.getElementById('tni-prev-btn');
  const nextBtn = document.getElementById('tni-next-btn');
  
  if (prevBtn) prevBtn.disabled = currentPage <= 1;
  if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
}

// Refresh trainers data
async function funRefreshTrainersData(showSkeleton = false) {
  const skeleton = document.getElementById('trainers-table-skeleton');
  const table = document.getElementById('trainers-table');
  
  if (showSkeleton) {
    skeleton?.classList.remove('hidden');
    table?.classList.add('hidden');
  }
  
  try {
    await yieldToFrame();
    
    // Process trainer availability data
    const trainerData = await funProcessTrainersData();
    
    await yieldToFrame();
    
    // Render table
    funRenderTrainersTable(trainerData);
    
    table?.classList.remove('hidden');
    
  } catch (error) {
    console.error('Error refreshing trainers data:', error);
    showToast('Error refreshing trainers data', 'error');
  } finally {
    skeleton?.classList.add('hidden');
  }
}

// Process trainers data
async function funProcessTrainersData() {
  try {
    const skillTrainers = new Map();
    
    // Build skill -> trainers mapping
    currentData.trainerEligibilities.forEach(eligibility => {
      const skill = currentData.skills.get(eligibility.skillId);
      if (!skill) return;
      
      // Apply filters
      if (globalFilters.categoryId && skill.categoryId !== globalFilters.categoryId) return;
      if (globalFilters.criticalityId && skill.criticalityId !== globalFilters.criticalityId) return;
      
      const skillKey = eligibility.skillId;
      
      if (!skillTrainers.has(skillKey)) {
        skillTrainers.set(skillKey, {
          skillId: eligibility.skillId,
          skillName: skill.name || 'Unknown',
          categoryName: currentData.categories.get(skill.categoryId)?.name || 'Unknown',
          availableTrainers: [],
          upcomingSessions: 0
        });
      }
      
      const skillData = skillTrainers.get(skillKey);
      
      // Check if trainer exists and is active
      const trainer = currentData.trainers.get(eligibility.employeeId);
      if (trainer?.status === 'active') {
        const employee = currentData.employees.get(eligibility.employeeId);
        
        skillData.availableTrainers.push({
          trainerId: trainer.id,
          employeeId: eligibility.employeeId,
          name: trainer.name || employee?.name || 'Unknown',
          type: trainer.type || 'internal'
        });
      }
    });
    
    // Count upcoming sessions per skill
    currentData.trainingSessions.forEach(session => {
      if (session.status === 'scheduled' && skillTrainers.has(session.skillId)) {
        skillTrainers.get(session.skillId).upcomingSessions++;
      }
    });
    
    return Array.from(skillTrainers.values()).filter(item => item.availableTrainers.length > 0);
    
  } catch (error) {
    console.error('Error processing trainers data:', error);
    return [];
  }
}

// Render trainers table
function funRenderTrainersTable(data) {
  const tbody = document.getElementById('trainers-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="px-4 py-8 text-center text-secondary">
          No trainer data available for current filters
        </td>
      </tr>
    `;
    return;
  }
  
  data.forEach(item => {
    const row = document.createElement('tr');
    row.className = 'border-b border-neutral-200 hover:bg-neutral-50';
    
    row.innerHTML = `
      <td class="px-4 py-3">
        <div class="font-medium text-neutral-700">${item.skillName}</div>
        <div class="text-xs text-secondary">${item.categoryName}</div>
      </td>
      <td class="px-4 py-3">
        <div class="space-y-1">
          ${item.availableTrainers.slice(0, 3).map(trainer => `
            <div class="text-sm text-neutral-700">
              ${trainer.name} 
              <span class="text-xs text-secondary">(${trainer.type})</span>
            </div>
          `).join('')}
          ${item.availableTrainers.length > 3 ? 
            `<div class="text-xs text-secondary">+${item.availableTrainers.length - 3} more</div>` : 
            ''}
        </div>
      </td>
      <td class="px-4 py-3 text-center">
        <span class="font-medium text-neutral-700">${item.upcomingSessions}</span>
        <div class="text-xs text-secondary">sessions</div>
      </td>
      <td class="px-4 py-3">
        <button class="text-xs px-2 py-1 border border-neutral-200 text-neutral-700 rounded hover:bg-neutral-50 transition-colors duration-150"
                onclick="funManageTrainers('${item.skillId}')">
          Manage Trainers
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

// Manage trainers navigation
window.funManageTrainers = function(skillId) {
  const params = new URLSearchParams({
    tab: 'trainers',
    skillId: skillId,
    returnTo: 'analytics_hub'
  });
  
  window.location.href = `/training_management.html?${params}`;
};

// Navigate to disputes
function funNavigateToDisputes() {
  const params = new URLSearchParams({
    status: 'open',
    returnTo: 'analytics_hub'
  });
  
  if (globalFilters.departmentId) {
    params.set('departmentId', globalFilters.departmentId);
  }
  
  window.location.href = `/disputes_center.html?${params}`;
}

// Initialize icons
document.addEventListener('DOMContentLoaded', () => {
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
});
</script>

</body>
</html>