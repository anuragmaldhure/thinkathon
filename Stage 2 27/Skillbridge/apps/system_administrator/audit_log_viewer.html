<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkillBridge Competency Management Platform</title>

    <!-- Required: Main JS Script -->
    <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

    <!-- Required: TailwindCSS -->
    <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

    <!-- Required: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

    <!-- Required: Favicon -->
    <link rel="icon" href="assets/imgs/logo.ico" type="image/x-icon" data-tiramai="web-gen"/>

    <!-- ECharts Support (for charts/graphs) -->
    <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

    <!-- Markdown Support (for content rendering) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

    <!-- Tailwind Configuration -->
    <script data-tiramai="web-gen">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e293b',
                        secondary: '#475569',
                        accent: '#2563eb',
                        gold: '#CBA35C',
                        success: '#16A34A',
                        warning: '#D97706',
                        error: '#DC2626',
                        info: '#0EA5E9',
                        neutral: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                            400: '#94A3B8',
                            700: '#334155',
                            900: '#0F172A',
                        }
                    },
                    fontFamily: {
                        sans: ['IBM Plex Sans', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                    },
                    boxShadow: {
                        sm: '0 1px 2px rgba(15,23,42,0.06)',
                        DEFAULT: '0 2px 8px rgba(15,23,42,0.08)',
                        lg: '0 8px 24px rgba(15,23,42,0.12)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral-50 min-h-screen text-neutral-700 font-sans">
    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-neutral-200 flex items-center justify-between px-6 py-4 z-30 h-16">
        <div class="flex items-center gap-4">
            <button id="mobile-menu-btn" class="md:hidden p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150">
                <i data-lucide="menu" class="w-6 h-6 text-secondary"></i>
            </button>
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" fill="none" class="h-8 w-8">
                    <rect x="100" y="100" width="200" height="200" rx="16" stroke="#1e293b" stroke-width="16" fill="none"/>
                    <path d="M150 250V170c0-11 9-20 20-20h60c11 0 20 9 20 20v80" stroke="#2563eb" stroke-width="14" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <circle cx="200" cy="170" r="18" stroke="#1e293b" stroke-width="12" fill="none"/>
                    <path d="M150 250h100m-60-30h20" stroke="#2563eb" stroke-width="12" stroke-linecap="round" fill="none"/>
                    <path d="M170 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                    <path d="M230 220v0" stroke="#1e293b" stroke-width="12" stroke-linecap="round"/>
                </svg>
                <span class="text-xl font-semibold text-primary">SkillBridge Competency Management Platform</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- User Profile Dropdown -->
            <div class="relative">
                <button id="user-profile-btn" class="flex items-center gap-3 p-2 hover:bg-neutral-100 rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
                    <div class="flex flex-col items-end">
                        <span id="user-name" class="text-sm font-medium text-neutral-700">Loading...</span>
                        <span id="user-role" class="text-xs text-neutral-400">System Admin</span>
                    </div>
                    <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                </button>
                <!-- Dropdown Menu -->
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-neutral-200 z-40">
                    <div class="py-2">
                        <button id="sign-out-btn" class="w-full px-4 py-2 text-left text-sm text-neutral-700 hover:bg-neutral-50 flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <!-- Side Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r border-neutral-200 h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto hidden md:block">
            <nav class="p-4 space-y-1">
                <!-- Analytics Hub -->
                <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Analytics Hub</span>
                </a>

                <!-- Organization Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                    <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="building-2" class="w-5 h-5"></i>
                        <span>Org Configuration</span>
                    </a>
                    <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span>Org Settings</span>
                    </a>
                </div>

                <!-- Core Management Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                    <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                        <span>Skill Framework</span>
                    </a>
                    <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Employees & Hierarchy</span>
                    </a>
                    <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>Training Management</span>
                    </a>
                </div>

                <!-- Operations Section -->
                <div class="pt-4">
                    <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                    <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="gavel" class="w-5 h-5"></i>
                        <span>Disputes Center</span>
                    </a>
                    <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        <span>Assessment Viewer</span>
                    </a>
                    <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="file-search" class="w-5 h-5"></i>
                        <span>Audit Log Viewer</span>
                    </a>
                </div>
            </nav>

            <!-- Footer -->
            <div class="absolute bottom-6 w-full text-center text-xs text-neutral-400 bg-white px-4">
                Made with ❤️ by TiramAi
            </div>
        </aside>

        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay" class="hidden fixed inset-0 z-40 md:hidden">
            <div class="fixed inset-0 bg-neutral-900 bg-opacity-50" id="mobile-nav-backdrop"></div>
            <aside class="fixed left-0 top-16 h-[calc(100vh-4rem)] w-64 bg-white border-r border-neutral-200 overflow-y-auto">
                <nav class="p-4 space-y-1">
                    <!-- Same navigation structure as desktop -->
                    <a href="analytics_hub.html" data-page="analytics_hub" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Analytics Hub</span>
                    </a>
                    
                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Organization</h3>
                        <a href="org_configuration.html" data-page="org_configuration" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="building-2" class="w-5 h-5"></i>
                            <span>Org Configuration</span>
                        </a>
                        <a href="org_settings_versioned.html" data-page="org_settings_versioned" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>Org Settings</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Core Management</h3>
                        <a href="skill_framework.html" data-page="skill_framework" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="book-open" class="w-5 h-5"></i>
                            <span>Skill Framework</span>
                        </a>
                        <a href="employees_hierarchy.html" data-page="employees_hierarchy" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Employees & Hierarchy</span>
                        </a>
                        <a href="training_management.html" data-page="training_management" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>Training Management</span>
                        </a>
                    </div>

                    <div class="pt-4">
                        <h3 class="px-3 text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Operations</h3>
                        <a href="disputes_center.html" data-page="disputes_center" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="gavel" class="w-5 h-5"></i>
                            <span>Disputes Center</span>
                        </a>
                        <a href="assessment_viewer.html" data-page="assessment_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span>Assessment Viewer</span>
                        </a>
                        <a href="audit_log_viewer.html" data-page="audit_log_viewer" class="nav-item flex items-center gap-3 px-3 py-2 text-sm rounded-md hover:bg-neutral-100 transition-colors duration-150 text-neutral-700">
                            <i data-lucide="file-search" class="w-5 h-5"></i>
                            <span>Audit Log Viewer</span>
                        </a>
                    </div>
                </nav>
            </aside>
        </div>

        <!-- Main Content -->
        <main id="pageContent" class="flex-1 p-6 overflow-y-auto max-w-[1440px] mx-auto">
            
<!-- Page Header -->
<div class="mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-[clamp(1.5rem,2.5vw,2rem)] leading-10 font-bold text-primary mb-2">Audit Log Viewer</h1>
      <p class="text-sm text-secondary">Unified timeline to trace all admin actions and entity changes for compliance and debugging.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-refresh" class="inline-flex items-center text-sm text-secondary hover:text-primary transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 rounded-md px-2 py-1" aria-label="Refresh audit logs">
        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i>
        Refresh
      </button>
      <button id="btn-back" class="inline-flex items-center gap-2 bg-white text-primary border border-neutral-200 rounded-md px-4 py-2 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back
      </button>
    </div>
  </div>
</div>

<!-- Filters Panel -->
<div class="bg-white rounded-md border border-neutral-200 shadow-sm p-6 mb-6">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Entity Type Filter -->
    <div>
      <label class="block text-secondary text-xs mb-1">Entity Type</label>
      <select id="filter-entity-type" class="w-full border border-neutral-200 rounded-md px-3 py-2 text-neutral-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        <option value="">All Types</option>
        <option value="employee">Employee</option>
        <option value="skill">Skill</option>
        <option value="assessment">Assessment</option>
        <option value="dispute">Dispute</option>
        <option value="department">Department</option>
        <option value="training">Training</option>
      </select>
    </div>

    <!-- Action Filter -->
    <div>
      <label class="block text-secondary text-xs mb-1">Action</label>
      <select id="filter-action" class="w-full border border-neutral-200 rounded-md px-3 py-2 text-neutral-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        <option value="">All Actions</option>
        <option value="create">Create</option>
        <option value="update">Update</option>
        <option value="softDelete">Soft Delete</option>
        <option value="resolveDispute">Resolve Dispute</option>
        <option value="overrideScore">Override Score</option>
        <option value="dismissDispute">Dismiss Dispute</option>
        <option value="changeTeamLead">Change Team Lead</option>
      </select>
    </div>

    <!-- Date Range Filter -->
    <div>
      <label class="block text-secondary text-xs mb-1">Date From</label>
      <input type="date" id="filter-date-from" class="w-full border border-neutral-200 rounded-md px-3 py-2 text-neutral-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
    </div>

    <div>
      <label class="block text-secondary text-xs mb-1">Date To</label>
      <input type="date" id="filter-date-to" class="w-full border border-neutral-200 rounded-md px-3 py-2 text-neutral-700 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
    </div>
  </div>

  <!-- Search and Apply Filters -->
  <div class="flex flex-col md:flex-row gap-3 mt-4">
    <div class="flex-1">
      <label class="block text-secondary text-xs mb-1">Search Keyword</label>
      <input type="text" id="filter-keyword" placeholder="Search by actor name, entity ID, reason..." class="w-full border border-neutral-200 rounded-md px-3 py-2 text-neutral-700 placeholder-neutral-400 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
    </div>
    <div class="flex items-end gap-2">
      <button id="btn-apply-filters" class="inline-flex items-center gap-2 bg-accent text-white rounded-md px-4 py-2 hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150">
        <i data-lucide="search" class="w-4 h-4"></i>
        Apply Filters
      </button>
      <button id="btn-clear-filters" class="inline-flex items-center gap-2 bg-white text-primary border border-neutral-200 rounded-md px-4 py-2 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150">
        <i data-lucide="x" class="w-4 h-4"></i>
        Clear
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="hidden">
  <div class="bg-white rounded-md border border-neutral-200 shadow-sm p-6">
    <div class="space-y-4">
      <!-- Skeleton rows -->
      <div class="animate-pulse space-y-3" id="skeleton-container">
        <div class="flex items-start gap-4">
          <div class="w-2 h-2 bg-neutral-200 rounded-full mt-2"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
            <div class="h-3 bg-neutral-200 rounded w-3/4"></div>
            <div class="h-20 bg-neutral-200 rounded"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Audit Log Timeline -->
<div id="audit-timeline" class="bg-white rounded-md border border-neutral-200 shadow-sm">
  <div class="p-6 border-b border-neutral-200">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-primary">Audit Timeline</h2>
      <span id="results-count" class="text-sm text-secondary">Loading...</span>
    </div>
  </div>

  <div id="timeline-content" class="p-6">
    <!-- Timeline items will be populated here -->
  </div>

  <!-- Pagination -->
  <div id="pagination-container" class="border-t border-neutral-200 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="text-sm text-secondary">
        Showing <span id="showing-from">0</span> to <span id="showing-to">0</span> of <span id="total-results">0</span> results
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-prev-page" class="inline-flex items-center gap-2 bg-white text-primary border border-neutral-200 rounded-md px-3 py-2 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
          <i data-lucide="chevron-left" class="w-4 h-4"></i>
          Previous
        </button>
        <span id="page-info" class="text-sm text-secondary px-4">Page 1</span>
        <button id="btn-next-page" class="inline-flex items-center gap-2 bg-white text-primary border border-neutral-200 rounded-md px-3 py-2 hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
          Next
          <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div id="empty-state" class="hidden bg-white rounded-md border border-neutral-200 shadow-sm p-12 text-center">
  <i data-lucide="file-search" class="w-12 h-12 text-neutral-400 mx-auto mb-4"></i>
  <h3 class="text-lg font-semibold text-primary mb-2">No audit logs found</h3>
  <p class="text-secondary text-sm mb-4">No audit logs match your current filters.</p>
  <button id="btn-clear-filters-empty" class="inline-flex items-center gap-2 bg-accent text-white rounded-md px-4 py-2 hover:bg-[#1d4ed8] focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 transition-colors duration-150">
    Clear filters
  </button>
</div>

<!-- Diff Modal -->
<div id="diff-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="diff-modal-backdrop"></div>
    <div class="relative bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-neutral-200">
        <h3 class="text-lg font-semibold text-primary">Audit Log Details</h3>
        <button id="btn-close-diff-modal" class="text-neutral-400 hover:text-neutral-600 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 rounded-md p-1" aria-label="Close">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[70vh]">
        <!-- Modal content will be populated here -->
        <div id="diff-modal-content"></div>
      </div>
    </div>
  </div>
</div>

        </main>
    </div>

    <!-- Required: JavaScript -->
    <script type="module" data-tiramai="web-gen">
        import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
        import { auth, db, storage } from "./scripts/firebase.js";
        import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Auth state management
        let currentUser = null;

        // Initialize auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user);
            } else {
                // Redirect to auth page if not authenticated
                window.location.href = 'auth.html';
            }
        });

        // Load user profile data
        async function loadUserProfile(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                    document.getElementById('user-name').textContent = fullName || user.email;
                } else {
                    // Fallback to email if no user doc exists
                    document.getElementById('user-name').textContent = user.email;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to email on error
                document.getElementById('user-name').textContent = user.email;
            }
        }

        // User dropdown functionality
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDropdown = document.getElementById('user-dropdown');
        const signOutBtn = document.getElementById('sign-out-btn');

        userProfileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            userDropdown.classList.add('hidden');
        });

        // Sign out functionality
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            }
        });

        // Mobile navigation
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const mobileNavBackdrop = document.getElementById('mobile-nav-backdrop');

        mobileMenuBtn.addEventListener('click', () => {
            mobileNavOverlay.classList.remove('hidden');
        });

        mobileNavBackdrop.addEventListener('click', () => {
            mobileNavOverlay.classList.add('hidden');
        });

        // Close mobile nav on navigation
        document.querySelectorAll('#mobile-nav-overlay .nav-item').forEach(link => {
            link.addEventListener('click', () => {
                mobileNavOverlay.classList.add('hidden');
            });
        });

        // Active navigation state
        function updateActiveNavState() {
            const currentPath = window.location.pathname;
            const pageName = currentPath.replace('/', '').replace('.html', '');
            
            // Remove active state from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-accent', 'text-white');
                item.classList.add('text-neutral-700');
            });

            // Add active state to current page
            document.querySelectorAll(`[data-page="${pageName}"]`).forEach(item => {
                item.classList.add('bg-accent', 'text-white');
                item.classList.remove('text-neutral-700');
            });
        }

        // Update active state on load
        updateActiveNavState();

        // Update active state on navigation (for SPA behavior)
        window.addEventListener('popstate', updateActiveNavState);
    </script>

    
<script id="data-script" type="module" data-tiramai="web-gen">
import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import {
  collection, getDocs, setDoc, addDoc, doc, getDoc, updateDoc, deleteDoc, writeBatch,
  query, where, orderBy, limit, startAfter, endBefore, onSnapshot, Timestamp,
  getCountFromServer
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { auth, getDb } from "./scripts/firebase.js";
import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";

const db = getDb();

// Auth check
onAuthStateChanged(auth, user => {
  if (!user) {
    const currentPath = encodeURIComponent(location.pathname);
    location.href = "auth.html?redirect=" + currentPath;
  }
});

// Page state
let auditLogs = [];
let currentPage = 1;
const pageSize = 20;
let lastVisible = null;
let totalCount = 0;
let currentFilters = {};
let currentAbort;

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  funInitialize();
});

// Utility functions
const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

function createSemaphore(max = 2) {
  const queue = [];
  let active = 0;
  const next = () => {
    if (active >= max || queue.length === 0) return;
    active++;
    const { fn, res, rej } = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(v => res(v))
      .catch(e => rej(e))
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
}

const withLimit = createSemaphore(2);

// Abortable fetch pattern
async function funFetchAuditLogs(buildQuery, isFirstPage = false) {
  if (currentAbort) currentAbort.abort();
  currentAbort = new AbortController();
  const signal = currentAbort.signal;

  try {
    const q = buildQuery();
    const snapshot = await getDocs(q);
    if (signal.aborted) return { items: [], cursor: null };
    
    return {
      items: snapshot.docs.map(d => ({ id: d.id, ...d.data() })),
      cursor: snapshot.docs.at(-1) || null,
    };
  } catch (err) {
    if (signal.aborted) return { items: [], cursor: null };
    console.error('Error fetching audit logs:', err);
    showToast(err?.message || "Failed to load audit logs");
    return { items: [], cursor: null };
  }
}

// Initialize page
async function funInitialize() {
  funSetupEventListeners();
  await funLoadAuditLogs();
}

// Event listeners
function funSetupEventListeners() {
  // Back button
  document.getElementById('btn-back')?.addEventListener('click', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const returnTo = urlParams.get('returnTo');
    if (returnTo) {
      window.location.href = returnTo;
    } else {
      window.location.href = 'analytics_hub.html';
    }
  });

  // Refresh button
  document.getElementById('btn-refresh')?.addEventListener('click', () => {
    funResetPagination();
    funLoadAuditLogs(true);
  });

  // Filter buttons
  document.getElementById('btn-apply-filters')?.addEventListener('click', () => {
    funApplyFilters();
  });

  document.getElementById('btn-clear-filters')?.addEventListener('click', funClearFilters);
  document.getElementById('btn-clear-filters-empty')?.addEventListener('click', funClearFilters);

  // Pagination
  document.getElementById('btn-prev-page')?.addEventListener('click', () => funChangePage(-1));
  document.getElementById('btn-next-page')?.addEventListener('click', () => funChangePage(1));

  // Modal handlers
  document.getElementById('btn-close-diff-modal')?.addEventListener('click', funCloseDiffModal);
  document.getElementById('diff-modal-backdrop')?.addEventListener('click', funCloseDiffModal);

  // Handle Enter key for search
  document.getElementById('filter-keyword')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      funApplyFilters();
    }
  });

  // ESC to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      funCloseDiffModal();
    }
  });
}

// Load audit logs
async function funLoadAuditLogs(forceRefresh = false) {
  try {
    funShowLoading();

    if (forceRefresh) {
      funResetPagination();
    }

    // Build query based on filters
    const buildQuery = () => {
      let q = query(collection(db, 'auditLogs'), orderBy('timestamp', 'desc'));

      // Apply filters
      if (currentFilters.entityType) {
        q = query(q, where('entityType', '==', currentFilters.entityType));
      }
      if (currentFilters.action) {
        q = query(q, where('action', '==', currentFilters.action));
      }
      if (currentFilters.dateFrom) {
        q = query(q, where('timestamp', '>=', currentFilters.dateFrom));
      }
      if (currentFilters.dateTo) {
        // Add one day to include the entire "to" date
        const endOfDay = new Date(currentFilters.dateTo);
        endOfDay.setDate(endOfDay.getDate() + 1);
        q = query(q, where('timestamp', '<', endOfDay.toISOString()));
      }

      // Add pagination
      q = query(q, limit(pageSize));
      if (lastVisible && currentPage > 1) {
        q = query(q, startAfter(lastVisible));
      }

      return q;
    };

    const result = await withLimit(() => funFetchAuditLogs(buildQuery, currentPage === 1));
    auditLogs = result.items;

    // Get total count for first page
    if (currentPage === 1) {
      await funGetTotalCount();
    }

    await yieldToFrame();
    funRenderAuditLogs();
    funUpdatePagination();
    lastVisible = result.cursor;
    
  } catch (error) {
    console.error('Error loading audit logs:', error);
    showToast('Failed to load audit logs');
  } finally {
    funHideLoading();
  }
}

// Get total count for pagination
async function funGetTotalCount() {
  try {
    let countQuery = collection(db, 'auditLogs');

    // Apply same filters for count
    if (currentFilters.entityType) {
      countQuery = query(countQuery, where('entityType', '==', currentFilters.entityType));
    }
    if (currentFilters.action) {
      countQuery = query(countQuery, where('action', '==', currentFilters.action));
    }
    if (currentFilters.dateFrom) {
      countQuery = query(countQuery, where('timestamp', '>=', currentFilters.dateFrom));
    }
    if (currentFilters.dateTo) {
      const endOfDay = new Date(currentFilters.dateTo);
      endOfDay.setDate(endOfDay.getDate() + 1);
      countQuery = query(countQuery, where('timestamp', '<', endOfDay.toISOString()));
    }

    const countSnapshot = await getCountFromServer(countQuery);
    totalCount = countSnapshot.data().count;
  } catch (error) {
    console.error('Error getting total count:', error);
    totalCount = 0;
  }
}

// Apply filters
function funApplyFilters() {
  currentFilters = {
    entityType: document.getElementById('filter-entity-type')?.value || '',
    action: document.getElementById('filter-action')?.value || '',
    dateFrom: document.getElementById('filter-date-from')?.value || '',
    dateTo: document.getElementById('filter-date-to')?.value || '',
    keyword: document.getElementById('filter-keyword')?.value?.toLowerCase().trim() || ''
  };

  // Convert date strings to ISO format
  if (currentFilters.dateFrom) {
    currentFilters.dateFrom = new Date(currentFilters.dateFrom).toISOString();
  }
  if (currentFilters.dateTo) {
    currentFilters.dateTo = new Date(currentFilters.dateTo).toISOString();
  }

  funResetPagination();
  funLoadAuditLogs();
}

// Clear filters
function funClearFilters() {
  document.getElementById('filter-entity-type').value = '';
  document.getElementById('filter-action').value = '';
  document.getElementById('filter-date-from').value = '';
  document.getElementById('filter-date-to').value = '';
  document.getElementById('filter-keyword').value = '';
  
  currentFilters = {};
  funResetPagination();
  funLoadAuditLogs();
}

// Reset pagination
function funResetPagination() {
  currentPage = 1;
  lastVisible = null;
}

// Change page
function funChangePage(direction) {
  if (direction > 0 && !funCanGoNext()) return;
  if (direction < 0 && !funCanGoPrev()) return;

  currentPage += direction;
  funLoadAuditLogs();
}

// Pagination helpers
function funCanGoPrev() {
  return currentPage > 1;
}

function funCanGoNext() {
  return currentPage * pageSize < totalCount;
}

// Render audit logs
function funRenderAuditLogs() {
  const container = document.getElementById('timeline-content');
  const emptyState = document.getElementById('empty-state');
  const timeline = document.getElementById('audit-timeline');

  if (!auditLogs || auditLogs.length === 0) {
    timeline.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }

  timeline.classList.remove('hidden');
  emptyState.classList.add('hidden');

  // Filter by keyword on client side (for displayed items only)
  let filteredLogs = auditLogs;
  if (currentFilters.keyword) {
    filteredLogs = auditLogs.filter(log => 
      (log.actorId && log.actorId.toLowerCase().includes(currentFilters.keyword)) ||
      (log.entityId && log.entityId.toLowerCase().includes(currentFilters.keyword)) ||
      (log.reason && log.reason.toLowerCase().includes(currentFilters.keyword)) ||
      (log.action && log.action.toLowerCase().includes(currentFilters.keyword)) ||
      (log.entityType && log.entityType.toLowerCase().includes(currentFilters.keyword))
    );
  }

  container.innerHTML = filteredLogs.map(log => funRenderAuditLogItem(log)).join('');

  // Update results count
  const resultsCount = document.getElementById('results-count');
  if (resultsCount) {
    resultsCount.textContent = `${totalCount || 0} entries found`;
  }
}

// Render individual audit log item
function funRenderAuditLogItem(log) {
  const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('en-IN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: 'Asia/Kolkata'
  }) : 'N/A';

  const actionColor = funGetActionColor(log.action);
  const hasChanges = log.before || log.after;

  return `
    <div class="flex items-start gap-4 pb-6 border-b border-neutral-100 last:border-0 last:pb-0 mb-6 last:mb-0">
      <div class="flex-shrink-0 mt-2">
        <span class="h-2 w-2 rounded-full ${actionColor}"></span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between gap-4 mb-2">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-medium text-primary">${funCapitalize(log.action || 'Unknown')}</span>
              <span class="text-xs text-white px-2 py-1 rounded-full ${funGetEntityTypeColor(log.entityType)}">${funCapitalize(log.entityType || 'Unknown')}</span>
            </div>
            <div class="text-sm text-secondary">
              <span class="font-mono">${log.entityId || 'N/A'}</span> by <span class="font-medium">${log.actorId || 'System'}</span>
            </div>
          </div>
          <div class="text-xs text-neutral-400 flex-shrink-0">
            ${timestamp}
          </div>
        </div>

        ${log.reason ? `
          <div class="mb-3">
            <span class="text-xs text-secondary font-medium">Reason:</span>
            <p class="text-sm text-neutral-700 mt-1">${funEscapeHtml(log.reason)}</p>
          </div>
        ` : ''}

        ${hasChanges ? `
          <div class="bg-neutral-50 rounded-md p-3">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-secondary">Changes</span>
              <button 
                class="text-xs text-accent hover:text-[#1d4ed8] transition-colors duration-150 font-medium"
                onclick="funShowDiffModal('${log.id}')"
              >
                View Details →
              </button>
            </div>
            <div class="text-xs text-neutral-600">
              ${funGetChangesSummary(log.before, log.after)}
            </div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

// Get action color
function funGetActionColor(action) {
  const colors = {
    'create': 'bg-success',
    'update': 'bg-info',
    'softDelete': 'bg-error',
    'resolveDispute': 'bg-success',
    'overrideScore': 'bg-warning',
    'dismissDispute': 'bg-neutral-400',
    'changeTeamLead': 'bg-info'
  };
  return colors[action] || 'bg-neutral-400';
}

// Get entity type color
function funGetEntityTypeColor(entityType) {
  const colors = {
    'employee': 'bg-info',
    'skill': 'bg-success',
    'assessment': 'bg-warning',
    'dispute': 'bg-error',
    'department': 'bg-info',
    'training': 'bg-accent'
  };
  return colors[entityType] || 'bg-neutral-400';
}

// Get changes summary
function funGetChangesSummary(before, after) {
  if (!before && !after) return 'No changes recorded';
  
  const beforeKeys = before ? Object.keys(before) : [];
  const afterKeys = after ? Object.keys(after) : [];
  const allKeys = [...new Set([...beforeKeys, ...afterKeys])];
  
  if (allKeys.length === 0) return 'No changes recorded';
  
  const changedFields = allKeys.filter(key => 
    JSON.stringify(before?.[key]) !== JSON.stringify(after?.[key])
  );

  if (changedFields.length === 0) return 'No fields changed';
  
  return `Modified ${changedFields.length} field${changedFields.length === 1 ? '' : 's'}: ${changedFields.slice(0, 3).join(', ')}${changedFields.length > 3 ? '...' : ''}`;
}

// Show diff modal
function funShowDiffModal(logId) {
  const log = auditLogs.find(l => l.id === logId);
  if (!log) return;

  const modal = document.getElementById('diff-modal');
  const content = document.getElementById('diff-modal-content');
  
  content.innerHTML = funRenderDiffModalContent(log);
  modal.classList.remove('hidden');
  
  // Focus trap
  modal.querySelector('button')?.focus();
}

// Close diff modal
function funCloseDiffModal() {
  document.getElementById('diff-modal')?.classList.add('hidden');
}

// Render diff modal content
function funRenderDiffModalContent(log) {
  const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('en-IN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    timeZone: 'Asia/Kolkata'
  }) : 'N/A';

  return `
    <div class="space-y-6">
      <!-- Header Info -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-neutral-50 rounded-md">
        <div>
          <label class="text-xs font-medium text-secondary">Action</label>
          <p class="text-sm text-primary">${funCapitalize(log.action || 'Unknown')}</p>
        </div>
        <div>
          <label class="text-xs font-medium text-secondary">Entity Type</label>
          <p class="text-sm text-primary">${funCapitalize(log.entityType || 'Unknown')}</p>
        </div>
        <div>
          <label class="text-xs font-medium text-secondary">Entity ID</label>
          <p class="text-sm font-mono text-primary">${log.entityId || 'N/A'}</p>
        </div>
        <div>
          <label class="text-xs font-medium text-secondary">Actor</label>
          <p class="text-sm text-primary">${log.actorId || 'System'}</p>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-medium text-secondary">Timestamp</label>
          <p class="text-sm text-primary">${timestamp}</p>
        </div>
        ${log.reason ? `
          <div class="md:col-span-2">
            <label class="text-xs font-medium text-secondary">Reason</label>
            <p class="text-sm text-primary">${funEscapeHtml(log.reason)}</p>
          </div>
        ` : ''}
      </div>

      <!-- Before/After Comparison -->
      ${log.before || log.after ? `
        <div class="space-y-4">
          <h4 class="text-lg font-semibold text-primary">Changes</h4>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Before -->
            <div>
              <h5 class="text-sm font-medium text-secondary mb-2 flex items-center gap-2">
                <span class="h-2 w-2 rounded-full bg-error"></span>
                Before
              </h5>
              <div class="bg-neutral-50 rounded-md p-3 border-l-4 border-error">
                <pre class="text-xs font-mono text-neutral-700 whitespace-pre-wrap overflow-x-auto">${funFormatJSON(log.before || {})}</pre>
              </div>
            </div>

            <!-- After -->
            <div>
              <h5 class="text-sm font-medium text-secondary mb-2 flex items-center gap-2">
                <span class="h-2 w-2 rounded-full bg-success"></span>
                After
              </h5>
              <div class="bg-neutral-50 rounded-md p-3 border-l-4 border-success">
                <pre class="text-xs font-mono text-neutral-700 whitespace-pre-wrap overflow-x-auto">${funFormatJSON(log.after || {})}</pre>
              </div>
            </div>
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

// Update pagination
function funUpdatePagination() {
  const showingFrom = ((currentPage - 1) * pageSize) + 1;
  const showingTo = Math.min(currentPage * pageSize, totalCount);

  document.getElementById('showing-from').textContent = totalCount > 0 ? showingFrom : 0;
  document.getElementById('showing-to').textContent = showingTo;
  document.getElementById('total-results').textContent = totalCount;
  document.getElementById('page-info').textContent = `Page ${currentPage}`;

  // Update button states
  const prevBtn = document.getElementById('btn-prev-page');
  const nextBtn = document.getElementById('btn-next-page');
  
  if (prevBtn) {
    prevBtn.disabled = !funCanGoPrev();
  }
  if (nextBtn) {
    nextBtn.disabled = !funCanGoNext();
  }
}

// Show/hide loading
function funShowLoading() {
  document.getElementById('loading-state')?.classList.remove('hidden');
  document.getElementById('audit-timeline')?.classList.add('hidden');
  document.getElementById('empty-state')?.classList.add('hidden');
}

function funHideLoading() {
  document.getElementById('loading-state')?.classList.add('hidden');
}

// Utility functions
function funCapitalize(str) {
  if (!str) return 'N/A';
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function funEscapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function funFormatJSON(obj) {
  if (!obj || typeof obj !== 'object') {
    return JSON.stringify(obj, null, 2) || 'null';
  }
  return JSON.stringify(obj, null, 2);
}

// Make functions available globally for inline event handlers
window.funShowDiffModal = funShowDiffModal;
</script>

</body>
</html>